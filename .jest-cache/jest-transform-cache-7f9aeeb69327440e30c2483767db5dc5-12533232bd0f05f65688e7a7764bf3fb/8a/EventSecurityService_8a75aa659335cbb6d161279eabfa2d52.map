{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\services\\EventSecurityService.ts","mappings":"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","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\services\\EventSecurityService.ts"],"sourcesContent":["// src/services/EventSecurityService.ts\r\nimport { supabase } from '../lib/supabaseClient';\r\n\r\ninterface SavePasswordResult {\r\n  success: boolean;\r\n  password?: string;\r\n  error?: string | Error;\r\n}\r\n\r\ninterface EntryTimeValidation {\r\n  allowed: boolean;\r\n  reason?: string;\r\n}\r\n\r\ninterface ValidatePasswordParams {\r\n  eventId: number;\r\n  participantId: string;\r\n  password: string;\r\n}\r\n\r\ninterface ValidatePasswordResult {\r\n  success: boolean;\r\n  message: string;\r\n}\r\n\r\ninterface EntryStatusResult {\r\n  success: boolean;\r\n  data?: {\r\n    password: string;\r\n    isLocked: boolean;\r\n    lockedAt: string | null;\r\n    openedAt: string | null;\r\n    totalWithAccess: number;\r\n    totalParticipants: number;\r\n  };\r\n  error?: string;\r\n}\r\n\r\nclass EventSecurityService {\r\n  /**\r\n   * Gera uma senha numérica de 4 dígitos\r\n   */\r\n  static generatePassword(): string {\r\n    return Math.floor(1000 + Math.random() * 9000).toString();\r\n  }\r\n\r\n  /**\r\n   * Salva uma senha no evento\r\n   */\r\n  static async savePasswordToEvent(\r\n    eventId: number,\r\n    password: string\r\n  ): Promise<SavePasswordResult> {\r\n    // Valida formato da senha\r\n    if (!/^\\d{4}$/.test(password)) {\r\n      return {\r\n        success: false,\r\n        error: 'Senha deve ser exatamente 4 dígitos'\r\n      };\r\n    }\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('events')\r\n        .update({\r\n          event_entry_password: password,\r\n          entry_opened_at: new Date().toISOString()\r\n        })\r\n        .eq('id', eventId);\r\n\r\n      if (error) {\r\n        return {\r\n          success: false,\r\n          error\r\n        };\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        password\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error as Error\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gera e salva uma senha automaticamente\r\n   */\r\n  static async generateAndSavePassword(\r\n    eventId: number\r\n  ): Promise<SavePasswordResult> {\r\n    const password = this.generatePassword();\r\n    return this.savePasswordToEvent(eventId, password);\r\n  }\r\n\r\n  /**\r\n   * Verifica se o horário de entrada é válido\r\n   */\r\n  static async isEntryTimeValid(\r\n    eventId: number\r\n  ): Promise<EntryTimeValidation> {\r\n    try {\r\n      const { data: event, error } = await supabase\r\n        .from('events')\r\n        .select('start_time, end_time, status')\r\n        .eq('id', eventId)\r\n        .single();\r\n\r\n      if (error || !event) {\r\n        return {\r\n          allowed: false,\r\n          reason: 'Evento não encontrado'\r\n        };\r\n      }\r\n\r\n      // Verifica status do evento\r\n      const validStatuses = ['Confirmado', 'Em Andamento'];\r\n      if (!validStatuses.includes(event.status)) {\r\n        return {\r\n          allowed: false,\r\n          reason: 'Evento não está disponível para entrada'\r\n        };\r\n      }\r\n\r\n      const now = new Date();\r\n      const startTime = new Date(event.start_time);\r\n      const endTime = new Date(event.end_time);\r\n\r\n      // Permite entrada 1 minuto antes do início\r\n      const entryStartTime = new Date(startTime.getTime() - 60000);\r\n\r\n      // Verifica se está dentro da janela de entrada\r\n      if (now < entryStartTime) {\r\n        return {\r\n          allowed: false,\r\n          reason: 'Entrada ainda não liberada'\r\n        };\r\n      }\r\n\r\n      if (now > endTime) {\r\n        return {\r\n          allowed: false,\r\n          reason: 'Entrada encerrada'\r\n        };\r\n      }\r\n\r\n      return { allowed: true };\r\n    } catch (error) {\r\n      return {\r\n        allowed: false,\r\n        reason: 'Erro ao validar horário'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Valida a senha de entrada do participante\r\n   */\r\n  static async validateEntryPassword(\r\n    params: ValidatePasswordParams\r\n  ): Promise<ValidatePasswordResult> {\r\n    const { eventId, participantId, password } = params;\r\n\r\n    // Verifica timing\r\n    const timingCheck = await this.isEntryTimeValid(eventId);\r\n    if (!timingCheck.allowed) {\r\n      return {\r\n        success: false,\r\n        message: timingCheck.reason || 'Entrada não permitida'\r\n      };\r\n    }\r\n\r\n    // Busca evento e senha\r\n    const { data: event, error: eventError } = await supabase\r\n      .from('events')\r\n      .select('event_entry_password, status')\r\n      .eq('id', eventId)\r\n      .single();\r\n\r\n    if (eventError || !event) {\r\n      return {\r\n        success: false,\r\n        message: 'Evento não encontrado'\r\n      };\r\n    }\r\n\r\n    // Verifica senha\r\n    if (event.event_entry_password !== password) {\r\n      return {\r\n        success: false,\r\n        message: 'Senha incorreta. Tente novamente.'\r\n      };\r\n    }\r\n\r\n    // Registra acesso do participante\r\n    const { error: updateError } = await supabase\r\n      .from('event_participants')\r\n      .update({\r\n        com_acesso: true,\r\n        entry_time: new Date().toISOString()\r\n      })\r\n      .eq('event_id', eventId)\r\n      .eq('user_id', participantId);\r\n\r\n    if (updateError) {\r\n      return {\r\n        success: false,\r\n        message: 'Erro ao registrar acesso'\r\n      };\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      message: '✅ Acesso liberado! Bem-vindo ao evento.'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Verifica se o usuário já tem acesso\r\n   */\r\n  static async hasUserAccess(\r\n    eventId: number,\r\n    userId: string\r\n  ): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('event_participants')\r\n        .select('com_acesso')\r\n        .eq('event_id', eventId)\r\n        .eq('user_id', userId)\r\n        .single();\r\n\r\n      if (error || !data) {\r\n        return false;\r\n      }\r\n\r\n      return data.com_acesso === true;\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Bloqueia a entrada no evento\r\n   */\r\n  static async lockEventEntry(eventId: number): Promise<SavePasswordResult> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('events')\r\n        .update({\r\n          entry_locked: true,\r\n          entry_locked_at: new Date().toISOString()\r\n        })\r\n        .eq('id', eventId);\r\n\r\n      if (error) {\r\n        return {\r\n          success: false,\r\n          error\r\n        };\r\n      }\r\n\r\n      return {\r\n        success: true\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error as Error\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtém o status de entrada do evento\r\n   */\r\n  static async getEntryStatus(eventId: number): Promise<EntryStatusResult> {\r\n    try {\r\n      // Busca dados do evento\r\n      const { data: event, error: eventError } = await supabase\r\n        .from('events')\r\n        .select('event_entry_password, entry_locked, entry_locked_at, entry_opened_at')\r\n        .eq('id', eventId)\r\n        .single();\r\n\r\n      if (eventError || !event) {\r\n        return {\r\n          success: false,\r\n          error: 'Evento não encontrado'\r\n        };\r\n      }\r\n\r\n      // Busca participantes\r\n      const { data: participants, error: participantsError } = await supabase\r\n        .from('event_participants')\r\n        .select('com_acesso')\r\n        .eq('event_id', eventId);\r\n\r\n      if (participantsError) {\r\n        return {\r\n          success: false,\r\n          error: 'Erro ao buscar participantes'\r\n        };\r\n      }\r\n\r\n      const totalWithAccess = participants?.filter(p => p.com_acesso).length || 0;\r\n      const totalParticipants = participants?.length || 0;\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          password: event.event_entry_password,\r\n          isLocked: event.entry_locked,\r\n          lockedAt: event.entry_locked_at,\r\n          openedAt: event.entry_opened_at,\r\n          totalWithAccess,\r\n          totalParticipants\r\n        }\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: 'Erro ao buscar status'\r\n      };\r\n    }\r\n  }\r\n}\r\n\r\nexport default EventSecurityService;"],"version":3}