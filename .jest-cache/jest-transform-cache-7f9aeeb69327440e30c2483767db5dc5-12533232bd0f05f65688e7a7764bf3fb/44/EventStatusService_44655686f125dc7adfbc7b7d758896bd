46b03dd00dedf83305d85d957990a823
"use strict";
// src/services/EventStatusService.ts
// ‚úÖ VERS√ÉO CORRIGIDA - Gera√ß√£o de senha 1 minuto antes
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const supabaseClient_1 = require("../lib/supabaseClient");
const EventSecurityService_1 = tslib_1.__importDefault(require("./EventSecurityService"));
const PushNotificationService_1 = tslib_1.__importDefault(require("./PushNotificationService"));
const TrustScoreService_1 = tslib_1.__importDefault(require("./TrustScoreService"));
class EventStatusService {
    /**
     * üéØ Atualiza status de TODOS os eventos
     */
    static async updateAllEventStatuses() {
        try {
            const { data: events, error } = await supabaseClient_1.supabase
                .from('events')
                .select('*')
                .neq('status', 'Cancelado')
                .neq('status', 'Conclu√≠do');
            if (error) {
                console.error('‚ùå Erro ao buscar eventos:', error);
                return;
            }
            if (!events || events.length === 0) {
                console.log('‚úÖ Nenhum evento para atualizar');
                return;
            }
            console.log(`üîÑ Atualizando ${events.length} eventos...`);
            for (const event of events) {
                try {
                    await this.calculateEventStatus(event);
                }
                catch (eventError) {
                    console.error(`‚ùå Erro ao processar evento ${event.id}:`, eventError);
                }
            }
        }
        catch (error) {
            console.error('‚ùå Erro ao atualizar todos os eventos:', error);
        }
    }
    /**
     * üß† L√≥gica de status de UM evento
     */
    static async calculateEventStatus(event) {
        const now = new Date();
        const startTime = new Date(event.start_time);
        const endTime = new Date(event.end_time);
        const currentStatus = event.status;
        // ============================================
        // üéØ FASE 1: Evento futuro
        // ============================================
        if (now < startTime) {
            // checa se falta 1 min ‚Üí gera senha ‚Üí envia push
            await this.detectAndHandlePasswordGeneration(event, now, startTime);
            // checa se precisa bloquear entrada pr√≥ximo do fim
            await this.detectAndHandleEntryLocking(event, now, endTime);
            return;
        }
        // ============================================
        // üéØ FASE 2: Evento prestes a acabar
        // ============================================
        await this.detectAndHandleEntryLocking(event, now, endTime);
        // ============================================
        // üéØ FASE 3: Evento est√° acontecendo
        // ============================================
        if (now >= startTime && now < endTime && currentStatus !== 'Em Andamento') {
            await this.updateEventStatus(event.id, 'Em Andamento');
        }
        // ============================================
        // üéØ FASE 4: Evento terminou
        // ============================================
        if (now >= endTime && currentStatus !== 'Finalizado') {
            console.log(`‚ÑπÔ∏è Evento ${event.id} terminou`);
            await this.updateEventStatus(event.id, 'Finalizado');
            // üìä Penalizar n√£o-presen√ßas
            await TrustScoreService_1.default.penalizeNoShowsForEvent(event.id);
            // üîç Verificar auto-conclus√£o
            const shouldComplete = await this.shouldAutoCompleteEvent(event);
            if (shouldComplete) {
                await this.updateEventStatus(event.id, 'Conclu√≠do');
            }
        }
    }
    /**
     * üé≤ Detecta "falta 1 minuto" ‚Üí Gera senha + Envia push
     * ‚úÖ CORRIGIDO: Agora gera quando falta EXATAMENTE 1 minuto OU MENOS (se ainda n√£o foi gerada)
     */
    static async detectAndHandlePasswordGeneration(event, now, startTime) {
        try {
            // j√° tem senha? n√£o faz nada
            if (event.event_entry_password && event.event_entry_password.length > 0) {
                return;
            }
            // falta quantos minutos?
            const diffMs = startTime.getTime() - now.getTime();
            const minutesUntilEvent = Math.floor(diffMs / (1000 * 60));
            // s√≥ processa quem est√° at√© 5 min do in√≠cio (pra n√£o ficar logando demais)
            if (minutesUntilEvent > 5)
                return;
            // 1. Evento ainda n√£o come√ßou
            if (now >= startTime) {
                return;
            }
            // 2. Est√° dentro da janela de 1 minuto
            const oneMinuteBeforeStart = new Date(startTime.getTime() - 60 * 1000);
            // 3. Senha ainda n√£o foi gerada
            const shouldGeneratePassword = now >= oneMinuteBeforeStart && now < startTime;
            if (!shouldGeneratePassword) {
                // Log apenas se estiver pr√≥ximo (nos √∫ltimos 5 minutos)
                if (minutesUntilEvent <= 5 && minutesUntilEvent > 0) {
                    console.log(`‚è≥ Evento ${event.id}: faltam ${minutesUntilEvent} minutos (senha ser√° gerada em 1 min)`);
                }
                return;
            }
            console.log(`üé≤ Gerando senha para evento ${event.id} (faltam ${minutesUntilEvent} minutos)...`);
            // 1Ô∏è‚É£ Gerar e salvar senha
            const passwordResult = await EventSecurityService_1.default.generateAndSavePassword(event.id);
            if (!passwordResult.success) {
                console.error('‚ùå Erro ao gerar senha:', passwordResult.error);
                return;
            }
            const password = passwordResult.password;
            console.log(`‚úÖ Senha gerada: ${password}`);
            // 2Ô∏è‚É£ Buscar anfitri√£o
            const { data: hostProfile, error: hostError } = await supabaseClient_1.supabase
                .from('profiles')
                .select('username')
                .eq('id', event.creator_id)
                .single();
            if (hostError) {
                console.error('‚ùå Erro ao buscar anfitri√£o:', hostError);
            }
            // 3Ô∏è‚É£ Buscar participantes aprovados
            const { data: participations, error: partError } = await supabaseClient_1.supabase
                .from('event_participants')
                .select('user_id')
                .eq('event_id', event.id)
                .eq('status', 'aprovado');
            if (partError) {
                console.error('‚ùå Erro ao buscar participantes:', partError);
                return;
            }
            // 4Ô∏è‚É£ Enviar push para ANFITRI√ÉO (com senha)
            console.log(`üì® Enviando SENHA para anfitri√£o ${event.creator_id}...`);
            const hostResult = await PushNotificationService_1.default.sendPasswordToHost(event.creator_id, event.id, password, event.title);
            if (hostResult.success) {
                console.log(`‚úÖ Senha enviada para anfitri√£o`);
            }
            else {
                console.error('‚ùå Erro ao enviar senha para anfitri√£o:', hostResult.error);
            }
            // 5Ô∏è‚É£ Enviar push para PARTICIPANTES (gen√©rica, sem senha)
            if (participations && participations.length > 0) {
                const participantIds = participations.map(p => p.user_id);
                console.log(`üì® Enviando notifica√ß√£o de IN√çCIO para ${participantIds.length} participantes...`);
                const participantsResult = await PushNotificationService_1.default.sendEventStartNotificationToParticipants(participantIds, event.id, event.title);
                if (participantsResult.success) {
                    console.log(`‚úÖ Notifica√ß√µes enviadas para participantes`);
                }
                else {
                    console.error('‚ùå Erro ao enviar para participantes:', participantsResult.error);
                }
            }
            console.log(`‚úÖ Processo de gera√ß√£o de senha completo para evento ${event.id}`);
        }
        catch (error) {
            console.error('‚ùå Erro ao processar gera√ß√£o de senha:', error);
        }
    }
    /**
     * üîí Bloqueia entrada 1 minuto antes do fim
     */
    static async detectAndHandleEntryLocking(event, now, endTime) {
        try {
            // se j√° est√° bloqueado, n√£o faz nada
            if (event.entry_locked)
                return;
            const oneMinuteBeforeEnd = new Date(endTime.getTime() - 60 * 1000);
            const timeUntilEnd = endTime.getTime() - now.getTime();
            const minutesUntilEnd = Math.floor(timeUntilEnd / 1000 / 60);
            // ‚úÖ Bloquear quando falta 1 minuto ou menos para terminar
            if (now >= oneMinuteBeforeEnd && now < endTime) {
                console.log(`üîí Bloqueando entrada do evento ${event.id} (faltam ${minutesUntilEnd} min para terminar)...`);
                const lockResult = await EventSecurityService_1.default.lockEventEntry(event.id);
                if (lockResult.success) {
                    console.log(`‚úÖ Entrada bloqueada para evento ${event.id}`);
                }
                else {
                    console.error('‚ùå Erro ao bloquear entrada:', lockResult.error);
                }
            }
        }
        catch (error) {
            console.error('‚ùå Erro ao processar bloqueio de entrada:', error);
        }
    }
    /**
     * üí° Verifica auto-conclus√£o (7 dias OU todos avaliaram)
     */
    static async shouldAutoCompleteEvent(event) {
        let retries = 2;
        while (retries > 0) {
            try {
                const endTime = new Date(event.end_time);
                const now = new Date();
                const daysSinceEnd = (now.getTime() - endTime.getTime()) / (1000 * 60 * 60 * 24);
                // üí° Condi√ß√£o 1: Passou 7 dias? ‚Üí Conclu√≠do
                if (daysSinceEnd >= 7) {
                    console.log(`‚úÖ Evento ${event.id} auto-conclu√≠do ap√≥s 7 dias`);
                    return true;
                }
                // üí° Condi√ß√£o 2: Todos que compareceram avaliaram?
                const { data: participations, error: participationsError } = await supabaseClient_1.supabase
                    .from('event_participants')
                    .select('id, avaliacao_feita, presenca_confirmada')
                    .eq('event_id', event.id)
                    .eq('status', 'aprovado');
                if (participationsError) {
                    console.error('‚ùå Erro ao buscar participa√ß√µes:', participationsError);
                    return false;
                }
                if (!participations || participations.length === 0) {
                    console.log(`‚è≥ Evento ${event.id} sem participa√ß√µes aprovadas ainda`);
                    return false;
                }
                const presentParticipants = participations.filter(p => p.presenca_confirmada === true);
                if (presentParticipants.length === 0) {
                    console.log(`‚è≥ Evento ${event.id} ningu√©m compareceu`);
                    return false;
                }
                const allEvaluated = presentParticipants.every(p => p.avaliacao_feita === true);
                if (allEvaluated) {
                    console.log(`‚úÖ Evento ${event.id} auto-conclu√≠do - TODOS avaliaram`);
                    return true;
                }
                const pendingCount = presentParticipants.filter(p => !p.avaliacao_feita).length;
                console.log(`‚è≥ Evento ${event.id} aguardando ${pendingCount} avalia√ß√£o(√µes)`);
                return false;
            }
            catch (error) {
                retries--;
                if (retries === 0) {
                    console.error('‚ùå Erro ao verificar auto-complete ap√≥s 2 tentativas:', error);
                    return false;
                }
                else {
                    console.warn(`‚ö†Ô∏è Erro ao verificar auto-complete. Tentando novamente...`);
                }
            }
        }
        return false;
    }
    /**
     * üîÑ Atualiza o status de um evento
     */
    static async updateEventStatus(eventId, newStatus) {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('events')
                .update({
                status: newStatus,
                updated_at: new Date().toISOString(),
            })
                .eq('id', eventId);
            if (error)
                throw error;
            console.log(`‚úÖ Evento ${eventId} status atualizado para: ${newStatus}`);
        }
        catch (error) {
            console.error(`‚ùå Erro ao atualizar status do evento ${eventId}:`, error);
        }
    }
    /**
     * üìä Obt√©m estat√≠sticas do evento
     * (corrigido para usar event_id e j√° trazer o perfil do participante)
     */
    static async getEventStats(eventId) {
        try {
            const { data: event, error: eventError } = await supabaseClient_1.supabase
                .from('events')
                .select('*')
                .eq('id', eventId)
                .single();
            if (eventError)
                throw eventError;
            const { data: participations, error: partError } = await supabaseClient_1.supabase
                .from('event_participants')
                .select(`
          id,
          user_id,
          event_id,
          status,
          presenca_confirmada,
          com_acesso,
          avaliacao_feita,
          profiles:profiles!event_participants_user_id_fkey (
            id,
            username,
            avatar_url,
            full_name
          )
        `)
                // üëá aqui estava dando 406 no frontend quando vinham UUIDs
                .eq('event_id', eventId);
            if (partError)
                throw partError;
            return {
                success: true,
                data: {
                    event,
                    participants: participations || [],
                },
            };
        }
        catch (error) {
            console.error('Erro ao obter stats do evento:', error);
            return { success: false, error };
        }
    }
    // ============================================
    // üîÑ M√âTODOS DE AUTO-UPDATE
    // ============================================
    /**
     * üöÄ Inicia atualiza√ß√£o autom√°tica de eventos
     * @param intervalSeconds - Intervalo em segundos (padr√£o: 30)
     */
    static startAutoUpdate(intervalSeconds = 30) {
        if (this.updateInterval) {
            this.stopAutoUpdate();
        }
        console.log(`üîÑ Iniciando auto-update de eventos a cada ${intervalSeconds}s`);
        // Executar imediatamente
        this.updateAllEventStatuses();
        // Depois executar a cada X segundos
        this.updateInterval = setInterval(() => {
            this.updateAllEventStatuses();
        }, intervalSeconds * 1000);
        return this.updateInterval;
    }
    /**
     * üõë Para a atualiza√ß√£o autom√°tica
     */
    static stopAutoUpdate() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
            console.log('üõë Auto-update de eventos parado');
        }
    }
    /**
     * üîç Verifica se auto-update est√° rodando
     */
    static isAutoUpdateRunning() {
        return this.updateInterval !== null;
    }
}
Object.defineProperty(EventStatusService, "updateInterval", {
    enumerable: true,
    configurable: true,
    writable: true,
    value: null
});
exports.default = EventStatusService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcRXZlbnRTdGF0dXNTZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxxQ0FBcUM7QUFDckMsdURBQXVEOzs7QUFFdkQsMERBQWlEO0FBQ2pELDBGQUEwRDtBQUMxRCxnR0FBZ0U7QUFDaEUsb0ZBQW9EO0FBd0JwRCxNQUFNLGtCQUFrQjtJQUd0Qjs7T0FFRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsc0JBQXNCO1FBQ2pDLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0seUJBQVE7aUJBQzNDLElBQUksQ0FBQyxRQUFRLENBQUM7aUJBQ2QsTUFBTSxDQUFDLEdBQUcsQ0FBQztpQkFDWCxHQUFHLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQztpQkFDMUIsR0FBRyxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUU5QixJQUFJLEtBQUssRUFBRSxDQUFDO2dCQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsMkJBQTJCLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ2xELE9BQU87WUFDVCxDQUFDO1lBRUQsSUFBSSxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7Z0JBQzlDLE9BQU87WUFDVCxDQUFDO1lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsTUFBTSxDQUFDLE1BQU0sYUFBYSxDQUFDLENBQUM7WUFFMUQsS0FBSyxNQUFNLEtBQUssSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDM0IsSUFBSSxDQUFDO29CQUNILE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQWMsQ0FBQyxDQUFDO2dCQUNsRCxDQUFDO2dCQUFDLE9BQU8sVUFBVSxFQUFFLENBQUM7b0JBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMs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LEVBQUUsQ0FBQztRQUNoQyxDQUFDLEVBQUUsZUFBZSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRTNCLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsY0FBYztRQUNuQixJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUN4QixhQUFhLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ25DLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1lBQzNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUNsRCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLG1CQUFtQjtRQUN4QixPQUFPLElBQUksQ0FBQyxjQUFjLEtBQUssSUFBSSxDQUFDO0lBQ3RDLENBQUM7O0FBdGFjOzs7O1dBQXdELElBQUk7R0FBQztBQXlhOUUsa0JBQWUsa0JBQWtCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcRXZlbnRTdGF0dXNTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9zZXJ2aWNlcy9FdmVudFN0YXR1c1NlcnZpY2UudHNcclxuLy8g4pyFIFZFUlPDg08gQ09SUklHSURBIC0gR2VyYcOnw6NvIGRlIHNlbmhhIDEgbWludXRvIGFudGVzXHJcblxyXG5pbXBvcnQgeyBzdXBhYmFzZSB9IGZyb20gJy4uL2xpYi9zdXBhYmFzZUNsaWVudCc7XHJcbmltcG9ydCBFdmVudFNlY3VyaXR5U2VydmljZSBmcm9tICcuL0V2ZW50U2VjdXJpdHlTZXJ2aWNlJztcclxuaW1wb3J0IFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlIGZyb20gJy4vUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UnO1xyXG5pbXBvcnQgVHJ1c3RTY29yZVNlcnZpY2UgZnJvbSAnLi9UcnVzdFNjb3JlU2VydmljZSc7XHJcblxyXG5pbnRlcmZhY2UgRXZlbnQge1xyXG4gIGlkOiBudW1iZXI7XHJcbiAgc3RhdHVzOiBzdHJpbmc7XHJcbiAgc3RhcnRfdGltZTogc3RyaW5nO1xyXG4gIGVuZF90aW1lOiBzdHJpbmc7XHJcbiAgY3JlYXRvcl9pZDogc3RyaW5nO1xyXG4gIHRpdGxlOiBzdHJpbmc7XHJcbiAgZXZlbnRfZW50cnlfcGFzc3dvcmQ/OiBzdHJpbmc7XHJcbiAgZW50cnlfbG9ja2VkPzogYm9vbGVhbjtcclxuICBba2V5OiBzdHJpbmddOiBhbnk7XHJcbn1cclxuXHJcbmludGVyZmFjZSBQYXJ0aWNpcGF0aW9uIHtcclxuICBpZDogc3RyaW5nO1xyXG4gIHVzZXJfaWQ6IHN0cmluZztcclxuICBldmVudF9pZDogbnVtYmVyO1xyXG4gIHN0YXR1czogc3RyaW5nO1xyXG4gIHByZXNlbmNhX2NvbmZpcm1hZGE6IGJvb2xlYW47XHJcbiAgYXZhbGlhY2FvX2ZlaXRhOiBib29sZWFuO1xyXG4gIFtrZXk6IHN0cmluZ106IGFueTtcclxufVxyXG5cclxuY2xhc3MgRXZlbnRTdGF0dXNTZXJ2aWNlIHtcclxuICBwcml2YXRlIHN0YXRpYyB1cGRhdGVJbnRlcnZhbDogUmV0dXJuVHlwZTx0eXBlb2Ygc2V0SW50ZXJ2YWw+IHwgbnVsbCA9IG51bGw7XHJcblxyXG4gIC8qKlxyXG4gICAqIPCfjq8gQXR1YWxpemEgc3RhdHVzIGRlIFRPRE9TIG9zIGV2ZW50b3NcclxuICAgKi9cclxuICBzdGF0aWMgYXN5bmMgdXBkYXRlQWxsRXZlbnRTdGF0dXNlcygpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZGF0YTogZXZlbnRzLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRzJylcclxuICAgICAgICAuc2VsZWN0KCcqJylcclxuICAgICAgICAubmVxKCdzdGF0dXMnLCAnQ2FuY2VsYWRvJylcclxuICAgICAgICAubmVxKCdzdGF0dXMnLCAnQ29uY2x1w61kbycpO1xyXG5cclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gYnVzY2FyIGV2ZW50b3M6JywgZXJyb3IpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCFldmVudHMgfHwgZXZlbnRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCfinIUgTmVuaHVtIGV2ZW50byBwYXJhIGF0dWFsaXphcicpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc29sZS5sb2coYPCflIQgQXR1YWxpemFuZG8gJHtldmVudHMubGVuZ3RofSBldmVudG9zLi4uYCk7XHJcblxyXG4gICAgICBmb3IgKGNvbnN0IGV2ZW50IG9mIGV2ZW50cykge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBhd2FpdCB0aGlzLmNhbGN1bGF0ZUV2ZW50U3RhdHVzKGV2ZW50IGFzIEV2ZW50KTtcclxuICAgICAgICB9IGNhdGNoIChldmVudEVycm9yKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGDinYwgRXJybyBhbyBwcm9jZXNzYXIgZXZlbnRvICR7ZXZlbnQuaWR9OmAsIGV2ZW50RXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gYXR1YWxpemFyIHRvZG9zIG9zIGV2ZW50b3M6JywgZXJyb3IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog8J+noCBMw7NnaWNhIGRlIHN0YXR1cyBkZSBVTSBldmVudG9cclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBhc3luYyBjYWxjdWxhdGVFdmVudFN0YXR1cyhldmVudDogRXZlbnQpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICBjb25zdCBzdGFydFRpbWUgPSBuZXcgRGF0ZShldmVudC5zdGFydF90aW1lKTtcclxuICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZShldmVudC5lbmRfdGltZSk7XHJcbiAgICBjb25zdCBjdXJyZW50U3RhdHVzID0gZXZlbnQuc3RhdHVzO1xyXG5cclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbiAgICAvLyDwn46vIEZBU0UgMTogRXZlbnRvIGZ1dHVyb1xyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIGlmIChub3cgPCBzdGFydFRpbWUpIHtcclxuICAgICAgLy8gY2hlY2Egc2UgZmFsdGEgMSBtaW4g4oaSIGdlcmEgc2VuaGEg4oaSIGVudmlhIHB1c2hcclxuICAgICAgYXdhaXQgdGhpcy5kZXRlY3RBbmRIYW5kbGVQYXNzd29yZEdlbmVyYXRpb24oZXZlbnQsIG5vdywgc3RhcnRUaW1lKTtcclxuXHJcbiAgICAgIC8vIGNoZWNhIHNlIHByZWNpc2EgYmxvcXVlYXIgZW50cmFkYSBwcsOzeGltbyBkbyBmaW1cclxuICAgICAgYXdhaXQgdGhpcy5kZXRlY3RBbmRIYW5kbGVFbnRyeUxvY2tpbmcoZXZlbnQsIG5vdywgZW5kVGltZSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgLy8g8J+OryBGQVNFIDI6IEV2ZW50byBwcmVzdGVzIGEgYWNhYmFyXHJcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgYXdhaXQgdGhpcy5kZXRlY3RBbmRIYW5kbGVFbnRyeUxvY2tpbmcoZXZlbnQsIG5vdywgZW5kVGltZSk7XHJcblxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIPCfjq8gRkFTRSAzOiBFdmVudG8gZXN0w6EgYWNvbnRlY2VuZG9cclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbiAgICBpZiAobm93ID49IHN0YXJ0VGltZSAmJiBub3cgPCBlbmRUaW1lICYmIGN1cnJlbnRTdGF0dXMgIT09ICdFbSBBbmRhbWVudG8nKSB7XHJcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlRXZlbnRTdGF0dXMoZXZlbnQuaWQsICdFbSBBbmRhbWVudG8nKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgLy8g8J+OryBGQVNFIDQ6IEV2ZW50byB0ZXJtaW5vdVxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIGlmIChub3cgPj0gZW5kVGltZSAmJiBjdXJyZW50U3RhdHVzICE9PSAnRmluYWxpemFkbycpIHtcclxuICAgICAgY29uc29sZS5sb2coYOKEue+4jyBFdmVudG8gJHtldmVudC5pZH0gdGVybWlub3VgKTtcclxuICAgICAgYXdhaXQgdGhpcy51cGRhdGVFdmVudFN0YXR1cyhldmVudC5pZCwgJ0ZpbmFsaXphZG8nKTtcclxuXHJcbiAgICAgIC8vIPCfk4ogUGVuYWxpemFyIG7Do28tcHJlc2Vuw6dhc1xyXG4gICAgICBhd2FpdCBUcnVzdFNjb3JlU2VydmljZS5wZW5hbGl6ZU5vU2hvd3NGb3JFdmVudChldmVudC5pZCk7XHJcblxyXG4gICAgICAvLyDwn5SNIFZlcmlmaWNhciBhdXRvLWNvbmNsdXPDo29cclxuICAgICAgY29uc3Qgc2hvdWxkQ29tcGxldGUgPSBhd2FpdCB0aGlzLnNob3VsZEF1dG9Db21wbGV0ZUV2ZW50KGV2ZW50KTtcclxuICAgICAgaWYgKHNob3VsZENvbXBsZXRlKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVFdmVudFN0YXR1cyhldmVudC5pZCwgJ0NvbmNsdcOtZG8nKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog8J+OsiBEZXRlY3RhIFwiZmFsdGEgMSBtaW51dG9cIiDihpIgR2VyYSBzZW5oYSArIEVudmlhIHB1c2hcclxuICAgKiDinIUgQ09SUklHSURPOiBBZ29yYSBnZXJhIHF1YW5kbyBmYWx0YSBFWEFUQU1FTlRFIDEgbWludXRvIE9VIE1FTk9TIChzZSBhaW5kYSBuw6NvIGZvaSBnZXJhZGEpXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgYXN5bmMgZGV0ZWN0QW5kSGFuZGxlUGFzc3dvcmRHZW5lcmF0aW9uKFxyXG4gICAgZXZlbnQ6IEV2ZW50LFxyXG4gICAgbm93OiBEYXRlLFxyXG4gICAgc3RhcnRUaW1lOiBEYXRlXHJcbiAgKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBqw6EgdGVtIHNlbmhhPyBuw6NvIGZheiBuYWRhXHJcbiAgICAgIGlmIChldmVudC5ldmVudF9lbnRyeV9wYXNzd29yZCAmJiBldmVudC5ldmVudF9lbnRyeV9wYXNzd29yZC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBmYWx0YSBxdWFudG9zIG1pbnV0b3M/XHJcbiAgICAgIGNvbnN0IGRpZmZNcyA9IHN0YXJ0VGltZS5nZXRUaW1lKCkgLSBub3cuZ2V0VGltZSgpO1xyXG4gICAgICBjb25zdCBtaW51dGVzVW50aWxFdmVudCA9IE1hdGguZmxvb3IoZGlmZk1zIC8gKDEwMDAgKiA2MCkpO1xyXG5cclxuICAgICAgLy8gc8OzIHByb2Nlc3NhIHF1ZW0gZXN0w6EgYXTDqSA1IG1pbiBkbyBpbsOtY2lvIChwcmEgbsOjbyBmaWNhciBsb2dhbmRvIGRlbWFpcylcclxuICAgICAgaWYgKG1pbnV0ZXNVbnRpbEV2ZW50ID4gNSkgcmV0dXJuO1xyXG5cclxuICAgICAgLy8gMS4gRXZlbnRvIGFpbmRhIG7Do28gY29tZcOnb3VcclxuICAgICAgaWYgKG5vdyA+PSBzdGFydFRpbWUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIDIuIEVzdMOhIGRlbnRybyBkYSBqYW5lbGEgZGUgMSBtaW51dG9cclxuICAgICAgY29uc3Qgb25lTWludXRlQmVmb3JlU3RhcnQgPSBuZXcgRGF0ZShzdGFydFRpbWUuZ2V0VGltZSgpIC0gNjAgKiAxMDAwKTtcclxuXHJcbiAgICAgIC8vIDMuIFNlbmhhIGFpbmRhIG7Do28gZm9pIGdlcmFkYVxyXG4gICAgICBjb25zdCBzaG91bGRHZW5lcmF0ZVBhc3N3b3JkID0gbm93ID49IG9uZU1pbnV0ZUJlZm9yZVN0YXJ0ICYmIG5vdyA8IHN0YXJ0VGltZTtcclxuXHJcbiAgICAgIGlmICghc2hvdWxkR2VuZXJhdGVQYXNzd29yZCkge1xyXG4gICAgICAgIC8vIExvZyBhcGVuYXMgc2UgZXN0aXZlciBwcsOzeGltbyAobm9zIMO6bHRpbW9zIDUgbWludXRvcylcclxuICAgICAgICBpZiAobWludXRlc1VudGlsRXZlbnQgPD0gNSAmJiBtaW51dGVzVW50aWxFdmVudCA+IDApIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKFxyXG4gICAgICAgICAgICBg4o+zIEV2ZW50byAke2V2ZW50LmlkfTogZmFsdGFtICR7bWludXRlc1VudGlsRXZlbnR9IG1pbnV0b3MgKHNlbmhhIHNlcsOhIGdlcmFkYSBlbSAxIG1pbilgXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKGDwn46yIEdlcmFuZG8gc2VuaGEgcGFyYSBldmVudG8gJHtldmVudC5pZH0gKGZhbHRhbSAke21pbnV0ZXNVbnRpbEV2ZW50fSBtaW51dG9zKS4uLmApO1xyXG5cclxuICAgICAgLy8gMe+4j+KDoyBHZXJhciBlIHNhbHZhciBzZW5oYVxyXG4gICAgICBjb25zdCBwYXNzd29yZFJlc3VsdCA9IGF3YWl0IEV2ZW50U2VjdXJpdHlTZXJ2aWNlLmdlbmVyYXRlQW5kU2F2ZVBhc3N3b3JkKGV2ZW50LmlkKTtcclxuXHJcbiAgICAgIGlmICghcGFzc3dvcmRSZXN1bHQuc3VjY2Vzcykge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGdlcmFyIHNlbmhhOicsIHBhc3N3b3JkUmVzdWx0LmVycm9yKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHBhc3N3b3JkID0gcGFzc3dvcmRSZXN1bHQucGFzc3dvcmQhO1xyXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIFNlbmhhIGdlcmFkYTogJHtwYXNzd29yZH1gKTtcclxuXHJcbiAgICAgIC8vIDLvuI/ig6MgQnVzY2FyIGFuZml0cmnDo29cclxuICAgICAgY29uc3QgeyBkYXRhOiBob3N0UHJvZmlsZSwgZXJyb3I6IGhvc3RFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgncHJvZmlsZXMnKVxyXG4gICAgICAgIC5zZWxlY3QoJ3VzZXJuYW1lJylcclxuICAgICAgICAuZXEoJ2lkJywgZXZlbnQuY3JlYXRvcl9pZClcclxuICAgICAgICAuc2luZ2xlKCk7XHJcblxyXG4gICAgICBpZiAoaG9zdEVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gYnVzY2FyIGFuZml0cmnDo286JywgaG9zdEVycm9yKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gM++4j+KDoyBCdXNjYXIgcGFydGljaXBhbnRlcyBhcHJvdmFkb3NcclxuICAgICAgY29uc3QgeyBkYXRhOiBwYXJ0aWNpcGF0aW9ucywgZXJyb3I6IHBhcnRFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRfcGFydGljaXBhbnRzJylcclxuICAgICAgICAuc2VsZWN0KCd1c2VyX2lkJylcclxuICAgICAgICAuZXEoJ2V2ZW50X2lkJywgZXZlbnQuaWQpXHJcbiAgICAgICAgLmVxKCdzdGF0dXMnLCAnYXByb3ZhZG8nKTtcclxuXHJcbiAgICAgIGlmIChwYXJ0RXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBidXNjYXIgcGFydGljaXBhbnRlczonLCBwYXJ0RXJyb3IpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gNO+4j+KDoyBFbnZpYXIgcHVzaCBwYXJhIEFORklUUknDg08gKGNvbSBzZW5oYSlcclxuICAgICAgY29uc29sZS5sb2coYPCfk6ggRW52aWFuZG8gU0VOSEEgcGFyYSBhbmZpdHJpw6NvICR7ZXZlbnQuY3JlYXRvcl9pZH0uLi5gKTtcclxuICAgICAgY29uc3QgaG9zdFJlc3VsdCA9IGF3YWl0IFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnNlbmRQYXNzd29yZFRvSG9zdChcclxuICAgICAgICBldmVudC5jcmVhdG9yX2lkLFxyXG4gICAgICAgIGV2ZW50LmlkLFxyXG4gICAgICAgIHBhc3N3b3JkLFxyXG4gICAgICAgIGV2ZW50LnRpdGxlXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBpZiAoaG9zdFJlc3VsdC5zdWNjZXNzKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYOKchSBTZW5oYSBlbnZpYWRhIHBhcmEgYW5maXRyacOjb2ApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGVudmlhciBzZW5oYSBwYXJhIGFuZml0cmnDo286JywgaG9zdFJlc3VsdC5lcnJvcik7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIDXvuI/ig6MgRW52aWFyIHB1c2ggcGFyYSBQQVJUSUNJUEFOVEVTIChnZW7DqXJpY2EsIHNlbSBzZW5oYSlcclxuICAgICAgaWYgKHBhcnRpY2lwYXRpb25zICYmIHBhcnRpY2lwYXRpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBwYXJ0aWNpcGFudElkcyA9IHBhcnRpY2lwYXRpb25zLm1hcChwID0+IHAudXNlcl9pZCk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYPCfk6ggRW52aWFuZG8gbm90aWZpY2HDp8OjbyBkZSBJTsONQ0lPIHBhcmEgJHtwYXJ0aWNpcGFudElkcy5sZW5ndGh9IHBhcnRpY2lwYW50ZXMuLi5gKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBwYXJ0aWNpcGFudHNSZXN1bHQgPSBhd2FpdCBQdXNoTm90aWZpY2F0aW9uU2VydmljZS5zZW5kRXZlbnRTdGFydE5vdGlmaWNhdGlvblRvUGFydGljaXBhbnRzKFxyXG4gICAgICAgICAgcGFydGljaXBhbnRJZHMsXHJcbiAgICAgICAgICBldmVudC5pZCxcclxuICAgICAgICAgIGV2ZW50LnRpdGxlXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKHBhcnRpY2lwYW50c1Jlc3VsdC5zdWNjZXNzKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhg4pyFIE5vdGlmaWNhw6fDtWVzIGVudmlhZGFzIHBhcmEgcGFydGljaXBhbnRlc2ApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBlbnZpYXIgcGFyYSBwYXJ0aWNpcGFudGVzOicsIHBhcnRpY2lwYW50c1Jlc3VsdC5lcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIFByb2Nlc3NvIGRlIGdlcmHDp8OjbyBkZSBzZW5oYSBjb21wbGV0byBwYXJhIGV2ZW50byAke2V2ZW50LmlkfWApO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gcHJvY2Vzc2FyIGdlcmHDp8OjbyBkZSBzZW5oYTonLCBlcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDwn5SSIEJsb3F1ZWlhIGVudHJhZGEgMSBtaW51dG8gYW50ZXMgZG8gZmltXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgYXN5bmMgZGV0ZWN0QW5kSGFuZGxlRW50cnlMb2NraW5nKFxyXG4gICAgZXZlbnQ6IEV2ZW50LFxyXG4gICAgbm93OiBEYXRlLFxyXG4gICAgZW5kVGltZTogRGF0ZVxyXG4gICk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gc2UgasOhIGVzdMOhIGJsb3F1ZWFkbywgbsOjbyBmYXogbmFkYVxyXG4gICAgICBpZiAoZXZlbnQuZW50cnlfbG9ja2VkKSByZXR1cm47XHJcblxyXG4gICAgICBjb25zdCBvbmVNaW51dGVCZWZvcmVFbmQgPSBuZXcgRGF0ZShlbmRUaW1lLmdldFRpbWUoKSAtIDYwICogMTAwMCk7XHJcbiAgICAgIGNvbnN0IHRpbWVVbnRpbEVuZCA9IGVuZFRpbWUuZ2V0VGltZSgpIC0gbm93LmdldFRpbWUoKTtcclxuICAgICAgY29uc3QgbWludXRlc1VudGlsRW5kID0gTWF0aC5mbG9vcih0aW1lVW50aWxFbmQgLyAxMDAwIC8gNjApO1xyXG5cclxuICAgICAgLy8g4pyFIEJsb3F1ZWFyIHF1YW5kbyBmYWx0YSAxIG1pbnV0byBvdSBtZW5vcyBwYXJhIHRlcm1pbmFyXHJcbiAgICAgIGlmIChub3cgPj0gb25lTWludXRlQmVmb3JlRW5kICYmIG5vdyA8IGVuZFRpbWUpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhg8J+UkiBCbG9xdWVhbmRvIGVudHJhZGEgZG8gZXZlbnRvICR7ZXZlbnQuaWR9IChmYWx0YW0gJHttaW51dGVzVW50aWxFbmR9IG1pbiBwYXJhIHRlcm1pbmFyKS4uLmApO1xyXG5cclxuICAgICAgICBjb25zdCBsb2NrUmVzdWx0ID0gYXdhaXQgRXZlbnRTZWN1cml0eVNlcnZpY2UubG9ja0V2ZW50RW50cnkoZXZlbnQuaWQpO1xyXG4gICAgICAgIGlmIChsb2NrUmVzdWx0LnN1Y2Nlc3MpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKGDinIUgRW50cmFkYSBibG9xdWVhZGEgcGFyYSBldmVudG8gJHtldmVudC5pZH1gKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gYmxvcXVlYXIgZW50cmFkYTonLCBsb2NrUmVzdWx0LmVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIHByb2Nlc3NhciBibG9xdWVpbyBkZSBlbnRyYWRhOicsIGVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCfkqEgVmVyaWZpY2EgYXV0by1jb25jbHVzw6NvICg3IGRpYXMgT1UgdG9kb3MgYXZhbGlhcmFtKVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBzaG91bGRBdXRvQ29tcGxldGVFdmVudChldmVudDogRXZlbnQpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIGxldCByZXRyaWVzID0gMjtcclxuXHJcbiAgICB3aGlsZSAocmV0cmllcyA+IDApIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoZXZlbnQuZW5kX3RpbWUpO1xyXG4gICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgY29uc3QgZGF5c1NpbmNlRW5kID0gKG5vdy5nZXRUaW1lKCkgLSBlbmRUaW1lLmdldFRpbWUoKSkgLyAoMTAwMCAqIDYwICogNjAgKiAyNCk7XHJcblxyXG4gICAgICAgIC8vIPCfkqEgQ29uZGnDp8OjbyAxOiBQYXNzb3UgNyBkaWFzPyDihpIgQ29uY2x1w61kb1xyXG4gICAgICAgIGlmIChkYXlzU2luY2VFbmQgPj0gNykge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYOKchSBFdmVudG8gJHtldmVudC5pZH0gYXV0by1jb25jbHXDrWRvIGFww7NzIDcgZGlhc2ApO1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDwn5KhIENvbmRpw6fDo28gMjogVG9kb3MgcXVlIGNvbXBhcmVjZXJhbSBhdmFsaWFyYW0/XHJcbiAgICAgICAgY29uc3QgeyBkYXRhOiBwYXJ0aWNpcGF0aW9ucywgZXJyb3I6IHBhcnRpY2lwYXRpb25zRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgICAuZnJvbSgnZXZlbnRfcGFydGljaXBhbnRzJylcclxuICAgICAgICAgIC5zZWxlY3QoJ2lkLCBhdmFsaWFjYW9fZmVpdGEsIHByZXNlbmNhX2NvbmZpcm1hZGEnKVxyXG4gICAgICAgICAgLmVxKCdldmVudF9pZCcsIGV2ZW50LmlkKVxyXG4gICAgICAgICAgLmVxKCdzdGF0dXMnLCAnYXByb3ZhZG8nKTtcclxuXHJcbiAgICAgICAgaWYgKHBhcnRpY2lwYXRpb25zRXJyb3IpIHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGJ1c2NhciBwYXJ0aWNpcGHDp8O1ZXM6JywgcGFydGljaXBhdGlvbnNFcnJvcik7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIXBhcnRpY2lwYXRpb25zIHx8IHBhcnRpY2lwYXRpb25zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYOKPsyBFdmVudG8gJHtldmVudC5pZH0gc2VtIHBhcnRpY2lwYcOnw7VlcyBhcHJvdmFkYXMgYWluZGFgKTtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHByZXNlbnRQYXJ0aWNpcGFudHMgPSAocGFydGljaXBhdGlvbnMgYXMgdW5rbm93biBhcyBQYXJ0aWNpcGF0aW9uW10pLmZpbHRlcihcclxuICAgICAgICAgIHAgPT4gcC5wcmVzZW5jYV9jb25maXJtYWRhID09PSB0cnVlXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKHByZXNlbnRQYXJ0aWNpcGFudHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhg4o+zIEV2ZW50byAke2V2ZW50LmlkfSBuaW5ndcOpbSBjb21wYXJlY2V1YCk7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBhbGxFdmFsdWF0ZWQgPSBwcmVzZW50UGFydGljaXBhbnRzLmV2ZXJ5KHAgPT4gcC5hdmFsaWFjYW9fZmVpdGEgPT09IHRydWUpO1xyXG5cclxuICAgICAgICBpZiAoYWxsRXZhbHVhdGVkKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhg4pyFIEV2ZW50byAke2V2ZW50LmlkfSBhdXRvLWNvbmNsdcOtZG8gLSBUT0RPUyBhdmFsaWFyYW1gKTtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcGVuZGluZ0NvdW50ID0gcHJlc2VudFBhcnRpY2lwYW50cy5maWx0ZXIocCA9PiAhcC5hdmFsaWFjYW9fZmVpdGEpLmxlbmd0aDtcclxuICAgICAgICBjb25zb2xlLmxvZyhg4o+zIEV2ZW50byAke2V2ZW50LmlkfSBhZ3VhcmRhbmRvICR7cGVuZGluZ0NvdW50fSBhdmFsaWHDp8OjbyjDtWVzKWApO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICByZXRyaWVzLS07XHJcbiAgICAgICAgaWYgKHJldHJpZXMgPT09IDApIHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIHZlcmlmaWNhciBhdXRvLWNvbXBsZXRlIGFww7NzIDIgdGVudGF0aXZhczonLCBlcnJvcik7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnNvbGUud2Fybihg4pqg77iPIEVycm8gYW8gdmVyaWZpY2FyIGF1dG8tY29tcGxldGUuIFRlbnRhbmRvIG5vdmFtZW50ZS4uLmApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCflIQgQXR1YWxpemEgbyBzdGF0dXMgZGUgdW0gZXZlbnRvXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIHVwZGF0ZUV2ZW50U3RhdHVzKGV2ZW50SWQ6IG51bWJlciwgbmV3U3RhdHVzOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgLnVwZGF0ZSh7XHJcbiAgICAgICAgICBzdGF0dXM6IG5ld1N0YXR1cyxcclxuICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5lcSgnaWQnLCBldmVudElkKTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIEV2ZW50byAke2V2ZW50SWR9IHN0YXR1cyBhdHVhbGl6YWRvIHBhcmE6ICR7bmV3U3RhdHVzfWApO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihg4p2MIEVycm8gYW8gYXR1YWxpemFyIHN0YXR1cyBkbyBldmVudG8gJHtldmVudElkfTpgLCBlcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDwn5OKIE9idMOpbSBlc3RhdMOtc3RpY2FzIGRvIGV2ZW50b1xyXG4gICAqIChjb3JyaWdpZG8gcGFyYSB1c2FyIGV2ZW50X2lkIGUgasOhIHRyYXplciBvIHBlcmZpbCBkbyBwYXJ0aWNpcGFudGUpXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIGdldEV2ZW50U3RhdHMoZXZlbnRJZDogbnVtYmVyKTogUHJvbWlzZTx7XHJcbiAgICBzdWNjZXNzOiBib29sZWFuO1xyXG4gICAgZGF0YT86IGFueTtcclxuICAgIGVycm9yPzogYW55O1xyXG4gIH0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZGF0YTogZXZlbnQsIGVycm9yOiBldmVudEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCdldmVudHMnKVxyXG4gICAgICAgIC5zZWxlY3QoJyonKVxyXG4gICAgICAgIC5lcSgnaWQnLCBldmVudElkKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICAgIGlmIChldmVudEVycm9yKSB0aHJvdyBldmVudEVycm9yO1xyXG5cclxuICAgICAgY29uc3QgeyBkYXRhOiBwYXJ0aWNpcGF0aW9ucywgZXJyb3I6IHBhcnRFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRfcGFydGljaXBhbnRzJylcclxuICAgICAgICAuc2VsZWN0KGBcclxuICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgdXNlcl9pZCxcclxuICAgICAgICAgIGV2ZW50X2lkLFxyXG4gICAgICAgICAgc3RhdHVzLFxyXG4gICAgICAgICAgcHJlc2VuY2FfY29uZmlybWFkYSxcclxuICAgICAgICAgIGNvbV9hY2Vzc28sXHJcbiAgICAgICAgICBhdmFsaWFjYW9fZmVpdGEsXHJcbiAgICAgICAgICBwcm9maWxlczpwcm9maWxlcyFldmVudF9wYXJ0aWNpcGFudHNfdXNlcl9pZF9ma2V5IChcclxuICAgICAgICAgICAgaWQsXHJcbiAgICAgICAgICAgIHVzZXJuYW1lLFxyXG4gICAgICAgICAgICBhdmF0YXJfdXJsLFxyXG4gICAgICAgICAgICBmdWxsX25hbWVcclxuICAgICAgICAgIClcclxuICAgICAgICBgKVxyXG4gICAgICAgIC8vIPCfkYcgYXF1aSBlc3RhdmEgZGFuZG8gNDA2IG5vIGZyb250ZW5kIHF1YW5kbyB2aW5oYW0gVVVJRHNcclxuICAgICAgICAuZXEoJ2V2ZW50X2lkJywgZXZlbnRJZCk7XHJcblxyXG4gICAgICBpZiAocGFydEVycm9yKSB0aHJvdyBwYXJ0RXJyb3I7XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgZXZlbnQsXHJcbiAgICAgICAgICBwYXJ0aWNpcGFudHM6IHBhcnRpY2lwYXRpb25zIHx8IFtdLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvIGFvIG9idGVyIHN0YXRzIGRvIGV2ZW50bzonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvciB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAvLyDwn5SEIE3DiVRPRE9TIERFIEFVVE8tVVBEQVRFXHJcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuXHJcbiAgLyoqXHJcbiAgICog8J+agCBJbmljaWEgYXR1YWxpemHDp8OjbyBhdXRvbcOhdGljYSBkZSBldmVudG9zXHJcbiAgICogQHBhcmFtIGludGVydmFsU2Vjb25kcyAtIEludGVydmFsbyBlbSBzZWd1bmRvcyAocGFkcsOjbzogMzApXHJcbiAgICovXHJcbiAgc3RhdGljIHN0YXJ0QXV0b1VwZGF0ZShpbnRlcnZhbFNlY29uZHM6IG51bWJlciA9IDMwKTogUmV0dXJuVHlwZTx0eXBlb2Ygc2V0SW50ZXJ2YWw+IHtcclxuICAgIGlmICh0aGlzLnVwZGF0ZUludGVydmFsKSB7XHJcbiAgICAgIHRoaXMuc3RvcEF1dG9VcGRhdGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLmxvZyhg8J+UhCBJbmljaWFuZG8gYXV0by11cGRhdGUgZGUgZXZlbnRvcyBhIGNhZGEgJHtpbnRlcnZhbFNlY29uZHN9c2ApO1xyXG5cclxuICAgIC8vIEV4ZWN1dGFyIGltZWRpYXRhbWVudGVcclxuICAgIHRoaXMudXBkYXRlQWxsRXZlbnRTdGF0dXNlcygpO1xyXG5cclxuICAgIC8vIERlcG9pcyBleGVjdXRhciBhIGNhZGEgWCBzZWd1bmRvc1xyXG4gICAgdGhpcy51cGRhdGVJbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgdGhpcy51cGRhdGVBbGxFdmVudFN0YXR1c2VzKCk7XHJcbiAgICB9LCBpbnRlcnZhbFNlY29uZHMgKiAxMDAwKTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy51cGRhdGVJbnRlcnZhbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCfm5EgUGFyYSBhIGF0dWFsaXphw6fDo28gYXV0b23DoXRpY2FcclxuICAgKi9cclxuICBzdGF0aWMgc3RvcEF1dG9VcGRhdGUoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy51cGRhdGVJbnRlcnZhbCkge1xyXG4gICAgICBjbGVhckludGVydmFsKHRoaXMudXBkYXRlSW50ZXJ2YWwpO1xyXG4gICAgICB0aGlzLnVwZGF0ZUludGVydmFsID0gbnVsbDtcclxuICAgICAgY29uc29sZS5sb2coJ/Cfm5EgQXV0by11cGRhdGUgZGUgZXZlbnRvcyBwYXJhZG8nKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCflI0gVmVyaWZpY2Egc2UgYXV0by11cGRhdGUgZXN0w6Egcm9kYW5kb1xyXG4gICAqL1xyXG4gIHN0YXRpYyBpc0F1dG9VcGRhdGVSdW5uaW5nKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMudXBkYXRlSW50ZXJ2YWwgIT09IG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBFdmVudFN0YXR1c1NlcnZpY2U7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==