7f403153421e9eb6d79e99f3469e34f4
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const supabaseClient_1 = require("../lib/supabaseClient");
const NotificationService_1 = tslib_1.__importDefault(require("./NotificationService"));
/**
 * Servi√ßo para gerenciar o ciclo de vida e status dos eventos
 * Baseado no White Paper V2.9
 */
class PartnerEventService {
    /**
     * Verifica e atualiza status de todos os eventos ativos
     * Deve ser chamado periodicamente (a cada minuto)
     */
    static async updateAllEventStatuses() {
        try {
            const now = new Date();
            // Busca eventos que n√£o est√£o Conclu√≠dos ou Cancelados
            const { data: events, error } = await supabaseClient_1.supabase
                .from('events')
                .select('*')
                .not('status', 'in', '(Concluido,Cancelado)');
            if (error)
                throw error;
            const updates = [];
            for (const event of events) {
                const newStatus = this.calculateEventStatus(event, now);
                if (newStatus !== event.status) {
                    updates.push({
                        id: event.id,
                        status: newStatus,
                        updated_at: now.toISOString()
                    });
                }
            }
            // Atualiza em batch
            if (updates.length > 0) {
                for (const update of updates) {
                    await supabaseClient_1.supabase
                        .from('events')
                        .update({ status: update.status, updated_at: update.updated_at })
                        .eq('id', update.id);
                }
                console.log(`‚úÖ ${updates.length} eventos atualizados`);
            }
            return { success: true, updated: updates.length };
        }
        catch (error) {
            console.error('‚ùå Erro ao atualizar status de eventos:', error);
            return { success: false, error };
        }
    }
    /**
     * Calcula o status correto de um evento baseado nas regras de neg√≥cio
     */
    static calculateEventStatus(event, now = new Date()) {
        const startTime = new Date(event.start_time);
        const endTime = new Date(event.end_time);
        // Cancelado permanece cancelado
        if (event.status === 'Cancelado') {
            return 'Cancelado';
        }
        // Conclu√≠do permanece conclu√≠do
        if (event.status === 'Conclu√≠do') {
            return 'Conclu√≠do';
        }
        // Evento j√° terminou ‚Üí Finalizado (aguardando avalia√ß√µes)
        if (now >= endTime) {
            return 'Finalizado';
        }
        // Evento est√° acontecendo ‚Üí Em Andamento
        if (now >= startTime && now < endTime) {
            return 'Em Andamento';
        }
        // Evento futuro - verifica regras
        if (now < startTime) {
            // ‚úÖ REGRA CR√çTICA: Confirma√ß√£o manual √© permanente!
            // Se o anfitri√£o confirmou manualmente, respeitar isso
            if (event.status === 'Confirmado') {
                return 'Confirmado';
            }
            // Se vagas preenchidas automaticamente ‚Üí Confirmado
            if (event.vagas <= 0) {
                return 'Confirmado';
            }
            // Se ainda tem vagas e est√° no prazo ‚Üí Aberto
            // Candidaturas aceitas at√© 5 minutos antes do in√≠cio
            const fiveMinutesBefore = new Date(startTime.getTime() - 5 * 60 * 1000);
            if (now < fiveMinutesBefore) {
                return 'Aberto';
            }
            // Menos de 5 minutos para come√ßar ‚Üí Confirmado automaticamente
            return 'Confirmado';
        }
        return event.status; // Mant√©m status atual se nada mudou
    }
    /**
     * Confirma manualmente um evento (anfitri√£o fecha inscri√ß√µes)
     */
    static async confirmEvent(eventId) {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('events')
                .update({
                status: 'Confirmado',
                updated_at: new Date().toISOString()
            })
                .eq('id', eventId);
            if (error)
                throw error;
            console.log(`‚úÖ Evento ${eventId} confirmado manualmente`);
            return { success: true };
        }
        catch (error) {
            console.error('‚ùå Erro ao confirmar evento:', error);
            return { success: false, error };
        }
    }
    /**
     * Cancela um evento
     */
    static async cancelEvent(eventId, reason = '') {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('events')
                .update({
                status: 'Cancelado',
                ...(reason && { cancelamento_motivo: reason }), // S√≥ inclui se reason for fornecido
                updated_at: new Date().toISOString()
            })
                .eq('id', eventId);
            if (error)
                throw error;
            // TODO: Notificar participantes
            // TODO: Aplicar pol√≠ticas de cancelamento
            return { success: true };
        }
        catch (error) {
            console.error('‚ùå Erro ao cancelar evento:', error);
            return { success: false, error };
        }
    }
    /**
     * Marca evento como conclu√≠do ap√≥s todas avalia√ß√µes
     */
    static async completeEvent(eventId) {
        try {
            // Verifica se todas avalia√ß√µes foram feitas
            const { data: participations, error: participationsError } = await supabaseClient_1.supabase
                .from('event_participants')
                .select('id, avaliacao_feita')
                .eq('event_id', eventId)
                .eq('presenca_confirmada', true);
            if (participationsError)
                throw participationsError;
            const allEvaluated = participations.every(p => p.avaliacao_feita === true);
            if (!allEvaluated) {
                return {
                    success: false,
                    error: 'Nem todos os participantes avaliaram o evento'
                };
            }
            const { error } = await supabaseClient_1.supabase
                .from('events')
                .update({
                status: 'Conclu√≠do',
                updated_at: new Date().toISOString()
            })
                .eq('id', eventId);
            if (error)
                throw error;
            return { success: true };
        }
        catch (error) {
            console.error('‚ùå Erro ao concluir evento:', error);
            return { success: false, error };
        }
    }
    /**
     * Obt√©m estat√≠sticas de um evento
     */
    static async getEventStats(eventId) {
        try {
            const { data: event, error: eventError } = await supabaseClient_1.supabase
                .from('events')
                .select('*, creator:profiles!creator_id(*)')
                .eq('id', eventId)
                .single();
            if (eventError)
                throw eventError;
            const { data: participations, error: participationsError } = await supabaseClient_1.supabase
                .from('event_participants')
                .select('*')
                .eq('event_id', eventId);
            if (participationsError)
                throw participationsError;
            const participationsList = participations;
            return {
                success: true,
                data: {
                    event: event,
                    totalCandidaturas: participationsList.length,
                    aprovados: participationsList.filter(p => p.status === 'aprovado').length,
                    presentes: participationsList.filter(p => p.presenca_confirmada === true).length,
                    avaliacoes: participationsList.filter(p => p.avaliacao_feita === true).length,
                }
            };
        }
        catch (error) {
            console.error('‚ùå Erro ao buscar estat√≠sticas:', error);
            return { success: false, error };
        }
    }
    /**
     * Inicia monitoramento autom√°tico de status
     * Atualiza a cada 1 minuto
     */
    static startAutoUpdate() {
        // Executa imediatamente
        this.updateAllEventStatuses();
        // Depois executa a cada 1 minuto
        const intervalId = setInterval(() => {
            this.updateAllEventStatuses();
        }, 60000); // 60 segundos
        return intervalId;
    }
    /**
     * Para o monitoramento autom√°tico
     */
    static stopAutoUpdate(intervalId) {
        if (intervalId) {
            clearInterval(intervalId);
        }
    }
    static async approveParticipation(participationId, eventId) {
        try {
            console.log('üîî [approveParticipation] Iniciando aprova√ß√£o:', { participationId, eventId });
            // 1. Buscar dados do evento
            const { data: event, error: eventError } = await supabaseClient_1.supabase
                .from('events')
                .select('vagas, title')
                .eq('id', eventId)
                .single();
            if (eventError) {
                console.error('‚ùå Erro ao buscar evento:', eventError);
                throw eventError;
            }
            if (event.vagas <= 0) {
                console.warn('‚ö†Ô∏è Sem vagas dispon√≠veis');
                return { success: false, error: 'Sem vagas dispon√≠veis' };
            }
            // 2. Buscar dados do participante
            const { data: participation, error: partError } = await supabaseClient_1.supabase
                .from('event_participants')
                .select('user_id')
                .eq('id', participationId)
                .single();
            if (partError) {
                console.error('‚ùå Erro ao buscar participa√ß√£o:', partError);
                throw partError;
            }
            console.log('üìã Dados obtidos:', {
                userId: participation.user_id,
                eventTitle: event.title
            });
            // 3. Atualizar status da participa√ß√£o
            const { error: updateError } = await supabaseClient_1.supabase
                .from('event_participants')
                .update({
                status: 'aprovado',
                updated_at: new Date().toISOString()
            })
                .eq('id', participationId);
            if (updateError) {
                console.error('‚ùå Erro ao atualizar participa√ß√£o:', updateError);
                throw updateError;
            }
            console.log('‚úÖ Status atualizado para aprovado');
            // 4. Decrementar vagas
            // Note: Using UserEventService's decrement, but since it's static, perhaps duplicate or import.
            // For now, duplicate the code to avoid circular imports or complex deps.
            const { error: decError } = await supabaseClient_1.supabase.rpc('decrement_event_vacancy', {
                event_id: eventId
            });
            if (decError) {
                const { data: eventData } = await supabaseClient_1.supabase
                    .from('events')
                    .select('vagas')
                    .eq('id', eventId)
                    .single();
                if (eventData && eventData.vagas > 0) {
                    await supabaseClient_1.supabase
                        .from('events')
                        .update({ vagas: eventData.vagas - 1 })
                        .eq('id', eventId);
                }
            }
            console.log('‚úÖ Vaga decrementada');
            // 5. üîî NOTIFICAR O PARTICIPANTE
            console.log('üîî Enviando notifica√ß√£o ao participante...');
            const notifResult = await NotificationService_1.default.notifyParticipationApproved(participation.user_id, parseInt(eventId, 10), event.title);
            if (notifResult.success) {
                console.log('‚úÖ Notifica√ß√£o enviada com sucesso');
            }
            else {
                console.error('‚ö†Ô∏è Erro ao enviar notifica√ß√£o (aprova√ß√£o conclu√≠da):', notifResult.error);
            }
            return {
                success: true,
                message: 'Participa√ß√£o aprovada com sucesso!'
            };
        }
        catch (error) {
            console.error('‚ùå Erro ao aprovar participa√ß√£o:', error);
            return { success: false, error: error.message };
        }
    }
    static async rejectParticipation(participationId, reason) {
        try {
            const { data: participation } = await supabaseClient_1.supabase
                .from('event_participants')
                .select('user_id, event_id, events!inner(title)')
                .eq('id', participationId)
                .single();
            const { error: updateError } = await supabaseClient_1.supabase
                .from('event_participants')
                .update({
                status: 'rejeitado',
                motivo_rejeicao: reason,
                updated_at: new Date().toISOString()
            })
                .eq('id', participationId);
            if (updateError)
                throw updateError;
            // Notificar o participante sobre rejei√ß√£o
            const part = participation;
            const notifResult = await NotificationService_1.default.notifyParticipationRejected(part.user_id, part.event_id, // Corrigido: mantido como string
            part.events.title, reason);
            if (!notifResult.success) {
                console.error('‚ö†Ô∏è Erro ao enviar notifica√ß√£o de rejei√ß√£o:', notifResult.error);
            }
            return { success: true, message: 'Participa√ß√£o rejeitada' };
        }
        catch (error) {
            console.error('‚ùå Erro ao rejeitar participa√ß√£o:', error);
            return { success: false, error: error.message };
        }
    }
    static async getEventParticipations(eventId) {
        try {
            const { data: participations, error } = await supabaseClient_1.supabase
                .from('event_participants')
                .select('*, user:profiles!event_participants_user_id_fkey(*)')
                .eq('event_id', eventId)
                .order('created_at', { ascending: false });
            if (error)
                throw error;
            return { success: true, data: participations };
        }
        catch (error) {
            console.error('‚ùå Erro ao buscar participa√ß√µes:', error);
            return { success: false, error: error.message };
        }
    }
}
exports.default = PartnerEventService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcUGFydG5lckV2ZW50U2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBaUQ7QUFDakQsd0ZBQXdEO0FBcUR4RDs7O0dBR0c7QUFDSCxNQUFNLG1CQUFtQjtJQUV2Qjs7O09BR0c7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLHNCQUFzQjtRQUNqQyxJQUFJLENBQUM7WUFDSCxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1lBRXZCLHVEQUF1RDtZQUN2RCxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLHlCQUFRO2lCQUMzQyxJQUFJLENBQUMsUUFBUSxDQUFDO2lCQUNkLE1BQU0sQ0FBQyxHQUFHLENBQUM7aUJBQ1gsR0FBRyxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztZQUVoRCxJQUFJLEtBQUs7Z0JBQUUsTUFBTSxLQUFLLENBQUM7WUFFdkIsTUFBTSxPQUFPLEdBQW1FLEVBQUUsQ0FBQztZQUVuRixLQUFLLE1BQU0sS0FBSyxJQUFLLE1BQTZCLEVBQUUsQ0FBQztnQkFDbkQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFFeEQsSUFBSSxTQUFTLEtBQUssS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUMvQixPQUFPLENBQUMsSUFBSSxDQUFDO3dCQUNYLEVBQUUsRUFBRSxLQUFLLENBQUMsRUFBRTt3QkFDWixNQUFNLEVBQUUsU0FBUzt3QkFDakIsVUFBVSxFQUFFLEdBQUcsQ0FBQyxXQUFXLEVBQUU7cUJBQzlCLENBQUMsQ0FBQztnQkFDTCxDQUFDO1lBQ0gsQ0FBQztZQUVELG9CQUFvQjtZQUNwQixJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZCLEtBQUssTUFBTSxNQUFNLElBQUksT0FB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SUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSx5QkFBUTtpQkFDbkQsSUFBSSxDQUFDLG9CQUFvQixDQUFDO2lCQUMxQixNQUFNLENBQUMscURBQXFELENBQUM7aUJBQzdELEVBQUUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDO2lCQUN2QixLQUFLLENBQUMsWUFBWSxFQUFFLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFFN0MsSUFBSSxLQUFLO2dCQUFFLE1BQU0sS0FBSyxDQUFDO1lBRXZCLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsQ0FBQztRQUVqRCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3hELE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbEQsQ0FBQztJQUNILENBQUM7Q0FDRjtBQUVELGtCQUFlLG1CQUFtQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxERVZNaXhcXEFwcC5NZXNhcHJhMi5jb21cXHNyY1xcc2VydmljZXNcXFBhcnRuZXJFdmVudFNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tICcuLi9saWIvc3VwYWJhc2VDbGllbnQnO1xyXG5pbXBvcnQgTm90aWZpY2F0aW9uU2VydmljZSBmcm9tICcuL05vdGlmaWNhdGlvblNlcnZpY2UnO1xyXG5cclxudHlwZSBFdmVudFN0YXR1cyA9ICdBYmVydG8nIHwgJ0NvbmZpcm1hZG8nIHwgJ0VtIEFuZGFtZW50bycgfCAnRmluYWxpemFkbycgfCAnQ29uY2x1w61kbycgfCAnQ2FuY2VsYWRvJztcclxuXHJcbmludGVyZmFjZSBFdmVudCB7XHJcbiAgaWQ6IHN0cmluZztcclxuICBzdGF0dXM6IEV2ZW50U3RhdHVzO1xyXG4gIHN0YXJ0X3RpbWU6IHN0cmluZztcclxuICBlbmRfdGltZTogc3RyaW5nO1xyXG4gIHZhZ2FzOiBudW1iZXI7XHJcbiAgY2FuY2VsYW1lbnRvX21vdGl2bz86IHN0cmluZztcclxuICB1cGRhdGVkX2F0Pzogc3RyaW5nO1xyXG4gIGNyZWF0b3JfaWQ/OiBzdHJpbmc7XHJcbiAgW2tleTogc3RyaW5nXTogYW55O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgUGFydGljaXBhdGlvbiB7XHJcbiAgaWQ6IHN0cmluZztcclxuICBldmVudF9pZDogc3RyaW5nO1xyXG4gIHN0YXR1czogc3RyaW5nO1xyXG4gIHByZXNlbmNhX2NvbmZpcm1hZGE6IGJvb2xlYW47XHJcbiAgYXZhbGlhY2FvX2ZlaXRhOiBib29sZWFuO1xyXG4gIFtrZXk6IHN0cmluZ106IGFueTtcclxufVxyXG5cclxuaW50ZXJmYWNlIFVwZGF0ZVJlc3VsdCB7XHJcbiAgc3VjY2VzczogYm9vbGVhbjtcclxuICB1cGRhdGVkPzogbnVtYmVyO1xyXG4gIGVycm9yPzogYW55O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgRXZlbnRTdGF0cyB7XHJcbiAgc3VjY2VzczogYm9vbGVhbjtcclxuICBkYXRhPzoge1xyXG4gICAgZXZlbnQ6IEV2ZW50O1xyXG4gICAgdG90YWxDYW5kaWRhdHVyYXM6IG51bWJlcjtcclxuICAgIGFwcm92YWRvczogbnVtYmVyO1xyXG4gICAgcHJlc2VudGVzOiBudW1iZXI7XHJcbiAgICBhdmFsaWFjb2VzOiBudW1iZXI7XHJcbiAgfTtcclxuICBlcnJvcj86IGFueTtcclxufVxyXG5cclxuaW50ZXJmYWNlIFNlcnZpY2VSZXN1bHQge1xyXG4gIHN1Y2Nlc3M6IGJvb2xlYW47XHJcbiAgZXJyb3I/OiBzdHJpbmcgfCBhbnk7XHJcbiAgbWVzc2FnZT86IHN0cmluZztcclxuICBwYXJ0aWNpcGF0aW9uPzogUGFydGljaXBhdGlvbjtcclxuICBkYXRhPzogYW55O1xyXG4gIGlzTGF0ZUNhbmNlbGxhdGlvbj86IGJvb2xlYW47XHJcbiAgaXNBdXRvQXBwcm92ZWQ/OiBib29sZWFuO1xyXG59XHJcblxyXG4vKipcclxuICogU2VydmnDp28gcGFyYSBnZXJlbmNpYXIgbyBjaWNsbyBkZSB2aWRhIGUgc3RhdHVzIGRvcyBldmVudG9zXHJcbiAqIEJhc2VhZG8gbm8gV2hpdGUgUGFwZXIgVjIuOVxyXG4gKi9cclxuY2xhc3MgUGFydG5lckV2ZW50U2VydmljZSB7XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogVmVyaWZpY2EgZSBhdHVhbGl6YSBzdGF0dXMgZGUgdG9kb3Mgb3MgZXZlbnRvcyBhdGl2b3NcclxuICAgKiBEZXZlIHNlciBjaGFtYWRvIHBlcmlvZGljYW1lbnRlIChhIGNhZGEgbWludXRvKVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyB1cGRhdGVBbGxFdmVudFN0YXR1c2VzKCk6IFByb21pc2U8VXBkYXRlUmVzdWx0PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICBcclxuICAgICAgLy8gQnVzY2EgZXZlbnRvcyBxdWUgbsOjbyBlc3TDo28gQ29uY2x1w61kb3Mgb3UgQ2FuY2VsYWRvc1xyXG4gICAgICBjb25zdCB7IGRhdGE6IGV2ZW50cywgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgLnNlbGVjdCgnKicpXHJcbiAgICAgICAgLm5vdCgnc3RhdHVzJywgJ2luJywgJyhDb25jbHVpZG8sQ2FuY2VsYWRvKScpO1xyXG5cclxuICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuXHJcbiAgICAgIGNvbnN0IHVwZGF0ZXM6IEFycmF5PHsgaWQ6IHN0cmluZzsgc3RhdHVzOiBFdmVudFN0YXR1czsgdXBkYXRlZF9hdDogc3RyaW5nIH0+ID0gW107XHJcblxyXG4gICAgICBmb3IgKGNvbnN0IGV2ZW50IG9mIChldmVudHMgYXMgdW5rbm93biBhcyBFdmVudFtdKSkge1xyXG4gICAgICAgIGNvbnN0IG5ld1N0YXR1cyA9IHRoaXMuY2FsY3VsYXRlRXZlbnRTdGF0dXMoZXZlbnQsIG5vdyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKG5ld1N0YXR1cyAhPT0gZXZlbnQuc3RhdHVzKSB7XHJcbiAgICAgICAgICB1cGRhdGVzLnB1c2goe1xyXG4gICAgICAgICAgICBpZDogZXZlbnQuaWQsXHJcbiAgICAgICAgICAgIHN0YXR1czogbmV3U3RhdHVzLFxyXG4gICAgICAgICAgICB1cGRhdGVkX2F0OiBub3cudG9JU09TdHJpbmcoKVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBBdHVhbGl6YSBlbSBiYXRjaFxyXG4gICAgICBpZiAodXBkYXRlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCB1cGRhdGUgb2YgdXBkYXRlcykge1xyXG4gICAgICAgICAgYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgICAgIC51cGRhdGUoeyBzdGF0dXM6IHVwZGF0ZS5zdGF0dXMsIHVwZGF0ZWRfYXQ6IHVwZGF0ZS51cGRhdGVkX2F0IH0pXHJcbiAgICAgICAgICAgIC5lcSgnaWQnLCB1cGRhdGUuaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBjb25zb2xlLmxvZyhg4pyFICR7dXBkYXRlcy5sZW5ndGh9IGV2ZW50b3MgYXR1YWxpemFkb3NgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgdXBkYXRlZDogdXBkYXRlcy5sZW5ndGggfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGF0dWFsaXphciBzdGF0dXMgZGUgZXZlbnRvczonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvciB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2FsY3VsYSBvIHN0YXR1cyBjb3JyZXRvIGRlIHVtIGV2ZW50byBiYXNlYWRvIG5hcyByZWdyYXMgZGUgbmVnw7NjaW9cclxuICAgKi9cclxuICBzdGF0aWMgY2FsY3VsYXRlRXZlbnRTdGF0dXMoZXZlbnQ6IEV2ZW50LCBub3c6IERhdGUgPSBuZXcgRGF0ZSgpKTogRXZlbnRTdGF0dXMge1xyXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gbmV3IERhdGUoZXZlbnQuc3RhcnRfdGltZSk7XHJcbiAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoZXZlbnQuZW5kX3RpbWUpO1xyXG5cclxuICAgIC8vIENhbmNlbGFkbyBwZXJtYW5lY2UgY2FuY2VsYWRvXHJcbiAgICBpZiAoZXZlbnQuc3RhdHVzID09PSAnQ2FuY2VsYWRvJykge1xyXG4gICAgICByZXR1cm4gJ0NhbmNlbGFkbyc7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ29uY2x1w61kbyBwZXJtYW5lY2UgY29uY2x1w61kb1xyXG4gICAgaWYgKGV2ZW50LnN0YXR1cyA9PT0gJ0NvbmNsdcOtZG8nKSB7XHJcbiAgICAgIHJldHVybiAnQ29uY2x1w61kbyc7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRXZlbnRvIGrDoSB0ZXJtaW5vdSDihpIgRmluYWxpemFkbyAoYWd1YXJkYW5kbyBhdmFsaWHDp8O1ZXMpXHJcbiAgICBpZiAobm93ID49IGVuZFRpbWUpIHtcclxuICAgICAgcmV0dXJuICdGaW5hbGl6YWRvJztcclxuICAgIH1cclxuXHJcbiAgICAvLyBFdmVudG8gZXN0w6EgYWNvbnRlY2VuZG8g4oaSIEVtIEFuZGFtZW50b1xyXG4gICAgaWYgKG5vdyA+PSBzdGFydFRpbWUgJiYgbm93IDwgZW5kVGltZSkge1xyXG4gICAgICByZXR1cm4gJ0VtIEFuZGFtZW50byc7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRXZlbnRvIGZ1dHVybyAtIHZlcmlmaWNhIHJlZ3Jhc1xyXG4gICAgaWYgKG5vdyA8IHN0YXJ0VGltZSkge1xyXG4gICAgICAvLyDinIUgUkVHUkEgQ1LDjVRJQ0E6IENvbmZpcm1hw6fDo28gbWFudWFsIMOpIHBlcm1hbmVudGUhXHJcbiAgICAgIC8vIFNlIG8gYW5maXRyacOjbyBjb25maXJtb3UgbWFudWFsbWVudGUsIHJlc3BlaXRhciBpc3NvXHJcbiAgICAgIGlmIChldmVudC5zdGF0dXMgPT09ICdDb25maXJtYWRvJykge1xyXG4gICAgICAgIHJldHVybiAnQ29uZmlybWFkbyc7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFNlIHZhZ2FzIHByZWVuY2hpZGFzIGF1dG9tYXRpY2FtZW50ZSDihpIgQ29uZmlybWFkb1xyXG4gICAgICBpZiAoZXZlbnQudmFnYXMgPD0gMCkge1xyXG4gICAgICAgIHJldHVybiAnQ29uZmlybWFkbyc7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIC8vIFNlIGFpbmRhIHRlbSB2YWdhcyBlIGVzdMOhIG5vIHByYXpvIOKGkiBBYmVydG9cclxuICAgICAgLy8gQ2FuZGlkYXR1cmFzIGFjZWl0YXMgYXTDqSA1IG1pbnV0b3MgYW50ZXMgZG8gaW7DrWNpb1xyXG4gICAgICBjb25zdCBmaXZlTWludXRlc0JlZm9yZSA9IG5ldyBEYXRlKHN0YXJ0VGltZS5nZXRUaW1lKCkgLSA1ICogNjAgKiAxMDAwKTtcclxuICAgICAgaWYgKG5vdyA8IGZpdmVNaW51dGVzQmVmb3JlKSB7XHJcbiAgICAgICAgcmV0dXJuICdBYmVydG8nO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBNZW5vcyBkZSA1IG1pbnV0b3MgcGFyYSBjb21lw6dhciDihpIgQ29uZmlybWFkbyBhdXRvbWF0aWNhbWVudGVcclxuICAgICAgcmV0dXJuICdDb25maXJtYWRvJztcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZXZlbnQuc3RhdHVzOyAvLyBNYW50w6ltIHN0YXR1cyBhdHVhbCBzZSBuYWRhIG11ZG91XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDb25maXJtYSBtYW51YWxtZW50ZSB1bSBldmVudG8gKGFuZml0cmnDo28gZmVjaGEgaW5zY3Jpw6fDtWVzKVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBjb25maXJtRXZlbnQoZXZlbnRJZDogc3RyaW5nKTogUHJvbWlzZTxVcGRhdGVSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgLnVwZGF0ZSh7IFxyXG4gICAgICAgICAgc3RhdHVzOiAnQ29uZmlybWFkbycsXHJcbiAgICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5lcSgnaWQnLCBldmVudElkKTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIEV2ZW50byAke2V2ZW50SWR9IGNvbmZpcm1hZG8gbWFudWFsbWVudGVgKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gY29uZmlybWFyIGV2ZW50bzonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvciB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2FuY2VsYSB1bSBldmVudG9cclxuICAgKi9cclxuICBzdGF0aWMgYXN5bmMgY2FuY2VsRXZlbnQoZXZlbnRJZDogc3RyaW5nLCByZWFzb246IHN0cmluZyA9ICcnKTogUHJvbWlzZTxVcGRhdGVSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgLnVwZGF0ZSh7IFxyXG4gICAgICAgICAgc3RhdHVzOiAnQ2FuY2VsYWRvJyxcclxuICAgICAgICAgIC4uLihyZWFzb24gJiYgeyBjYW5jZWxhbWVudG9fbW90aXZvOiByZWFzb24gfSksIC8vIFPDsyBpbmNsdWkgc2UgcmVhc29uIGZvciBmb3JuZWNpZG9cclxuICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmVxKCdpZCcsIGV2ZW50SWQpO1xyXG5cclxuICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuXHJcbiAgICAgIC8vIFRPRE86IE5vdGlmaWNhciBwYXJ0aWNpcGFudGVzXHJcbiAgICAgIC8vIFRPRE86IEFwbGljYXIgcG9sw610aWNhcyBkZSBjYW5jZWxhbWVudG9cclxuXHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGNhbmNlbGFyIGV2ZW50bzonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvciB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTWFyY2EgZXZlbnRvIGNvbW8gY29uY2x1w61kbyBhcMOzcyB0b2RhcyBhdmFsaWHDp8O1ZXNcclxuICAgKi9cclxuICBzdGF0aWMgYXN5bmMgY29tcGxldGVFdmVudChldmVudElkOiBzdHJpbmcpOiBQcm9taXNlPFVwZGF0ZVJlc3VsdD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gVmVyaWZpY2Egc2UgdG9kYXMgYXZhbGlhw6fDtWVzIGZvcmFtIGZlaXRhc1xyXG4gICAgICBjb25zdCB7IGRhdGE6IHBhcnRpY2lwYXRpb25zLCBlcnJvcjogcGFydGljaXBhdGlvbnNFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRfcGFydGljaXBhbnRzJylcclxuICAgICAgICAuc2VsZWN0KCdpZCwgYXZhbGlhY2FvX2ZlaXRhJylcclxuICAgICAgICAuZXEoJ2V2ZW50X2lkJywgZXZlbnRJZClcclxuICAgICAgICAuZXEoJ3ByZXNlbmNhX2NvbmZpcm1hZGEnLCB0cnVlKTtcclxuXHJcbiAgICAgIGlmIChwYXJ0aWNpcGF0aW9uc0Vycm9yKSB0aHJvdyBwYXJ0aWNpcGF0aW9uc0Vycm9yO1xyXG5cclxuICAgICAgY29uc3QgYWxsRXZhbHVhdGVkID0gKHBhcnRpY2lwYXRpb25zIGFzIHVua25vd24gYXMgUGFydGljaXBhdGlvbltdKS5ldmVyeShwID0+IHAuYXZhbGlhY2FvX2ZlaXRhID09PSB0cnVlKTtcclxuXHJcbiAgICAgIGlmICghYWxsRXZhbHVhdGVkKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgXHJcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSwgXHJcbiAgICAgICAgICBlcnJvcjogJ05lbSB0b2RvcyBvcyBwYXJ0aWNpcGFudGVzIGF2YWxpYXJhbSBvIGV2ZW50bycgXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRzJylcclxuICAgICAgICAudXBkYXRlKHsgXHJcbiAgICAgICAgICBzdGF0dXM6ICdDb25jbHXDrWRvJyxcclxuICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmVxKCdpZCcsIGV2ZW50SWQpO1xyXG5cclxuICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuXHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGNvbmNsdWlyIGV2ZW50bzonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvciB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogT2J0w6ltIGVzdGF0w61zdGljYXMgZGUgdW0gZXZlbnRvXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIGdldEV2ZW50U3RhdHMoZXZlbnRJZDogc3RyaW5nKTogUHJvbWlzZTxFdmVudFN0YXRzPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IGRhdGE6IGV2ZW50LCBlcnJvcjogZXZlbnRFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRzJylcclxuICAgICAgICAuc2VsZWN0KCcqLCBjcmVhdG9yOnByb2ZpbGVzIWNyZWF0b3JfaWQoKiknKVxyXG4gICAgICAgIC5lcSgnaWQnLCBldmVudElkKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICAgIGlmIChldmVudEVycm9yKSB0aHJvdyBldmVudEVycm9yO1xyXG5cclxuICAgICAgY29uc3QgeyBkYXRhOiBwYXJ0aWNpcGF0aW9ucywgZXJyb3I6IHBhcnRpY2lwYXRpb25zRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50X3BhcnRpY2lwYW50cycpXHJcbiAgICAgICAgLnNlbGVjdCgnKicpXHJcbiAgICAgICAgLmVxKCdldmVudF9pZCcsIGV2ZW50SWQpO1xyXG5cclxuICAgICAgaWYgKHBhcnRpY2lwYXRpb25zRXJyb3IpIHRocm93IHBhcnRpY2lwYXRpb25zRXJyb3I7XHJcblxyXG4gICAgICBjb25zdCBwYXJ0aWNpcGF0aW9uc0xpc3QgPSBwYXJ0aWNpcGF0aW9ucyBhcyB1bmtub3duIGFzIFBhcnRpY2lwYXRpb25bXTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICBldmVudDogZXZlbnQgYXMgdW5rbm93biBhcyBFdmVudCxcclxuICAgICAgICAgIHRvdGFsQ2FuZGlkYXR1cmFzOiBwYXJ0aWNpcGF0aW9uc0xpc3QubGVuZ3RoLFxyXG4gICAgICAgICAgYXByb3ZhZG9zOiBwYXJ0aWNpcGF0aW9uc0xpc3QuZmlsdGVyKHAgPT4gcC5zdGF0dXMgPT09ICdhcHJvdmFkbycpLmxlbmd0aCxcclxuICAgICAgICAgIHByZXNlbnRlczogcGFydGljaXBhdGlvbnNMaXN0LmZpbHRlcihwID0+IHAucHJlc2VuY2FfY29uZmlybWFkYSA9PT0gdHJ1ZSkubGVuZ3RoLFxyXG4gICAgICAgICAgYXZhbGlhY29lczogcGFydGljaXBhdGlvbnNMaXN0LmZpbHRlcihwID0+IHAuYXZhbGlhY2FvX2ZlaXRhID09PSB0cnVlKS5sZW5ndGgsXHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gYnVzY2FyIGVzdGF0w61zdGljYXM6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3IgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEluaWNpYSBtb25pdG9yYW1lbnRvIGF1dG9tw6F0aWNvIGRlIHN0YXR1c1xyXG4gICAqIEF0dWFsaXphIGEgY2FkYSAxIG1pbnV0b1xyXG4gICAqL1xyXG4gIHN0YXRpYyBzdGFydEF1dG9VcGRhdGUoKTogbnVtYmVyIHtcclxuICAgIC8vIEV4ZWN1dGEgaW1lZGlhdGFtZW50ZVxyXG4gICAgdGhpcy51cGRhdGVBbGxFdmVudFN0YXR1c2VzKCk7XHJcblxyXG4gICAgLy8gRGVwb2lzIGV4ZWN1dGEgYSBjYWRhIDEgbWludXRvXHJcbiAgICBjb25zdCBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZUFsbEV2ZW50U3RhdHVzZXMoKTtcclxuICAgIH0sIDYwMDAwKTsgLy8gNjAgc2VndW5kb3NcclxuXHJcbiAgICByZXR1cm4gaW50ZXJ2YWxJZCBhcyB1bmtub3duIGFzIG51bWJlcjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFBhcmEgbyBtb25pdG9yYW1lbnRvIGF1dG9tw6F0aWNvXHJcbiAgICovXHJcbiAgc3RhdGljIHN0b3BBdXRvVXBkYXRlKGludGVydmFsSWQ6IG51bWJlcik6IHZvaWQge1xyXG4gICAgaWYgKGludGVydmFsSWQpIHtcclxuICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHN0YXRpYyBhc3luYyBhcHByb3ZlUGFydGljaXBhdGlvbihwYXJ0aWNpcGF0aW9uSWQ6IHN0cmluZywgZXZlbnRJZDogc3RyaW5nKTogUHJvbWlzZTxTZXJ2aWNlUmVzdWx0PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zb2xlLmxvZygn8J+UlCBbYXBwcm92ZVBhcnRpY2lwYXRpb25dIEluaWNpYW5kbyBhcHJvdmHDp8OjbzonLCB7IHBhcnRpY2lwYXRpb25JZCwgZXZlbnRJZCB9KTtcclxuXHJcbiAgICAgIC8vIDEuIEJ1c2NhciBkYWRvcyBkbyBldmVudG9cclxuICAgICAgY29uc3QgeyBkYXRhOiBldmVudCwgZXJyb3I6IGV2ZW50RXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgLnNlbGVjdCgndmFnYXMsIHRpdGxlJylcclxuICAgICAgICAuZXEoJ2lkJywgZXZlbnRJZClcclxuICAgICAgICAuc2luZ2xlKCk7XHJcblxyXG4gICAgICBpZiAoZXZlbnRFcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGJ1c2NhciBldmVudG86JywgZXZlbnRFcnJvcik7XHJcbiAgICAgICAgdGhyb3cgZXZlbnRFcnJvcjtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKChldmVudCBhcyBhbnkpLnZhZ2FzIDw9IDApIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oJ+KaoO+4jyBTZW0gdmFnYXMgZGlzcG9uw612ZWlzJyk7XHJcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnU2VtIHZhZ2FzIGRpc3BvbsOtdmVpcycgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gMi4gQnVzY2FyIGRhZG9zIGRvIHBhcnRpY2lwYW50ZVxyXG4gICAgICBjb25zdCB7IGRhdGE6IHBhcnRpY2lwYXRpb24sIGVycm9yOiBwYXJ0RXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50X3BhcnRpY2lwYW50cycpXHJcbiAgICAgICAgLnNlbGVjdCgndXNlcl9pZCcpXHJcbiAgICAgICAgLmVxKCdpZCcsIHBhcnRpY2lwYXRpb25JZClcclxuICAgICAgICAuc2luZ2xlKCk7XHJcblxyXG4gICAgICBpZiAocGFydEVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gYnVzY2FyIHBhcnRpY2lwYcOnw6NvOicsIHBhcnRFcnJvcik7XHJcbiAgICAgICAgdGhyb3cgcGFydEVycm9yO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zb2xlLmxvZygn8J+TiyBEYWRvcyBvYnRpZG9zOicsIHtcclxuICAgICAgICB1c2VySWQ6IChwYXJ0aWNpcGF0aW9uIGFzIGFueSkudXNlcl9pZCxcclxuICAgICAgICBldmVudFRpdGxlOiAoZXZlbnQgYXMgYW55KS50aXRsZVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIDMuIEF0dWFsaXphciBzdGF0dXMgZGEgcGFydGljaXBhw6fDo29cclxuICAgICAgY29uc3QgeyBlcnJvcjogdXBkYXRlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50X3BhcnRpY2lwYW50cycpXHJcbiAgICAgICAgLnVwZGF0ZSh7IFxyXG4gICAgICAgICAgc3RhdHVzOiAnYXByb3ZhZG8nLFxyXG4gICAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgfSlcclxuICAgICAgICAuZXEoJ2lkJywgcGFydGljaXBhdGlvbklkKTtcclxuXHJcbiAgICAgIGlmICh1cGRhdGVFcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGF0dWFsaXphciBwYXJ0aWNpcGHDp8OjbzonLCB1cGRhdGVFcnJvcik7XHJcbiAgICAgICAgdGhyb3cgdXBkYXRlRXJyb3I7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKCfinIUgU3RhdHVzIGF0dWFsaXphZG8gcGFyYSBhcHJvdmFkbycpO1xyXG5cclxuICAgICAgLy8gNC4gRGVjcmVtZW50YXIgdmFnYXNcclxuICAgICAgLy8gTm90ZTogVXNpbmcgVXNlckV2ZW50U2VydmljZSdzIGRlY3JlbWVudCwgYnV0IHNpbmNlIGl0J3Mgc3RhdGljLCBwZXJoYXBzIGR1cGxpY2F0ZSBvciBpbXBvcnQuXHJcbiAgICAgIC8vIEZvciBub3csIGR1cGxpY2F0ZSB0aGUgY29kZSB0byBhdm9pZCBjaXJjdWxhciBpbXBvcnRzIG9yIGNvbXBsZXggZGVwcy5cclxuICAgICAgY29uc3QgeyBlcnJvcjogZGVjRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLnJwYygnZGVjcmVtZW50X2V2ZW50X3ZhY2FuY3knLCB7IFxyXG4gICAgICAgIGV2ZW50X2lkOiBldmVudElkIFxyXG4gICAgICB9KTtcclxuICAgICAgXHJcbiAgICAgIGlmIChkZWNFcnJvcikge1xyXG4gICAgICAgIGNvbnN0IHsgZGF0YTogZXZlbnREYXRhIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgICAuc2VsZWN0KCd2YWdhcycpXHJcbiAgICAgICAgICAuZXEoJ2lkJywgZXZlbnRJZClcclxuICAgICAgICAgIC5zaW5nbGUoKTtcclxuICAgICAgICBcclxuICAgICAgICBpZiAoZXZlbnREYXRhICYmIGV2ZW50RGF0YS52YWdhcyA+IDApIHtcclxuICAgICAgICAgIGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgICAgIC5mcm9tKCdldmVudHMnKVxyXG4gICAgICAgICAgICAudXBkYXRlKHsgdmFnYXM6IGV2ZW50RGF0YS52YWdhcyAtIDEgfSlcclxuICAgICAgICAgICAgLmVxKCdpZCcsIGV2ZW50SWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBjb25zb2xlLmxvZygn4pyFIFZhZ2EgZGVjcmVtZW50YWRhJyk7XHJcblxyXG4gICAgICAvLyA1LiDwn5SUIE5PVElGSUNBUiBPIFBBUlRJQ0lQQU5URVxyXG4gICAgICBjb25zb2xlLmxvZygn8J+UlCBFbnZpYW5kbyBub3RpZmljYcOnw6NvIGFvIHBhcnRpY2lwYW50ZS4uLicpO1xyXG4gICAgICBjb25zdCBub3RpZlJlc3VsdCA9IGF3YWl0IE5vdGlmaWNhdGlvblNlcnZpY2Uubm90aWZ5UGFydGljaXBhdGlvbkFwcHJvdmVkKFxyXG4gICAgICAgIChwYXJ0aWNpcGF0aW9uIGFzIGFueSkudXNlcl9pZCxcclxucGFyc2VJbnQoZXZlbnRJZCwgMTApLCAgICAgICAgKGV2ZW50IGFzIGFueSkudGl0bGVcclxuICAgICAgKTtcclxuXHJcbiAgICAgIGlmIChub3RpZlJlc3VsdC5zdWNjZXNzKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ+KchSBOb3RpZmljYcOnw6NvIGVudmlhZGEgY29tIHN1Y2Vzc28nKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCfimqDvuI8gRXJybyBhbyBlbnZpYXIgbm90aWZpY2HDp8OjbyAoYXByb3Zhw6fDo28gY29uY2x1w61kYSk6Jywgbm90aWZSZXN1bHQuZXJyb3IpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4geyBcclxuICAgICAgICBzdWNjZXNzOiB0cnVlLCBcclxuICAgICAgICBtZXNzYWdlOiAnUGFydGljaXBhw6fDo28gYXByb3ZhZGEgY29tIHN1Y2Vzc28hJyBcclxuICAgICAgfTtcclxuXHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGFwcm92YXIgcGFydGljaXBhw6fDo286JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHN0YXRpYyBhc3luYyByZWplY3RQYXJ0aWNpcGF0aW9uKHBhcnRpY2lwYXRpb25JZDogc3RyaW5nLCByZWFzb24/OiBzdHJpbmcpOiBQcm9taXNlPFNlcnZpY2VSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZGF0YTogcGFydGljaXBhdGlvbiB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRfcGFydGljaXBhbnRzJylcclxuICAgICAgICAuc2VsZWN0KCd1c2VyX2lkLCBldmVudF9pZCwgZXZlbnRzIWlubmVyKHRpdGxlKScpXHJcbiAgICAgICAgLmVxKCdpZCcsIHBhcnRpY2lwYXRpb25JZClcclxuICAgICAgICAuc2luZ2xlKCk7XHJcblxyXG4gICAgICBjb25zdCB7IGVycm9yOiB1cGRhdGVFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRfcGFydGljaXBhbnRzJylcclxuICAgICAgICAudXBkYXRlKHsgXHJcbiAgICAgICAgICBzdGF0dXM6ICdyZWplaXRhZG8nLFxyXG4gICAgICAgICAgbW90aXZvX3JlamVpY2FvOiByZWFzb24sXHJcbiAgICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5lcSgnaWQnLCBwYXJ0aWNpcGF0aW9uSWQpO1xyXG5cclxuICAgICAgaWYgKHVwZGF0ZUVycm9yKSB0aHJvdyB1cGRhdGVFcnJvcjtcclxuXHJcbiAgICAgIC8vIE5vdGlmaWNhciBvIHBhcnRpY2lwYW50ZSBzb2JyZSByZWplacOnw6NvXHJcbiAgICAgIGNvbnN0IHBhcnQgPSBwYXJ0aWNpcGF0aW9uIGFzIGFueTtcclxuICAgICAgY29uc3Qgbm90aWZSZXN1bHQgPSBhd2FpdCBOb3RpZmljYXRpb25TZXJ2aWNlLm5vdGlmeVBhcnRpY2lwYXRpb25SZWplY3RlZChcclxuICAgICAgICBwYXJ0LnVzZXJfaWQsXHJcbiAgICAgICAgcGFydC5ldmVudF9pZCwgLy8gQ29ycmlnaWRvOiBtYW50aWRvIGNvbW8gc3RyaW5nXHJcbiAgICAgICAgcGFydC5ldmVudHMudGl0bGUsXHJcbiAgICAgICAgcmVhc29uXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBpZiAoIW5vdGlmUmVzdWx0LnN1Y2Nlc3MpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCfimqDvuI8gRXJybyBhbyBlbnZpYXIgbm90aWZpY2HDp8OjbyBkZSByZWplacOnw6NvOicsIG5vdGlmUmVzdWx0LmVycm9yKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ1BhcnRpY2lwYcOnw6NvIHJlamVpdGFkYScgfTtcclxuXHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIHJlamVpdGFyIHBhcnRpY2lwYcOnw6NvOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgYXN5bmMgZ2V0RXZlbnRQYXJ0aWNpcGF0aW9ucyhldmVudElkOiBzdHJpbmcpOiBQcm9taXNlPFNlcnZpY2VSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZGF0YTogcGFydGljaXBhdGlvbnMsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCdldmVudF9wYXJ0aWNpcGFudHMnKVxyXG4gICAgICAgIC5zZWxlY3QoJyosIHVzZXI6cHJvZmlsZXMhZXZlbnRfcGFydGljaXBhbnRzX3VzZXJfaWRfZmtleSgqKScpXHJcbiAgICAgICAgLmVxKCdldmVudF9pZCcsIGV2ZW50SWQpXHJcbiAgICAgICAgLm9yZGVyKCdjcmVhdGVkX2F0JywgeyBhc2NlbmRpbmc6IGZhbHNlIH0pO1xyXG5cclxuICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuXHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHBhcnRpY2lwYXRpb25zIH07XHJcblxyXG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBidXNjYXIgcGFydGljaXBhw6fDtWVzOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBQYXJ0bmVyRXZlbnRTZXJ2aWNlOyJdLCJ2ZXJzaW9uIjozfQ==