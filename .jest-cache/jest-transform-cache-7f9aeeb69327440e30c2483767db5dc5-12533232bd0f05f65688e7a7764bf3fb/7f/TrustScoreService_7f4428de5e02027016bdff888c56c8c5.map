{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\services\\TrustScoreService.ts","mappings":"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","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\services\\TrustScoreService.ts"],"sourcesContent":["// src/services/TrustScoreService.ts\r\nimport { supabase } from '../lib/supabaseClient';\r\n\r\ninterface TrustScoreResult {\r\n  success: boolean;\r\n  data?: any;\r\n  error?: any;\r\n}\r\n\r\n// ‚úÖ Interface 'UserTrustStatus' removida daqui (Corre√ß√£o TS6196)\r\n\r\n/**\r\n * ‚≠ê Servi√ßo de Ranking de Confiabilidade\r\n * Gerencia trust score (5-0) e banimentos\r\n * Regra: N√£o compareceu = -1 score, quando chega em 0 = banido\r\n */\r\nclass TrustScoreService {\r\n  /**\r\n   * üéØ Obt√©m trust score do usu√°rio\r\n   * @param userId - ID do usu√°rio\r\n   */\r\n  static async getTrustScore(userId: string): Promise<TrustScoreResult> {\r\n    try {\r\n      const { data: profile, error } = await supabase\r\n        .from('profiles')\r\n        .select('trust_score, is_banned')\r\n        .eq('id', userId)\r\n        .single();\r\n\r\n      if (error) {\r\n        if (error.code === 'PGRST116') {\r\n          return { success: false, error: 'Usu√°rio n√£o encontrado' };\r\n        }\r\n        throw error;\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          trustScore: profile?.trust_score || 5,\r\n          isBanned: profile?.is_banned || false\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao obter trust score:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üö´ Verifica se usu√°rio est√° banido\r\n   * @param userId - ID do usu√°rio\r\n   */\r\n  static async isBanned(userId: string): Promise<boolean> {\r\n    try {\r\n      const result = await this.getTrustScore(userId);\r\n      if (!result.success) return false;\r\n      return result.data?.isBanned === true;\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao verificar banimento:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ‚¨áÔ∏è Reduz trust score (n√£o compareceu)\r\n   * @param userId - ID do usu√°rio\r\n   */\r\n  static async penalizeNoShow(userId: string): Promise<TrustScoreResult> {\r\n    try {\r\n      const { data: profile, error: getError } = await supabase\r\n        .from('profiles')\r\n        .select('trust_score')\r\n        .eq('id', userId)\r\n        .single();\r\n\r\n      if (getError) throw getError;\r\n\r\n      const currentScore = profile?.trust_score || 5;\r\n      const newScore = Math.max(0, currentScore - 1); // M√≠nimo 0\r\n\r\n      console.log(`‚¨áÔ∏è Penalizando ${userId}: ${currentScore} ‚Üí ${newScore}`);\r\n\r\n      const { error: updateError } = await supabase\r\n        .from('profiles')\r\n        .update({\r\n          trust_score: newScore,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', userId);\r\n\r\n      if (updateError) throw updateError;\r\n\r\n      // üö´ Se score chegou em 0, banir automaticamente\r\n      if (newScore === 0) {\r\n        await this.banUser(userId, 'Trust score atingiu 0');\r\n      }\r\n\r\n      // üìä Registrar penalidade\r\n      await this.logTrustScoreChange(userId, currentScore, newScore, 'no_show');\r\n\r\n      console.log(`‚úÖ Penalidade aplicada: ${userId} agora tem score ${newScore}`);\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          previousScore: currentScore,\r\n          newScore,\r\n          wasBanned: newScore === 0\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao penalizar usu√°rio:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üö´ Bani um usu√°rio (trust_score = 0)\r\n   * @param userId - ID do usu√°rio\r\n   * @param reason - Motivo do banimento\r\n   */\r\n  static async banUser(userId: string, reason: string = 'Trust score zerado'): Promise<TrustScoreResult> {\r\n    try {\r\n      console.log(`üö´ Banindo usu√°rio ${userId}: ${reason}`);\r\n\r\n      const { error } = await supabase\r\n        .from('profiles')\r\n        .update({\r\n          is_banned: true,\r\n          trust_score: 0,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', userId);\r\n\r\n      if (error) throw error;\r\n\r\n      // üìä Registrar banimento\r\n      await this.logBanishment(userId, reason);\r\n\r\n      console.log(`‚úÖ Usu√°rio ${userId} foi banido`);\r\n\r\n      return { success: true, data: { userId, reason } };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao banir usu√°rio:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üí∞ Desbloqueia usu√°rio ap√≥s pagamento (trust_score = 5 novamente)\r\n   * @param userId - ID do usu√°rio\r\n   * @param paymentId - ID da transa√ß√£o Stripe/Mercado Pago\r\n   */\r\n  static async unbanUserAfterPayment(\r\n    userId: string,\r\n    paymentId: string\r\n  ): Promise<TrustScoreResult> {\r\n    try {\r\n      console.log(`üíö Desbloqueando usu√°rio ${userId} ap√≥s pagamento`);\r\n\r\n      // 1Ô∏è‚É£ Resetar score para 5 e desbanir\r\n      const { error: updateError } = await supabase\r\n        .from('profiles')\r\n        .update({\r\n          trust_score: 5, // Volta para o m√°ximo\r\n          is_banned: false,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', userId);\r\n\r\n      if (updateError) throw updateError;\r\n\r\n      // 2Ô∏è‚É£ Registrar desbloqueio no payments table\r\n      const { error: paymentError } = await supabase\r\n        .from('payments')\r\n        .insert({\r\n          user_id: userId,\r\n          amount: 249.00,\r\n          reason: 'unban_trust_score',\r\n          status: 'completed',\r\n          stripe_payment_id: paymentId,\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n      if (paymentError) {\r\n        console.warn('‚ö†Ô∏è Erro ao registrar pagamento (n√£o √© cr√≠tico):', paymentError);\r\n        // N√£o falhar - usu√°rio j√° foi desbloqueado\r\n      }\r\n\r\n      // 3Ô∏è‚É£ Registrar no log\r\n      await this.logUnbanishment(userId, paymentId);\r\n\r\n      console.log(`‚úÖ Usu√°rio ${userId} foi desbloqueado. Score resetado para 5.`);\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          userId,\r\n          newScore: 5,\r\n          message: 'Perfil desbloqueado com sucesso!'\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao desbloquear usu√°rio:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üìä Penaliza n√£o-presen√ßa de participantes (chamar quando evento termina)\r\n   * @param eventId - ID do evento\r\n   */\r\n  static async penalizeNoShowsForEvent(eventId: number): Promise<TrustScoreResult> {\r\n    try {\r\n      console.log(`üìä Processando penalidades de n√£o-presen√ßa para evento ${eventId}`);\r\n\r\n      // 1Ô∏è‚É£ Buscar participa√ß√µes de aprovados SEM acesso (n√£o compareceu)\r\n      const { data: noShows, error: queryError } = await supabase\r\n        .from('event_participants')\r\n        .select('id, user_id')\r\n        .eq('event_id', eventId)\r\n        .eq('status', 'aprovado')\r\n        .eq('presenca_confirmada', true) // Confirmou presen√ßa\r\n        .eq('com_acesso', false); // Mas n√£o entrou\r\n\r\n      if (queryError) throw queryError;\r\n\r\n      if (!noShows || noShows.length === 0) {\r\n        console.log(`‚úÖ Nenhuma n√£o-presen√ßa para penalizar no evento ${eventId}`);\r\n        return { success: true, data: { penalized: 0 } };\r\n      }\r\n\r\n      console.log(`‚ö†Ô∏è Encontradas ${noShows.length} n√£o-presen√ßas`);\r\n\r\n      // 2Ô∏è‚É£ Penalizar cada um\r\n      let penalizedCount = 0;\r\n      const errors: any[] = [];\r\n\r\n      for (const noShow of noShows) {\r\n        try {\r\n          const result = await this.penalizeNoShow(noShow.user_id);\r\n          if (result.success) {\r\n            penalizedCount++;\r\n          } else {\r\n            errors.push({ userId: noShow.user_id, error: result.error });\r\n          }\r\n        } catch (error) {\r\n          errors.push({ userId: noShow.user_id, error });\r\n        }\r\n      }\r\n\r\n      console.log(`‚úÖ Penalizadas ${penalizedCount}/${noShows.length} n√£o-presen√ßas`);\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          eventId,\r\n          penalized: penalizedCount,\r\n          errors: errors.length > 0 ? errors : undefined\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao penalizar no-shows:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üìà Restaura trust score manualmente (admin)\r\n   * @param userId - ID do usu√°rio\r\n   * @param newScore - Novo score (0-5)\r\n   */\r\n  static async setTrustScoreManual(userId: string, newScore: number): Promise<TrustScoreResult> {\r\n    try {\r\n      if (newScore < 0 || newScore > 5) {\r\n        return { success: false, error: 'Score deve estar entre 0 e 5' };\r\n      }\r\n\r\n      console.log(`üîß Ajustando score de ${userId} para ${newScore} (manual)`);\r\n\r\n      const { error } = await supabase\r\n        .from('profiles')\r\n        .update({\r\n          trust_score: newScore,\r\n          is_banned: newScore === 0,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', userId);\r\n\r\n      if (error) throw error;\r\n\r\n      console.log(`‚úÖ Score ajustado manualmente`);\r\n\r\n      return { success: true, data: { userId, newScore } };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao ajustar score:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üìä Obt√©m relat√≥rio de confiabilidade do usu√°rio\r\n   */\r\n  static async getTrustReport(userId: string): Promise<TrustScoreResult> {\r\n    try {\r\n      const { data: profile, error: profileError } = await supabase\r\n        .from('profiles')\r\n        .select('trust_score, is_banned, created_at')\r\n        .eq('id', userId)\r\n        .single();\r\n\r\n      if (profileError) throw profileError;\r\n\r\n      // Buscar hist√≥rico de mudan√ßas\r\n      const { data: history, error: historyError } = await supabase\r\n        .from('trust_score_changes')\r\n        .select('*')\r\n        .eq('user_id', userId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(10);\r\n\r\n      if (historyError) {\r\n        console.warn('‚ö†Ô∏è Erro ao buscar hist√≥rico:', historyError);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          userId,\r\n          currentScore: profile?.trust_score,\r\n          isBanned: profile?.is_banned,\r\n          memberSince: profile?.created_at,\r\n          scoreHistory: history || []\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao obter relat√≥rio:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üìù Registra mudan√ßa de score (log)\r\n   */\r\n  private static async logTrustScoreChange(\r\n    userId: string,\r\n    previousScore: number,\r\n    newScore: number,\r\n    reason: string\r\n  ): Promise<void> {\r\n    try {\r\n      await supabase.from('trust_score_changes').insert({\r\n        user_id: userId,\r\n        previous_score: previousScore,\r\n        new_score: newScore,\r\n        reason,\r\n        created_at: new Date().toISOString()\r\n      });\r\n    } catch (error) {\r\n      console.warn('‚ö†Ô∏è Erro ao registrar mudan√ßa de score:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üìù Registra banimento (log)\r\n   */\r\n  private static async logBanishment(userId: string, reason: string): Promise<void> {\r\n    try {\r\n      await supabase.from('banishment_logs').insert({\r\n        user_id: userId,\r\n        reason,\r\n        banned_at: new Date().toISOString()\r\n      });\r\n    } catch (error) {\r\n      console.warn('‚ö†Ô∏è Erro ao registrar banimento:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üìù Registra desbloqueio (log)\r\n   */\r\n  private static async logUnbanishment(userId: string, paymentId: string): Promise<void> {\r\n    try {\r\n      await supabase.from('unbanishment_logs').insert({\r\n        user_id: userId,\r\n        payment_id: paymentId,\r\n        unbanned_at: new Date().toISOString()\r\n      });\r\n    } catch (error) {\r\n      console.warn('‚ö†Ô∏è Erro ao registrar desbloqueio:', error);\r\n    }\r\n  }\r\n}\r\n\r\nexport default TrustScoreService;\r\n\r\n"],"version":3}