a97b388801127e0f82132890d0f4aa0e
"use strict";
// src/services/PushNotificationService.test.ts
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const globals_1 = require("@jest/globals");
globals_1.jest.mock('../lib/supabaseClient', () => ({
    supabase: mockSupabaseInstance,
}));
const supabaseClient_1 = require("../lib/supabaseClient");
const PushNotificationService_1 = tslib_1.__importDefault(require("./PushNotificationService"));
// --- 1. MOCKING DEPENDÃŠNCIAS ---
// Mock do Supabase
const mockSupabaseInstance = {
    from: globals_1.jest.fn(),
};
// Typecast do mock para intellisense
const mockedSupabase = supabaseClient_1.supabase;
// --- 2. CONFIGURAÃ‡ÃƒO DOS TESTES ---
(0, globals_1.describe)('PushNotificationService', () => {
    // EspiÃµes (Spies) para os mÃ©todos estÃ¡ticos que sÃ£o chamados internamente
    let spySendPush;
    let spyLogPush; // 'any' para espionar mÃ©todo privado
    let spySendToDevice; // 'any' para espionar mÃ©todo privado
    (0, globals_1.beforeEach)(() => {
        globals_1.jest.clearAllMocks();
        mockedSupabase.from.mockReset();
        // Recria os espiÃµes antes de cada teste
        // Espionamos sendPush para testes de orquestraÃ§Ã£o (ex: sendPasswordToHost)
        spySendPush = globals_1.jest.spyOn(PushNotificationService_1.default, 'sendPush')
            .mockImplementation(() => Promise.resolve({ success: true }));
        // Espionamos os mÃ©todos privados para verificar se sÃ£o chamados
        spyLogPush = globals_1.jest.spyOn(PushNotificationService_1.default, 'logPushNotification')
            .mockImplementation(() => Promise.resolve());
        spySendToDevice = globals_1.jest.spyOn(PushNotificationService_1.default, 'sendPushToDevice')
            .mockImplementation(() => Promise.resolve());
    });
    (0, globals_1.afterEach)(() => {
        // Restaura os espiÃµes apÃ³s cada teste
        spySendPush.mockRestore();
        spyLogPush.mockRestore();
        spySendToDevice.mockRestore();
    });
    // --- 3. TESTES DOS MÃ‰TODOS ---
    (0, globals_1.describe)('sendPush (MÃ©todo Principal)', () => {
        (0, globals_1.it)('deve enviar push para mÃºltiplos devices e registrar log', async () => {
            // Libera o mock de 'sendPush' para testar sua lÃ³gica interna
            spySendPush.mockRestore();
            const mockDevices = [
                { token: 'token-web', platform: 'web' },
                { token: 'token-ios', platform: 'ios' },
            ];
            // 1. Mock do SELECT de tokens
            mockedSupabase.from.mockImplementationOnce(() => ({
                select: globals_1.jest.fn(() => ({
                    eq: globals_1.jest.fn(() => ({
                        eq: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: mockDevices, error: null })),
                    })),
                })),
            }));
            const params = {
                userId: 'user-123',
                title: 'TÃ­tulo Teste',
                body: 'Corpo Teste',
                eventId: 1,
            };
            const result = await PushNotificationService_1.default.sendPush(params);
            (0, globals_1.expect)(result.success).toBe(true);
            (0, globals_1.expect)(result.message).toBe('Enviada para 2 dispositivos');
            // Verifica se buscou os tokens
            (0, globals_1.expect)(mockedSupabase.from).toHaveBeenCalledWith('user_device_tokens');
            // Verifica se tentou enviar para os 2 devices
            (0, globals_1.expect)(spySendToDevice).toHaveBeenCalledTimes(2);
            (0, globals_1.expect)(spySendToDevice).toHaveBeenCalledWith(globals_1.expect.objectContaining({ token: 'token-web' }));
            (0, globals_1.expect)(spySendToDevice).toHaveBeenCalledWith(globals_1.expect.objectContaining({ token: 'token-ios' }));
            // Verifica se registrou o log
            (0, globals_1.expect)(spyLogPush).toHaveBeenCalledWith(globals_1.expect.objectContaining({
                user_id: 'user-123',
                devices_sent: 2,
                total_devices: 2,
            }));
        });
        (0, globals_1.it)('nÃ£o deve fazer nada se o usuÃ¡rio nÃ£o tiver tokens', async () => {
            // Libera o mock de 'sendPush' para testar sua lÃ³gica interna
            spySendPush.mockRestore();
            // 1. Mock do SELECT de tokens (retornando vazio)
            mockedSupabase.from.mockImplementationOnce(() => ({
                select: globals_1.jest.fn(() => ({
                    eq: globals_1.jest.fn(() => ({
                        eq: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: [], error: null })),
                    })),
                })),
            }));
            const params = { userId: 'user-404', title: 'Teste', body: '...' };
            const result = await PushNotificationService_1.default.sendPush(params);
            (0, globals_1.expect)(result.success).toBe(true);
            (0, globals_1.expect)(result.message).toBe('Nenhum dispositivo registrado');
            // Garante que nÃ£o tentou enviar nem registrar log
            (0, globals_1.expect)(spySendToDevice).not.toHaveBeenCalled();
            (0, globals_1.expect)(spyLogPush).not.toHaveBeenCalled();
        });
    });
    (0, globals_1.describe)('sendPasswordToHost', () => {
        (0, globals_1.it)('deve inserir notificaÃ§Ã£o no DB e chamar sendPush', async () => {
            // 1. Mock do INSERT da notificaÃ§Ã£o
            const mockInsert = globals_1.jest.fn().mockImplementation(() => Promise.resolve({ error: null }));
            mockedSupabase.from.mockReturnValue({
                insert: mockInsert,
            });
            const result = await PushNotificationService_1.default.sendPasswordToHost('host-id', 1, '1234', 'Evento Senha');
            (0, globals_1.expect)(result.success).toBe(true);
            // Verifica se inseriu a notificaÃ§Ã£o no DB
            (0, globals_1.expect)(mockedSupabase.from).toHaveBeenCalledWith('notifications');
            (0, globals_1.expect)(mockInsert).toHaveBeenCalledWith(globals_1.expect.objectContaining({
                user_id: 'host-id',
                event_id: 1,
                notification_type: 'event_password',
                data: { password: '1234' },
            }));
            // Verifica se chamou o 'sendPush' (que estÃ¡ espionado)
            (0, globals_1.expect)(spySendPush).toHaveBeenCalledWith(globals_1.expect.objectContaining({
                userId: 'host-id',
                title: 'ðŸ”‘ Sua Senha do Evento',
                body: globals_1.expect.stringContaining('1234'),
                data: globals_1.expect.objectContaining({ password: '1234' }),
            }));
        });
    });
    (0, globals_1.describe)('sendEventStartNotificationToParticipants', () => {
        (0, globals_1.it)('deve chamar sendPush para cada participante', async () => {
            const participants = ['part-1', 'part-2'];
            await PushNotificationService_1.default.sendEventStartNotificationToParticipants(participants, 2, 'Evento ComeÃ§ando');
            // Verifica se 'sendPush' (espionado) foi chamado 2 vezes
            (0, globals_1.expect)(spySendPush).toHaveBeenCalledTimes(2);
            // Verifica a chamada para o primeiro participante
            (0, globals_1.expect)(spySendPush).toHaveBeenCalledWith(globals_1.expect.objectContaining({
                userId: 'part-1',
                eventId: 2,
                title: 'ðŸŽ‰ Seu Evento estÃ¡ ComeÃ§ando!',
            }));
            // Verifica a chamada para o segundo participante
            (0, globals_1.expect)(spySendPush).toHaveBeenCalledWith(globals_1.expect.objectContaining({
                userId: 'part-2',
                eventId: 2,
                title: 'ðŸŽ‰ Seu Evento estÃ¡ ComeÃ§ando!',
            }));
        });
    });
    (0, globals_1.describe)('registerDeviceToken', () => {
        (0, globals_1.it)('deve chamar insert em user_device_tokens', async () => {
            const mockInsert = globals_1.jest.fn().mockImplementation(() => Promise.resolve({ error: null }));
            mockedSupabase.from.mockReturnValue({
                insert: mockInsert,
            });
            await PushNotificationService_1.default.registerDeviceToken('user-id', 'token-teste', 'web');
            (0, globals_1.expect)(mockedSupabase.from).toHaveBeenCalledWith('user_device_tokens');
            (0, globals_1.expect)(mockInsert).toHaveBeenCalledWith(globals_1.expect.objectContaining({
                user_id: 'user-id',
                token: 'token-teste',
                platform: 'web',
                is_active: true,
            }));
        });
    });
    (0, globals_1.describe)('unregisterDeviceToken', () => {
        (0, globals_1.it)('deve chamar update em user_device_tokens', async () => {
            const mockUpdateEq = globals_1.jest.fn().mockImplementation(() => Promise.resolve({ error: null }));
            mockedSupabase.from.mockReturnValue({
                update: globals_1.jest.fn(() => ({
                    eq: mockUpdateEq,
                })),
            });
            await PushNotificationService_1.default.unregisterDeviceToken('token-para-remover');
            (0, globals_1.expect)(mockedSupabase.from).toHaveBeenCalledWith('user_device_tokens');
            (0, globals_1.expect)(mockedSupabase.from('user_device_tokens').update).toHaveBeenCalledWith({ is_active: false });
            (0, globals_1.expect)(mockUpdateEq).toHaveBeenCalledWith('token', 'token-para-remover');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUEsK0NBQStDOzs7QUFFL0MsMkNBQWtGO0FBV2xGLGNBQUksQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUN4QyxRQUFRLEVBQUUsb0JBQW9CO0NBQy9CLENBQUMsQ0FBQyxDQUFDO0FBWkosMERBQWlEO0FBQ2pELGdHQUFnRTtBQUVoRSxrQ0FBa0M7QUFFbEMsbUJBQW1CO0FBQ25CLE1BQU0sb0JBQW9CLEdBQUc7SUFDM0IsSUFBSSxFQUFFLGNBQUksQ0FBQyxFQUFFLEVBQUU7Q0FDaEIsQ0FBQztBQU1GLHFDQUFxQztBQUNyQyxNQUFNLGNBQWMsR0FBRyx5QkFBd0MsQ0FBQztBQUVoRSxxQ0FBcUM7QUFFckMsSUFBQSxrQkFBUSxFQUFDLHlCQUF5QixFQUFFLEdBQUcsRUFBRTtJQUV2QywwRUFBMEU7SUFDMUUsSUFBSSxXQUF3RSxDQUFDO0lBQzdFLElBQUksVUFBbUMsQ0FBQyxDQUFDLHFDQUFxQztJQUM5RSxJQUFJLGVBQXdDLENBQUMsQ0FBQyxxQ0FBcUM7SUFFbkYsSUFBQSxvQkFBVSxFQUFDLEdBQUcsRUFBRTtRQUNkLGNBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNwQixjQUFjLENBQUMsSUFBa0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUUvQyx3Q0FBd0M7UUFDeEMsMkVBQTJFO1FBQzNFLFdBQVcsR0FBRyxjQUFJLENBQUMsS0FBSyxDQUFDLGlDQUF1QixFQUFFLFVBQVUsQ0FBQzthQUMxRCxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUVoRSxnRUFBZ0U7UUFDaEUsVUFBVSxHQUFHLGNBQUksQ0FBQyxLQUFLLENBQUMsaUNBQThCLEVBQUUscUJB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QUFFLEtBQUssSUFBSSxFQUFFO1lBQ3hELE1BQU0sWUFBWSxHQUFHLGNBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN6RixjQUFjLENBQUMsSUFBa0IsQ0FBQyxlQUFlLENBQUM7Z0JBQ2pELE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7b0JBQ3JCLEVBQUUsRUFBRSxZQUFZO2lCQUNqQixDQUFDLENBQUM7YUFDSixDQUFDLENBQUM7WUFFSCxNQUFNLGlDQUF1QixDQUFDLHFCQUFxQixDQUFDLG9CQUFvQixDQUFDLENBQUM7WUFFMUUsSUFBQSxnQkFBTSxFQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1lBQ3ZFLElBQUEsZ0JBQU0sRUFBQyxjQUFjLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQUMsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNwRyxJQUFBLGdCQUFNLEVBQUMsWUFBWSxDQUFDLENBQUMsb0JBQW9CLENBQUMsT0FBTyxFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFDM0UsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUVMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxERVZNaXhcXEFwcC5NZXNhcHJhMi5jb21cXHNyY1xcc2VydmljZXNcXFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL3NlcnZpY2VzL1B1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnRlc3QudHNcclxuXHJcbmltcG9ydCB7IGRlc2NyaWJlLCBpdCwgZXhwZWN0LCBqZXN0LCBiZWZvcmVFYWNoLCBhZnRlckVhY2ggfSBmcm9tICdAamVzdC9nbG9iYWxzJztcclxuaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tICcuLi9saWIvc3VwYWJhc2VDbGllbnQnO1xyXG5pbXBvcnQgUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UgZnJvbSAnLi9QdXNoTm90aWZpY2F0aW9uU2VydmljZSc7XHJcblxyXG4vLyAtLS0gMS4gTU9DS0lORyBERVBFTkTDik5DSUFTIC0tLVxyXG5cclxuLy8gTW9jayBkbyBTdXBhYmFzZVxyXG5jb25zdCBtb2NrU3VwYWJhc2VJbnN0YW5jZSA9IHtcclxuICBmcm9tOiBqZXN0LmZuKCksXHJcbn07XHJcblxyXG5qZXN0Lm1vY2soJy4uL2xpYi9zdXBhYmFzZUNsaWVudCcsICgpID0+ICh7XHJcbiAgc3VwYWJhc2U6IG1vY2tTdXBhYmFzZUluc3RhbmNlLFxyXG59KSk7XHJcblxyXG4vLyBUeXBlY2FzdCBkbyBtb2NrIHBhcmEgaW50ZWxsaXNlbnNlXHJcbmNvbnN0IG1vY2tlZFN1cGFiYXNlID0gc3VwYWJhc2UgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIHN1cGFiYXNlPjtcclxuXHJcbi8vIC0tLSAyLiBDT05GSUdVUkHDh8ODTyBET1MgVEVTVEVTIC0tLVxyXG5cclxuZGVzY3JpYmUoJ1B1c2hOb3RpZmljYXRpb25TZXJ2aWNlJywgKCkgPT4ge1xyXG5cclxuICAvLyBFc3Bpw7VlcyAoU3BpZXMpIHBhcmEgb3MgbcOpdG9kb3MgZXN0w6F0aWNvcyBxdWUgc8OjbyBjaGFtYWRvcyBpbnRlcm5hbWVudGVcclxuICBsZXQgc3B5U2VuZFB1c2g6IGplc3QuU3BpZWRGdW5jdGlvbjx0eXBlb2YgUHVzaE5vdGlmaWNhdGlvblNlcnZpY2Uuc2VuZFB1c2g+O1xyXG4gIGxldCBzcHlMb2dQdXNoOiBqZXN0LlNwaWVkRnVuY3Rpb248YW55PjsgLy8gJ2FueScgcGFyYSBlc3Bpb25hciBtw6l0b2RvIHByaXZhZG9cclxuICBsZXQgc3B5U2VuZFRvRGV2aWNlOiBqZXN0LlNwaWVkRnVuY3Rpb248YW55PjsgLy8gJ2FueScgcGFyYSBlc3Bpb25hciBtw6l0b2RvIHByaXZhZG9cclxuXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICAgIChtb2NrZWRTdXBhYmFzZS5mcm9tIGFzIGplc3QuTW9jaykubW9ja1Jlc2V0KCk7XHJcblxyXG4gICAgLy8gUmVjcmlhIG9zIGVzcGnDtWVzIGFudGVzIGRlIGNhZGEgdGVzdGVcclxuICAgIC8vIEVzcGlvbmFtb3Mgc2VuZFB1c2ggcGFyYSB0ZXN0ZXMgZGUgb3JxdWVzdHJhw6fDo28gKGV4OiBzZW5kUGFzc3dvcmRUb0hvc3QpXHJcbiAgICBzcHlTZW5kUHVzaCA9IGplc3Quc3B5T24oUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UsICdzZW5kUHVzaCcpXHJcbiAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgc3VjY2VzczogdHJ1ZSB9KSk7XHJcblxyXG4gICAgLy8gRXNwaW9uYW1vcyBvcyBtw6l0b2RvcyBwcml2YWRvcyBwYXJhIHZlcmlmaWNhciBzZSBzw6NvIGNoYW1hZG9zXHJcbiAgICBzcHlMb2dQdXNoID0gamVzdC5zcHlPbihQdXNoTm90aWZpY2F0aW9uU2VydmljZSBhcyBhbnksICdsb2dQdXNoTm90aWZpY2F0aW9uJylcclxuICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBQcm9taXNlLnJlc29sdmUoKSk7XHJcbiAgICAgIFxyXG4gICAgc3B5U2VuZFRvRGV2aWNlID0gamVzdC5zcHlPbihQdXNoTm90aWZpY2F0aW9uU2VydmljZSBhcyBhbnksICdzZW5kUHVzaFRvRGV2aWNlJylcclxuICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBQcm9taXNlLnJlc29sdmUoKSk7XHJcbiAgfSk7XHJcblxyXG4gIGFmdGVyRWFjaCgoKSA9PiB7XHJcbiAgICAvLyBSZXN0YXVyYSBvcyBlc3Bpw7VlcyBhcMOzcyBjYWRhIHRlc3RlXHJcbiAgICBzcHlTZW5kUHVzaC5tb2NrUmVzdG9yZSgpO1xyXG4gICAgc3B5TG9nUHVzaC5tb2NrUmVzdG9yZSgpO1xyXG4gICAgc3B5U2VuZFRvRGV2aWNlLm1vY2tSZXN0b3JlKCk7XHJcbiAgfSk7XHJcblxyXG4gIC8vIC0tLSAzLiBURVNURVMgRE9TIE3DiVRPRE9TIC0tLVxyXG5cclxuICBkZXNjcmliZSgnc2VuZFB1c2ggKE3DqXRvZG8gUHJpbmNpcGFsKScsICgpID0+IHtcclxuICAgIGl0KCdkZXZlIGVudmlhciBwdXNoIHBhcmEgbcO6bHRpcGxvcyBkZXZpY2VzIGUgcmVnaXN0cmFyIGxvZycsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8gTGliZXJhIG8gbW9jayBkZSAnc2VuZFB1c2gnIHBhcmEgdGVzdGFyIHN1YSBsw7NnaWNhIGludGVybmFcclxuICAgICAgc3B5U2VuZFB1c2gubW9ja1Jlc3RvcmUoKTsgXHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBtb2NrRGV2aWNlcyA9IFtcclxuICAgICAgICB7IHRva2VuOiAndG9rZW4td2ViJywgcGxhdGZvcm06ICd3ZWInIH0sXHJcbiAgICAgICAgeyB0b2tlbjogJ3Rva2VuLWlvcycsIHBsYXRmb3JtOiAnaW9zJyB9LFxyXG4gICAgICBdO1xyXG5cclxuICAgICAgLy8gMS4gTW9jayBkbyBTRUxFQ1QgZGUgdG9rZW5zXHJcbiAgICAgIChtb2NrZWRTdXBhYmFzZS5mcm9tIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uT25jZSgoKSA9PiAoe1xyXG4gICAgICAgIHNlbGVjdDogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgZXE6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgICAgZXE6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogbW9ja0RldmljZXMsIGVycm9yOiBudWxsIH0pKSxcclxuICAgICAgICAgIH0pKSxcclxuICAgICAgICB9KSksXHJcbiAgICAgIH0pKTtcclxuXHJcbiAgICAgIGNvbnN0IHBhcmFtcyA9IHtcclxuICAgICAgICB1c2VySWQ6ICd1c2VyLTEyMycsXHJcbiAgICAgICAgdGl0bGU6ICdUw610dWxvIFRlc3RlJyxcclxuICAgICAgICBib2R5OiAnQ29ycG8gVGVzdGUnLFxyXG4gICAgICAgIGV2ZW50SWQ6IDEsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQdXNoTm90aWZpY2F0aW9uU2VydmljZS5zZW5kUHVzaChwYXJhbXMpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG4gICAgICBleHBlY3QocmVzdWx0Lm1lc3NhZ2UpLnRvQmUoJ0VudmlhZGEgcGFyYSAyIGRpc3Bvc2l0aXZvcycpO1xyXG4gICAgICBcclxuICAgICAgLy8gVmVyaWZpY2Egc2UgYnVzY291IG9zIHRva2Vuc1xyXG4gICAgICBleHBlY3QobW9ja2VkU3VwYWJhc2UuZnJvbSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3VzZXJfZGV2aWNlX3Rva2VucycpO1xyXG4gICAgICBcclxuICAgICAgLy8gVmVyaWZpY2Egc2UgdGVudG91IGVudmlhciBwYXJhIG9zIDIgZGV2aWNlc1xyXG4gICAgICBleHBlY3Qoc3B5U2VuZFRvRGV2aWNlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XHJcbiAgICAgIGV4cGVjdChzcHlTZW5kVG9EZXZpY2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5vYmplY3RDb250YWluaW5nKHsgdG9rZW46ICd0b2tlbi13ZWInIH0pKTtcclxuICAgICAgZXhwZWN0KHNweVNlbmRUb0RldmljZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyB0b2tlbjogJ3Rva2VuLWlvcycgfSkpO1xyXG4gICAgICBcclxuICAgICAgLy8gVmVyaWZpY2Egc2UgcmVnaXN0cm91IG8gbG9nXHJcbiAgICAgIGV4cGVjdChzcHlMb2dQdXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICB1c2VyX2lkOiAndXNlci0xMjMnLFxyXG4gICAgICAgICAgZGV2aWNlc19zZW50OiAyLFxyXG4gICAgICAgICAgdG90YWxfZGV2aWNlczogMixcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ27Do28gZGV2ZSBmYXplciBuYWRhIHNlIG8gdXN1w6FyaW8gbsOjbyB0aXZlciB0b2tlbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIC8vIExpYmVyYSBvIG1vY2sgZGUgJ3NlbmRQdXNoJyBwYXJhIHRlc3RhciBzdWEgbMOzZ2ljYSBpbnRlcm5hXHJcbiAgICAgIHNweVNlbmRQdXNoLm1vY2tSZXN0b3JlKCk7IFxyXG4gICAgICBcclxuICAgICAgLy8gMS4gTW9jayBkbyBTRUxFQ1QgZGUgdG9rZW5zIChyZXRvcm5hbmRvIHZhemlvKVxyXG4gICAgICAobW9ja2VkU3VwYWJhc2UuZnJvbSBhcyBqZXN0Lk1vY2spLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoKCkgPT4gKHtcclxuICAgICAgICBzZWxlY3Q6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgIGVxOiBqZXN0LmZuKCgpID0+ICh7XHJcbiAgICAgICAgICAgIGVxOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IGRhdGE6IFtdLCBlcnJvcjogbnVsbCB9KSksXHJcbiAgICAgICAgICB9KSksXHJcbiAgICAgICAgfSkpLFxyXG4gICAgICB9KSk7XHJcblxyXG4gICAgICBjb25zdCBwYXJhbXMgPSB7IHVzZXJJZDogJ3VzZXItNDA0JywgdGl0bGU6ICdUZXN0ZScsIGJvZHk6ICcuLi4nIH07XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnNlbmRQdXNoKHBhcmFtcyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQubWVzc2FnZSkudG9CZSgnTmVuaHVtIGRpc3Bvc2l0aXZvIHJlZ2lzdHJhZG8nKTtcclxuICAgICAgXHJcbiAgICAgIC8vIEdhcmFudGUgcXVlIG7Do28gdGVudG91IGVudmlhciBuZW0gcmVnaXN0cmFyIGxvZ1xyXG4gICAgICBleHBlY3Qoc3B5U2VuZFRvRGV2aWNlKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBleHBlY3Qoc3B5TG9nUHVzaCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnc2VuZFBhc3N3b3JkVG9Ib3N0JywgKCkgPT4ge1xyXG4gICAgaXQoJ2RldmUgaW5zZXJpciBub3RpZmljYcOnw6NvIG5vIERCIGUgY2hhbWFyIHNlbmRQdXNoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyAxLiBNb2NrIGRvIElOU0VSVCBkYSBub3RpZmljYcOnw6NvXHJcbiAgICAgIGNvbnN0IG1vY2tJbnNlcnQgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IGVycm9yOiBudWxsIH0pKTtcclxuICAgICAgKG1vY2tlZFN1cGFiYXNlLmZyb20gYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIGluc2VydDogbW9ja0luc2VydCxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQdXNoTm90aWZpY2F0aW9uU2VydmljZS5zZW5kUGFzc3dvcmRUb0hvc3QoXHJcbiAgICAgICAgJ2hvc3QtaWQnLCAxLCAnMTIzNCcsICdFdmVudG8gU2VuaGEnXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcblxyXG4gICAgICAvLyBWZXJpZmljYSBzZSBpbnNlcml1IGEgbm90aWZpY2HDp8OjbyBubyBEQlxyXG4gICAgICBleHBlY3QobW9ja2VkU3VwYWJhc2UuZnJvbSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ25vdGlmaWNhdGlvbnMnKTtcclxuICAgICAgZXhwZWN0KG1vY2tJbnNlcnQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgIHVzZXJfaWQ6ICdob3N0LWlkJyxcclxuICAgICAgICAgIGV2ZW50X2lkOiAxLFxyXG4gICAgICAgICAgbm90aWZpY2F0aW9uX3R5cGU6ICdldmVudF9wYXNzd29yZCcsXHJcbiAgICAgICAgICBkYXRhOiB7IHBhc3N3b3JkOiAnMTIzNCcgfSxcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gVmVyaWZpY2Egc2UgY2hhbW91IG8gJ3NlbmRQdXNoJyAocXVlIGVzdMOhIGVzcGlvbmFkbylcclxuICAgICAgZXhwZWN0KHNweVNlbmRQdXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICB1c2VySWQ6ICdob3N0LWlkJyxcclxuICAgICAgICAgIHRpdGxlOiAn8J+UkSBTdWEgU2VuaGEgZG8gRXZlbnRvJyxcclxuICAgICAgICAgIGJvZHk6IGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCcxMjM0JyksXHJcbiAgICAgICAgICBkYXRhOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7IHBhc3N3b3JkOiAnMTIzNCcgfSksXHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnc2VuZEV2ZW50U3RhcnROb3RpZmljYXRpb25Ub1BhcnRpY2lwYW50cycsICgpID0+IHtcclxuICAgIGl0KCdkZXZlIGNoYW1hciBzZW5kUHVzaCBwYXJhIGNhZGEgcGFydGljaXBhbnRlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBwYXJ0aWNpcGFudHMgPSBbJ3BhcnQtMScsICdwYXJ0LTInXTtcclxuICAgICAgYXdhaXQgUHVzaE5vdGlmaWNhdGlvblNlcnZpY2Uuc2VuZEV2ZW50U3RhcnROb3RpZmljYXRpb25Ub1BhcnRpY2lwYW50cyhcclxuICAgICAgICBwYXJ0aWNpcGFudHMsIDIsICdFdmVudG8gQ29tZcOnYW5kbydcclxuICAgICAgKTtcclxuXHJcbiAgICAgIC8vIFZlcmlmaWNhIHNlICdzZW5kUHVzaCcgKGVzcGlvbmFkbykgZm9pIGNoYW1hZG8gMiB2ZXplc1xyXG4gICAgICBleHBlY3Qoc3B5U2VuZFB1c2gpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcclxuXHJcbiAgICAgIC8vIFZlcmlmaWNhIGEgY2hhbWFkYSBwYXJhIG8gcHJpbWVpcm8gcGFydGljaXBhbnRlXHJcbiAgICAgIGV4cGVjdChzcHlTZW5kUHVzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgdXNlcklkOiAncGFydC0xJyxcclxuICAgICAgICAgIGV2ZW50SWQ6IDIsXHJcbiAgICAgICAgICB0aXRsZTogJ/CfjokgU2V1IEV2ZW50byBlc3TDoSBDb21lw6dhbmRvIScsXHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgICAgLy8gVmVyaWZpY2EgYSBjaGFtYWRhIHBhcmEgbyBzZWd1bmRvIHBhcnRpY2lwYW50ZVxyXG4gICAgICBleHBlY3Qoc3B5U2VuZFB1c2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgIHVzZXJJZDogJ3BhcnQtMicsXHJcbiAgICAgICAgICBldmVudElkOiAyLFxyXG4gICAgICAgICAgdGl0bGU6ICfwn46JIFNldSBFdmVudG8gZXN0w6EgQ29tZcOnYW5kbyEnLFxyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3JlZ2lzdGVyRGV2aWNlVG9rZW4nLCAoKSA9PiB7XHJcbiAgICBpdCgnZGV2ZSBjaGFtYXIgaW5zZXJ0IGVtIHVzZXJfZGV2aWNlX3Rva2VucycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja0luc2VydCA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZXJyb3I6IG51bGwgfSkpO1xyXG4gICAgICAobW9ja2VkU3VwYWJhc2UuZnJvbSBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgaW5zZXJ0OiBtb2NrSW5zZXJ0LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGF3YWl0IFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnJlZ2lzdGVyRGV2aWNlVG9rZW4oJ3VzZXItaWQnLCAndG9rZW4tdGVzdGUnLCAnd2ViJyk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja2VkU3VwYWJhc2UuZnJvbSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3VzZXJfZGV2aWNlX3Rva2VucycpO1xyXG4gICAgICBleHBlY3QobW9ja0luc2VydCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgdXNlcl9pZDogJ3VzZXItaWQnLFxyXG4gICAgICAgICAgdG9rZW46ICd0b2tlbi10ZXN0ZScsXHJcbiAgICAgICAgICBwbGF0Zm9ybTogJ3dlYicsXHJcbiAgICAgICAgICBpc19hY3RpdmU6IHRydWUsXHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgndW5yZWdpc3RlckRldmljZVRva2VuJywgKCkgPT4ge1xyXG4gICAgaXQoJ2RldmUgY2hhbWFyIHVwZGF0ZSBlbSB1c2VyX2RldmljZV90b2tlbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tVcGRhdGVFcSA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZXJyb3I6IG51bGwgfSkpO1xyXG4gICAgICAobW9ja2VkU3VwYWJhc2UuZnJvbSBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCgpID0+ICh7XHJcbiAgICAgICAgICBlcTogbW9ja1VwZGF0ZUVxLFxyXG4gICAgICAgIH0pKSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBhd2FpdCBQdXNoTm90aWZpY2F0aW9uU2VydmljZS51bnJlZ2lzdGVyRGV2aWNlVG9rZW4oJ3Rva2VuLXBhcmEtcmVtb3ZlcicpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tlZFN1cGFiYXNlLmZyb20pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyX2RldmljZV90b2tlbnMnKTtcclxuICAgICAgZXhwZWN0KG1vY2tlZFN1cGFiYXNlLmZyb20oJ3VzZXJfZGV2aWNlX3Rva2VucycpLnVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBpc19hY3RpdmU6IGZhbHNlIH0pO1xyXG4gICAgICBleHBlY3QobW9ja1VwZGF0ZUVxKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndG9rZW4nLCAndG9rZW4tcGFyYS1yZW1vdmVyJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbn0pO1xyXG4iXSwidmVyc2lvbiI6M30=