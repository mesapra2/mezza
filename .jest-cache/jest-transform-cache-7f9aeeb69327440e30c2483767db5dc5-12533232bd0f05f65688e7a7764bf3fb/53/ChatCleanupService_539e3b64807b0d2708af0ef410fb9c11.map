{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\services\\ChatCleanupService.ts","mappings":"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","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\services\\ChatCleanupService.ts"],"sourcesContent":["// src/services/ChatCleanupService.ts\r\nimport { supabase } from '../lib/supabaseClient';\r\n\r\n/**\r\n * üóëÔ∏è Servi√ßo para limpeza autom√°tica de chats ap√≥s conclus√£o do evento\r\n * Deleta mensagens ap√≥s 180 dias do encerramento do evento\r\n */\r\nclass ChatCleanupService {\r\n  \r\n  /**\r\n   * üóëÔ∏è Limpa mensagens de eventos conclu√≠dos h√° 180+ dias\r\n   */\r\n  static async cleanupOldMessages(): Promise<{ deleted: number; error?: any }> {\r\n    let retries = 2;\r\n    \r\n    while (retries > 0) {\r\n      try {\r\n        // 1Ô∏è‚É£ Buscar eventos conclu√≠dos h√° 180+ dias\r\n        const now = new Date();\r\n        const cutoffDate = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);\r\n\r\n        const { data: oldEvents, error: eventError } = await supabase\r\n          .from('events')\r\n          .select('id, status, updated_at')\r\n          .eq('status', 'Conclu√≠do')\r\n          .lt('updated_at', cutoffDate.toISOString());\r\n\r\n        if (eventError) throw eventError;\r\n\r\n        if (!oldEvents || oldEvents.length === 0) {\r\n          console.log('‚úÖ Nenhuma mensagem antiga para limpar');\r\n          return { deleted: 0 };\r\n        }\r\n\r\n        console.log(`üóëÔ∏è Encontrados ${oldEvents.length} eventos para limpeza de mensagens`);\r\n\r\n        // 2Ô∏è‚É£ Deletar mensagens destes eventos\r\n        let totalDeleted = 0;\r\n\r\n        for (const event of oldEvents) {\r\n          const { data: messages, error: messagesError } = await supabase\r\n            .from('event_messages')\r\n            .select('id')\r\n            .eq('event_id', event.id);\r\n\r\n          if (messagesError) {\r\n            console.error(`‚ùå Erro ao buscar mensagens do evento ${event.id}:`, messagesError);\r\n            continue;\r\n          }\r\n\r\n          if (messages && messages.length > 0) {\r\n            const messageIds = messages.map(m => m.id);\r\n            \r\n            // Deletar em lotes de 100 para evitar timeouts\r\n            for (let i = 0; i < messageIds.length; i += 100) {\r\n              const batch = messageIds.slice(i, i + 100);\r\n              \r\n              const { error: deleteError } = await supabase\r\n                .from('event_messages')\r\n                .delete()\r\n                .in('id', batch);\r\n\r\n              if (deleteError) {\r\n                console.error(`‚ùå Erro ao deletar mensagens do evento ${event.id}:`, deleteError);\r\n              } else {\r\n                totalDeleted += batch.length;\r\n                console.log(`‚úÖ Deletadas ${batch.length} mensagens do evento ${event.id}`);\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        console.log(`‚úÖ Limpeza conclu√≠da: ${totalDeleted} mensagens deletadas`);\r\n        return { deleted: totalDeleted };\r\n\r\n      } catch (error) {\r\n        retries--;\r\n        if (retries === 0) {\r\n          console.error('‚ùå Erro ao limpar mensagens antigas ap√≥s 2 tentativas:', error);\r\n          return { deleted: 0, error };\r\n        } else {\r\n          console.warn(`‚ö†Ô∏è Erro ao limpar mensagens. Tentando novamente... (${retries} tentativas restantes)`);\r\n          await new Promise(resolve => setTimeout(resolve, 2000));\r\n        }\r\n      }\r\n    }\r\n\r\n    return { deleted: 0, error: 'Falha ao limpar mensagens' };\r\n  }\r\n\r\n  /**\r\n   * ‚è∞ Inicia limpeza autom√°tica a cada 24 horas\r\n   */\r\n  static startAutoCleanup(): number {\r\n    console.log('üïê Iniciando limpeza autom√°tica de mensagens...');\r\n    \r\n    // Executar imediatamente\r\n    this.cleanupOldMessages();\r\n\r\n    // Executar a cada 24 horas\r\n    const intervalId = setInterval(() => {\r\n      console.log('üïê Executando limpeza autom√°tica de mensagens...');\r\n      this.cleanupOldMessages();\r\n    }, 24 * 60 * 60 * 1000);\r\n\r\n    return intervalId as unknown as number;\r\n  }\r\n\r\n  /**\r\n   * ‚èπÔ∏è Para a limpeza autom√°tica\r\n   */\r\n  static stopAutoCleanup(intervalId: number): void {\r\n    if (intervalId) {\r\n      clearInterval(intervalId);\r\n      console.log('‚èπÔ∏è Limpeza autom√°tica parada');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üóëÔ∏è For√ßa limpeza imediata (para testes)\r\n   */\r\n  static async forceCleanup(): Promise<{ deleted: number; error?: any }> {\r\n    console.log('üîÑ For√ßando limpeza imediata...');\r\n    return this.cleanupOldMessages();\r\n  }\r\n}\r\n\r\nexport default ChatCleanupService;"],"version":3}