5f539a2ab94cbf921c11ef8ad23e1b74
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// src/services/PushNotificationService.ts
const supabaseClient_1 = require("../lib/supabaseClient");
/**
 * üì≤ Servi√ßo de Notifica√ß√µes Push
 * Gerencia envio de notifica√ß√µes para web e mobile
 */
class PushNotificationService {
    /**
     * üì≤ Envia push gen√©rica para usu√°rio
     * @param params - Par√¢metros da notifica√ß√£o
     */
    static async sendPush(params) {
        try {
            const { userId, title, body, data, eventId } = params;
            // üîç Buscar tokens de push do usu√°rio
            const { data: deviceTokens, error: tokenError } = await supabaseClient_1.supabase
                .from('user_device_tokens')
                .select('token, platform')
                .eq('user_id', userId)
                .eq('is_active', true);
            if (tokenError) {
                console.warn('‚ö†Ô∏è Erro ao buscar tokens de dispositivo:', tokenError);
                return { success: true, message: 'Push registrada (sem devices)' };
            }
            if (!deviceTokens || deviceTokens.length === 0) {
                console.log(`‚ö†Ô∏è Usu√°rio ${userId} n√£o tem devices registrados`);
                return { success: true, message: 'Nenhum dispositivo registrado' };
            }
            // üì§ Enviar para cada device
            let sentCount = 0;
            for (const device of deviceTokens) {
                try {
                    await this.sendPushToDevice({
                        token: device.token,
                        platform: device.platform,
                        title,
                        body,
                        data,
                        eventId
                    });
                    sentCount++;
                }
                catch (deviceError) {
                    console.error('‚ùå Erro ao enviar push para device:', deviceError);
                }
            }
            // üìä Registrar envio de notifica√ß√£o
            await this.logPushNotification({
                user_id: userId,
                title,
                body,
                event_id: eventId,
                devices_sent: sentCount,
                total_devices: deviceTokens.length
            });
            console.log(`‚úÖ Push enviada para ${sentCount}/${deviceTokens.length} devices do usu√°rio ${userId}`);
            return { success: true, message: `Enviada para ${sentCount} dispositivos` };
        }
        catch (error) {
            console.error('‚ùå Erro ao enviar push:', error);
            return { success: false, error };
        }
    }
    /**
     * üéÅ Envia push para ANFITRI√ÉO com a SENHA
     * @param hostId - ID do anfitri√£o
     * @param eventId - ID do evento
     * @param password - Senha de 4 d√≠gitos
     * @param eventTitle - T√≠tulo do evento
     */
    static async sendPasswordToHost(hostId, eventId, password, eventTitle) {
        try {
            console.log(`üî® Enviando senha para anfitri√£o ${hostId}`);
            const title = 'üîë Sua Senha do Evento';
            const body = `Evento "${eventTitle}" vai come√ßar em 1 minuto. Compartilhe a senha: ${password}`;
            // üÜï IMPORTANTE: Criar notifica√ß√£o no banco com data.password
            const { error: notifError } = await supabaseClient_1.supabase
                .from('notifications')
                .insert({
                user_id: hostId,
                event_id: eventId,
                notification_type: 'event_password',
                title,
                message: body,
                data: { password },
                sent: false,
                created_at: new Date().toISOString()
            });
            if (notifError) {
                console.error('‚ùå Erro ao criar notifica√ß√£o:', notifError);
            }
            return this.sendPush({
                userId: hostId,
                title,
                body,
                data: {
                    type: 'event_password',
                    password,
                    action: 'show_password'
                },
                eventId
            });
        }
        catch (error) {
            console.error('‚ùå Erro ao enviar senha para anfitri√£o:', error);
            return { success: false, error };
        }
    }
    /**
     * üé¨ Envia push para PARTICIPANTES (gen√©rica, sem senha)
     * @param participantIds - Array com IDs dos participantes
     * @param eventId - ID do evento
     * @param eventTitle - T√≠tulo do evento
     */
    static async sendEventStartNotificationToParticipants(participantIds, eventId, eventTitle) {
        try {
            console.log(`üî® Enviando notifica√ß√£o de in√≠cio para ${participantIds.length} participantes`);
            const title = 'üéâ Seu Evento est√° Come√ßando!';
            const body = `"${eventTitle}" come√ßa em 1 minuto. Digite a senha para entrar!`;
            let successCount = 0;
            const errors = [];
            for (const participantId of participantIds) {
                try {
                    const result = await this.sendPush({
                        userId: participantId,
                        title,
                        body,
                        data: {
                            type: 'event_start',
                            action: 'open_event_entry'
                        },
                        eventId
                    });
                    if (result.success)
                        successCount++;
                    else
                        errors.push({ participantId, error: result.error });
                }
                catch (error) {
                    errors.push({ participantId, error });
                }
            }
            console.log(`‚úÖ Notifica√ß√µes enviadas: ${successCount}/${participantIds.length}`);
            if (errors.length > 0) {
                console.warn(`‚ö†Ô∏è Erros ao enviar para ${errors.length} participantes`);
            }
            return {
                success: successCount > 0,
                message: `Enviada para ${successCount}/${participantIds.length} participantes`,
                error: errors.length > 0 ? errors : undefined
            };
        }
        catch (error) {
            console.error('‚ùå Erro ao enviar notifica√ß√£o de in√≠cio:', error);
            return { success: false, error };
        }
    }
    /**
     * üö® Envia push para ANFITRI√ÉO quando evento est√° prestes a terminar
     * @param hostId - ID do anfitri√£o
     * @param eventId - ID do evento
     * @param eventTitle - T√≠tulo do evento
     */
    static async sendEventEndingNotification(hostId, eventId, eventTitle) {
        try {
            const title = '‚è∞ Seu Evento est√° Terminando';
            const body = `"${eventTitle}" vai terminar em 2 minutos. Prepare-se!`;
            return this.sendPush({
                userId: hostId,
                title,
                body,
                data: {
                    type: 'event_ending',
                    action: 'show_event_details'
                },
                eventId
            });
        }
        catch (error) {
            console.error('‚ùå Erro ao enviar notifica√ß√£o de fim:', error);
            return { success: false, error };
        }
    }
    /**
     * üîî Envia notifica√ß√£o para TEST (validar se funciona)
     */
    static async sendTestNotification(userId) {
        try {
            return this.sendPush({
                userId,
                title: '‚úÖ Teste de Notifica√ß√£o',
                body: 'Se voc√™ recebeu isto, as notifica√ß√µes push est√£o funcionando!',
                data: { type: 'test' }
            });
        }
        catch (error) {
            console.error('‚ùå Erro ao enviar notifica√ß√£o de teste:', error);
            return { success: false, error };
        }
    }
    /**
     * üì£ Envia push para m√∫ltiplos usu√°rios com mesma mensagem
     */
    static async sendBroadcast(userIds, title, body, data) {
        try {
            console.log(`üì¢ Enviando broadcast para ${userIds.length} usu√°rios`);
            let successCount = 0;
            const errors = [];
            for (const userId of userIds) {
                try {
                    const result = await this.sendPush({
                        userId,
                        title,
                        body,
                        data
                    });
                    if (result.success)
                        successCount++;
                    else
                        errors.push({ userId, error: result.error });
                }
                catch (error) {
                    errors.push({ userId, error });
                }
            }
            return {
                success: successCount > 0,
                message: `Broadcast enviado para ${successCount}/${userIds.length}`,
                error: errors.length > 0 ? errors : undefined
            };
        }
        catch (error) {
            console.error('‚ùå Erro ao enviar broadcast:', error);
            return { success: false, error };
        }
    }
    /**
     * üîß M√©todo PRIVADO: Enviar para um device espec√≠fico
     */
    static async sendPushToDevice(params) {
        const { token, platform, title, body } = params;
        console.log(`üì§ Enviando para ${platform} device:`, {
            token: token.substring(0, 10) + '...',
            title,
            body
        });
        // Placeholder - ser√° implementado com FCM
        if (platform === 'web') {
            console.log('üíª Web Push (placeholder)');
        }
        else if (platform === 'android' || platform === 'ios') {
            console.log('üì± FCM (placeholder)');
        }
    }
    /**
     * üìä Registra a notifica√ß√£o enviada
     */
    static async logPushNotification(params) {
        try {
            await supabaseClient_1.supabase.from('push_notification_logs').insert({
                user_id: params.user_id,
                title: params.title,
                body: params.body,
                event_id: params.event_id,
                devices_sent: params.devices_sent,
                total_devices: params.total_devices,
                created_at: new Date().toISOString()
            });
        }
        catch (error) {
            console.warn('‚ö†Ô∏è Erro ao registrar log de notifica√ß√£o:', error);
        }
    }
    /**
     * üì± Registra token de dispositivo do usu√°rio
     */
    static async registerDeviceToken(userId, token, platform) {
        try {
            const { error } = await supabaseClient_1.supabase.from('user_device_tokens').insert({
                user_id: userId,
                token,
                platform,
                is_active: true,
                created_at: new Date().toISOString()
            });
            if (error)
                throw error;
            console.log(`‚úÖ Device token registrado para ${userId} (${platform})`);
            return { success: true, message: 'Device registrado com sucesso' };
        }
        catch (error) {
            console.error('‚ùå Erro ao registrar device token:', error);
            return { success: false, error };
        }
    }
    /**
     * üóëÔ∏è Remove token de dispositivo (logout)
     */
    static async unregisterDeviceToken(token) {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('user_device_tokens')
                .update({ is_active: false })
                .eq('token', token);
            if (error)
                throw error;
            console.log('‚úÖ Device token removido');
            return { success: true, message: 'Device removido com sucesso' };
        }
        catch (error) {
            console.error('‚ùå Erro ao remover device token:', error);
            return { success: false, error };
        }
    }
}
exports.default = PushNotificationService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSwwQ0FBMEM7QUFDMUMsMERBQWlEO0FBZ0JqRDs7O0dBR0c7QUFDSCxNQUFNLHVCQUF1QjtJQUMzQjs7O09BR0c7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUE4QjtRQUNsRCxJQUFJLENBQUM7WUFDSCxNQUFNLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxHQUFHLE1BQU0sQ0FBQztZQUV0RCxzQ0FBc0M7WUFDdEMsTUFBTSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxHQUFHLE1BQU0seUJBQVE7aUJBQzdELElBQUksQ0FBQyxvQkFBb0IsQ0FBQztpQkFDMUIsTUFBTSxDQUFDLGlCQUFpQixDQUFDO2lCQUN6QixFQUFFLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQztpQkFDckIsRUFBRSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUV6QixJQUFJLFVBQVUsRUFBRSxDQUFDO2dCQUNmLE9BQU8sQ0FBQyxJQUFJLENBQUMsMENBQTBDLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBQ3JFLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxDQUFDO1lBQ3JFLENBQUM7WUFFRCxJQUFJLENBQUMsWUFBWSxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQy9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxNQUFNLDhCQUE4QixDQUFDLENBQUM7Z0JBQ2hFLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxDQUFDO1lBQ3JFLENBQUM7WUFFRCw2QkFBNkI7WUFDN0IsSUFBSSxTQUFTLEdBQUcs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a0JBQWUsdUJBQXVCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL3NlcnZpY2VzL1B1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnRzXHJcbmltcG9ydCB7IHN1cGFiYXNlIH0gZnJvbSAnLi4vbGliL3N1cGFiYXNlQ2xpZW50JztcclxuXHJcbmludGVyZmFjZSBQdXNoTm90aWZpY2F0aW9uUGFyYW1zIHtcclxuICB1c2VySWQ6IHN0cmluZztcclxuICB0aXRsZTogc3RyaW5nO1xyXG4gIGJvZHk6IHN0cmluZztcclxuICBkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PjtcclxuICBldmVudElkPzogbnVtYmVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgU2VuZFB1c2hSZXN1bHQge1xyXG4gIHN1Y2Nlc3M6IGJvb2xlYW47XHJcbiAgbWVzc2FnZT86IHN0cmluZztcclxuICBlcnJvcj86IGFueTtcclxufVxyXG5cclxuLyoqXHJcbiAqIPCfk7IgU2VydmnDp28gZGUgTm90aWZpY2HDp8O1ZXMgUHVzaFxyXG4gKiBHZXJlbmNpYSBlbnZpbyBkZSBub3RpZmljYcOnw7VlcyBwYXJhIHdlYiBlIG1vYmlsZVxyXG4gKi9cclxuY2xhc3MgUHVzaE5vdGlmaWNhdGlvblNlcnZpY2Uge1xyXG4gIC8qKlxyXG4gICAqIPCfk7IgRW52aWEgcHVzaCBnZW7DqXJpY2EgcGFyYSB1c3XDoXJpb1xyXG4gICAqIEBwYXJhbSBwYXJhbXMgLSBQYXLDom1ldHJvcyBkYSBub3RpZmljYcOnw6NvXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIHNlbmRQdXNoKHBhcmFtczogUHVzaE5vdGlmaWNhdGlvblBhcmFtcyk6IFByb21pc2U8U2VuZFB1c2hSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgdXNlcklkLCB0aXRsZSwgYm9keSwgZGF0YSwgZXZlbnRJZCB9ID0gcGFyYW1zO1xyXG5cclxuICAgICAgLy8g8J+UjSBCdXNjYXIgdG9rZW5zIGRlIHB1c2ggZG8gdXN1w6FyaW9cclxuICAgICAgY29uc3QgeyBkYXRhOiBkZXZpY2VUb2tlbnMsIGVycm9yOiB0b2tlbkVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCd1c2VyX2RldmljZV90b2tlbnMnKVxyXG4gICAgICAgIC5zZWxlY3QoJ3Rva2VuLCBwbGF0Zm9ybScpXHJcbiAgICAgICAgLmVxKCd1c2VyX2lkJywgdXNlcklkKVxyXG4gICAgICAgIC5lcSgnaXNfYWN0aXZlJywgdHJ1ZSk7XHJcblxyXG4gICAgICBpZiAodG9rZW5FcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUud2Fybign4pqg77iPIEVycm8gYW8gYnVzY2FyIHRva2VucyBkZSBkaXNwb3NpdGl2bzonLCB0b2tlbkVycm9yKTtcclxuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiAnUHVzaCByZWdpc3RyYWRhIChzZW0gZGV2aWNlcyknIH07XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICghZGV2aWNlVG9rZW5zIHx8IGRldmljZVRva2Vucy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhg4pqg77iPIFVzdcOhcmlvICR7dXNlcklkfSBuw6NvIHRlbSBkZXZpY2VzIHJlZ2lzdHJhZG9zYCk7XHJcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ05lbmh1bSBkaXNwb3NpdGl2byByZWdpc3RyYWRvJyB9O1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDwn5OkIEVudmlhciBwYXJhIGNhZGEgZGV2aWNlXHJcbiAgICAgIGxldCBzZW50Q291bnQgPSAwO1xyXG4gICAgICBmb3IgKGNvbnN0IGRldmljZSBvZiBkZXZpY2VUb2tlbnMpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgYXdhaXQgdGhpcy5zZW5kUHVzaFRvRGV2aWNlKHtcclxuICAgICAgICAgICAgdG9rZW46IGRldmljZS50b2tlbixcclxuICAgICAgICAgICAgcGxhdGZvcm06IGRldmljZS5wbGF0Zm9ybSxcclxuICAgICAgICAgICAgdGl0bGUsXHJcbiAgICAgICAgICAgIGJvZHksXHJcbiAgICAgICAgICAgIGRhdGEsXHJcbiAgICAgICAgICAgIGV2ZW50SWRcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgc2VudENvdW50Kys7XHJcbiAgICAgICAgfSBjYXRjaCAoZGV2aWNlRXJyb3IpIHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGVudmlhciBwdXNoIHBhcmEgZGV2aWNlOicsIGRldmljZUVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIPCfk4ogUmVnaXN0cmFyIGVudmlvIGRlIG5vdGlmaWNhw6fDo29cclxuICAgICAgYXdhaXQgdGhpcy5sb2dQdXNoTm90aWZpY2F0aW9uKHtcclxuICAgICAgICB1c2VyX2lkOiB1c2VySWQsXHJcbiAgICAgICAgdGl0bGUsXHJcbiAgICAgICAgYm9keSxcclxuICAgICAgICBldmVudF9pZDogZXZlbnRJZCxcclxuICAgICAgICBkZXZpY2VzX3NlbnQ6IHNlbnRDb3VudCxcclxuICAgICAgICB0b3RhbF9kZXZpY2VzOiBkZXZpY2VUb2tlbnMubGVuZ3RoXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coYOKchSBQdXNoIGVudmlhZGEgcGFyYSAke3NlbnRDb3VudH0vJHtkZXZpY2VUb2tlbnMubGVuZ3RofSBkZXZpY2VzIGRvIHVzdcOhcmlvICR7dXNlcklkfWApO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiBgRW52aWFkYSBwYXJhICR7c2VudENvdW50fSBkaXNwb3NpdGl2b3NgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBlbnZpYXIgcHVzaDonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvciB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog8J+OgSBFbnZpYSBwdXNoIHBhcmEgQU5GSVRSScODTyBjb20gYSBTRU5IQVxyXG4gICAqIEBwYXJhbSBob3N0SWQgLSBJRCBkbyBhbmZpdHJpw6NvXHJcbiAgICogQHBhcmFtIGV2ZW50SWQgLSBJRCBkbyBldmVudG9cclxuICAgKiBAcGFyYW0gcGFzc3dvcmQgLSBTZW5oYSBkZSA0IGTDrWdpdG9zXHJcbiAgICogQHBhcmFtIGV2ZW50VGl0bGUgLSBUw610dWxvIGRvIGV2ZW50b1xyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBzZW5kUGFzc3dvcmRUb0hvc3QoXHJcbiAgICBob3N0SWQ6IHN0cmluZyxcclxuICAgIGV2ZW50SWQ6IG51bWJlcixcclxuICAgIHBhc3N3b3JkOiBzdHJpbmcsXHJcbiAgICBldmVudFRpdGxlOiBzdHJpbmdcclxuICApOiBQcm9taXNlPFNlbmRQdXNoUmVzdWx0PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zb2xlLmxvZyhg8J+UqCBFbnZpYW5kbyBzZW5oYSBwYXJhIGFuZml0cmnDo28gJHtob3N0SWR9YCk7XHJcblxyXG4gICAgICBjb25zdCB0aXRsZSA9ICfwn5SRIFN1YSBTZW5oYSBkbyBFdmVudG8nO1xyXG4gICAgICBjb25zdCBib2R5ID0gYEV2ZW50byBcIiR7ZXZlbnRUaXRsZX1cIiB2YWkgY29tZcOnYXIgZW0gMSBtaW51dG8uIENvbXBhcnRpbGhlIGEgc2VuaGE6ICR7cGFzc3dvcmR9YDtcclxuXHJcbiAgICAgIC8vIPCfhpUgSU1QT1JUQU5URTogQ3JpYXIgbm90aWZpY2HDp8OjbyBubyBiYW5jbyBjb20gZGF0YS5wYXNzd29yZFxyXG4gICAgICBjb25zdCB7IGVycm9yOiBub3RpZkVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCdub3RpZmljYXRpb25zJylcclxuICAgICAgICAuaW5zZXJ0KHtcclxuICAgICAgICAgIHVzZXJfaWQ6IGhvc3RJZCxcclxuICAgICAgICAgIGV2ZW50X2lkOiBldmVudElkLFxyXG4gICAgICAgICAgbm90aWZpY2F0aW9uX3R5cGU6ICdldmVudF9wYXNzd29yZCcsXHJcbiAgICAgICAgICB0aXRsZSxcclxuICAgICAgICAgIG1lc3NhZ2U6IGJvZHksXHJcbiAgICAgICAgICBkYXRhOiB7IHBhc3N3b3JkIH0sXHJcbiAgICAgICAgICBzZW50OiBmYWxzZSxcclxuICAgICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgaWYgKG5vdGlmRXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBjcmlhciBub3RpZmljYcOnw6NvOicsIG5vdGlmRXJyb3IpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gdGhpcy5zZW5kUHVzaCh7XHJcbiAgICAgICAgdXNlcklkOiBob3N0SWQsXHJcbiAgICAgICAgdGl0bGUsXHJcbiAgICAgICAgYm9keSxcclxuICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICB0eXBlOiAnZXZlbnRfcGFzc3dvcmQnLFxyXG4gICAgICAgICAgcGFzc3dvcmQsXHJcbiAgICAgICAgICBhY3Rpb246ICdzaG93X3Bhc3N3b3JkJ1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXZlbnRJZFxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGVudmlhciBzZW5oYSBwYXJhIGFuZml0cmnDo286JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3IgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCfjqwgRW52aWEgcHVzaCBwYXJhIFBBUlRJQ0lQQU5URVMgKGdlbsOpcmljYSwgc2VtIHNlbmhhKVxyXG4gICAqIEBwYXJhbSBwYXJ0aWNpcGFudElkcyAtIEFycmF5IGNvbSBJRHMgZG9zIHBhcnRpY2lwYW50ZXNcclxuICAgKiBAcGFyYW0gZXZlbnRJZCAtIElEIGRvIGV2ZW50b1xyXG4gICAqIEBwYXJhbSBldmVudFRpdGxlIC0gVMOtdHVsbyBkbyBldmVudG9cclxuICAgKi9cclxuICBzdGF0aWMgYXN5bmMgc2VuZEV2ZW50U3RhcnROb3RpZmljYXRpb25Ub1BhcnRpY2lwYW50cyhcclxuICAgIHBhcnRpY2lwYW50SWRzOiBzdHJpbmdbXSxcclxuICAgIGV2ZW50SWQ6IG51bWJlcixcclxuICAgIGV2ZW50VGl0bGU6IHN0cmluZ1xyXG4gICk6IFByb21pc2U8U2VuZFB1c2hSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDwn5SoIEVudmlhbmRvIG5vdGlmaWNhw6fDo28gZGUgaW7DrWNpbyBwYXJhICR7cGFydGljaXBhbnRJZHMubGVuZ3RofSBwYXJ0aWNpcGFudGVzYCk7XHJcblxyXG4gICAgICBjb25zdCB0aXRsZSA9ICfwn46JIFNldSBFdmVudG8gZXN0w6EgQ29tZcOnYW5kbyEnO1xyXG4gICAgICBjb25zdCBib2R5ID0gYFwiJHtldmVudFRpdGxlfVwiIGNvbWXDp2EgZW0gMSBtaW51dG8uIERpZ2l0ZSBhIHNlbmhhIHBhcmEgZW50cmFyIWA7XHJcblxyXG4gICAgICBsZXQgc3VjY2Vzc0NvdW50ID0gMDtcclxuICAgICAgY29uc3QgZXJyb3JzOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgICAgZm9yIChjb25zdCBwYXJ0aWNpcGFudElkIG9mIHBhcnRpY2lwYW50SWRzKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuc2VuZFB1c2goe1xyXG4gICAgICAgICAgICB1c2VySWQ6IHBhcnRpY2lwYW50SWQsXHJcbiAgICAgICAgICAgIHRpdGxlLFxyXG4gICAgICAgICAgICBib2R5LFxyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgdHlwZTogJ2V2ZW50X3N0YXJ0JyxcclxuICAgICAgICAgICAgICBhY3Rpb246ICdvcGVuX2V2ZW50X2VudHJ5J1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBldmVudElkXHJcbiAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHN1Y2Nlc3NDb3VudCsrO1xyXG4gICAgICAgICAgZWxzZSBlcnJvcnMucHVzaCh7IHBhcnRpY2lwYW50SWQsIGVycm9yOiByZXN1bHQuZXJyb3IgfSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgIGVycm9ycy5wdXNoKHsgcGFydGljaXBhbnRJZCwgZXJyb3IgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIE5vdGlmaWNhw6fDtWVzIGVudmlhZGFzOiAke3N1Y2Nlc3NDb3VudH0vJHtwYXJ0aWNpcGFudElkcy5sZW5ndGh9YCk7XHJcbiAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnNvbGUud2Fybihg4pqg77iPIEVycm9zIGFvIGVudmlhciBwYXJhICR7ZXJyb3JzLmxlbmd0aH0gcGFydGljaXBhbnRlc2ApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NDb3VudCA+IDAsXHJcbiAgICAgICAgbWVzc2FnZTogYEVudmlhZGEgcGFyYSAke3N1Y2Nlc3NDb3VudH0vJHtwYXJ0aWNpcGFudElkcy5sZW5ndGh9IHBhcnRpY2lwYW50ZXNgLFxyXG4gICAgICAgIGVycm9yOiBlcnJvcnMubGVuZ3RoID4gMCA/IGVycm9ycyA6IHVuZGVmaW5lZFxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gZW52aWFyIG5vdGlmaWNhw6fDo28gZGUgaW7DrWNpbzonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvciB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog8J+aqCBFbnZpYSBwdXNoIHBhcmEgQU5GSVRSScODTyBxdWFuZG8gZXZlbnRvIGVzdMOhIHByZXN0ZXMgYSB0ZXJtaW5hclxyXG4gICAqIEBwYXJhbSBob3N0SWQgLSBJRCBkbyBhbmZpdHJpw6NvXHJcbiAgICogQHBhcmFtIGV2ZW50SWQgLSBJRCBkbyBldmVudG9cclxuICAgKiBAcGFyYW0gZXZlbnRUaXRsZSAtIFTDrXR1bG8gZG8gZXZlbnRvXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIHNlbmRFdmVudEVuZGluZ05vdGlmaWNhdGlvbihcclxuICAgIGhvc3RJZDogc3RyaW5nLFxyXG4gICAgZXZlbnRJZDogbnVtYmVyLFxyXG4gICAgZXZlbnRUaXRsZTogc3RyaW5nXHJcbiAgKTogUHJvbWlzZTxTZW5kUHVzaFJlc3VsdD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdGl0bGUgPSAn4o+wIFNldSBFdmVudG8gZXN0w6EgVGVybWluYW5kbyc7XHJcbiAgICAgIGNvbnN0IGJvZHkgPSBgXCIke2V2ZW50VGl0bGV9XCIgdmFpIHRlcm1pbmFyIGVtIDIgbWludXRvcy4gUHJlcGFyZS1zZSFgO1xyXG5cclxuICAgICAgcmV0dXJuIHRoaXMuc2VuZFB1c2goe1xyXG4gICAgICAgIHVzZXJJZDogaG9zdElkLFxyXG4gICAgICAgIHRpdGxlLFxyXG4gICAgICAgIGJvZHksXHJcbiAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgdHlwZTogJ2V2ZW50X2VuZGluZycsXHJcbiAgICAgICAgICBhY3Rpb246ICdzaG93X2V2ZW50X2RldGFpbHMnXHJcbiAgICAgICAgfSxcclxuICAgICAgICBldmVudElkXHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gZW52aWFyIG5vdGlmaWNhw6fDo28gZGUgZmltOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDwn5SUIEVudmlhIG5vdGlmaWNhw6fDo28gcGFyYSBURVNUICh2YWxpZGFyIHNlIGZ1bmNpb25hKVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBzZW5kVGVzdE5vdGlmaWNhdGlvbih1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8U2VuZFB1c2hSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnNlbmRQdXNoKHtcclxuICAgICAgICB1c2VySWQsXHJcbiAgICAgICAgdGl0bGU6ICfinIUgVGVzdGUgZGUgTm90aWZpY2HDp8OjbycsXHJcbiAgICAgICAgYm9keTogJ1NlIHZvY8OqIHJlY2ViZXUgaXN0bywgYXMgbm90aWZpY2HDp8O1ZXMgcHVzaCBlc3TDo28gZnVuY2lvbmFuZG8hJyxcclxuICAgICAgICBkYXRhOiB7IHR5cGU6ICd0ZXN0JyB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gZW52aWFyIG5vdGlmaWNhw6fDo28gZGUgdGVzdGU6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3IgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCfk6MgRW52aWEgcHVzaCBwYXJhIG3Dumx0aXBsb3MgdXN1w6FyaW9zIGNvbSBtZXNtYSBtZW5zYWdlbVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBzZW5kQnJvYWRjYXN0KFxyXG4gICAgdXNlcklkczogc3RyaW5nW10sXHJcbiAgICB0aXRsZTogc3RyaW5nLFxyXG4gICAgYm9keTogc3RyaW5nLFxyXG4gICAgZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT5cclxuICApOiBQcm9taXNlPFNlbmRQdXNoUmVzdWx0PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zb2xlLmxvZyhg8J+ToiBFbnZpYW5kbyBicm9hZGNhc3QgcGFyYSAke3VzZXJJZHMubGVuZ3RofSB1c3XDoXJpb3NgKTtcclxuXHJcbiAgICAgIGxldCBzdWNjZXNzQ291bnQgPSAwO1xyXG4gICAgICBjb25zdCBlcnJvcnM6IGFueVtdID0gW107XHJcblxyXG4gICAgICBmb3IgKGNvbnN0IHVzZXJJZCBvZiB1c2VySWRzKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuc2VuZFB1c2goe1xyXG4gICAgICAgICAgICB1c2VySWQsXHJcbiAgICAgICAgICAgIHRpdGxlLFxyXG4gICAgICAgICAgICBib2R5LFxyXG4gICAgICAgICAgICBkYXRhXHJcbiAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHN1Y2Nlc3NDb3VudCsrO1xyXG4gICAgICAgICAgZWxzZSBlcnJvcnMucHVzaCh7IHVzZXJJZCwgZXJyb3I6IHJlc3VsdC5lcnJvciB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgZXJyb3JzLnB1c2goeyB1c2VySWQsIGVycm9yIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdWNjZXNzOiBzdWNjZXNzQ291bnQgPiAwLFxyXG4gICAgICAgIG1lc3NhZ2U6IGBCcm9hZGNhc3QgZW52aWFkbyBwYXJhICR7c3VjY2Vzc0NvdW50fS8ke3VzZXJJZHMubGVuZ3RofWAsXHJcbiAgICAgICAgZXJyb3I6IGVycm9ycy5sZW5ndGggPiAwID8gZXJyb3JzIDogdW5kZWZpbmVkXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBlbnZpYXIgYnJvYWRjYXN0OicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDwn5SnIE3DqXRvZG8gUFJJVkFETzogRW52aWFyIHBhcmEgdW0gZGV2aWNlIGVzcGVjw61maWNvXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgYXN5bmMgc2VuZFB1c2hUb0RldmljZShwYXJhbXM6IHtcclxuICAgIHRva2VuOiBzdHJpbmc7XHJcbiAgICBwbGF0Zm9ybTogc3RyaW5nO1xyXG4gICAgdGl0bGU6IHN0cmluZztcclxuICAgIGJvZHk6IHN0cmluZztcclxuICAgIGRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xyXG4gICAgZXZlbnRJZD86IG51bWJlcjtcclxuICB9KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCB7IHRva2VuLCBwbGF0Zm9ybSwgdGl0bGUsIGJvZHkgfSA9IHBhcmFtcztcclxuXHJcbiAgICBjb25zb2xlLmxvZyhg8J+TpCBFbnZpYW5kbyBwYXJhICR7cGxhdGZvcm19IGRldmljZTpgLCB7XHJcbiAgICAgIHRva2VuOiB0b2tlbi5zdWJzdHJpbmcoMCwgMTApICsgJy4uLicsXHJcbiAgICAgIHRpdGxlLFxyXG4gICAgICBib2R5XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBQbGFjZWhvbGRlciAtIHNlcsOhIGltcGxlbWVudGFkbyBjb20gRkNNXHJcbiAgICBpZiAocGxhdGZvcm0gPT09ICd3ZWInKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCfwn5K7IFdlYiBQdXNoIChwbGFjZWhvbGRlciknKTtcclxuICAgIH0gZWxzZSBpZiAocGxhdGZvcm0gPT09ICdhbmRyb2lkJyB8fCBwbGF0Zm9ybSA9PT0gJ2lvcycpIHtcclxuICAgICAgY29uc29sZS5sb2coJ/Cfk7EgRkNNIChwbGFjZWhvbGRlciknKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCfk4ogUmVnaXN0cmEgYSBub3RpZmljYcOnw6NvIGVudmlhZGFcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBhc3luYyBsb2dQdXNoTm90aWZpY2F0aW9uKHBhcmFtczoge1xyXG4gICAgdXNlcl9pZDogc3RyaW5nO1xyXG4gICAgdGl0bGU6IHN0cmluZztcclxuICAgIGJvZHk6IHN0cmluZztcclxuICAgIGV2ZW50X2lkPzogbnVtYmVyO1xyXG4gICAgZGV2aWNlc19zZW50OiBudW1iZXI7XHJcbiAgICB0b3RhbF9kZXZpY2VzOiBudW1iZXI7XHJcbiAgfSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgncHVzaF9ub3RpZmljYXRpb25fbG9ncycpLmluc2VydCh7XHJcbiAgICAgICAgdXNlcl9pZDogcGFyYW1zLnVzZXJfaWQsXHJcbiAgICAgICAgdGl0bGU6IHBhcmFtcy50aXRsZSxcclxuICAgICAgICBib2R5OiBwYXJhbXMuYm9keSxcclxuICAgICAgICBldmVudF9pZDogcGFyYW1zLmV2ZW50X2lkLFxyXG4gICAgICAgIGRldmljZXNfc2VudDogcGFyYW1zLmRldmljZXNfc2VudCxcclxuICAgICAgICB0b3RhbF9kZXZpY2VzOiBwYXJhbXMudG90YWxfZGV2aWNlcyxcclxuICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLndhcm4oJ+KaoO+4jyBFcnJvIGFvIHJlZ2lzdHJhciBsb2cgZGUgbm90aWZpY2HDp8OjbzonLCBlcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDwn5OxIFJlZ2lzdHJhIHRva2VuIGRlIGRpc3Bvc2l0aXZvIGRvIHVzdcOhcmlvXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIHJlZ2lzdGVyRGV2aWNlVG9rZW4oXHJcbiAgICB1c2VySWQ6IHN0cmluZyxcclxuICAgIHRva2VuOiBzdHJpbmcsXHJcbiAgICBwbGF0Zm9ybTogJ3dlYicgfCAnaW9zJyB8ICdhbmRyb2lkJ1xyXG4gICk6IFByb21pc2U8U2VuZFB1c2hSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmZyb20oJ3VzZXJfZGV2aWNlX3Rva2VucycpLmluc2VydCh7XHJcbiAgICAgICAgdXNlcl9pZDogdXNlcklkLFxyXG4gICAgICAgIHRva2VuLFxyXG4gICAgICAgIHBsYXRmb3JtLFxyXG4gICAgICAgIGlzX2FjdGl2ZTogdHJ1ZSxcclxuICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coYOKchSBEZXZpY2UgdG9rZW4gcmVnaXN0cmFkbyBwYXJhICR7dXNlcklkfSAoJHtwbGF0Zm9ybX0pYCk7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIG1lc3NhZ2U6ICdEZXZpY2UgcmVnaXN0cmFkbyBjb20gc3VjZXNzbycgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIHJlZ2lzdHJhciBkZXZpY2UgdG9rZW46JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3IgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCfl5HvuI8gUmVtb3ZlIHRva2VuIGRlIGRpc3Bvc2l0aXZvIChsb2dvdXQpXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIHVucmVnaXN0ZXJEZXZpY2VUb2tlbih0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxTZW5kUHVzaFJlc3VsdD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgndXNlcl9kZXZpY2VfdG9rZW5zJylcclxuICAgICAgICAudXBkYXRlKHsgaXNfYWN0aXZlOiBmYWxzZSB9KVxyXG4gICAgICAgIC5lcSgndG9rZW4nLCB0b2tlbik7XHJcblxyXG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coJ+KchSBEZXZpY2UgdG9rZW4gcmVtb3ZpZG8nKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ0RldmljZSByZW1vdmlkbyBjb20gc3VjZXNzbycgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIHJlbW92ZXIgZGV2aWNlIHRva2VuOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yIH07XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBQdXNoTm90aWZpY2F0aW9uU2VydmljZTsiXSwidmVyc2lvbiI6M30=