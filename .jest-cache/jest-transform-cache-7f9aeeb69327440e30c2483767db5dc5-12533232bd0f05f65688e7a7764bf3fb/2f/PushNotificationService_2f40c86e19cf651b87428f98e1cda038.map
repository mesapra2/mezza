{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\services\\PushNotificationService.ts","mappings":"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","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\services\\PushNotificationService.ts"],"sourcesContent":["// src/services/PushNotificationService.ts\r\nimport { supabase } from '../lib/supabaseClient';\r\n\r\ninterface PushNotificationParams {\r\n  userId: string;\r\n  title: string;\r\n  body: string;\r\n  data?: Record<string, any>;\r\n  eventId?: number;\r\n}\r\n\r\ninterface SendPushResult {\r\n  success: boolean;\r\n  message?: string;\r\n  error?: any;\r\n}\r\n\r\n/**\r\n * üì≤ Servi√ßo de Notifica√ß√µes Push\r\n * Gerencia envio de notifica√ß√µes para web e mobile\r\n */\r\nclass PushNotificationService {\r\n  /**\r\n   * üì≤ Envia push gen√©rica para usu√°rio\r\n   * @param params - Par√¢metros da notifica√ß√£o\r\n   */\r\n  static async sendPush(params: PushNotificationParams): Promise<SendPushResult> {\r\n    try {\r\n      const { userId, title, body, data, eventId } = params;\r\n\r\n      // üîç Buscar tokens de push do usu√°rio\r\n      const { data: deviceTokens, error: tokenError } = await supabase\r\n        .from('user_device_tokens')\r\n        .select('token, platform')\r\n        .eq('user_id', userId)\r\n        .eq('is_active', true);\r\n\r\n      if (tokenError) {\r\n        console.warn('‚ö†Ô∏è Erro ao buscar tokens de dispositivo:', tokenError);\r\n        return { success: true, message: 'Push registrada (sem devices)' };\r\n      }\r\n\r\n      if (!deviceTokens || deviceTokens.length === 0) {\r\n        console.log(`‚ö†Ô∏è Usu√°rio ${userId} n√£o tem devices registrados`);\r\n        return { success: true, message: 'Nenhum dispositivo registrado' };\r\n      }\r\n\r\n      // üì§ Enviar para cada device\r\n      let sentCount = 0;\r\n      for (const device of deviceTokens) {\r\n        try {\r\n          await this.sendPushToDevice({\r\n            token: device.token,\r\n            platform: device.platform,\r\n            title,\r\n            body,\r\n            data,\r\n            eventId\r\n          });\r\n          sentCount++;\r\n        } catch (deviceError) {\r\n          console.error('‚ùå Erro ao enviar push para device:', deviceError);\r\n        }\r\n      }\r\n\r\n      // üìä Registrar envio de notifica√ß√£o\r\n      await this.logPushNotification({\r\n        user_id: userId,\r\n        title,\r\n        body,\r\n        event_id: eventId,\r\n        devices_sent: sentCount,\r\n        total_devices: deviceTokens.length\r\n      });\r\n\r\n      console.log(`‚úÖ Push enviada para ${sentCount}/${deviceTokens.length} devices do usu√°rio ${userId}`);\r\n      return { success: true, message: `Enviada para ${sentCount} dispositivos` };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao enviar push:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üéÅ Envia push para ANFITRI√ÉO com a SENHA\r\n   * @param hostId - ID do anfitri√£o\r\n   * @param eventId - ID do evento\r\n   * @param password - Senha de 4 d√≠gitos\r\n   * @param eventTitle - T√≠tulo do evento\r\n   */\r\n  static async sendPasswordToHost(\r\n    hostId: string,\r\n    eventId: number,\r\n    password: string,\r\n    eventTitle: string\r\n  ): Promise<SendPushResult> {\r\n    try {\r\n      console.log(`üî® Enviando senha para anfitri√£o ${hostId}`);\r\n\r\n      const title = 'üîë Sua Senha do Evento';\r\n      const body = `Evento \"${eventTitle}\" vai come√ßar em 1 minuto. Compartilhe a senha: ${password}`;\r\n\r\n      // üÜï IMPORTANTE: Criar notifica√ß√£o no banco com data.password\r\n      const { error: notifError } = await supabase\r\n        .from('notifications')\r\n        .insert({\r\n          user_id: hostId,\r\n          event_id: eventId,\r\n          notification_type: 'event_password',\r\n          title,\r\n          message: body,\r\n          data: { password },\r\n          sent: false,\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n      if (notifError) {\r\n        console.error('‚ùå Erro ao criar notifica√ß√£o:', notifError);\r\n      }\r\n\r\n      return this.sendPush({\r\n        userId: hostId,\r\n        title,\r\n        body,\r\n        data: {\r\n          type: 'event_password',\r\n          password,\r\n          action: 'show_password'\r\n        },\r\n        eventId\r\n      });\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao enviar senha para anfitri√£o:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üé¨ Envia push para PARTICIPANTES (gen√©rica, sem senha)\r\n   * @param participantIds - Array com IDs dos participantes\r\n   * @param eventId - ID do evento\r\n   * @param eventTitle - T√≠tulo do evento\r\n   */\r\n  static async sendEventStartNotificationToParticipants(\r\n    participantIds: string[],\r\n    eventId: number,\r\n    eventTitle: string\r\n  ): Promise<SendPushResult> {\r\n    try {\r\n      console.log(`üî® Enviando notifica√ß√£o de in√≠cio para ${participantIds.length} participantes`);\r\n\r\n      const title = 'üéâ Seu Evento est√° Come√ßando!';\r\n      const body = `\"${eventTitle}\" come√ßa em 1 minuto. Digite a senha para entrar!`;\r\n\r\n      let successCount = 0;\r\n      const errors: any[] = [];\r\n\r\n      for (const participantId of participantIds) {\r\n        try {\r\n          const result = await this.sendPush({\r\n            userId: participantId,\r\n            title,\r\n            body,\r\n            data: {\r\n              type: 'event_start',\r\n              action: 'open_event_entry'\r\n            },\r\n            eventId\r\n          });\r\n\r\n          if (result.success) successCount++;\r\n          else errors.push({ participantId, error: result.error });\r\n        } catch (error) {\r\n          errors.push({ participantId, error });\r\n        }\r\n      }\r\n\r\n      console.log(`‚úÖ Notifica√ß√µes enviadas: ${successCount}/${participantIds.length}`);\r\n      if (errors.length > 0) {\r\n        console.warn(`‚ö†Ô∏è Erros ao enviar para ${errors.length} participantes`);\r\n      }\r\n\r\n      return {\r\n        success: successCount > 0,\r\n        message: `Enviada para ${successCount}/${participantIds.length} participantes`,\r\n        error: errors.length > 0 ? errors : undefined\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao enviar notifica√ß√£o de in√≠cio:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üö® Envia push para ANFITRI√ÉO quando evento est√° prestes a terminar\r\n   * @param hostId - ID do anfitri√£o\r\n   * @param eventId - ID do evento\r\n   * @param eventTitle - T√≠tulo do evento\r\n   */\r\n  static async sendEventEndingNotification(\r\n    hostId: string,\r\n    eventId: number,\r\n    eventTitle: string\r\n  ): Promise<SendPushResult> {\r\n    try {\r\n      const title = '‚è∞ Seu Evento est√° Terminando';\r\n      const body = `\"${eventTitle}\" vai terminar em 2 minutos. Prepare-se!`;\r\n\r\n      return this.sendPush({\r\n        userId: hostId,\r\n        title,\r\n        body,\r\n        data: {\r\n          type: 'event_ending',\r\n          action: 'show_event_details'\r\n        },\r\n        eventId\r\n      });\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao enviar notifica√ß√£o de fim:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üîî Envia notifica√ß√£o para TEST (validar se funciona)\r\n   */\r\n  static async sendTestNotification(userId: string): Promise<SendPushResult> {\r\n    try {\r\n      return this.sendPush({\r\n        userId,\r\n        title: '‚úÖ Teste de Notifica√ß√£o',\r\n        body: 'Se voc√™ recebeu isto, as notifica√ß√µes push est√£o funcionando!',\r\n        data: { type: 'test' }\r\n      });\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao enviar notifica√ß√£o de teste:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üì£ Envia push para m√∫ltiplos usu√°rios com mesma mensagem\r\n   */\r\n  static async sendBroadcast(\r\n    userIds: string[],\r\n    title: string,\r\n    body: string,\r\n    data?: Record<string, any>\r\n  ): Promise<SendPushResult> {\r\n    try {\r\n      console.log(`üì¢ Enviando broadcast para ${userIds.length} usu√°rios`);\r\n\r\n      let successCount = 0;\r\n      const errors: any[] = [];\r\n\r\n      for (const userId of userIds) {\r\n        try {\r\n          const result = await this.sendPush({\r\n            userId,\r\n            title,\r\n            body,\r\n            data\r\n          });\r\n\r\n          if (result.success) successCount++;\r\n          else errors.push({ userId, error: result.error });\r\n        } catch (error) {\r\n          errors.push({ userId, error });\r\n        }\r\n      }\r\n\r\n      return {\r\n        success: successCount > 0,\r\n        message: `Broadcast enviado para ${successCount}/${userIds.length}`,\r\n        error: errors.length > 0 ? errors : undefined\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao enviar broadcast:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üîß M√©todo PRIVADO: Enviar para um device espec√≠fico\r\n   */\r\n  private static async sendPushToDevice(params: {\r\n    token: string;\r\n    platform: string;\r\n    title: string;\r\n    body: string;\r\n    data?: Record<string, any>;\r\n    eventId?: number;\r\n  }): Promise<void> {\r\n    const { token, platform, title, body } = params;\r\n\r\n    console.log(`üì§ Enviando para ${platform} device:`, {\r\n      token: token.substring(0, 10) + '...',\r\n      title,\r\n      body\r\n    });\r\n\r\n    // Placeholder - ser√° implementado com FCM\r\n    if (platform === 'web') {\r\n      console.log('üíª Web Push (placeholder)');\r\n    } else if (platform === 'android' || platform === 'ios') {\r\n      console.log('üì± FCM (placeholder)');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üìä Registra a notifica√ß√£o enviada\r\n   */\r\n  private static async logPushNotification(params: {\r\n    user_id: string;\r\n    title: string;\r\n    body: string;\r\n    event_id?: number;\r\n    devices_sent: number;\r\n    total_devices: number;\r\n  }): Promise<void> {\r\n    try {\r\n      await supabase.from('push_notification_logs').insert({\r\n        user_id: params.user_id,\r\n        title: params.title,\r\n        body: params.body,\r\n        event_id: params.event_id,\r\n        devices_sent: params.devices_sent,\r\n        total_devices: params.total_devices,\r\n        created_at: new Date().toISOString()\r\n      });\r\n    } catch (error) {\r\n      console.warn('‚ö†Ô∏è Erro ao registrar log de notifica√ß√£o:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üì± Registra token de dispositivo do usu√°rio\r\n   */\r\n  static async registerDeviceToken(\r\n    userId: string,\r\n    token: string,\r\n    platform: 'web' | 'ios' | 'android'\r\n  ): Promise<SendPushResult> {\r\n    try {\r\n      const { error } = await supabase.from('user_device_tokens').insert({\r\n        user_id: userId,\r\n        token,\r\n        platform,\r\n        is_active: true,\r\n        created_at: new Date().toISOString()\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      console.log(`‚úÖ Device token registrado para ${userId} (${platform})`);\r\n      return { success: true, message: 'Device registrado com sucesso' };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao registrar device token:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * üóëÔ∏è Remove token de dispositivo (logout)\r\n   */\r\n  static async unregisterDeviceToken(token: string): Promise<SendPushResult> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_device_tokens')\r\n        .update({ is_active: false })\r\n        .eq('token', token);\r\n\r\n      if (error) throw error;\r\n\r\n      console.log('‚úÖ Device token removido');\r\n      return { success: true, message: 'Device removido com sucesso' };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao remover device token:', error);\r\n      return { success: false, error };\r\n    }\r\n  }\r\n}\r\n\r\nexport default PushNotificationService;"],"version":3}