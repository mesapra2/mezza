{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\services\\RatingService.test.ts","mappings":";AAAA,qCAAqC;;;AAErC,2CAAkF;AAWlF,cAAI,CAAC,IAAI,CAAC,uBAAuB,EAAE,GAAG,EAAE,CAAC,CAAC;IACxC,QAAQ,EAAE,oBAAoB;CAC/B,CAAC,CAAC,CAAC;AAZJ,0DAAiD;AACjD,4EAA4D;AAE5D,kCAAkC;AAElC,mBAAmB;AACnB,MAAM,oBAAoB,GAAG;IAC3B,IAAI,EAAE,cAAI,CAAC,EAAE,EAAE;CAChB,CAAC;AAMF,qCAAqC;AACrC,MAAM,cAAc,GAAG,yBAAwC,CAAC;AAEhE,qCAAqC;AAErC,IAAA,kBAAQ,EAAC,eAAe,EAAE,GAAG,EAAE;IAE7B,uDAAuD;IACvD,IAAI,eAAsE,CAAC;IAC3E,IAAI,aAAyF,CAAC;IAE9F,IAAA,oBAAU,EAAC,GAAG,EAAE;QACd,cAAI,CAAC,aAAa,EAAE,CAAC;QACpB,cAAc,CAAC,IAAkB,CAAC,SAAS,EAAE,CAAC;QAE/C,wEAAwE;QACxE,eAAe,GAAG,cAAI,CAAC,KAAK,CAAC,uBAAa,EAAE,cAAc,CAAC;aACxD,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC;QAEhE,aAAa,GAAG,cAAI,CAAC,KAAK,CAAC,uBAAa,EAAE,mCAAmC,CAAC;aAC3E,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC;IACjD,CAAC,CAAC,CAAC;IAEH,IAAA,mBAAS,EAAC,GAAG,EAAE;QACb,yBAAyB;QACzB,eAAe,CAAC,WAAW,EAAE,CAAC;QAC9B,aAAa,CAAC,WAAW,EAAE,CAAC;IAC9B,CAAC,CAAC,CAAC;IAEH,gCAAgC;IAEhC,IAAA,kBAAQ,EAAC,cAAc,EAAE,GAAG,EAAE;QAC5B,MAAM,MAAM,GAAG;YACb,OAAO,EAAE,CAAC;YACV,OAAO,EAAE,YAAY;YACrB,OAAO,EAAE,YAAY;YACrB,UAAU,EAAE,MAAoB;YAChC,KAAK,EAAE,CAAC;SACT,CAAC;QAEF,IAAA,YAAE,EAAC,kDAAkD,EAAE,KAAK,IAAI,EAAE;YAChE,MAAM,UAAU,GAAG,EAAE,EAAE,EAAE,YAAY,EAAE,GAAG,MAAM,EAAE,CAAC;YAEnD,2DAA2D;YAC1D,cAAc,CAAC,IAAkB,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC;gBAC/D,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oBACrB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;wBACjB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;4BACjB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;gCACjB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oCACjB,MAAM,EAAE,cAAI,CAAC,EAAE,EAAE,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,EAAE,IAAI,EAAE,UAAU,EAAE,EAAE,CAAC,CAAC;iCACzG,CAAC,CAAC;6BACJ,CAAC,CAAC;yBACJ,CAAC,CAAC;qBACJ,CAAC,CAAC;iBACJ,CAAC,CAAC;aACJ,CAAC,CAAC,CAAC;YAEJ,oBAAoB;YACnB,cAAc,CAAC,IAAkB,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC;gBAC/D,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oBACrB,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;wBACrB,MAAM,EAAE,cAAI,CAAC,EAAE,EAAE,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;qBAC/F,CAAC,CAAC;iBACJ,CAAC,CAAC;aACJ,CAAC,CAAC,CAAC;YAEJ,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;YAExD,IAAA,gBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,IAAA,gBAAM,EAAC,MAAM,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;YACxC,IAAA,gBAAM,EAAC,cAAc,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,CAAC,gBAAgB,EAAE,CAAC;YAEjE,8EAA8E;YAC9E,IAAA,gBAAM,EAAC,aAAa,CAAC,CAAC,oBAAoB,CAAC,MAAM,CAAC,OAAO,EAAE,MAAM,CAAC,OAAO,CAAC,CAAC;YAE3E,wCAAwC;YACxC,IAAA,gBAAM,EAAC,eAAe,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC;QACjD,CAAC,CAAC,CAAC;QAEH,IAAA,YAAE,EAAC,oDAAoD,EAAE,KAAK,IAAI,EAAE;YAClE,MAAM,cAAc,GAAG,EAAE,EAAE,EAAE,iBAAiB,EAAE,CAAC;YAEjD,4CAA4C;YAC3C,cAAc,CAAC,IAAkB,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC;gBAC/D,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oBACrB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;wBACjB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;4BACjB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;gCACjB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oCACjB,MAAM,EAAE,cAAI,CAAC,EAAE,EAAE,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;iCACnG,CAAC,CAAC;6BACJ,CAAC,CAAC;yBACJ,CAAC,CAAC;qBACJ,CAAC,CAAC;iBACJ,CAAC,CAAC;aACJ,CAAC,CAAC,CAAC;YAEJ,MAAM,uBAAa,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;YAEzC,2CAA2C;YAC3C,IAAA,gBAAM,EAAC,eAAe,CAAC,CAAC,oBAAoB,CAAC,cAAc,CAAC,EAAE,EAAE,MAAM,CAAC,KAAK,CAAC,CAAC;YAE9E,iDAAiD;YACjD,IAAA,gBAAM,EAAC,cAAc,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC;YACrE,IAAA,gBAAM,EAAC,aAAa,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC;QAC/C,CAAC,CAAC,CAAC;QAEH,IAAA,YAAE,EAAC,qCAAqC,EAAE,KAAK,IAAI,EAAE;YACnD,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,YAAY,CAAC,EAAE,GAAG,MAAM,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC,CAAC;YACzE,IAAA,gBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACnC,IAAA,gBAAM,EAAC,MAAM,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,8BAA8B,CAAC,CAAC;QAC5D,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,IAAA,kBAAQ,EAAC,cAAc,EAAE,GAAG,EAAE;QAC5B,IAAA,YAAE,EAAC,8CAA8C,EAAE,KAAK,IAAI,EAAE;YAC5D,gDAAgD;YAChD,eAAe,CAAC,WAAW,EAAE,CAAC;YAC9B,MAAM,UAAU,GAAG,EAAE,EAAE,EAAE,YAAY,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;YAElD,iBAAiB;YAChB,cAAc,CAAC,IAAkB,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC;gBAC/D,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oBACrB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;wBACjB,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;4BACrB,MAAM,EAAE,cAAI,CAAC,EAAE,EAAE,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;yBAC/F,CAAC,CAAC;qBACJ,CAAC,CAAC;iBACJ,CAAC,CAAC;aACJ,CAAC,CAAC,CAAC;YAEJ,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,YAAY,CAAC,YAAY,EAAE,CAAC,CAAC,CAAC;YAEjE,IAAA,gBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,IAAA,gBAAM,EAAC,MAAM,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;YACxC,IAAA,gBAAM,EAAC,cAAc,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,CAAC,oBAAoB,CAChE,gBAAM,CAAC,gBAAgB,CAAC,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC,CACtC,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,IAAA,kBAAQ,EAAC,gBAAgB,EAAE,GAAG,EAAE;QAC9B,IAAA,YAAE,EAAC,+CAA+C,EAAE,KAAK,IAAI,EAAE;YAC7D,MAAM,WAAW,GAAG;gBAClB,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,EAAE;gBACrD,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,aAAa,EAAE,KAAK,EAAE,CAAC,EAAE;gBAC5D,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,aAAa,EAAE,KAAK,EAAE,CAAC,EAAE;aAC7D,CAAC;YAEF,iBAAiB;YAChB,cAAc,CAAC,IAAkB,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC;gBAC/D,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oBACrB,EAAE,EAAE,cAAI,CAAC,EAAE,EAAE,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,WAAW,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;iBAC5F,CAAC,CAAC;aACJ,CAAC,CAAC,CAAC;YAEJ,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;YAE5D,IAAA,gBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,IAAA,gBAAM,EAAC,MAAM,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YACpC,IAAA,gBAAM,EAAC,MAAM,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,kBAAkB;YACvD,IAAA,gBAAM,EAAC,MAAM,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YACnC,IAAA,gBAAM,EAAC,MAAM,CAAC,kBAAkB,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAC5C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,IAAA,kBAAQ,EAAC,uBAAuB,EAAE,GAAG,EAAE;QACrC,IAAA,YAAE,EAAC,uCAAuC,EAAE,KAAK,IAAI,EAAE;YACrD,MAAM,gBAAgB,GAAG;gBACvB,EAAE,OAAO,EAAE,QAAQ,EAAE,mBAAmB,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,QAAQ,EAAE,OAAO,EAAE,EAAE;gBAChF,EAAE,OAAO,EAAE,QAAQ,EAAE,mBAAmB,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,QAAQ,EAAE,OAAO,EAAE,EAAE;aACjF,CAAC;YACF,MAAM,SAAS,GAAG,EAAE,UAAU,EAAE,SAAS,EAAE,UAAU,EAAE,UAAU,EAAE,CAAC;YACpE,MAAM,WAAW,GAAG;gBAClB,sBAAsB;gBACtB,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,MAAM,EAAE,QAAQ,EAAE,SAAS,EAAE;gBAChE,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,aAAa,EAAE,QAAQ,EAAE,QAAQ,EAAE;gBACtE,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,YAAY,EAAE,QAAQ,EAAE,UAAU,EAAE;gBACvE,gCAAgC;gBAChC,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,MAAM,EAAE,QAAQ,EAAE,SAAS,EAAE;gBAChE,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,aAAa,EAAE,QAAQ,EAAE,QAAQ,EAAE;aACvE,CAAC;YAEF,+BAA+B;YAC9B,cAAc,CAAC,IAAkB,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC;gBAC/D,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oBACrB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;wBACjB,EAAE,EAAE,cAAI,CAAC,EAAE,EAAE,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,gBAAgB,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;qBACjG,CAAC,CAAC;iBACJ,CAAC,CAAC;aACJ,CAAC,CAAC,CAAC;YAEJ,wBAAwB;YACvB,cAAc,CAAC,IAAkB,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC;gBAC/D,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oBACrB,EAAE,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;wBACjB,MAAM,EAAE,cAAI,CAAC,EAAE,EAAE,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;qBAC9F,CAAC,CAAC;iBACJ,CAAC,CAAC;aACJ,CAAC,CAAC,CAAC;YAEJ,yBAAyB;YACxB,cAAc,CAAC,IAAkB,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC;gBAC/D,MAAM,EAAE,cAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,CAAC;oBACrB,EAAE,EAAE,cAAI,CAAC,EAAE,EAAE,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,WAAW,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;iBAC5F,CAAC,CAAC;aACJ,CAAC,CAAC,CAAC;YAEJ,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAE5D,IAAA,gBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,IAAA,gBAAM,EAAC,MAAM,CAAC,IAAI,EAAE,kBAAkB,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACpD,IAAA,gBAAM,EAAC,MAAM,CAAC,IAAI,EAAE,iBAAiB,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YAC/C,IAAA,gBAAM,EAAC,MAAM,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;YACnD,IAAA,gBAAM,EAAC,MAAM,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YAC7D,IAAA,gBAAM,EAAC,MAAM,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC,CAAC,CAAC,oBAAoB,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACvE,IAAA,gBAAM,EAAC,MAAM,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClE,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AAEL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\services\\RatingService.test.ts"],"sourcesContent":["// src/services/RatingService.test.ts\r\n\r\nimport { describe, it, expect, jest, beforeEach, afterEach } from '@jest/globals';\r\nimport { supabase } from '../lib/supabaseClient';\r\nimport RatingService, { RatingType } from './RatingService';\r\n\r\n// --- 1. MOCKING DEPENDÊNCIAS ---\r\n\r\n// Mock do Supabase\r\nconst mockSupabaseInstance = {\r\n  from: jest.fn(),\r\n};\r\n\r\njest.mock('../lib/supabaseClient', () => ({\r\n  supabase: mockSupabaseInstance,\r\n}));\r\n\r\n// Typecast do mock para intellisense\r\nconst mockedSupabase = supabase as jest.Mocked<typeof supabase>;\r\n\r\n// --- 2. CONFIGURAÇÃO DOS TESTES ---\r\n\r\ndescribe('RatingService', () => {\r\n\r\n  // Espiões para métodos estáticos chamados internamente\r\n  let spyUpdateRating: jest.SpiedFunction<typeof RatingService.updateRating>;\r\n  let spyUpdateFlag: jest.SpiedFunction<typeof RatingService.updateParticipationEvaluationFlag>;\r\n\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    (mockedSupabase.from as jest.Mock).mockReset();\r\n\r\n    // Mockamos as implementações dos métodos internos para isolar os testes\r\n    spyUpdateRating = jest.spyOn(RatingService, 'updateRating')\r\n      .mockImplementation(() => Promise.resolve({ success: true }));\r\n      \r\n    spyUpdateFlag = jest.spyOn(RatingService, 'updateParticipationEvaluationFlag')\r\n      .mockImplementation(() => Promise.resolve());\r\n  });\r\n\r\n  afterEach(() => {\r\n    // Restauramos os espiões\r\n    spyUpdateRating.mockRestore();\r\n    spyUpdateFlag.mockRestore();\r\n  });\r\n\r\n  // --- 3. TESTES DOS MÉTODOS ---\r\n\r\n  describe('createRating', () => {\r\n    const params = {\r\n      eventId: 1,\r\n      raterId: 'user-rater',\r\n      ratedId: 'user-rated',\r\n      ratingType: 'host' as RatingType,\r\n      score: 5,\r\n    };\r\n    \r\n    it('deve criar uma nova avaliação se ela não existir', async () => {\r\n      const mockRating = { id: 'rating-123', ...params };\r\n\r\n      // 1. Mock do SELECT (checkError) - não encontra (PGRST116)\r\n      (mockedSupabase.from as jest.Mock).mockImplementationOnce(() => ({\r\n        select: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            eq: jest.fn(() => ({\r\n              eq: jest.fn(() => ({\r\n                eq: jest.fn(() => ({\r\n                  single: jest.fn().mockImplementation(() => Promise.resolve({ data: null, error: { code: 'PGRST116' } })),\r\n                })),\r\n              })),\r\n            })),\r\n          })),\r\n        })),\r\n      }));\r\n\r\n      // 2. Mock do INSERT\r\n      (mockedSupabase.from as jest.Mock).mockImplementationOnce(() => ({\r\n        insert: jest.fn(() => ({\r\n          select: jest.fn(() => ({\r\n            single: jest.fn().mockImplementation(() => Promise.resolve({ data: mockRating, error: null })),\r\n          })),\r\n        })),\r\n      }));\r\n\r\n      const result = await RatingService.createRating(params);\r\n\r\n      expect(result.success).toBe(true);\r\n      expect(result.data).toEqual(mockRating);\r\n      expect(mockedSupabase.from('ratings').insert).toHaveBeenCalled();\r\n      \r\n      // Verifica se chamou o método interno para atualizar o status do participante\r\n      expect(spyUpdateFlag).toHaveBeenCalledWith(params.eventId, params.raterId);\r\n      \r\n      // Garante que NÃO chamou o updateRating\r\n      expect(spyUpdateRating).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it('deve chamar updateRating se a avaliação já existir', async () => {\r\n      const existingRating = { id: 'rating-existing' };\r\n\r\n      // 1. Mock do SELECT (checkError) - ENCONTRA\r\n      (mockedSupabase.from as jest.Mock).mockImplementationOnce(() => ({\r\n        select: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            eq: jest.fn(() => ({\r\n              eq: jest.fn(() => ({\r\n                eq: jest.fn(() => ({\r\n                  single: jest.fn().mockImplementation(() => Promise.resolve({ data: existingRating, error: null })),\r\n                })),\r\n              })),\r\n            })),\r\n          })),\r\n        })),\r\n      }));\r\n\r\n      await RatingService.createRating(params);\r\n\r\n      // Garante que chamou o spy de updateRating\r\n      expect(spyUpdateRating).toHaveBeenCalledWith(existingRating.id, params.score);\r\n      \r\n      // Garante que NÃO chamou insert nem o updateFlag\r\n      expect(mockedSupabase.from('ratings').insert).not.toHaveBeenCalled();\r\n      expect(spyUpdateFlag).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it('deve falhar se o score for inválido', async () => {\r\n      const result = await RatingService.createRating({ ...params, score: 0 });\r\n      expect(result.success).toBe(false);\r\n      expect(result.error).toBe('Score deve estar entre 1 e 5');\r\n    });\r\n  });\r\n\r\n  describe('updateRating', () => {\r\n    it('deve chamar supabase.update com o novo score', async () => {\r\n      // Libera o spy para testar a implementação real\r\n      spyUpdateRating.mockRestore();\r\n      const mockRating = { id: 'rating-123', score: 5 };\r\n\r\n      // Mock do UPDATE\r\n      (mockedSupabase.from as jest.Mock).mockImplementationOnce(() => ({\r\n        update: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            select: jest.fn(() => ({\r\n              single: jest.fn().mockImplementation(() => Promise.resolve({ data: mockRating, error: null })),\r\n            })),\r\n          })),\r\n        })),\r\n      }));\r\n      \r\n      const result = await RatingService.updateRating('rating-123', 5);\r\n\r\n      expect(result.success).toBe(true);\r\n      expect(result.data).toEqual(mockRating);\r\n      expect(mockedSupabase.from('ratings').update).toHaveBeenCalledWith(\r\n        expect.objectContaining({ score: 5 })\r\n      );\r\n    });\r\n  });\r\n\r\n  describe('getUserRatings', () => {\r\n    it('deve calcular a média e o total de avaliações', async () => {\r\n      const mockRatings = [\r\n        { rated_id: 'user-1', rating_type: 'host', score: 5 },\r\n        { rated_id: 'user-1', rating_type: 'participant', score: 4 },\r\n        { rated_id: 'user-1', rating_type: 'participant', score: 3 },\r\n      ];\r\n      \r\n      // Mock do SELECT\r\n      (mockedSupabase.from as jest.Mock).mockImplementationOnce(() => ({\r\n        select: jest.fn(() => ({\r\n          eq: jest.fn().mockImplementation(() => Promise.resolve({ data: mockRatings, error: null })),\r\n        })),\r\n      }));\r\n\r\n      const result = await RatingService.getUserRatings('user-1');\r\n\r\n      expect(result.success).toBe(true);\r\n      expect(result.totalRatings).toBe(3);\r\n      expect(result.averageScore).toBe(4); // (5+4+3) / 3 = 4\r\n      expect(result.hostRatings).toBe(1);\r\n      expect(result.participantRatings).toBe(2);\r\n    });\r\n  });\r\n\r\n  describe('getEventRatingsStatus', () => {\r\n    it('deve identificar avaliações pendentes', async () => {\r\n      const mockParticipants = [\r\n        { user_id: 'user-A', presenca_confirmada: true, profile: { username: 'UserA' } },\r\n        { user_id: 'user-B', presenca_confirmada: true, profile: { username: 'UserB' } },\r\n      ];\r\n      const mockEvent = { creator_id: 'host-id', partner_id: 'resto-id' };\r\n      const mockRatings = [\r\n        // User A avaliou tudo\r\n        { rater_id: 'user-A', rating_type: 'host', rated_id: 'host-id' },\r\n        { rater_id: 'user-A', rating_type: 'participant', rated_id: 'user-B' },\r\n        { rater_id: 'user-A', rating_type: 'restaurant', rated_id: 'resto-id' },\r\n        // User B esqueceu o restaurante\r\n        { rater_id: 'user-B', rating_type: 'host', rated_id: 'host-id' },\r\n        { rater_id: 'user-B', rating_type: 'participant', rated_id: 'user-A' },\r\n      ];\r\n\r\n      // 1. Mock SELECT participantes\r\n      (mockedSupabase.from as jest.Mock).mockImplementationOnce(() => ({\r\n        select: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            eq: jest.fn().mockImplementation(() => Promise.resolve({ data: mockParticipants, error: null })),\r\n          })),\r\n        })),\r\n      }));\r\n      \r\n      // 2. Mock SELECT evento\r\n      (mockedSupabase.from as jest.Mock).mockImplementationOnce(() => ({\r\n        select: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            single: jest.fn().mockImplementation(() => Promise.resolve({ data: mockEvent, error: null })),\r\n          })),\r\n        })),\r\n      }));\r\n      \r\n      // 3. Mock SELECT ratings\r\n      (mockedSupabase.from as jest.Mock).mockImplementationOnce(() => ({\r\n        select: jest.fn(() => ({\r\n          eq: jest.fn().mockImplementation(() => Promise.resolve({ data: mockRatings, error: null })),\r\n        })),\r\n      }));\r\n\r\n      const result = await RatingService.getEventRatingsStatus(1);\r\n\r\n      expect(result.success).toBe(true);\r\n      expect(result.data?.allRatingsComplete).toBe(false);\r\n      expect(result.data?.totalParticipants).toBe(2);\r\n      expect(result.data?.pendingRaters).toHaveLength(1);\r\n      expect(result.data?.pendingRaters[0].user_id).toBe('user-B');\r\n      expect(result.data?.pendingRaters[0].evaluated_restaurant).toBe(false);\r\n      expect(result.data?.pendingRaters[0].evaluated_host).toBe(true);\r\n    });\r\n  });\r\n\r\n});\r\n"],"version":3}