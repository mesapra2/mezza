1f5366f03f4c7ecdcf499c496241a1db
"use strict";
// src/services/RatingService.test.ts
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const globals_1 = require("@jest/globals");
globals_1.jest.mock('../lib/supabaseClient', () => ({
    supabase: mockSupabaseInstance,
}));
const supabaseClient_1 = require("../lib/supabaseClient");
const RatingService_1 = tslib_1.__importDefault(require("./RatingService"));
// --- 1. MOCKING DEPENDÊNCIAS ---
// Mock do Supabase
const mockSupabaseInstance = {
    from: globals_1.jest.fn(),
};
// Typecast do mock para intellisense
const mockedSupabase = supabaseClient_1.supabase;
// --- 2. CONFIGURAÇÃO DOS TESTES ---
(0, globals_1.describe)('RatingService', () => {
    // Espiões para métodos estáticos chamados internamente
    let spyUpdateRating;
    let spyUpdateFlag;
    (0, globals_1.beforeEach)(() => {
        globals_1.jest.clearAllMocks();
        mockedSupabase.from.mockReset();
        // Mockamos as implementações dos métodos internos para isolar os testes
        spyUpdateRating = globals_1.jest.spyOn(RatingService_1.default, 'updateRating')
            .mockImplementation(() => Promise.resolve({ success: true }));
        spyUpdateFlag = globals_1.jest.spyOn(RatingService_1.default, 'updateParticipationEvaluationFlag')
            .mockImplementation(() => Promise.resolve());
    });
    (0, globals_1.afterEach)(() => {
        // Restauramos os espiões
        spyUpdateRating.mockRestore();
        spyUpdateFlag.mockRestore();
    });
    // --- 3. TESTES DOS MÉTODOS ---
    (0, globals_1.describe)('createRating', () => {
        const params = {
            eventId: 1,
            raterId: 'user-rater',
            ratedId: 'user-rated',
            ratingType: 'host',
            score: 5,
        };
        (0, globals_1.it)('deve criar uma nova avaliação se ela não existir', async () => {
            const mockRating = { id: 'rating-123', ...params };
            // 1. Mock do SELECT (checkError) - não encontra (PGRST116)
            mockedSupabase.from.mockImplementationOnce(() => ({
                select: globals_1.jest.fn(() => ({
                    eq: globals_1.jest.fn(() => ({
                        eq: globals_1.jest.fn(() => ({
                            eq: globals_1.jest.fn(() => ({
                                eq: globals_1.jest.fn(() => ({
                                    single: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: null, error: { code: 'PGRST116' } })),
                                })),
                            })),
                        })),
                    })),
                })),
            }));
            // 2. Mock do INSERT
            mockedSupabase.from.mockImplementationOnce(() => ({
                insert: globals_1.jest.fn(() => ({
                    select: globals_1.jest.fn(() => ({
                        single: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: mockRating, error: null })),
                    })),
                })),
            }));
            const result = await RatingService_1.default.createRating(params);
            (0, globals_1.expect)(result.success).toBe(true);
            (0, globals_1.expect)(result.data).toEqual(mockRating);
            (0, globals_1.expect)(mockedSupabase.from('ratings').insert).toHaveBeenCalled();
            // Verifica se chamou o método interno para atualizar o status do participante
            (0, globals_1.expect)(spyUpdateFlag).toHaveBeenCalledWith(params.eventId, params.raterId);
            // Garante que NÃO chamou o updateRating
            (0, globals_1.expect)(spyUpdateRating).not.toHaveBeenCalled();
        });
        (0, globals_1.it)('deve chamar updateRating se a avaliação já existir', async () => {
            const existingRating = { id: 'rating-existing' };
            // 1. Mock do SELECT (checkError) - ENCONTRA
            mockedSupabase.from.mockImplementationOnce(() => ({
                select: globals_1.jest.fn(() => ({
                    eq: globals_1.jest.fn(() => ({
                        eq: globals_1.jest.fn(() => ({
                            eq: globals_1.jest.fn(() => ({
                                eq: globals_1.jest.fn(() => ({
                                    single: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: existingRating, error: null })),
                                })),
                            })),
                        })),
                    })),
                })),
            }));
            await RatingService_1.default.createRating(params);
            // Garante que chamou o spy de updateRating
            (0, globals_1.expect)(spyUpdateRating).toHaveBeenCalledWith(existingRating.id, params.score);
            // Garante que NÃO chamou insert nem o updateFlag
            (0, globals_1.expect)(mockedSupabase.from('ratings').insert).not.toHaveBeenCalled();
            (0, globals_1.expect)(spyUpdateFlag).not.toHaveBeenCalled();
        });
        (0, globals_1.it)('deve falhar se o score for inválido', async () => {
            const result = await RatingService_1.default.createRating({ ...params, score: 0 });
            (0, globals_1.expect)(result.success).toBe(false);
            (0, globals_1.expect)(result.error).toBe('Score deve estar entre 1 e 5');
        });
    });
    (0, globals_1.describe)('updateRating', () => {
        (0, globals_1.it)('deve chamar supabase.update com o novo score', async () => {
            // Libera o spy para testar a implementação real
            spyUpdateRating.mockRestore();
            const mockRating = { id: 'rating-123', score: 5 };
            // Mock do UPDATE
            mockedSupabase.from.mockImplementationOnce(() => ({
                update: globals_1.jest.fn(() => ({
                    eq: globals_1.jest.fn(() => ({
                        select: globals_1.jest.fn(() => ({
                            single: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: mockRating, error: null })),
                        })),
                    })),
                })),
            }));
            const result = await RatingService_1.default.updateRating('rating-123', 5);
            (0, globals_1.expect)(result.success).toBe(true);
            (0, globals_1.expect)(result.data).toEqual(mockRating);
            (0, globals_1.expect)(mockedSupabase.from('ratings').update).toHaveBeenCalledWith(globals_1.expect.objectContaining({ score: 5 }));
        });
    });
    (0, globals_1.describe)('getUserRatings', () => {
        (0, globals_1.it)('deve calcular a média e o total de avaliações', async () => {
            const mockRatings = [
                { rated_id: 'user-1', rating_type: 'host', score: 5 },
                { rated_id: 'user-1', rating_type: 'participant', score: 4 },
                { rated_id: 'user-1', rating_type: 'participant', score: 3 },
            ];
            // Mock do SELECT
            mockedSupabase.from.mockImplementationOnce(() => ({
                select: globals_1.jest.fn(() => ({
                    eq: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: mockRatings, error: null })),
                })),
            }));
            const result = await RatingService_1.default.getUserRatings('user-1');
            (0, globals_1.expect)(result.success).toBe(true);
            (0, globals_1.expect)(result.totalRatings).toBe(3);
            (0, globals_1.expect)(result.averageScore).toBe(4); // (5+4+3) / 3 = 4
            (0, globals_1.expect)(result.hostRatings).toBe(1);
            (0, globals_1.expect)(result.participantRatings).toBe(2);
        });
    });
    (0, globals_1.describe)('getEventRatingsStatus', () => {
        (0, globals_1.it)('deve identificar avaliações pendentes', async () => {
            const mockParticipants = [
                { user_id: 'user-A', presenca_confirmada: true, profile: { username: 'UserA' } },
                { user_id: 'user-B', presenca_confirmada: true, profile: { username: 'UserB' } },
            ];
            const mockEvent = { creator_id: 'host-id', partner_id: 'resto-id' };
            const mockRatings = [
                // User A avaliou tudo
                { rater_id: 'user-A', rating_type: 'host', rated_id: 'host-id' },
                { rater_id: 'user-A', rating_type: 'participant', rated_id: 'user-B' },
                { rater_id: 'user-A', rating_type: 'restaurant', rated_id: 'resto-id' },
                // User B esqueceu o restaurante
                { rater_id: 'user-B', rating_type: 'host', rated_id: 'host-id' },
                { rater_id: 'user-B', rating_type: 'participant', rated_id: 'user-A' },
            ];
            // 1. Mock SELECT participantes
            mockedSupabase.from.mockImplementationOnce(() => ({
                select: globals_1.jest.fn(() => ({
                    eq: globals_1.jest.fn(() => ({
                        eq: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: mockParticipants, error: null })),
                    })),
                })),
            }));
            // 2. Mock SELECT evento
            mockedSupabase.from.mockImplementationOnce(() => ({
                select: globals_1.jest.fn(() => ({
                    eq: globals_1.jest.fn(() => ({
                        single: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: mockEvent, error: null })),
                    })),
                })),
            }));
            // 3. Mock SELECT ratings
            mockedSupabase.from.mockImplementationOnce(() => ({
                select: globals_1.jest.fn(() => ({
                    eq: globals_1.jest.fn().mockImplementation(() => Promise.resolve({ data: mockRatings, error: null })),
                })),
            }));
            const result = await RatingService_1.default.getEventRatingsStatus(1);
            (0, globals_1.expect)(result.success).toBe(true);
            (0, globals_1.expect)(result.data?.allRatingsComplete).toBe(false);
            (0, globals_1.expect)(result.data?.totalParticipants).toBe(2);
            (0, globals_1.expect)(result.data?.pendingRaters).toHaveLength(1);
            (0, globals_1.expect)(result.data?.pendingRaters[0].user_id).toBe('user-B');
            (0, globals_1.expect)(result.data?.pendingRaters[0].evaluated_restaurant).toBe(false);
            (0, globals_1.expect)(result.data?.pendingRaters[0].evaluated_host).toBe(true);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcUmF0aW5nU2VydmljZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQSxxQ0FBcUM7OztBQUVyQywyQ0FBa0Y7QUFXbEYsY0FBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLFFBQVEsRUFBRSxvQkFBb0I7Q0FDL0IsQ0FBQyxDQUFDLENBQUM7QUFaSiwwREFBaUQ7QUFDakQsNEVBQTREO0FBRTVELGtDQUFrQztBQUVsQyxtQkFBbUI7QUFDbkIsTUFBTSxvQkFBb0IsR0FBRztJQUMzQixJQUFJLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRTtDQUNoQixDQUFDO0FBTUYscUNBQXFDO0FBQ3JDLE1BQU0sY0FBYyxHQUFHLHlCQUF3QyxDQUFDO0FBRWhFLHFDQUFxQztBQUVyQyxJQUFBLGtCQUFRLEVBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUU3Qix1REFBdUQ7SUFDdkQsSUFBSSxlQUFzRSxDQUFDO0lBQzNFLElBQUksYUFBeUYsQ0FBQztJQUU5RixJQUFBLG9CQUFVLEVBQUMsR0FBRyxFQUFFO1FBQ2QsY0FBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3BCLGNBQWMsQ0FBQyxJQUFrQixDQUFDLFNBQVMsRUFBRSxDQUFDO1FBRS9DLHdFQUF3RTtRQUN4RSxlQUFlLEdBQUcsY0FBSSxDQUFDLEtBQUssQ0FBQyx1QkFBYSxFQUFFLGNBQWMsQ0FBQzthQUN4RCxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUVoRSxhQUFhLEdBQUcsY0FBSSxDQUFDLEtBQUssQ0FBQyx1QkFBYSxFQUFFLG1DQUFtQyxDQUFDO2FBQzNFLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQ2pELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSxtQkFBUyxFQUFDLEdBQUcsRUFBRTtRQUNiLHlCQUF5QjtRQUN6QixlQUFlLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDOUIsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQzlCLENBQUMsQ0FBQyxDQUFDO0lBRUgsZ0NBQWdDO0lBRWhDLElBQUEsa0JBQVEsRUFBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO1FBQzVCLE1BQU0sTUFBTSxHQUFHO1lBQ2IsT0FBTyxFQUFFLENBQUM7WUFDVixPQUFPLEVBQUUsWUFBWTtZQUNyQixPQUFPLEVBQUUsWUFBWTtZQUNyQixVQUFVLEVBQUUsTUFBb0I7WUFDaEMsS0FBSyxFQUFFLENBQUM7U0FDVCxDQUFDO1FBRUYsSUFBQSxZQUFFLEVBQUMsa0RBQWtELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDaEUsTUFBTSxVQUFVLEdBQUcsRUFBRSxFQUFFLEVBQUUsWUFBWSxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUM7WUFFbkQsMkRBQTJEO1lBQzFELGNBQWMsQ0FBQyxJQUFrQixDQUFDLHNCQUFzQixDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQy9ELE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7b0JBQ3JCLEVBQUUsRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7d0JBQ2pCLEVBQUUsRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7NEJBQ2pCLEVBQUUsRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0NBQ2pCLEVBQUUsRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7b0NBQ2pCLE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQztpQ0FDekcsQ0FBQyxDQUFDOzZCQUNKLENBQUMsQ0FBQzt5QkFDSixDQUFDLENBQUM7cUJBQ0osQ0FBQyxDQUFDO2lCQUNKLENBQUMsQ0FBQzthQUNKLENBQUMsQ0FBQyxDQUFDO1lBRUosb0JBQW9CO1lBQ25CLGNBQWMsQ0FBQyxJQUFrQixDQUFDLHNCQUFzQixDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQy9ELE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7b0JBQ3JCLE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7d0JBQ3JCLE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7cUJBQy9GLENBQUMsQ0FBQztpQkFDSixDQUFDLENBQUM7YUFDSixDQUFDLENBQUMsQ0FBQztZQUVKLE1BQU0sTUFBTSxHQUFHLE1BQU0sdUJBQWEsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFeEQsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEMsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDeEMsSUFBQSxnQkFBTSxFQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUVqRSw4RUFBOEU7WUFDOUUsSUFBQSxnQkFBTSxFQUFDLGFBQWEsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRTNFLHdDQUF3QztZQUN4QyxJQUFBLGdCQUFNLEVBQUMsZUFBZSxDQUFDLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDakQsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFBLFlBQUUsRUFBQyxvREFBb0QsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNsRSxNQUFNLGNBQWMsR0FBRyxFQUFFLEVBQUUsRUFBRSxpQkFBaUIsRUFBRSxDQUFDO1lBRWpELDRDQUE0QztZQUMzQyxjQUFjLENBQUMsSUFBa0IsQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUMvRCxNQUFNLEVBQUUsY0FBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO29CQUNyQixFQUFFLEVBQUUsY0FBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO3dCQUNqQixFQUFFLEVBQUUsY0FBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDOzRCQUNqQixFQUFFLEVBQUUsY0FBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dDQUNqQixFQUFFLEVBQUUsY0FBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO29DQUNqQixNQUFNLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2lDQUNuRyxDQUFDLENBQUM7NkJBQ0osQ0FBQyxDQUFDO3lCQUNKLENBQUMsQ0FBQztxQkFDSixDQUFDLENBQUM7aUJBQ0osQ0FBQyxDQUFDO2FBQ0osQ0FBQyxDQUFDLENBQUM7WUFFSixNQUFNLHVCQUFhLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXpDLDJDQUEyQztZQUMzQyxJQUFBLGdCQUFNLEVBQUMsZUFBZSxDQUFDLENBQUMsb0JBQW9CLENBQUMsY0FBYyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFOUUsaURBQWlEO1lBQ2pELElBQUEsZ0JBQU0sRUFBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3JFLElBQUEsZ0JBQU0sRUFBQyxhQUFhLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUMvQyxDQUFDLENBQUMsQ0FBQztRQUVILElBQUEsWUFBRSxFQUFDLHFDQUFxQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ25ELE1BQU0sTUFBTSxHQUFHLE1BQU0sdUJBQWEsQ0FBQyxZQUFZLENBQUMsRUFBRSxHQUFHLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN6RSxJQUFBLGdCQUFNLEVBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNuQyxJQUFBLGdCQUFNLEVBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBQzVELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFBLGtCQUFRLEVBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtRQUM1QixJQUFBLFlBQUUsRUFBQyw4Q0FBOEMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM1RCxnREFBZ0Q7WUFDaEQsZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzlCLE1BQU0sVUFBVSxHQUFHLEVBQUUsRUFBRSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFFbEQsaUJBQWlCO1lBQ2hCLGNBQWMsQ0FBQyxJQUFrQixDQUFDLHNCQUFzQixDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQy9ELE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7b0JBQ3JCLEVBQUUsRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7d0JBQ2pCLE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7NEJBQ3JCLE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7eUJBQy9GLENBQUMsQ0FBQztxQkFDSixDQUFDLENBQUM7aUJBQ0osQ0FBQyxDQUFDO2FBQ0osQ0FBQyxDQUFDLENBQUM7WUFFSixNQUFNLE1BQU0sR0FBRyxNQUFNLHVCQUFhLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUVqRSxJQUFBLGdCQUFNLEVBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsQyxJQUFBLGdCQUFNLEVBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN4QyxJQUFBLGdCQUFNLEVBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FDaEUsZ0JBQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUN0QyxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsa0JBQVEsRUFBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7UUFDOUIsSUFBQSxZQUFFLEVBQUMsK0NBQStDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDN0QsTUFBTSxXQUFXLEdBQUc7Z0JBQ2xCLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUU7Z0JBQ3JELEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUU7Z0JBQzVELEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUU7YUFDN0QsQ0FBQztZQUVGLGlCQUFpQjtZQUNoQixjQUFjLENBQUMsSUFBa0IsQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUMvRCxNQUFNLEVBQUUsY0FBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO29CQUNyQixFQUFFLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2lCQUM1RixDQUFDLENBQUM7YUFDSixDQUFDLENBQUMsQ0FBQztZQUVKLE1BQU0sTUFBTSxHQUFHLE1BQU0sdUJBQWEsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFNUQsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEMsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEMsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxrQkFBa0I7WUFDdkQsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSxrQkFBUSxFQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtRQUNyQyxJQUFBLFlBQUUsRUFBQyx1Q0FBdUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNyRCxNQUFNLGdCQUFnQixHQUFHO2dCQUN2QixFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsbUJBQW1CLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRTtnQkFDaEYsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLG1CQUFtQixFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLEVBQUU7YUFDakYsQ0FBQztZQUNGLE1BQU0sU0FBUyxHQUFHLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLENBQUM7WUFDcEUsTUFBTSxXQUFXLEdBQUc7Z0JBQ2xCLHNCQUFzQjtnQkFDdEIsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRTtnQkFDaEUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRTtnQkFDdEUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRTtnQkFDdkUsZ0NBQWdDO2dCQUNoQyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFO2dCQUNoRSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFO2FBQ3ZFLENBQUM7WUFFRiwrQkFBK0I7WUFDOUIsY0FBYyxDQUFDLElBQWtCLENBQUMsc0JBQXNCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDL0QsTUFBTSxFQUFFLGNBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztvQkFDckIsRUFBRSxFQUFFLGNBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQzt3QkFDakIsRUFBRSxFQUFFLGNBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO3FCQUNqRyxDQUFDLENBQUM7aUJBQ0osQ0FBQyxDQUFDO2FBQ0osQ0FBQyxDQUFDLENBQUM7WUFFSix3QkFBd0I7WUFDdkIsY0FBYyxDQUFDLElBQWtCLENBQUMsc0JBQXNCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDL0QsTUFBTSxFQUFFLGNBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztvQkFDckIsRUFBRSxFQUFFLGNBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQzt3QkFDakIsTUFBTSxFQUFFLGNBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztxQkFDOUYsQ0FBQyxDQUFDO2lCQUNKLENBQUMsQ0FBQzthQUNKLENBQUMsQ0FBQyxDQUFDO1lBRUoseUJBQXlCO1lBQ3hCLGNBQWMsQ0FBQyxJQUFrQixDQUFDLHNCQUFzQixDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQy9ELE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7b0JBQ3JCLEVBQUUsRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7aUJBQzVGLENBQUMsQ0FBQzthQUNKLENBQUMsQ0FBQyxDQUFDO1lBRUosTUFBTSxNQUFNLEdBQUcsTUFBTSx1QkFBYSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTVELElBQUEsZ0JBQU0sRUFBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xDLElBQUEsZ0JBQU0sRUFBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGtCQUFrQixDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BELElBQUEsZ0JBQU0sRUFBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGlCQUFpQixDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLElBQUEsZ0JBQU0sRUFBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuRCxJQUFBLGdCQUFNLEVBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzdELElBQUEsZ0JBQU0sRUFBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2RSxJQUFBLGdCQUFNLEVBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcREVWTWl4XFxBcHAuTWVzYXByYTIuY29tXFxzcmNcXHNlcnZpY2VzXFxSYXRpbmdTZXJ2aWNlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL3NlcnZpY2VzL1JhdGluZ1NlcnZpY2UudGVzdC50c1xyXG5cclxuaW1wb3J0IHsgZGVzY3JpYmUsIGl0LCBleHBlY3QsIGplc3QsIGJlZm9yZUVhY2gsIGFmdGVyRWFjaCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xyXG5pbXBvcnQgeyBzdXBhYmFzZSB9IGZyb20gJy4uL2xpYi9zdXBhYmFzZUNsaWVudCc7XHJcbmltcG9ydCBSYXRpbmdTZXJ2aWNlLCB7IFJhdGluZ1R5cGUgfSBmcm9tICcuL1JhdGluZ1NlcnZpY2UnO1xyXG5cclxuLy8gLS0tIDEuIE1PQ0tJTkcgREVQRU5Ew4pOQ0lBUyAtLS1cclxuXHJcbi8vIE1vY2sgZG8gU3VwYWJhc2VcclxuY29uc3QgbW9ja1N1cGFiYXNlSW5zdGFuY2UgPSB7XHJcbiAgZnJvbTogamVzdC5mbigpLFxyXG59O1xyXG5cclxuamVzdC5tb2NrKCcuLi9saWIvc3VwYWJhc2VDbGllbnQnLCAoKSA9PiAoe1xyXG4gIHN1cGFiYXNlOiBtb2NrU3VwYWJhc2VJbnN0YW5jZSxcclxufSkpO1xyXG5cclxuLy8gVHlwZWNhc3QgZG8gbW9jayBwYXJhIGludGVsbGlzZW5zZVxyXG5jb25zdCBtb2NrZWRTdXBhYmFzZSA9IHN1cGFiYXNlIGFzIGplc3QuTW9ja2VkPHR5cGVvZiBzdXBhYmFzZT47XHJcblxyXG4vLyAtLS0gMi4gQ09ORklHVVJBw4fDg08gRE9TIFRFU1RFUyAtLS1cclxuXHJcbmRlc2NyaWJlKCdSYXRpbmdTZXJ2aWNlJywgKCkgPT4ge1xyXG5cclxuICAvLyBFc3Bpw7VlcyBwYXJhIG3DqXRvZG9zIGVzdMOhdGljb3MgY2hhbWFkb3MgaW50ZXJuYW1lbnRlXHJcbiAgbGV0IHNweVVwZGF0ZVJhdGluZzogamVzdC5TcGllZEZ1bmN0aW9uPHR5cGVvZiBSYXRpbmdTZXJ2aWNlLnVwZGF0ZVJhdGluZz47XHJcbiAgbGV0IHNweVVwZGF0ZUZsYWc6IGplc3QuU3BpZWRGdW5jdGlvbjx0eXBlb2YgUmF0aW5nU2VydmljZS51cGRhdGVQYXJ0aWNpcGF0aW9uRXZhbHVhdGlvbkZsYWc+O1xyXG5cclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gICAgKG1vY2tlZFN1cGFiYXNlLmZyb20gYXMgamVzdC5Nb2NrKS5tb2NrUmVzZXQoKTtcclxuXHJcbiAgICAvLyBNb2NrYW1vcyBhcyBpbXBsZW1lbnRhw6fDtWVzIGRvcyBtw6l0b2RvcyBpbnRlcm5vcyBwYXJhIGlzb2xhciBvcyB0ZXN0ZXNcclxuICAgIHNweVVwZGF0ZVJhdGluZyA9IGplc3Quc3B5T24oUmF0aW5nU2VydmljZSwgJ3VwZGF0ZVJhdGluZycpXHJcbiAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgc3VjY2VzczogdHJ1ZSB9KSk7XHJcbiAgICAgIFxyXG4gICAgc3B5VXBkYXRlRmxhZyA9IGplc3Quc3B5T24oUmF0aW5nU2VydmljZSwgJ3VwZGF0ZVBhcnRpY2lwYXRpb25FdmFsdWF0aW9uRmxhZycpXHJcbiAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkpO1xyXG4gIH0pO1xyXG5cclxuICBhZnRlckVhY2goKCkgPT4ge1xyXG4gICAgLy8gUmVzdGF1cmFtb3Mgb3MgZXNwacO1ZXNcclxuICAgIHNweVVwZGF0ZVJhdGluZy5tb2NrUmVzdG9yZSgpO1xyXG4gICAgc3B5VXBkYXRlRmxhZy5tb2NrUmVzdG9yZSgpO1xyXG4gIH0pO1xyXG5cclxuICAvLyAtLS0gMy4gVEVTVEVTIERPUyBNw4lUT0RPUyAtLS1cclxuXHJcbiAgZGVzY3JpYmUoJ2NyZWF0ZVJhdGluZycsICgpID0+IHtcclxuICAgIGNvbnN0IHBhcmFtcyA9IHtcclxuICAgICAgZXZlbnRJZDogMSxcclxuICAgICAgcmF0ZXJJZDogJ3VzZXItcmF0ZXInLFxyXG4gICAgICByYXRlZElkOiAndXNlci1yYXRlZCcsXHJcbiAgICAgIHJhdGluZ1R5cGU6ICdob3N0JyBhcyBSYXRpbmdUeXBlLFxyXG4gICAgICBzY29yZTogNSxcclxuICAgIH07XHJcbiAgICBcclxuICAgIGl0KCdkZXZlIGNyaWFyIHVtYSBub3ZhIGF2YWxpYcOnw6NvIHNlIGVsYSBuw6NvIGV4aXN0aXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tSYXRpbmcgPSB7IGlkOiAncmF0aW5nLTEyMycsIC4uLnBhcmFtcyB9O1xyXG5cclxuICAgICAgLy8gMS4gTW9jayBkbyBTRUxFQ1QgKGNoZWNrRXJyb3IpIC0gbsOjbyBlbmNvbnRyYSAoUEdSU1QxMTYpXHJcbiAgICAgIChtb2NrZWRTdXBhYmFzZS5mcm9tIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uT25jZSgoKSA9PiAoe1xyXG4gICAgICAgIHNlbGVjdDogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgZXE6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgICAgZXE6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgICAgICBlcTogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgICAgICAgZXE6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgICAgICAgICAgc2luZ2xlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IGRhdGE6IG51bGwsIGVycm9yOiB7IGNvZGU6ICdQR1JTVDExNicgfSB9KSksXHJcbiAgICAgICAgICAgICAgICB9KSksXHJcbiAgICAgICAgICAgICAgfSkpLFxyXG4gICAgICAgICAgICB9KSksXHJcbiAgICAgICAgICB9KSksXHJcbiAgICAgICAgfSkpLFxyXG4gICAgICB9KSk7XHJcblxyXG4gICAgICAvLyAyLiBNb2NrIGRvIElOU0VSVFxyXG4gICAgICAobW9ja2VkU3VwYWJhc2UuZnJvbSBhcyBqZXN0Lk1vY2spLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoKCkgPT4gKHtcclxuICAgICAgICBpbnNlcnQ6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgIHNlbGVjdDogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgICBzaW5nbGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogbW9ja1JhdGluZywgZXJyb3I6IG51bGwgfSkpLFxyXG4gICAgICAgICAgfSkpLFxyXG4gICAgICAgIH0pKSxcclxuICAgICAgfSkpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgUmF0aW5nU2VydmljZS5jcmVhdGVSYXRpbmcocGFyYW1zKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhKS50b0VxdWFsKG1vY2tSYXRpbmcpO1xyXG4gICAgICBleHBlY3QobW9ja2VkU3VwYWJhc2UuZnJvbSgncmF0aW5ncycpLmluc2VydCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBcclxuICAgICAgLy8gVmVyaWZpY2Egc2UgY2hhbW91IG8gbcOpdG9kbyBpbnRlcm5vIHBhcmEgYXR1YWxpemFyIG8gc3RhdHVzIGRvIHBhcnRpY2lwYW50ZVxyXG4gICAgICBleHBlY3Qoc3B5VXBkYXRlRmxhZykudG9IYXZlQmVlbkNhbGxlZFdpdGgocGFyYW1zLmV2ZW50SWQsIHBhcmFtcy5yYXRlcklkKTtcclxuICAgICAgXHJcbiAgICAgIC8vIEdhcmFudGUgcXVlIE7Dg08gY2hhbW91IG8gdXBkYXRlUmF0aW5nXHJcbiAgICAgIGV4cGVjdChzcHlVcGRhdGVSYXRpbmcpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnZGV2ZSBjaGFtYXIgdXBkYXRlUmF0aW5nIHNlIGEgYXZhbGlhw6fDo28gasOhIGV4aXN0aXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGV4aXN0aW5nUmF0aW5nID0geyBpZDogJ3JhdGluZy1leGlzdGluZycgfTtcclxuXHJcbiAgICAgIC8vIDEuIE1vY2sgZG8gU0VMRUNUIChjaGVja0Vycm9yKSAtIEVOQ09OVFJBXHJcbiAgICAgIChtb2NrZWRTdXBhYmFzZS5mcm9tIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uT25jZSgoKSA9PiAoe1xyXG4gICAgICAgIHNlbGVjdDogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgZXE6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgICAgZXE6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgICAgICBlcTogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgICAgICAgZXE6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgICAgICAgICAgc2luZ2xlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IGRhdGE6IGV4aXN0aW5nUmF0aW5nLCBlcnJvcjogbnVsbCB9KSksXHJcbiAgICAgICAgICAgICAgICB9KSksXHJcbiAgICAgICAgICAgICAgfSkpLFxyXG4gICAgICAgICAgICB9KSksXHJcbiAgICAgICAgICB9KSksXHJcbiAgICAgICAgfSkpLFxyXG4gICAgICB9KSk7XHJcblxyXG4gICAgICBhd2FpdCBSYXRpbmdTZXJ2aWNlLmNyZWF0ZVJhdGluZyhwYXJhbXMpO1xyXG5cclxuICAgICAgLy8gR2FyYW50ZSBxdWUgY2hhbW91IG8gc3B5IGRlIHVwZGF0ZVJhdGluZ1xyXG4gICAgICBleHBlY3Qoc3B5VXBkYXRlUmF0aW5nKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleGlzdGluZ1JhdGluZy5pZCwgcGFyYW1zLnNjb3JlKTtcclxuICAgICAgXHJcbiAgICAgIC8vIEdhcmFudGUgcXVlIE7Dg08gY2hhbW91IGluc2VydCBuZW0gbyB1cGRhdGVGbGFnXHJcbiAgICAgIGV4cGVjdChtb2NrZWRTdXBhYmFzZS5mcm9tKCdyYXRpbmdzJykuaW5zZXJ0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBleHBlY3Qoc3B5VXBkYXRlRmxhZykubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdkZXZlIGZhbGhhciBzZSBvIHNjb3JlIGZvciBpbnbDoWxpZG8nLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFJhdGluZ1NlcnZpY2UuY3JlYXRlUmF0aW5nKHsgLi4ucGFyYW1zLCBzY29yZTogMCB9KTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKGZhbHNlKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcikudG9CZSgnU2NvcmUgZGV2ZSBlc3RhciBlbnRyZSAxIGUgNScpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCd1cGRhdGVSYXRpbmcnLCAoKSA9PiB7XHJcbiAgICBpdCgnZGV2ZSBjaGFtYXIgc3VwYWJhc2UudXBkYXRlIGNvbSBvIG5vdm8gc2NvcmUnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIC8vIExpYmVyYSBvIHNweSBwYXJhIHRlc3RhciBhIGltcGxlbWVudGHDp8OjbyByZWFsXHJcbiAgICAgIHNweVVwZGF0ZVJhdGluZy5tb2NrUmVzdG9yZSgpO1xyXG4gICAgICBjb25zdCBtb2NrUmF0aW5nID0geyBpZDogJ3JhdGluZy0xMjMnLCBzY29yZTogNSB9O1xyXG5cclxuICAgICAgLy8gTW9jayBkbyBVUERBVEVcclxuICAgICAgKG1vY2tlZFN1cGFiYXNlLmZyb20gYXMgamVzdC5Nb2NrKS5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+ICh7XHJcbiAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCgpID0+ICh7XHJcbiAgICAgICAgICBlcTogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgICBzZWxlY3Q6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICAgICAgICBzaW5nbGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogbW9ja1JhdGluZywgZXJyb3I6IG51bGwgfSkpLFxyXG4gICAgICAgICAgICB9KSksXHJcbiAgICAgICAgICB9KSksXHJcbiAgICAgICAgfSkpLFxyXG4gICAgICB9KSk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBSYXRpbmdTZXJ2aWNlLnVwZGF0ZVJhdGluZygncmF0aW5nLTEyMycsIDUpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LmRhdGEpLnRvRXF1YWwobW9ja1JhdGluZyk7XHJcbiAgICAgIGV4cGVjdChtb2NrZWRTdXBhYmFzZS5mcm9tKCdyYXRpbmdzJykudXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7IHNjb3JlOiA1IH0pXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2dldFVzZXJSYXRpbmdzJywgKCkgPT4ge1xyXG4gICAgaXQoJ2RldmUgY2FsY3VsYXIgYSBtw6lkaWEgZSBvIHRvdGFsIGRlIGF2YWxpYcOnw7VlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja1JhdGluZ3MgPSBbXHJcbiAgICAgICAgeyByYXRlZF9pZDogJ3VzZXItMScsIHJhdGluZ190eXBlOiAnaG9zdCcsIHNjb3JlOiA1IH0sXHJcbiAgICAgICAgeyByYXRlZF9pZDogJ3VzZXItMScsIHJhdGluZ190eXBlOiAncGFydGljaXBhbnQnLCBzY29yZTogNCB9LFxyXG4gICAgICAgIHsgcmF0ZWRfaWQ6ICd1c2VyLTEnLCByYXRpbmdfdHlwZTogJ3BhcnRpY2lwYW50Jywgc2NvcmU6IDMgfSxcclxuICAgICAgXTtcclxuICAgICAgXHJcbiAgICAgIC8vIE1vY2sgZG8gU0VMRUNUXHJcbiAgICAgIChtb2NrZWRTdXBhYmFzZS5mcm9tIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uT25jZSgoKSA9PiAoe1xyXG4gICAgICAgIHNlbGVjdDogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgZXE6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogbW9ja1JhdGluZ3MsIGVycm9yOiBudWxsIH0pKSxcclxuICAgICAgICB9KSksXHJcbiAgICAgIH0pKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFJhdGluZ1NlcnZpY2UuZ2V0VXNlclJhdGluZ3MoJ3VzZXItMScpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LnRvdGFsUmF0aW5ncykudG9CZSgzKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5hdmVyYWdlU2NvcmUpLnRvQmUoNCk7IC8vICg1KzQrMykgLyAzID0gNFxyXG4gICAgICBleHBlY3QocmVzdWx0Lmhvc3RSYXRpbmdzKS50b0JlKDEpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LnBhcnRpY2lwYW50UmF0aW5ncykudG9CZSgyKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZ2V0RXZlbnRSYXRpbmdzU3RhdHVzJywgKCkgPT4ge1xyXG4gICAgaXQoJ2RldmUgaWRlbnRpZmljYXIgYXZhbGlhw6fDtWVzIHBlbmRlbnRlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja1BhcnRpY2lwYW50cyA9IFtcclxuICAgICAgICB7IHVzZXJfaWQ6ICd1c2VyLUEnLCBwcmVzZW5jYV9jb25maXJtYWRhOiB0cnVlLCBwcm9maWxlOiB7IHVzZXJuYW1lOiAnVXNlckEnIH0gfSxcclxuICAgICAgICB7IHVzZXJfaWQ6ICd1c2VyLUInLCBwcmVzZW5jYV9jb25maXJtYWRhOiB0cnVlLCBwcm9maWxlOiB7IHVzZXJuYW1lOiAnVXNlckInIH0gfSxcclxuICAgICAgXTtcclxuICAgICAgY29uc3QgbW9ja0V2ZW50ID0geyBjcmVhdG9yX2lkOiAnaG9zdC1pZCcsIHBhcnRuZXJfaWQ6ICdyZXN0by1pZCcgfTtcclxuICAgICAgY29uc3QgbW9ja1JhdGluZ3MgPSBbXHJcbiAgICAgICAgLy8gVXNlciBBIGF2YWxpb3UgdHVkb1xyXG4gICAgICAgIHsgcmF0ZXJfaWQ6ICd1c2VyLUEnLCByYXRpbmdfdHlwZTogJ2hvc3QnLCByYXRlZF9pZDogJ2hvc3QtaWQnIH0sXHJcbiAgICAgICAgeyByYXRlcl9pZDogJ3VzZXItQScsIHJhdGluZ190eXBlOiAncGFydGljaXBhbnQnLCByYXRlZF9pZDogJ3VzZXItQicgfSxcclxuICAgICAgICB7IHJhdGVyX2lkOiAndXNlci1BJywgcmF0aW5nX3R5cGU6ICdyZXN0YXVyYW50JywgcmF0ZWRfaWQ6ICdyZXN0by1pZCcgfSxcclxuICAgICAgICAvLyBVc2VyIEIgZXNxdWVjZXUgbyByZXN0YXVyYW50ZVxyXG4gICAgICAgIHsgcmF0ZXJfaWQ6ICd1c2VyLUInLCByYXRpbmdfdHlwZTogJ2hvc3QnLCByYXRlZF9pZDogJ2hvc3QtaWQnIH0sXHJcbiAgICAgICAgeyByYXRlcl9pZDogJ3VzZXItQicsIHJhdGluZ190eXBlOiAncGFydGljaXBhbnQnLCByYXRlZF9pZDogJ3VzZXItQScgfSxcclxuICAgICAgXTtcclxuXHJcbiAgICAgIC8vIDEuIE1vY2sgU0VMRUNUIHBhcnRpY2lwYW50ZXNcclxuICAgICAgKG1vY2tlZFN1cGFiYXNlLmZyb20gYXMgamVzdC5Nb2NrKS5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+ICh7XHJcbiAgICAgICAgc2VsZWN0OiBqZXN0LmZuKCgpID0+ICh7XHJcbiAgICAgICAgICBlcTogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgICBlcTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBQcm9taXNlLnJlc29sdmUoeyBkYXRhOiBtb2NrUGFydGljaXBhbnRzLCBlcnJvcjogbnVsbCB9KSksXHJcbiAgICAgICAgICB9KSksXHJcbiAgICAgICAgfSkpLFxyXG4gICAgICB9KSk7XHJcbiAgICAgIFxyXG4gICAgICAvLyAyLiBNb2NrIFNFTEVDVCBldmVudG9cclxuICAgICAgKG1vY2tlZFN1cGFiYXNlLmZyb20gYXMgamVzdC5Nb2NrKS5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+ICh7XHJcbiAgICAgICAgc2VsZWN0OiBqZXN0LmZuKCgpID0+ICh7XHJcbiAgICAgICAgICBlcTogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgICBzaW5nbGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogbW9ja0V2ZW50LCBlcnJvcjogbnVsbCB9KSksXHJcbiAgICAgICAgICB9KSksXHJcbiAgICAgICAgfSkpLFxyXG4gICAgICB9KSk7XHJcbiAgICAgIFxyXG4gICAgICAvLyAzLiBNb2NrIFNFTEVDVCByYXRpbmdzXHJcbiAgICAgIChtb2NrZWRTdXBhYmFzZS5mcm9tIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uT25jZSgoKSA9PiAoe1xyXG4gICAgICAgIHNlbGVjdDogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgZXE6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogbW9ja1JhdGluZ3MsIGVycm9yOiBudWxsIH0pKSxcclxuICAgICAgICB9KSksXHJcbiAgICAgIH0pKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFJhdGluZ1NlcnZpY2UuZ2V0RXZlbnRSYXRpbmdzU3RhdHVzKDEpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LmRhdGE/LmFsbFJhdGluZ3NDb21wbGV0ZSkudG9CZShmYWxzZSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuZGF0YT8udG90YWxQYXJ0aWNpcGFudHMpLnRvQmUoMik7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuZGF0YT8ucGVuZGluZ1JhdGVycykudG9IYXZlTGVuZ3RoKDEpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LmRhdGE/LnBlbmRpbmdSYXRlcnNbMF0udXNlcl9pZCkudG9CZSgndXNlci1CJyk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuZGF0YT8ucGVuZGluZ1JhdGVyc1swXS5ldmFsdWF0ZWRfcmVzdGF1cmFudCkudG9CZShmYWxzZSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuZGF0YT8ucGVuZGluZ1JhdGVyc1swXS5ldmFsdWF0ZWRfaG9zdCkudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==