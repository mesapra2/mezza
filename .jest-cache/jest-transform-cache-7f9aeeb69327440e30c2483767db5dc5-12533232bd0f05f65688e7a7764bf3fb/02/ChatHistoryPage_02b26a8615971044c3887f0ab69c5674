bf644133de96b3865e229da3bd4fad3d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const react_helmet_async_1 = require("react-helmet-async");
const react_router_dom_1 = require("react-router-dom");
const lucide_react_1 = require("lucide-react");
const AuthContext_1 = require("@/contexts/AuthContext");
const supabaseClient_1 = require("@/lib/supabaseClient");
const date_fns_1 = require("date-fns");
const locale_1 = require("date-fns/locale");
const button_1 = require("@/features/shared/components/ui/button"); // Import Button
const ChatHistoryPage = () => {
    const { user } = (0, AuthContext_1.useAuth)();
    const [chatEvents, setChatEvents] = (0, react_1.useState)([]);
    const [loading, setLoading] = (0, react_1.useState)(true);
    const [error, setError] = (0, react_1.useState)(null);
    (0, react_1.useEffect)(() => {
        const fetchChatEvents = async () => {
            if (!user)
                return; // Se não houver usuário, não fazer nada
            setLoading(true);
            setError(null);
            try {
                // 1. Buscar eventos onde o usuário é participante APROVADO
                const { data: participatedEventsData, error: participatedError } = await supabaseClient_1.supabase
                    .from('event_participants')
                    .select(`
            event_id,
            event:events (
              id,
              title,
              start_time,
              status
            )
          `)
                    .eq('user_id', user.id)
                    .eq('status', 'aprovado');
                if (participatedError)
                    throw participatedError;
                // 2. Buscar eventos onde o usuário é o CRIADOR
                const { data: createdEventsData, error: createdError } = await supabaseClient_1.supabase
                    .from('events')
                    .select('id, title, start_time, status')
                    .eq('creator_id', user.id);
                if (createdError)
                    throw createdError;
                // 3. Combinar e remover duplicatas
                const allEventsMap = new Map();
                participatedEventsData.forEach(p => {
                    if (p.event) { // Checa se o join funcionou
                        allEventsMap.set(p.event.id, {
                            id: p.event.id,
                            title: p.event.title,
                            start_time: p.event.start_time,
                            status: p.event.status,
                            role: 'Participante' // Adiciona o papel
                        });
                    }
                });
                createdEventsData.forEach(e => {
                    // Se já existe como participante, apenas adiciona o papel 'Criador'
                    if (allEventsMap.has(e.id)) {
                        const existing = allEventsMap.get(e.id);
                        existing.role = 'Criador & Participante'; // Ou apenas 'Criador' se preferir
                    }
                    else {
                        // Se não existe, adiciona como criador
                        allEventsMap.set(e.id, {
                            id: e.id,
                            title: e.title,
                            start_time: e.start_time,
                            status: e.status,
                            role: 'Criador'
                        });
                    }
                });
                // 4. Converter o Map para Array e ordenar por data (mais recente primeiro)
                const combinedEvents = Array.from(allEventsMap.values())
                    .sort((a, b) => new Date(b.start_time).getTime() - new Date(a.start_time).getTime());
                setChatEvents(combinedEvents);
            }
            catch (err) {
                console.error("Erro ao buscar histórico de chats:", err);
                setError("Não foi possível carregar o histórico de chats.");
            }
            finally {
                setLoading(false);
            }
        };
        fetchChatEvents();
    }, [user]); // Depende do 'user'
    if (loading) {
        return ((0, jsx_runtime_1.jsxs)("div", { className: "flex items-center justify-center h-[calc(100vh-10rem)]", children: [(0, jsx_runtime_1.jsx)(lucide_react_1.Loader2, { className: "w-12 h-12 text-purple-500 animate-spin" }), (0, jsx_runtime_1.jsx)("p", { className: "ml-3 text-white/70", children: "Carregando seus chats..." })] }));
    }
    if (error) {
        return ((0, jsx_runtime_1.jsxs)("div", { className: "flex flex-col items-center justify-center h-[calc(100vh-10rem)] text-center", children: [(0, jsx_runtime_1.jsx)(lucide_react_1.AlertTriangle, { className: "w-12 h-12 text-red-500 mb-4" }), (0, jsx_runtime_1.jsx)("h2", { className: "text-xl font-semibold text-white mb-2", children: error }), (0, jsx_runtime_1.jsx)(button_1.Button, { onClick: () => window.location.reload(), children: "Tentar Novamente" })] }));
    }
    return ((0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsx)(react_helmet_async_1.Helmet, { children: (0, jsx_runtime_1.jsx)("title", { children: "Meus Chats - Mesapra2" }) }), (0, jsx_runtime_1.jsxs)("div", { className: "py-6 px-4 sm:px-6 lg:px-8", children: [(0, jsx_runtime_1.jsx)("h1", { className: "text-3xl font-bold text-white mb-6", children: "Meus Chats" }), chatEvents.length === 0 ? ((0, jsx_runtime_1.jsxs)("div", { className: "glass-effect rounded-2xl p-12 border border-white/10 text-center", children: [(0, jsx_runtime_1.jsx)(lucide_react_1.MessageSquare, { className: "w-16 h-16 text-white/20 mx-auto mb-4" }), (0, jsx_runtime_1.jsx)("p", { className: "text-white/60 text-lg mb-4", children: "Nenhum chat encontrado" }), (0, jsx_runtime_1.jsx)("p", { className: "text-white/40 text-sm", children: "Participe ou crie eventos para come\u00E7ar a conversar!" })] })) : ((0, jsx_runtime_1.jsx)("div", { className: "space-y-4", children: chatEvents.map(event => ((0, jsx_runtime_1.jsx)(react_router_dom_1.Link, { to: `/event/${event.id}/chat`, children: (0, jsx_runtime_1.jsx)("div", { className: "glass-effect rounded-lg p-4 border border-white/10 hover:border-purple-500/50 transition-colors cursor-pointer", children: (0, jsx_runtime_1.jsxs)("div", { className: "flex justify-between items-start", children: [(0, jsx_runtime_1.jsxs)("div", { children: [(0, jsx_runtime_1.jsx)("h2", { className: "text-lg font-semibold text-white mb-1", children: event.title }), (0, jsx_runtime_1.jsxs)("div", { className: "flex items-center gap-4 text-xs text-white/60", children: [(0, jsx_runtime_1.jsxs)("span", { className: "flex items-center gap-1", children: [(0, jsx_runtime_1.jsx)(lucide_react_1.Calendar, { className: "w-3 h-3" }), (0, date_fns_1.format)(new Date(event.start_time), "dd/MM/yy 'às' HH:mm", { locale: locale_1.ptBR })] }), (0, jsx_runtime_1.jsxs)("span", { className: "flex items-center gap-1", children: [(0, jsx_runtime_1.jsx)(lucide_react_1.Users, { className: "w-3 h-3" }), event.role, " "] })] })] }), (0, jsx_runtime_1.jsx)("span", { className: `px-2 py-0.5 rounded-full text-xs font-medium border ${event.status === 'Cancelado' ? 'border-red-500/30 text-red-300'
                                                : ['Finalizado', 'Concluído'].includes(event.status) ? 'border-gray-500/30 text-gray-300'
                                                    : 'border-green-500/30 text-green-300'}`, children: event.status })] }) }) }, event.id))) }))] })] }));
};
exports.default = ChatHistoryPage;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxmZWF0dXJlc1xcc2hhcmVkXFxwYWdlc1xcQ2hhdEhpc3RvcnlQYWdlLmpzeCIsIm1hcHBpbmdzIjoiOzs7QUFBQSxpQ0FBNEM7QUFDNUMsMkRBQTRDO0FBQzVDLHVEQUF3QztBQUN4QywrQ0FBc0Y7QUFDdEYsd0RBQWlEO0FBQ2pELHlEQUFnRDtBQUNoRCx1Q0FBa0M7QUFDbEMsNENBQXVDO0FBQ3ZDLG1FQUFnRSxDQUFDLGdCQUFnQjtBQUVqRixNQUFNLGVBQWUsR0FBRyxHQUFHLEVBQUU7SUFDM0IsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLElBQUEscUJBQU8sR0FBRSxDQUFDO0lBQzNCLE1BQU0sQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2pELE1BQU0sQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFDLElBQUksQ0FBQyxDQUFDO0lBQzdDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFDLElBQUksQ0FBQyxDQUFDO0lBRXpDLElBQUEsaUJBQVMsRUFBQyxHQUFHLEVBQUU7UUFDYixNQUFNLGVBQWUsR0FBRyxLQUFLLElBQUksRUFBRTtZQUNqQyxJQUFJLENBQUMsSUFBSTtnQkFBRSxPQUFPLENBQUMsd0NBQXdDO1lBRTNELFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqQixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDZixJQUFJLENBQUM7Z0JBQ0gsMkRBQTJEO2dCQUMzRCxNQUFNLEVBQUUsSUFBSSxFQUFFLHNCQUFzQixFQUFFLEtBQUssRUFBRSxpQkFBaUIsRUFBRSxHQUFHLE1BQU0seUJBQVE7cUJBQzlFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztxQkFDMUIsTUFBTSxDQUFDOzs7Ozs7OztXQVFQLENBQUM7cUJBQ0QsRUFBRSxDQUFDLFNBQVMsRUFBRSxJ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XFxzaGFyZWRcXHBhZ2VzXFxDaGF0SGlzdG9yeVBhZ2UuanN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVzZVN0YXRlLCB1c2VFZmZlY3QgfSBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCB7IEhlbG1ldCB9IGZyb20gJ3JlYWN0LWhlbG1ldC1hc3luYyc7XHJcbmltcG9ydCB7IExpbmsgfSBmcm9tICdyZWFjdC1yb3V0ZXItZG9tJztcclxuaW1wb3J0IHsgTWVzc2FnZVNxdWFyZSwgTG9hZGVyMiwgQWxlcnRUcmlhbmdsZSwgQ2FsZW5kYXIsIFVzZXJzIH0gZnJvbSAnbHVjaWRlLXJlYWN0JztcclxuaW1wb3J0IHsgdXNlQXV0aCB9IGZyb20gJ0AvY29udGV4dHMvQXV0aENvbnRleHQnO1xyXG5pbXBvcnQgeyBzdXBhYmFzZSB9IGZyb20gJ0AvbGliL3N1cGFiYXNlQ2xpZW50JztcclxuaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnZGF0ZS1mbnMnO1xyXG5pbXBvcnQgeyBwdEJSIH0gZnJvbSAnZGF0ZS1mbnMvbG9jYWxlJztcclxuaW1wb3J0IHsgQnV0dG9uIH0gZnJvbSAnQC9mZWF0dXJlcy9zaGFyZWQvY29tcG9uZW50cy91aS9idXR0b24nOyAvLyBJbXBvcnQgQnV0dG9uXHJcblxyXG5jb25zdCBDaGF0SGlzdG9yeVBhZ2UgPSAoKSA9PiB7XHJcbiAgY29uc3QgeyB1c2VyIH0gPSB1c2VBdXRoKCk7XHJcbiAgY29uc3QgW2NoYXRFdmVudHMsIHNldENoYXRFdmVudHNdID0gdXNlU3RhdGUoW10pO1xyXG4gIGNvbnN0IFtsb2FkaW5nLCBzZXRMb2FkaW5nXSA9IHVzZVN0YXRlKHRydWUpO1xyXG4gIGNvbnN0IFtlcnJvciwgc2V0RXJyb3JdID0gdXNlU3RhdGUobnVsbCk7XHJcblxyXG4gIHVzZUVmZmVjdCgoKSA9PiB7XHJcbiAgICBjb25zdCBmZXRjaENoYXRFdmVudHMgPSBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGlmICghdXNlcikgcmV0dXJuOyAvLyBTZSBuw6NvIGhvdXZlciB1c3XDoXJpbywgbsOjbyBmYXplciBuYWRhXHJcblxyXG4gICAgICBzZXRMb2FkaW5nKHRydWUpO1xyXG4gICAgICBzZXRFcnJvcihudWxsKTtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICAvLyAxLiBCdXNjYXIgZXZlbnRvcyBvbmRlIG8gdXN1w6FyaW8gw6kgcGFydGljaXBhbnRlIEFQUk9WQURPXHJcbiAgICAgICAgY29uc3QgeyBkYXRhOiBwYXJ0aWNpcGF0ZWRFdmVudHNEYXRhLCBlcnJvcjogcGFydGljaXBhdGVkRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgICAuZnJvbSgnZXZlbnRfcGFydGljaXBhbnRzJylcclxuICAgICAgICAgIC5zZWxlY3QoYFxyXG4gICAgICAgICAgICBldmVudF9pZCxcclxuICAgICAgICAgICAgZXZlbnQ6ZXZlbnRzIChcclxuICAgICAgICAgICAgICBpZCxcclxuICAgICAgICAgICAgICB0aXRsZSxcclxuICAgICAgICAgICAgICBzdGFydF90aW1lLFxyXG4gICAgICAgICAgICAgIHN0YXR1c1xyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICBgKVxyXG4gICAgICAgICAgLmVxKCd1c2VyX2lkJywgdXNlci5pZClcclxuICAgICAgICAgIC5lcSgnc3RhdHVzJywgJ2Fwcm92YWRvJyk7XHJcblxyXG4gICAgICAgIGlmIChwYXJ0aWNpcGF0ZWRFcnJvcikgdGhyb3cgcGFydGljaXBhdGVkRXJyb3I7XHJcblxyXG4gICAgICAgIC8vIDIuIEJ1c2NhciBldmVudG9zIG9uZGUgbyB1c3XDoXJpbyDDqSBvIENSSUFET1JcclxuICAgICAgICBjb25zdCB7IGRhdGE6IGNyZWF0ZWRFdmVudHNEYXRhLCBlcnJvcjogY3JlYXRlZEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgICAuc2VsZWN0KCdpZCwgdGl0bGUsIHN0YXJ0X3RpbWUsIHN0YXR1cycpXHJcbiAgICAgICAgICAuZXEoJ2NyZWF0b3JfaWQnLCB1c2VyLmlkKTtcclxuXHJcbiAgICAgICAgaWYgKGNyZWF0ZWRFcnJvcikgdGhyb3cgY3JlYXRlZEVycm9yO1xyXG5cclxuICAgICAgICAvLyAzLiBDb21iaW5hciBlIHJlbW92ZXIgZHVwbGljYXRhc1xyXG4gICAgICAgIGNvbnN0IGFsbEV2ZW50c01hcCA9IG5ldyBNYXAoKTtcclxuXHJcbiAgICAgICAgcGFydGljaXBhdGVkRXZlbnRzRGF0YS5mb3JFYWNoKHAgPT4ge1xyXG4gICAgICAgICAgaWYgKHAuZXZlbnQpIHsgLy8gQ2hlY2Egc2UgbyBqb2luIGZ1bmNpb25vdVxyXG4gICAgICAgICAgICBhbGxFdmVudHNNYXAuc2V0KHAuZXZlbnQuaWQsIHtcclxuICAgICAgICAgICAgICBpZDogcC5ldmVudC5pZCxcclxuICAgICAgICAgICAgICB0aXRsZTogcC5ldmVudC50aXRsZSxcclxuICAgICAgICAgICAgICBzdGFydF90aW1lOiBwLmV2ZW50LnN0YXJ0X3RpbWUsXHJcbiAgICAgICAgICAgICAgc3RhdHVzOiBwLmV2ZW50LnN0YXR1cyxcclxuICAgICAgICAgICAgICByb2xlOiAnUGFydGljaXBhbnRlJyAvLyBBZGljaW9uYSBvIHBhcGVsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjcmVhdGVkRXZlbnRzRGF0YS5mb3JFYWNoKGUgPT4ge1xyXG4gICAgICAgICAgLy8gU2UgasOhIGV4aXN0ZSBjb21vIHBhcnRpY2lwYW50ZSwgYXBlbmFzIGFkaWNpb25hIG8gcGFwZWwgJ0NyaWFkb3InXHJcbiAgICAgICAgICBpZiAoYWxsRXZlbnRzTWFwLmhhcyhlLmlkKSkge1xyXG4gICAgICAgICAgICBjb25zdCBleGlzdGluZyA9IGFsbEV2ZW50c01hcC5nZXQoZS5pZCk7XHJcbiAgICAgICAgICAgIGV4aXN0aW5nLnJvbGUgPSAnQ3JpYWRvciAmIFBhcnRpY2lwYW50ZSc7IC8vIE91IGFwZW5hcyAnQ3JpYWRvcicgc2UgcHJlZmVyaXJcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIFNlIG7Do28gZXhpc3RlLCBhZGljaW9uYSBjb21vIGNyaWFkb3JcclxuICAgICAgICAgICAgYWxsRXZlbnRzTWFwLnNldChlLmlkLCB7XHJcbiAgICAgICAgICAgICAgaWQ6IGUuaWQsXHJcbiAgICAgICAgICAgICAgdGl0bGU6IGUudGl0bGUsXHJcbiAgICAgICAgICAgICAgc3RhcnRfdGltZTogZS5zdGFydF90aW1lLFxyXG4gICAgICAgICAgICAgIHN0YXR1czogZS5zdGF0dXMsXHJcbiAgICAgICAgICAgICAgcm9sZTogJ0NyaWFkb3InXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyA0LiBDb252ZXJ0ZXIgbyBNYXAgcGFyYSBBcnJheSBlIG9yZGVuYXIgcG9yIGRhdGEgKG1haXMgcmVjZW50ZSBwcmltZWlybylcclxuICAgICAgICBjb25zdCBjb21iaW5lZEV2ZW50cyA9IEFycmF5LmZyb20oYWxsRXZlbnRzTWFwLnZhbHVlcygpKVxyXG4gICAgICAgICAgLnNvcnQoKGEsIGIpID0+IG5ldyBEYXRlKGIuc3RhcnRfdGltZSkuZ2V0VGltZSgpIC0gbmV3IERhdGUoYS5zdGFydF90aW1lKS5nZXRUaW1lKCkpO1xyXG5cclxuICAgICAgICBzZXRDaGF0RXZlbnRzKGNvbWJpbmVkRXZlbnRzKTtcclxuXHJcbiAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvIGFvIGJ1c2NhciBoaXN0w7NyaWNvIGRlIGNoYXRzOlwiLCBlcnIpO1xyXG4gICAgICAgIHNldEVycm9yKFwiTsOjbyBmb2kgcG9zc8OtdmVsIGNhcnJlZ2FyIG8gaGlzdMOzcmljbyBkZSBjaGF0cy5cIik7XHJcbiAgICAgIH0gZmluYWxseSB7XHJcbiAgICAgICAgc2V0TG9hZGluZyhmYWxzZSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZmV0Y2hDaGF0RXZlbnRzKCk7XHJcbiAgfSwgW3VzZXJdKTsgLy8gRGVwZW5kZSBkbyAndXNlcidcclxuXHJcbiAgaWYgKGxvYWRpbmcpIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZmxleCBpdGVtcy1jZW50ZXIganVzdGlmeS1jZW50ZXIgaC1bY2FsYygxMDB2aC0xMHJlbSldXCI+XHJcbiAgICAgICAgPExvYWRlcjIgY2xhc3NOYW1lPVwidy0xMiBoLTEyIHRleHQtcHVycGxlLTUwMCBhbmltYXRlLXNwaW5cIiAvPlxyXG4gICAgICAgIDxwIGNsYXNzTmFtZT1cIm1sLTMgdGV4dC13aGl0ZS83MFwiPkNhcnJlZ2FuZG8gc2V1cyBjaGF0cy4uLjwvcD5cclxuICAgICAgPC9kaXY+XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgaWYgKGVycm9yKSB7XHJcbiAgICByZXR1cm4gKFxyXG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cImZsZXggZmxleC1jb2wgaXRlbXMtY2VudGVyIGp1c3RpZnktY2VudGVyIGgtW2NhbGMoMTAwdmgtMTByZW0pXSB0ZXh0LWNlbnRlclwiPlxyXG4gICAgICAgIDxBbGVydFRyaWFuZ2xlIGNsYXNzTmFtZT1cInctMTIgaC0xMiB0ZXh0LXJlZC01MDAgbWItNFwiIC8+XHJcbiAgICAgICAgPGgyIGNsYXNzTmFtZT1cInRleHQteGwgZm9udC1zZW1pYm9sZCB0ZXh0LXdoaXRlIG1iLTJcIj57ZXJyb3J9PC9oMj5cclxuICAgICAgICB7LyogQWRpY2lvbmFkbyBib3TDo28gcGFyYSB0ZW50YXIgbm92YW1lbnRlICovfVxyXG4gICAgICAgIDxCdXR0b24gb25DbGljaz17KCkgPT4gd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpfT4gXHJcbiAgICAgICAgICBUZW50YXIgTm92YW1lbnRlXHJcbiAgICAgICAgPC9CdXR0b24+XHJcbiAgICAgIDwvZGl2PlxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHJldHVybiAoXHJcbiAgICA8PlxyXG4gICAgICA8SGVsbWV0PlxyXG4gICAgICAgIDx0aXRsZT5NZXVzIENoYXRzIC0gTWVzYXByYTI8L3RpdGxlPlxyXG4gICAgICA8L0hlbG1ldD5cclxuICAgICAgPGRpdiBjbGFzc05hbWU9XCJweS02IHB4LTQgc206cHgtNiBsZzpweC04XCI+XHJcbiAgICAgICAgPGgxIGNsYXNzTmFtZT1cInRleHQtM3hsIGZvbnQtYm9sZCB0ZXh0LXdoaXRlIG1iLTZcIj5NZXVzIENoYXRzPC9oMT5cclxuXHJcbiAgICAgICAge2NoYXRFdmVudHMubGVuZ3RoID09PSAwID8gKFxyXG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJnbGFzcy1lZmZlY3Qgcm91bmRlZC0yeGwgcC0xMiBib3JkZXIgYm9yZGVyLXdoaXRlLzEwIHRleHQtY2VudGVyXCI+XHJcbiAgICAgICAgICAgIDxNZXNzYWdlU3F1YXJlIGNsYXNzTmFtZT1cInctMTYgaC0xNiB0ZXh0LXdoaXRlLzIwIG14LWF1dG8gbWItNFwiIC8+XHJcbiAgICAgICAgICAgIDxwIGNsYXNzTmFtZT1cInRleHQtd2hpdGUvNjAgdGV4dC1sZyBtYi00XCI+XHJcbiAgICAgICAgICAgICAgTmVuaHVtIGNoYXQgZW5jb250cmFkb1xyXG4gICAgICAgICAgICA8L3A+XHJcbiAgICAgICAgICAgIDxwIGNsYXNzTmFtZT1cInRleHQtd2hpdGUvNDAgdGV4dC1zbVwiPlxyXG4gICAgICAgICAgICAgIFBhcnRpY2lwZSBvdSBjcmllIGV2ZW50b3MgcGFyYSBjb21lw6dhciBhIGNvbnZlcnNhciFcclxuICAgICAgICAgICAgPC9wPlxyXG4gICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgKSA6IChcclxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwic3BhY2UteS00XCI+XHJcbiAgICAgICAgICAgIHtjaGF0RXZlbnRzLm1hcChldmVudCA9PiAoXHJcbiAgICAgICAgICAgICAgPExpbmsga2V5PXtldmVudC5pZH0gdG89e2AvZXZlbnQvJHtldmVudC5pZH0vY2hhdGB9PlxyXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJnbGFzcy1lZmZlY3Qgcm91bmRlZC1sZyBwLTQgYm9yZGVyIGJvcmRlci13aGl0ZS8xMCBob3Zlcjpib3JkZXItcHVycGxlLTUwMC81MCB0cmFuc2l0aW9uLWNvbG9ycyBjdXJzb3ItcG9pbnRlclwiPlxyXG4gICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImZsZXgganVzdGlmeS1iZXR3ZWVuIGl0ZW1zLXN0YXJ0XCI+XHJcbiAgICAgICAgICAgICAgICAgICAgPGRpdj5cclxuICAgICAgICAgICAgICAgICAgICAgIDxoMiBjbGFzc05hbWU9XCJ0ZXh0LWxnIGZvbnQtc2VtaWJvbGQgdGV4dC13aGl0ZSBtYi0xXCI+e2V2ZW50LnRpdGxlfTwvaDI+XHJcbiAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImZsZXggaXRlbXMtY2VudGVyIGdhcC00IHRleHQteHMgdGV4dC13aGl0ZS82MFwiPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwiZmxleCBpdGVtcy1jZW50ZXIgZ2FwLTFcIj5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxDYWxlbmRhciBjbGFzc05hbWU9XCJ3LTMgaC0zXCIvPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge2Zvcm1hdChuZXcgRGF0ZShldmVudC5zdGFydF90aW1lKSwgXCJkZC9NTS95eSAnw6BzJyBISDptbVwiLCB7IGxvY2FsZTogcHRCUiB9KX1cclxuICAgICAgICAgICAgICAgICAgICAgICAgIDwvc3Bhbj5cclxuICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cImZsZXggaXRlbXMtY2VudGVyIGdhcC0xXCI+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPFVzZXJzIGNsYXNzTmFtZT1cInctMyBoLTNcIi8+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAge2V2ZW50LnJvbGV9IHsvKiBNb3N0cmEgc2Ugw6kgQ3JpYWRvciBvdSBQYXJ0aWNpcGFudGUgKi99XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XHJcbiAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgICAgICAgICAgey8qIEJhZGdlIGRlIFN0YXR1cyAoT3BjaW9uYWwpICovfVxyXG4gICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2BweC0yIHB5LTAuNSByb3VuZGVkLWZ1bGwgdGV4dC14cyBmb250LW1lZGl1bSBib3JkZXIgJHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5zdGF0dXMgPT09ICdDYW5jZWxhZG8nID8gJ2JvcmRlci1yZWQtNTAwLzMwIHRleHQtcmVkLTMwMCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgOiBbJ0ZpbmFsaXphZG8nLCAnQ29uY2x1w61kbyddLmluY2x1ZGVzKGV2ZW50LnN0YXR1cykgPyAnYm9yZGVyLWdyYXktNTAwLzMwIHRleHQtZ3JheS0zMDAnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDogJ2JvcmRlci1ncmVlbi01MDAvMzAgdGV4dC1ncmVlbi0zMDAnXHJcbiAgICAgICAgICAgICAgICAgICAgIH1gfT5cclxuICAgICAgICAgICAgICAgICAgICAgICB7ZXZlbnQuc3RhdHVzfVxyXG4gICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XHJcbiAgICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgey8qIEZ1dHVyYW1lbnRlOiBBZGljaW9uYXIgw7psdGltYSBtZW5zYWdlbSBvdSBpbmRpY2Fkb3IgZGUgbsOjbyBsaWRhcyBhcXVpICovfVxyXG4gICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgICAgPC9MaW5rPlxyXG4gICAgICAgICAgICApKX1cclxuICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICl9XHJcbiAgICAgIDwvZGl2PlxyXG4gICAgPC8+XHJcbiAgKTtcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IENoYXRIaXN0b3J5UGFnZTsiXSwidmVyc2lvbiI6M30=