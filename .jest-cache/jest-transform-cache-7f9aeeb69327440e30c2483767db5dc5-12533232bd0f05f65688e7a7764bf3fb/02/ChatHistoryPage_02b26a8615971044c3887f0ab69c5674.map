{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\features\\shared\\pages\\ChatHistoryPage.jsx","mappings":"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","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\features\\shared\\pages\\ChatHistoryPage.jsx"],"sourcesContent":["import { useState, useEffect } from 'react';\r\nimport { Helmet } from 'react-helmet-async';\r\nimport { Link } from 'react-router-dom';\r\nimport { MessageSquare, Loader2, AlertTriangle, Calendar, Users } from 'lucide-react';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { supabase } from '@/lib/supabaseClient';\r\nimport { format } from 'date-fns';\r\nimport { ptBR } from 'date-fns/locale';\r\nimport { Button } from '@/features/shared/components/ui/button'; // Import Button\r\n\r\nconst ChatHistoryPage = () => {\r\n  const { user } = useAuth();\r\n  const [chatEvents, setChatEvents] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n\r\n  useEffect(() => {\r\n    const fetchChatEvents = async () => {\r\n      if (!user) return; // Se não houver usuário, não fazer nada\r\n\r\n      setLoading(true);\r\n      setError(null);\r\n      try {\r\n        // 1. Buscar eventos onde o usuário é participante APROVADO\r\n        const { data: participatedEventsData, error: participatedError } = await supabase\r\n          .from('event_participants')\r\n          .select(`\r\n            event_id,\r\n            event:events (\r\n              id,\r\n              title,\r\n              start_time,\r\n              status\r\n            )\r\n          `)\r\n          .eq('user_id', user.id)\r\n          .eq('status', 'aprovado');\r\n\r\n        if (participatedError) throw participatedError;\r\n\r\n        // 2. Buscar eventos onde o usuário é o CRIADOR\r\n        const { data: createdEventsData, error: createdError } = await supabase\r\n          .from('events')\r\n          .select('id, title, start_time, status')\r\n          .eq('creator_id', user.id);\r\n\r\n        if (createdError) throw createdError;\r\n\r\n        // 3. Combinar e remover duplicatas\r\n        const allEventsMap = new Map();\r\n\r\n        participatedEventsData.forEach(p => {\r\n          if (p.event) { // Checa se o join funcionou\r\n            allEventsMap.set(p.event.id, {\r\n              id: p.event.id,\r\n              title: p.event.title,\r\n              start_time: p.event.start_time,\r\n              status: p.event.status,\r\n              role: 'Participante' // Adiciona o papel\r\n            });\r\n          }\r\n        });\r\n\r\n        createdEventsData.forEach(e => {\r\n          // Se já existe como participante, apenas adiciona o papel 'Criador'\r\n          if (allEventsMap.has(e.id)) {\r\n            const existing = allEventsMap.get(e.id);\r\n            existing.role = 'Criador & Participante'; // Ou apenas 'Criador' se preferir\r\n          } else {\r\n            // Se não existe, adiciona como criador\r\n            allEventsMap.set(e.id, {\r\n              id: e.id,\r\n              title: e.title,\r\n              start_time: e.start_time,\r\n              status: e.status,\r\n              role: 'Criador'\r\n            });\r\n          }\r\n        });\r\n\r\n        // 4. Converter o Map para Array e ordenar por data (mais recente primeiro)\r\n        const combinedEvents = Array.from(allEventsMap.values())\r\n          .sort((a, b) => new Date(b.start_time).getTime() - new Date(a.start_time).getTime());\r\n\r\n        setChatEvents(combinedEvents);\r\n\r\n      } catch (err) {\r\n        console.error(\"Erro ao buscar histórico de chats:\", err);\r\n        setError(\"Não foi possível carregar o histórico de chats.\");\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchChatEvents();\r\n  }, [user]); // Depende do 'user'\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-[calc(100vh-10rem)]\">\r\n        <Loader2 className=\"w-12 h-12 text-purple-500 animate-spin\" />\r\n        <p className=\"ml-3 text-white/70\">Carregando seus chats...</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"flex flex-col items-center justify-center h-[calc(100vh-10rem)] text-center\">\r\n        <AlertTriangle className=\"w-12 h-12 text-red-500 mb-4\" />\r\n        <h2 className=\"text-xl font-semibold text-white mb-2\">{error}</h2>\r\n        {/* Adicionado botão para tentar novamente */}\r\n        <Button onClick={() => window.location.reload()}> \r\n          Tentar Novamente\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <Helmet>\r\n        <title>Meus Chats - Mesapra2</title>\r\n      </Helmet>\r\n      <div className=\"py-6 px-4 sm:px-6 lg:px-8\">\r\n        <h1 className=\"text-3xl font-bold text-white mb-6\">Meus Chats</h1>\r\n\r\n        {chatEvents.length === 0 ? (\r\n          <div className=\"glass-effect rounded-2xl p-12 border border-white/10 text-center\">\r\n            <MessageSquare className=\"w-16 h-16 text-white/20 mx-auto mb-4\" />\r\n            <p className=\"text-white/60 text-lg mb-4\">\r\n              Nenhum chat encontrado\r\n            </p>\r\n            <p className=\"text-white/40 text-sm\">\r\n              Participe ou crie eventos para começar a conversar!\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {chatEvents.map(event => (\r\n              <Link key={event.id} to={`/event/${event.id}/chat`}>\r\n                <div className=\"glass-effect rounded-lg p-4 border border-white/10 hover:border-purple-500/50 transition-colors cursor-pointer\">\r\n                  <div className=\"flex justify-between items-start\">\r\n                    <div>\r\n                      <h2 className=\"text-lg font-semibold text-white mb-1\">{event.title}</h2>\r\n                      <div className=\"flex items-center gap-4 text-xs text-white/60\">\r\n                         <span className=\"flex items-center gap-1\">\r\n                            <Calendar className=\"w-3 h-3\"/>\r\n                            {format(new Date(event.start_time), \"dd/MM/yy 'às' HH:mm\", { locale: ptBR })}\r\n                         </span>\r\n                         <span className=\"flex items-center gap-1\">\r\n                             <Users className=\"w-3 h-3\"/>\r\n                             {event.role} {/* Mostra se é Criador ou Participante */}\r\n                         </span>\r\n                      </div>\r\n                    </div>\r\n                     {/* Badge de Status (Opcional) */}\r\n                     <span className={`px-2 py-0.5 rounded-full text-xs font-medium border ${\r\n                          event.status === 'Cancelado' ? 'border-red-500/30 text-red-300'\r\n                        : ['Finalizado', 'Concluído'].includes(event.status) ? 'border-gray-500/30 text-gray-300'\r\n                        : 'border-green-500/30 text-green-300'\r\n                     }`}>\r\n                       {event.status}\r\n                     </span>\r\n                  </div>\r\n                   {/* Futuramente: Adicionar última mensagem ou indicador de não lidas aqui */}\r\n                </div>\r\n              </Link>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default ChatHistoryPage;"],"version":3}