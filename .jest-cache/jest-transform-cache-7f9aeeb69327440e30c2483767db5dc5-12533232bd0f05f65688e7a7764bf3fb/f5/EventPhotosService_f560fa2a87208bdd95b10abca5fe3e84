615b07b4134babf86ce77e21a03ce9bb
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// src/services/EventPhotosService.ts
const supabaseClient_1 = require("../lib/supabaseClient");
const BUCKET = 'event-photos';
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
class EventPhotosService {
    /**
     * Upload de foto de participante para um evento.
     * - valida tipo e tamanho
     * - substitui foto antiga se existir
     * - faz upload no Supabase Storage
     * - registra no BD
     */
    static async uploadEventPhoto(eventId, userId, file) {
        console.log(`üì∏ Iniciando upload de foto para evento ${eventId}...`);
        if (!file.type.startsWith('image/')) {
            return { success: false, error: 'Apenas imagens s√£o permitidas' };
        }
        if (file.size > MAX_FILE_SIZE) {
            return { success: false, error: 'Arquivo muito grande (m√°x: 10MB)' };
        }
        const existing = await this.getUserPhotoForEvent(eventId, userId);
        if (existing) {
            await this.deleteEventPhoto(existing.id, userId);
        }
        const resizedFile = await this.resizeImage(file);
        const ext = file.name.split('.').pop() || 'jpg';
        const fileName = `${eventId}/${userId}-${Date.now()}.${ext}`;
        const { error: uploadError } = await supabaseClient_1.supabase.storage
            .from(BUCKET)
            .upload(fileName, resizedFile, {
            cacheControl: '3600',
            upsert: true
        });
        if (uploadError) {
            console.error('‚ùå Erro no upload:', uploadError);
            return { success: false, error: uploadError.message };
        }
        const { data: publicUrlData } = supabaseClient_1.supabase.storage
            .from(BUCKET)
            .getPublicUrl(fileName);
        const publicUrl = publicUrlData?.publicUrl ?? '';
        const { error: dbError } = await supabaseClient_1.supabase.from('event_photos').insert({
            event_id: eventId,
            user_id: userId,
            photo_url: publicUrl,
            file_size: resizedFile.size,
            status: 'aprovado'
        });
        if (dbError) {
            console.error('‚ùå Erro ao salvar no BD:', dbError);
            await supabaseClient_1.supabase.storage.from(BUCKET).remove([fileName]);
            return { success: false, error: dbError.message };
        }
        console.log('‚úÖ Foto enviada com sucesso!');
        return { success: true, photoUrl: publicUrl };
    }
    /**
     * Retorna todas as fotos aprovadas de um evento.
     */
    static async getEventPhotos(eventId) {
        const { data, error } = await supabaseClient_1.supabase
            .from('event_photos')
            .select('*')
            .eq('event_id', eventId)
            .eq('status', 'aprovado')
            .order('created_at', { ascending: false });
        if (error) {
            console.error('‚ùå Erro ao buscar fotos:', error);
            return [];
        }
        return data ?? [];
    }
    /**
     * Retorna a foto de um usu√°rio espec√≠fico em um evento.
     */
    static async getUserPhotoForEvent(eventId, userId) {
        const { data, error } = await supabaseClient_1.supabase
            .from('event_photos')
            .select('*')
            .eq('event_id', eventId)
            .eq('user_id', userId)
            .maybeSingle();
        if (error || !data)
            return null;
        return data;
    }
    /**
     * Deleta foto de evento (somente se for o dono).
     */
    static async deleteEventPhoto(photoId, userId) {
        const { data: photo, error: fetchError } = await supabaseClient_1.supabase
            .from('event_photos')
            .select('*')
            .eq('id', photoId)
            .maybeSingle();
        if (fetchError || !photo) {
            console.error('‚ùå Foto n√£o encontrada');
            return false;
        }
        if (photo.user_id !== userId) {
            console.error('‚ùå Sem permiss√£o para deletar esta foto');
            return false;
        }
        const storagePath = this.extractStoragePath(photo.photo_url);
        if (storagePath) {
            await supabaseClient_1.supabase.storage.from(BUCKET).remove([storagePath]);
        }
        const { error: deleteError } = await supabaseClient_1.supabase
            .from('event_photos')
            .delete()
            .eq('id', photoId)
            .eq('user_id', userId);
        if (deleteError) {
            console.error('‚ùå Erro ao deletar do BD:', deleteError);
            return false;
        }
        console.log('‚úÖ Foto deletada com sucesso');
        return true;
    }
    /**
     * Retorna estat√≠sticas de fotos de um evento.
     */
    static async getPhotoStats(eventId) {
        try {
            const { count: totalPhotos, error: photosError } = await supabaseClient_1.supabase
                .from('event_photos')
                .select('*', { count: 'exact', head: true })
                .eq('event_id', eventId)
                .eq('status', 'aprovado');
            if (photosError)
                throw photosError;
            const { count: totalParticipants, error: participantsError } = await supabaseClient_1.supabase
                .from('event_participants')
                .select('*', { count: 'exact', head: true })
                .eq('event_id', eventId);
            if (participantsError)
                throw participantsError;
            const photos = totalPhotos ?? 0;
            const participants = totalParticipants ?? 0;
            return {
                totalPhotos: photos,
                totalParticipants: participants,
                percentageWithPhotos: participants > 0 ? Number(((photos / participants) * 100).toFixed(2)) : 0
            };
        }
        catch (error) {
            console.error('‚ùå Erro ao buscar stats de fotos:', error);
            return {
                totalPhotos: 0,
                totalParticipants: 0,
                percentageWithPhotos: 0
            };
        }
    }
    /**
     * Redimensiona imagem (mock no ambiente de teste)
     */
    static async resizeImage(file) {
        return file;
    }
    /**
     * Extrai o path do storage a partir da URL p√∫blica
     */
    static extractStoragePath(publicUrl) {
        if (!publicUrl)
            return null;
        const marker = `${BUCKET}/`;
        const idx = publicUrl.lastIndexOf(marker);
        if (idx === -1)
            return null;
        return publicUrl.substring(idx + marker.length);
    }
}
exports.default = EventPhotosService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcRXZlbnRQaG90b3NTZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEscUNBQXFDO0FBQ3JDLDBEQUFpRDtBQUVqRCxNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUM7QUFDOUIsTUFBTSxhQUFhLEdBQUcsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxPQUFPO0FBc0IvQyxNQUFxQixrQkFBa0I7SUFDckM7Ozs7OztPQU1HO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FDM0IsT0FBZSxFQUNmLE1BQWMsRUFDZCxJQUFVO1FBRVYsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQ0FBMkMsT0FBTyxLQUFLLENBQUMsQ0FBQztRQUVyRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUNwQyxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsK0JBQStCLEVBQUUsQ0FBQztRQUNwRSxDQUFDO1FBRUQsSUFBSSxJQUFJLENBQUMsSUFBSSxHQUFHLGFBQWEsRUFBRSxDQUFDO1lBQzlCLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxrQ0FBa0MsRUFBRSxDQUFDO1FBQ3ZFLENBQUM7UUFFRCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDbEUsSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUNiLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDbkQsQ0FBQztRQUVELE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUss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QUcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbEQsQ0FBQztDQUNGO0FBNU1ELHFDQTRNQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcREVWTWl4XFxBcHAuTWVzYXByYTIuY29tXFxzcmNcXHNlcnZpY2VzXFxFdmVudFBob3Rvc1NlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL3NlcnZpY2VzL0V2ZW50UGhvdG9zU2VydmljZS50c1xyXG5pbXBvcnQgeyBzdXBhYmFzZSB9IGZyb20gJy4uL2xpYi9zdXBhYmFzZUNsaWVudCc7XHJcblxyXG5jb25zdCBCVUNLRVQgPSAnZXZlbnQtcGhvdG9zJztcclxuY29uc3QgTUFYX0ZJTEVfU0laRSA9IDEwICogMTAyNCAqIDEwMjQ7IC8vIDEwTUJcclxuXHJcbmV4cG9ydCB0eXBlIEV2ZW50UGhvdG8gPSB7XHJcbiAgaWQ6IG51bWJlcjtcclxuICBldmVudF9pZDogbnVtYmVyO1xyXG4gIHVzZXJfaWQ6IHN0cmluZztcclxuICBwaG90b191cmw6IHN0cmluZztcclxuICBzdGF0dXM6IHN0cmluZztcclxuICBmaWxlX3NpemU/OiBudW1iZXI7XHJcbiAgY3JlYXRlZF9hdD86IHN0cmluZztcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIFVwbG9hZFJlc3VsdCA9XHJcbiAgfCB7IHN1Y2Nlc3M6IHRydWU7IHBob3RvVXJsOiBzdHJpbmcgfVxyXG4gIHwgeyBzdWNjZXNzOiBmYWxzZTsgZXJyb3I6IHN0cmluZyB9O1xyXG5cclxuZXhwb3J0IHR5cGUgUGhvdG9TdGF0cyA9IHtcclxuICB0b3RhbFBob3RvczogbnVtYmVyO1xyXG4gIHRvdGFsUGFydGljaXBhbnRzOiBudW1iZXI7XHJcbiAgcGVyY2VudGFnZVdpdGhQaG90b3M6IG51bWJlcjtcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEV2ZW50UGhvdG9zU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICogVXBsb2FkIGRlIGZvdG8gZGUgcGFydGljaXBhbnRlIHBhcmEgdW0gZXZlbnRvLlxyXG4gICAqIC0gdmFsaWRhIHRpcG8gZSB0YW1hbmhvXHJcbiAgICogLSBzdWJzdGl0dWkgZm90byBhbnRpZ2Egc2UgZXhpc3RpclxyXG4gICAqIC0gZmF6IHVwbG9hZCBubyBTdXBhYmFzZSBTdG9yYWdlXHJcbiAgICogLSByZWdpc3RyYSBubyBCRFxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyB1cGxvYWRFdmVudFBob3RvKFxyXG4gICAgZXZlbnRJZDogbnVtYmVyLFxyXG4gICAgdXNlcklkOiBzdHJpbmcsXHJcbiAgICBmaWxlOiBGaWxlXHJcbiAgKTogUHJvbWlzZTxVcGxvYWRSZXN1bHQ+IHtcclxuICAgIGNvbnNvbGUubG9nKGDwn5O4IEluaWNpYW5kbyB1cGxvYWQgZGUgZm90byBwYXJhIGV2ZW50byAke2V2ZW50SWR9Li4uYCk7XHJcblxyXG4gICAgaWYgKCFmaWxlLnR5cGUuc3RhcnRzV2l0aCgnaW1hZ2UvJykpIHtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnQXBlbmFzIGltYWdlbnMgc8OjbyBwZXJtaXRpZGFzJyB9O1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWxlLnNpemUgPiBNQVhfRklMRV9TSVpFKSB7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ0FycXVpdm8gbXVpdG8gZ3JhbmRlIChtw6F4OiAxME1CKScgfTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHRoaXMuZ2V0VXNlclBob3RvRm9yRXZlbnQoZXZlbnRJZCwgdXNlcklkKTtcclxuICAgIGlmIChleGlzdGluZykge1xyXG4gICAgICBhd2FpdCB0aGlzLmRlbGV0ZUV2ZW50UGhvdG8oZXhpc3RpbmcuaWQsIHVzZXJJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVzaXplZEZpbGUgPSBhd2FpdCB0aGlzLnJlc2l6ZUltYWdlKGZpbGUpO1xyXG4gICAgY29uc3QgZXh0ID0gZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCkgfHwgJ2pwZyc7XHJcbiAgICBjb25zdCBmaWxlTmFtZSA9IGAke2V2ZW50SWR9LyR7dXNlcklkfS0ke0RhdGUubm93KCl9LiR7ZXh0fWA7XHJcblxyXG4gICAgY29uc3QgeyBlcnJvcjogdXBsb2FkRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLnN0b3JhZ2VcclxuICAgICAgLmZyb20oQlVDS0VUKVxyXG4gICAgICAudXBsb2FkKGZpbGVOYW1lLCByZXNpemVkRmlsZSwge1xyXG4gICAgICAgIGNhY2hlQ29udHJvbDogJzM2MDAnLFxyXG4gICAgICAgIHVwc2VydDogdHJ1ZVxyXG4gICAgICB9KTtcclxuXHJcbiAgICBpZiAodXBsb2FkRXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gbm8gdXBsb2FkOicsIHVwbG9hZEVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiB1cGxvYWRFcnJvci5tZXNzYWdlIH07XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyBkYXRhOiBwdWJsaWNVcmxEYXRhIH0gPSBzdXBhYmFzZS5zdG9yYWdlXHJcbiAgICAgIC5mcm9tKEJVQ0tFVClcclxuICAgICAgLmdldFB1YmxpY1VybChmaWxlTmFtZSk7XHJcbiAgICBjb25zdCBwdWJsaWNVcmwgPSBwdWJsaWNVcmxEYXRhPy5wdWJsaWNVcmwgPz8gJyc7XHJcblxyXG4gICAgY29uc3QgeyBlcnJvcjogZGJFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UuZnJvbSgnZXZlbnRfcGhvdG9zJykuaW5zZXJ0KHtcclxuICAgICAgZXZlbnRfaWQ6IGV2ZW50SWQsXHJcbiAgICAgIHVzZXJfaWQ6IHVzZXJJZCxcclxuICAgICAgcGhvdG9fdXJsOiBwdWJsaWNVcmwsXHJcbiAgICAgIGZpbGVfc2l6ZTogcmVzaXplZEZpbGUuc2l6ZSxcclxuICAgICAgc3RhdHVzOiAnYXByb3ZhZG8nXHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoZGJFcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBzYWx2YXIgbm8gQkQ6JywgZGJFcnJvcik7XHJcbiAgICAgIGF3YWl0IHN1cGFiYXNlLnN0b3JhZ2UuZnJvbShCVUNLRVQpLnJlbW92ZShbZmlsZU5hbWVdKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBkYkVycm9yLm1lc3NhZ2UgfTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLmxvZygn4pyFIEZvdG8gZW52aWFkYSBjb20gc3VjZXNzbyEnKTtcclxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHBob3RvVXJsOiBwdWJsaWNVcmwgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldG9ybmEgdG9kYXMgYXMgZm90b3MgYXByb3ZhZGFzIGRlIHVtIGV2ZW50by5cclxuICAgKi9cclxuICBzdGF0aWMgYXN5bmMgZ2V0RXZlbnRQaG90b3MoZXZlbnRJZDogbnVtYmVyKTogUHJvbWlzZTxFdmVudFBob3RvW10+IHtcclxuICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgIC5mcm9tKCdldmVudF9waG90b3MnKVxyXG4gICAgICAuc2VsZWN0KCcqJylcclxuICAgICAgLmVxKCdldmVudF9pZCcsIGV2ZW50SWQpXHJcbiAgICAgIC5lcSgnc3RhdHVzJywgJ2Fwcm92YWRvJylcclxuICAgICAgLm9yZGVyKCdjcmVhdGVkX2F0JywgeyBhc2NlbmRpbmc6IGZhbHNlIH0pO1xyXG5cclxuICAgIGlmIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBidXNjYXIgZm90b3M6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGRhdGEgPz8gW107XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXRvcm5hIGEgZm90byBkZSB1bSB1c3XDoXJpbyBlc3BlY8OtZmljbyBlbSB1bSBldmVudG8uXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIGdldFVzZXJQaG90b0ZvckV2ZW50KFxyXG4gICAgZXZlbnRJZDogbnVtYmVyLFxyXG4gICAgdXNlcklkOiBzdHJpbmdcclxuICApOiBQcm9taXNlPEV2ZW50UGhvdG8gfCBudWxsPiB7XHJcbiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAuZnJvbSgnZXZlbnRfcGhvdG9zJylcclxuICAgICAgLnNlbGVjdCgnKicpXHJcbiAgICAgIC5lcSgnZXZlbnRfaWQnLCBldmVudElkKVxyXG4gICAgICAuZXEoJ3VzZXJfaWQnLCB1c2VySWQpXHJcbiAgICAgIC5tYXliZVNpbmdsZSgpO1xyXG5cclxuICAgIGlmIChlcnJvciB8fCAhZGF0YSkgcmV0dXJuIG51bGw7XHJcbiAgICByZXR1cm4gZGF0YSBhcyBFdmVudFBob3RvO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGVsZXRhIGZvdG8gZGUgZXZlbnRvIChzb21lbnRlIHNlIGZvciBvIGRvbm8pLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBkZWxldGVFdmVudFBob3RvKFxyXG4gICAgcGhvdG9JZDogbnVtYmVyLFxyXG4gICAgdXNlcklkOiBzdHJpbmdcclxuICApOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IHsgZGF0YTogcGhvdG8sIGVycm9yOiBmZXRjaEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAuZnJvbSgnZXZlbnRfcGhvdG9zJylcclxuICAgICAgLnNlbGVjdCgnKicpXHJcbiAgICAgIC5lcSgnaWQnLCBwaG90b0lkKVxyXG4gICAgICAubWF5YmVTaW5nbGUoKTtcclxuXHJcbiAgICBpZiAoZmV0Y2hFcnJvciB8fCAhcGhvdG8pIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEZvdG8gbsOjbyBlbmNvbnRyYWRhJyk7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocGhvdG8udXNlcl9pZCAhPT0gdXNlcklkKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBTZW0gcGVybWlzc8OjbyBwYXJhIGRlbGV0YXIgZXN0YSBmb3RvJyk7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdG9yYWdlUGF0aCA9IHRoaXMuZXh0cmFjdFN0b3JhZ2VQYXRoKHBob3RvLnBob3RvX3VybCk7XHJcbiAgICBpZiAoc3RvcmFnZVBhdGgpIHtcclxuICAgICAgYXdhaXQgc3VwYWJhc2Uuc3RvcmFnZS5mcm9tKEJVQ0tFVCkucmVtb3ZlKFtzdG9yYWdlUGF0aF0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHsgZXJyb3I6IGRlbGV0ZUVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAuZnJvbSgnZXZlbnRfcGhvdG9zJylcclxuICAgICAgLmRlbGV0ZSgpXHJcbiAgICAgIC5lcSgnaWQnLCBwaG90b0lkKVxyXG4gICAgICAuZXEoJ3VzZXJfaWQnLCB1c2VySWQpO1xyXG5cclxuICAgIGlmIChkZWxldGVFcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBkZWxldGFyIGRvIEJEOicsIGRlbGV0ZUVycm9yKTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnNvbGUubG9nKCfinIUgRm90byBkZWxldGFkYSBjb20gc3VjZXNzbycpO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXRvcm5hIGVzdGF0w61zdGljYXMgZGUgZm90b3MgZGUgdW0gZXZlbnRvLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBnZXRQaG90b1N0YXRzKGV2ZW50SWQ6IG51bWJlcik6IFByb21pc2U8UGhvdG9TdGF0cz4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBjb3VudDogdG90YWxQaG90b3MsIGVycm9yOiBwaG90b3NFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRfcGhvdG9zJylcclxuICAgICAgICAuc2VsZWN0KCcqJywgeyBjb3VudDogJ2V4YWN0JywgaGVhZDogdHJ1ZSB9KVxyXG4gICAgICAgIC5lcSgnZXZlbnRfaWQnLCBldmVudElkKVxyXG4gICAgICAgIC5lcSgnc3RhdHVzJywgJ2Fwcm92YWRvJyk7XHJcblxyXG4gICAgICBpZiAocGhvdG9zRXJyb3IpIHRocm93IHBob3Rvc0Vycm9yO1xyXG5cclxuICAgICAgY29uc3QgeyBjb3VudDogdG90YWxQYXJ0aWNpcGFudHMsIGVycm9yOiBwYXJ0aWNpcGFudHNFcnJvciB9ID1cclxuICAgICAgICBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgICAgLmZyb20oJ2V2ZW50X3BhcnRpY2lwYW50cycpXHJcbiAgICAgICAgICAuc2VsZWN0KCcqJywgeyBjb3VudDogJ2V4YWN0JywgaGVhZDogdHJ1ZSB9KVxyXG4gICAgICAgICAgLmVxKCdldmVudF9pZCcsIGV2ZW50SWQpO1xyXG5cclxuICAgICAgaWYgKHBhcnRpY2lwYW50c0Vycm9yKSB0aHJvdyBwYXJ0aWNpcGFudHNFcnJvcjtcclxuXHJcbiAgICAgIGNvbnN0IHBob3RvcyA9IHRvdGFsUGhvdG9zID8/IDA7XHJcbiAgICAgIGNvbnN0IHBhcnRpY2lwYW50cyA9IHRvdGFsUGFydGljaXBhbnRzID8/IDA7XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHRvdGFsUGhvdG9zOiBwaG90b3MsXHJcbiAgICAgICAgdG90YWxQYXJ0aWNpcGFudHM6IHBhcnRpY2lwYW50cyxcclxuICAgICAgICBwZXJjZW50YWdlV2l0aFBob3RvczpcclxuICAgICAgICAgIHBhcnRpY2lwYW50cyA+IDAgPyBOdW1iZXIoKChwaG90b3MgLyBwYXJ0aWNpcGFudHMpICogMTAwKS50b0ZpeGVkKDIpKSA6IDBcclxuICAgICAgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGJ1c2NhciBzdGF0cyBkZSBmb3RvczonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgdG90YWxQaG90b3M6IDAsXHJcbiAgICAgICAgdG90YWxQYXJ0aWNpcGFudHM6IDAsXHJcbiAgICAgICAgcGVyY2VudGFnZVdpdGhQaG90b3M6IDBcclxuICAgICAgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlZGltZW5zaW9uYSBpbWFnZW0gKG1vY2sgbm8gYW1iaWVudGUgZGUgdGVzdGUpXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgYXN5bmMgcmVzaXplSW1hZ2UoZmlsZTogRmlsZSk6IFByb21pc2U8RmlsZT4ge1xyXG4gICAgcmV0dXJuIGZpbGU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBFeHRyYWkgbyBwYXRoIGRvIHN0b3JhZ2UgYSBwYXJ0aXIgZGEgVVJMIHDDumJsaWNhXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXh0cmFjdFN0b3JhZ2VQYXRoKHB1YmxpY1VybDogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XHJcbiAgICBpZiAoIXB1YmxpY1VybCkgcmV0dXJuIG51bGw7XHJcbiAgICBjb25zdCBtYXJrZXIgPSBgJHtCVUNLRVR9L2A7XHJcbiAgICBjb25zdCBpZHggPSBwdWJsaWNVcmwubGFzdEluZGV4T2YobWFya2VyKTtcclxuICAgIGlmIChpZHggPT09IC0xKSByZXR1cm4gbnVsbDtcclxuICAgIHJldHVybiBwdWJsaWNVcmwuc3Vic3RyaW5nKGlkeCArIG1hcmtlci5sZW5ndGgpO1xyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=