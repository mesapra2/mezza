{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\services\\EventPhotosService.ts","mappings":"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","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\services\\EventPhotosService.ts"],"sourcesContent":["// src/services/EventPhotosService.ts\r\nimport { supabase } from '../lib/supabaseClient';\r\n\r\nconst BUCKET = 'event-photos';\r\nconst MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB\r\n\r\nexport type EventPhoto = {\r\n  id: number;\r\n  event_id: number;\r\n  user_id: string;\r\n  photo_url: string;\r\n  status: string;\r\n  file_size?: number;\r\n  created_at?: string;\r\n};\r\n\r\nexport type UploadResult =\r\n  | { success: true; photoUrl: string }\r\n  | { success: false; error: string };\r\n\r\nexport type PhotoStats = {\r\n  totalPhotos: number;\r\n  totalParticipants: number;\r\n  percentageWithPhotos: number;\r\n};\r\n\r\nexport default class EventPhotosService {\r\n  /**\r\n   * Upload de foto de participante para um evento.\r\n   * - valida tipo e tamanho\r\n   * - substitui foto antiga se existir\r\n   * - faz upload no Supabase Storage\r\n   * - registra no BD\r\n   */\r\n  static async uploadEventPhoto(\r\n    eventId: number,\r\n    userId: string,\r\n    file: File\r\n  ): Promise<UploadResult> {\r\n    console.log(`üì∏ Iniciando upload de foto para evento ${eventId}...`);\r\n\r\n    if (!file.type.startsWith('image/')) {\r\n      return { success: false, error: 'Apenas imagens s√£o permitidas' };\r\n    }\r\n\r\n    if (file.size > MAX_FILE_SIZE) {\r\n      return { success: false, error: 'Arquivo muito grande (m√°x: 10MB)' };\r\n    }\r\n\r\n    const existing = await this.getUserPhotoForEvent(eventId, userId);\r\n    if (existing) {\r\n      await this.deleteEventPhoto(existing.id, userId);\r\n    }\r\n\r\n    const resizedFile = await this.resizeImage(file);\r\n    const ext = file.name.split('.').pop() || 'jpg';\r\n    const fileName = `${eventId}/${userId}-${Date.now()}.${ext}`;\r\n\r\n    const { error: uploadError } = await supabase.storage\r\n      .from(BUCKET)\r\n      .upload(fileName, resizedFile, {\r\n        cacheControl: '3600',\r\n        upsert: true\r\n      });\r\n\r\n    if (uploadError) {\r\n      console.error('‚ùå Erro no upload:', uploadError);\r\n      return { success: false, error: uploadError.message };\r\n    }\r\n\r\n    const { data: publicUrlData } = supabase.storage\r\n      .from(BUCKET)\r\n      .getPublicUrl(fileName);\r\n    const publicUrl = publicUrlData?.publicUrl ?? '';\r\n\r\n    const { error: dbError } = await supabase.from('event_photos').insert({\r\n      event_id: eventId,\r\n      user_id: userId,\r\n      photo_url: publicUrl,\r\n      file_size: resizedFile.size,\r\n      status: 'aprovado'\r\n    });\r\n\r\n    if (dbError) {\r\n      console.error('‚ùå Erro ao salvar no BD:', dbError);\r\n      await supabase.storage.from(BUCKET).remove([fileName]);\r\n      return { success: false, error: dbError.message };\r\n    }\r\n\r\n    console.log('‚úÖ Foto enviada com sucesso!');\r\n    return { success: true, photoUrl: publicUrl };\r\n  }\r\n\r\n  /**\r\n   * Retorna todas as fotos aprovadas de um evento.\r\n   */\r\n  static async getEventPhotos(eventId: number): Promise<EventPhoto[]> {\r\n    const { data, error } = await supabase\r\n      .from('event_photos')\r\n      .select('*')\r\n      .eq('event_id', eventId)\r\n      .eq('status', 'aprovado')\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      console.error('‚ùå Erro ao buscar fotos:', error);\r\n      return [];\r\n    }\r\n\r\n    return data ?? [];\r\n  }\r\n\r\n  /**\r\n   * Retorna a foto de um usu√°rio espec√≠fico em um evento.\r\n   */\r\n  static async getUserPhotoForEvent(\r\n    eventId: number,\r\n    userId: string\r\n  ): Promise<EventPhoto | null> {\r\n    const { data, error } = await supabase\r\n      .from('event_photos')\r\n      .select('*')\r\n      .eq('event_id', eventId)\r\n      .eq('user_id', userId)\r\n      .maybeSingle();\r\n\r\n    if (error || !data) return null;\r\n    return data as EventPhoto;\r\n  }\r\n\r\n  /**\r\n   * Deleta foto de evento (somente se for o dono).\r\n   */\r\n  static async deleteEventPhoto(\r\n    photoId: number,\r\n    userId: string\r\n  ): Promise<boolean> {\r\n    const { data: photo, error: fetchError } = await supabase\r\n      .from('event_photos')\r\n      .select('*')\r\n      .eq('id', photoId)\r\n      .maybeSingle();\r\n\r\n    if (fetchError || !photo) {\r\n      console.error('‚ùå Foto n√£o encontrada');\r\n      return false;\r\n    }\r\n\r\n    if (photo.user_id !== userId) {\r\n      console.error('‚ùå Sem permiss√£o para deletar esta foto');\r\n      return false;\r\n    }\r\n\r\n    const storagePath = this.extractStoragePath(photo.photo_url);\r\n    if (storagePath) {\r\n      await supabase.storage.from(BUCKET).remove([storagePath]);\r\n    }\r\n\r\n    const { error: deleteError } = await supabase\r\n      .from('event_photos')\r\n      .delete()\r\n      .eq('id', photoId)\r\n      .eq('user_id', userId);\r\n\r\n    if (deleteError) {\r\n      console.error('‚ùå Erro ao deletar do BD:', deleteError);\r\n      return false;\r\n    }\r\n\r\n    console.log('‚úÖ Foto deletada com sucesso');\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Retorna estat√≠sticas de fotos de um evento.\r\n   */\r\n  static async getPhotoStats(eventId: number): Promise<PhotoStats> {\r\n    try {\r\n      const { count: totalPhotos, error: photosError } = await supabase\r\n        .from('event_photos')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('event_id', eventId)\r\n        .eq('status', 'aprovado');\r\n\r\n      if (photosError) throw photosError;\r\n\r\n      const { count: totalParticipants, error: participantsError } =\r\n        await supabase\r\n          .from('event_participants')\r\n          .select('*', { count: 'exact', head: true })\r\n          .eq('event_id', eventId);\r\n\r\n      if (participantsError) throw participantsError;\r\n\r\n      const photos = totalPhotos ?? 0;\r\n      const participants = totalParticipants ?? 0;\r\n\r\n      return {\r\n        totalPhotos: photos,\r\n        totalParticipants: participants,\r\n        percentageWithPhotos:\r\n          participants > 0 ? Number(((photos / participants) * 100).toFixed(2)) : 0\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao buscar stats de fotos:', error);\r\n      return {\r\n        totalPhotos: 0,\r\n        totalParticipants: 0,\r\n        percentageWithPhotos: 0\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Redimensiona imagem (mock no ambiente de teste)\r\n   */\r\n  private static async resizeImage(file: File): Promise<File> {\r\n    return file;\r\n  }\r\n\r\n  /**\r\n   * Extrai o path do storage a partir da URL p√∫blica\r\n   */\r\n  private static extractStoragePath(publicUrl: string): string | null {\r\n    if (!publicUrl) return null;\r\n    const marker = `${BUCKET}/`;\r\n    const idx = publicUrl.lastIndexOf(marker);\r\n    if (idx === -1) return null;\r\n    return publicUrl.substring(idx + marker.length);\r\n  }\r\n}\r\n"],"version":3}