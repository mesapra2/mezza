79eb2a25917edfd616aa0d726aa5d100
"use strict";
// src/services/NotificationService.test.ts
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
jest.mock('@/lib/supabaseClient', () => ({
    supabase: {
        from: mockFrom,
        rpc: mockRpc,
    }
}));
// --- 1. MOCKING DEPENDÃŠNCIAS (ANTES DAS IMPORTAÃ‡Ã•ES) ---
// Mock do Supabase
const mockFrom = jest.fn();
const mockRpc = jest.fn();
const NotificationService_1 = tslib_1.__importDefault(require("./NotificationService"));
// --- 3. CONFIGURAÃ‡ÃƒO DOS TESTES ---
describe('NotificationService', () => {
    // Limpa todos os mocks antes de cada teste
    beforeEach(() => {
        jest.clearAllMocks();
    });
    // --- 4. TESTES DOS MÃ‰TODOS ---
    describe('create (RLS)', () => {
        it('deve chamar supabase.insert com os dados corretos', async () => {
            const mockNotification = {
                user_id: 'user-123',
                event_id: 1,
                notification_type: 'Novo Evento',
                title: 'Teste',
                message: 'Mensagem teste',
            };
            const mockSingle = jest.fn().mockResolvedValue({
                data: { id: 1, ...mockNotification },
                error: null
            });
            const mockSelect = jest.fn().mockReturnValue({ single: mockSingle });
            const mockInsert = jest.fn().mockReturnValue({ select: mockSelect });
            mockFrom.mockReturnValue({
                insert: mockInsert,
            });
            const result = await NotificationService_1.default.create(mockNotification);
            expect(mockFrom).toHaveBeenCalledWith('notifications');
            expect(mockInsert).toHaveBeenCalledWith(expect.objectContaining({
                ...mockNotification,
                sent: false,
            }));
            expect(result.success).toBe(true);
            expect(result.data).toHaveProperty('id', 1);
        });
    });
    describe('createForUser (RPC)', () => {
        it('deve chamar supabase.rpc com os parÃ¢metros corretos', async () => {
            const rpcParams = {
                target_user_id: 'user-456',
                target_event_id: 2,
                notification_type: 'Candidatura Aprovada',
                title: 'Aprovado!',
                message: 'VocÃª foi aprovado.',
                target_participation_id: 'part-789',
            };
            mockRpc.mockResolvedValue({ error: null });
            const result = await NotificationService_1.default.createForUser(rpcParams);
            expect(mockRpc).toHaveBeenCalledWith('create_notification_for_user', rpcParams);
            expect(result.success).toBe(true);
        });
        it('deve lidar com participation_id nulo no RPC', async () => {
            mockRpc.mockResolvedValue({ error: null });
            await NotificationService_1.default.createForUser({
                target_user_id: 'user-456',
                target_event_id: 2,
                notification_type: 'Candidatura Aprovada',
                title: 'Aprovado!',
                message: 'VocÃª foi aprovado.',
                // participation_id Ã© omitido
            });
            expect(mockRpc).toHaveBeenCalledWith('create_notification_for_user', expect.objectContaining({
                target_participation_id: null, // Verifica se foi definido como null
            }));
        });
    });
    describe('FunÃ§Ãµes de NotificaÃ§Ã£o (notify*)', () => {
        // Espiona o mÃ©todo 'createForUser' que Ã© a base de todos
        let spyCreateForUser;
        beforeEach(() => {
            // Espionamos o mÃ©todo e simulamos um retorno de sucesso
            spyCreateForUser = jest.spyOn(NotificationService_1.default, 'createForUser')
                .mockResolvedValue({ success: true });
        });
        afterEach(() => {
            // Restauramos o mÃ©todo original apÃ³s cada teste
            spyCreateForUser.mockRestore();
        });
        it('notifyNewParticipation deve chamar createForUser corretamente', async () => {
            await NotificationService_1.default.notifyNewParticipation('host-id', 1, 'part-id', 'Michael', 'Evento Teste');
            expect(spyCreateForUser).toHaveBeenCalledWith({
                target_user_id: 'host-id',
                target_event_id: 1,
                notification_type: 'Candidatura Recebida',
                title: 'ðŸŽ‰ Nova Candidatura!',
                message: 'Michael se candidatou ao seu evento "Evento Teste"',
                target_participation_id: 'part-id',
            });
        });
        it('notifyParticipationApproved deve chamar createForUser corretamente', async () => {
            await NotificationService_1.default.notifyParticipationApproved('user-id', 2, 'Evento Aprovado');
            expect(spyCreateForUser).toHaveBeenCalledWith({
                target_user_id: 'user-id',
                target_event_id: 2,
                notification_type: 'Candidatura Aprovada',
                title: 'âœ… VocÃª foi aprovado!',
                message: 'Sua candidatura para "Evento Aprovado" foi aprovada!',
            });
        });
    });
    describe('notifyUsersWithMatchingHashtags', () => {
        it('deve notificar usuÃ¡rios com hashtags correspondentes', async () => {
            const profiles = [
                { id: 'user-1', username: 'user1', hashtags: ['react', 'node'] },
                { id: 'user-2', username: 'user2', hashtags: ['react', 'outro'] },
                { id: 'user-3', username: 'user3', hashtags: ['python'] }, // nÃ£o deve notificar
            ];
            const eventData = {
                creator_id: 'host-id',
                title: 'Evento de React',
                hashtags: ['react', 'typescript'],
                event_type: 'padrao',
            };
            // Mock 1: SELECT de perfis
            const mockSelectNeq = jest.fn().mockResolvedValue({ data: profiles, error: null });
            const mockSelectNot = jest.fn().mockReturnValue({ neq: mockSelectNeq });
            const mockSelect = jest.fn().mockReturnValue({ not: mockSelectNot });
            // Mock 2: INSERT de notificaÃ§Ãµes
            const mockInsert = jest.fn().mockResolvedValue({ error: null });
            mockFrom
                .mockReturnValueOnce({ select: mockSelect }) // primeira chamada: buscar perfis
                .mockReturnValueOnce({ insert: mockInsert }); // segunda chamada: inserir notificaÃ§Ãµes
            const result = await NotificationService_1.default.notifyUsersWithMatchingHashtags(10, eventData);
            expect(mockFrom).toHaveBeenCalledWith('profiles');
            expect(mockFrom).toHaveBeenCalledWith('notifications');
            expect(mockInsert).toHaveBeenCalled();
            // Verifica se apenas 2 usuÃ¡rios (user-1, user-2) foram notificados
            const insertedNotifications = mockInsert.mock.calls[0][0];
            expect(insertedNotifications).toHaveLength(2);
            expect(insertedNotifications[0].user_id).toBe('user-1');
            expect(insertedNotifications[1].user_id).toBe('user-2');
            expect(result.success).toBe(true);
            expect(result.data.notified).toBe(2);
        });
    });
    describe('getUserNotifications', () => {
        it('deve buscar notificaÃ§Ãµes e ordenÃ¡-las', async () => {
            const mockNotifications = [{ id: 1, message: 'NotificaÃ§Ã£o 1' }];
            const mockLimit = jest.fn().mockResolvedValue({ data: mockNotifications, error: null });
            const mockOrder = jest.fn().mockReturnValue({ limit: mockLimit });
            const mockEq = jest.fn().mockReturnValue({ order: mockOrder });
            const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });
            mockFrom.mockReturnValue({
                select: mockSelect,
            });
            const result = await NotificationService_1.default.getUserNotifications('user-id');
            expect(mockFrom).toHaveBeenCalledWith('notifications');
            expect(mockSelect).toHaveBeenCalledWith('*');
            expect(result.success).toBe(true);
            expect(result.data).toEqual(mockNotifications);
        });
    });
    describe('markAsRead', () => {
        it('deve chamar update para marcar como sent: true', async () => {
            const mockEq = jest.fn().mockResolvedValue({ error: null });
            const mockUpdate = jest.fn().mockReturnValue({ eq: mockEq });
            mockFrom.mockReturnValue({
                update: mockUpdate,
            });
            await NotificationService_1.default.markAsRead(123);
            expect(mockFrom).toHaveBeenCalledWith('notifications');
            expect(mockUpdate).toHaveBeenCalledWith({ sent: true });
            expect(mockEq).toHaveBeenCalledWith('id', 123);
        });
    });
    describe('getUnreadCount', () => {
        it('deve retornar a contagem de notificaÃ§Ãµes nÃ£o lidas', async () => {
            const mockEq2 = jest.fn().mockResolvedValue({ count: 5, error: null });
            const mockEq1 = jest.fn().mockReturnValue({ eq: mockEq2 });
            const mockSelect = jest.fn().mockReturnValue({ eq: mockEq1 });
            mockFrom.mockReturnValue({
                select: mockSelect,
            });
            const count = await NotificationService_1.default.getUnreadCount('user-id');
            expect(mockSelect).toHaveBeenCalledWith('*', { count: 'exact', head: true });
            expect(mockEq2).toHaveBeenCalledWith('sent', false);
            expect(count).toBe(5);
        });
    });
    describe('delete', () => {
        it('deve chamar delete com o ID correto', async () => {
            const mockEq = jest.fn().mockResolvedValue({ error: null });
            const mockDelete = jest.fn().mockReturnValue({ eq: mockEq });
            mockFrom.mockReturnValue({
                delete: mockDelete,
            });
            await NotificationService_1.default.delete(123);
            expect(mockFrom).toHaveBeenCalledWith('notifications');
            expect(mockEq).toHaveBeenCalledWith('id', 123);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcTm90aWZpY2F0aW9uU2VydmljZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQSwyQ0FBMkM7OztBQVEzQyxJQUFJLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDdkMsUUFBUSxFQUFFO1FBQ1IsSUFBSSxFQUFFLFFBQVE7UUFDZCxHQUFHLEVBQUUsT0FBTztLQUNiO0NBQ0YsQ0FBQyxDQUFDLENBQUM7QUFYSiwwREFBMEQ7QUFFMUQsbUJBQW1CO0FBQ25CLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUMzQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7QUFZMUIsd0ZBQXdEO0FBRXhELHFDQUFxQztBQUVyQyxRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO0lBRW5DLDJDQUEyQztJQUMzQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBRUgsZ0NBQWdDO0lBRWhDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO1FBQzVCLEVBQUUsQ0FBQyxtREFBbUQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNqRSxNQUFNLGdCQUFnQixHQUFHO2dCQUN2QixPQUFPLEVBQUUsVUFBVTtnQkFDbkIsUUFBUSxFQUFFLENBQUM7Z0JBQ1gsaUJBQWlCLEVBQUUsYUFBYTtnQkFDaEMsS0FBSyxFQUFFLE9BQU87Z0JBQ2QsT0FBTyxFQUFFLGdCQUFnQjthQUMxQixDQUFDO1lBRUYsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO2dCQUM3QyxJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsZ0JBQWdCLEVBQUU7Z0JBQ3BDLEtBQUssRUFBRSxJQUFJO2FBQ1os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bkIsQ0FBQyxDQUFDO1lBRUgsTUFBTSw2QkFBbUIsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFdEMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3ZELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDakQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUVMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxERVZNaXhcXEFwcC5NZXNhcHJhMi5jb21cXHNyY1xcc2VydmljZXNcXE5vdGlmaWNhdGlvblNlcnZpY2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvc2VydmljZXMvTm90aWZpY2F0aW9uU2VydmljZS50ZXN0LnRzXHJcblxyXG4vLyAtLS0gMS4gTU9DS0lORyBERVBFTkTDik5DSUFTIChBTlRFUyBEQVMgSU1QT1JUQcOHw5VFUykgLS0tXHJcblxyXG4vLyBNb2NrIGRvIFN1cGFiYXNlXHJcbmNvbnN0IG1vY2tGcm9tID0gamVzdC5mbigpO1xyXG5jb25zdCBtb2NrUnBjID0gamVzdC5mbigpO1xyXG5cclxuamVzdC5tb2NrKCdAL2xpYi9zdXBhYmFzZUNsaWVudCcsICgpID0+ICh7XHJcbiAgc3VwYWJhc2U6IHtcclxuICAgIGZyb206IG1vY2tGcm9tLFxyXG4gICAgcnBjOiBtb2NrUnBjLFxyXG4gIH1cclxufSkpO1xyXG5cclxuLy8gLS0tIDIuIElNUE9SVEHDh8OVRVMgKERFUE9JUyBET1MgTU9DS1MpIC0tLVxyXG5cclxuaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tICdAL2xpYi9zdXBhYmFzZUNsaWVudCc7XHJcbmltcG9ydCBOb3RpZmljYXRpb25TZXJ2aWNlIGZyb20gJy4vTm90aWZpY2F0aW9uU2VydmljZSc7XHJcblxyXG4vLyAtLS0gMy4gQ09ORklHVVJBw4fDg08gRE9TIFRFU1RFUyAtLS1cclxuXHJcbmRlc2NyaWJlKCdOb3RpZmljYXRpb25TZXJ2aWNlJywgKCkgPT4ge1xyXG5cclxuICAvLyBMaW1wYSB0b2RvcyBvcyBtb2NrcyBhbnRlcyBkZSBjYWRhIHRlc3RlXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICB9KTtcclxuXHJcbiAgLy8gLS0tIDQuIFRFU1RFUyBET1MgTcOJVE9ET1MgLS0tXHJcblxyXG4gIGRlc2NyaWJlKCdjcmVhdGUgKFJMUyknLCAoKSA9PiB7XHJcbiAgICBpdCgnZGV2ZSBjaGFtYXIgc3VwYWJhc2UuaW5zZXJ0IGNvbSBvcyBkYWRvcyBjb3JyZXRvcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja05vdGlmaWNhdGlvbiA9IHtcclxuICAgICAgICB1c2VyX2lkOiAndXNlci0xMjMnLFxyXG4gICAgICAgIGV2ZW50X2lkOiAxLFxyXG4gICAgICAgIG5vdGlmaWNhdGlvbl90eXBlOiAnTm92byBFdmVudG8nLFxyXG4gICAgICAgIHRpdGxlOiAnVGVzdGUnLFxyXG4gICAgICAgIG1lc3NhZ2U6ICdNZW5zYWdlbSB0ZXN0ZScsXHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBtb2NrU2luZ2xlID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgXHJcbiAgICAgICAgZGF0YTogeyBpZDogMSwgLi4ubW9ja05vdGlmaWNhdGlvbiB9LCBcclxuICAgICAgICBlcnJvcjogbnVsbCBcclxuICAgICAgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tTZWxlY3QgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgc2luZ2xlOiBtb2NrU2luZ2xlIH0pO1xyXG4gICAgICBjb25zdCBtb2NrSW5zZXJ0ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IHNlbGVjdDogbW9ja1NlbGVjdCB9KTtcclxuICAgICAgXHJcbiAgICAgIG1vY2tGcm9tLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgaW5zZXJ0OiBtb2NrSW5zZXJ0LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IE5vdGlmaWNhdGlvblNlcnZpY2UuY3JlYXRlKG1vY2tOb3RpZmljYXRpb24gYXMgYW55KTtcclxuXHJcbiAgICAgIGV4cGVjdChtb2NrRnJvbSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ25vdGlmaWNhdGlvbnMnKTtcclxuICAgICAgZXhwZWN0KG1vY2tJbnNlcnQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgIC4uLm1vY2tOb3RpZmljYXRpb24sXHJcbiAgICAgICAgICBzZW50OiBmYWxzZSxcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuZGF0YSkudG9IYXZlUHJvcGVydHkoJ2lkJywgMSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2NyZWF0ZUZvclVzZXIgKFJQQyknLCAoKSA9PiB7XHJcbiAgICBpdCgnZGV2ZSBjaGFtYXIgc3VwYWJhc2UucnBjIGNvbSBvcyBwYXLDom1ldHJvcyBjb3JyZXRvcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcnBjUGFyYW1zID0ge1xyXG4gICAgICAgIHRhcmdldF91c2VyX2lkOiAndXNlci00NTYnLFxyXG4gICAgICAgIHRhcmdldF9ldmVudF9pZDogMixcclxuICAgICAgICBub3RpZmljYXRpb25fdHlwZTogJ0NhbmRpZGF0dXJhIEFwcm92YWRhJyBhcyBjb25zdCxcclxuICAgICAgICB0aXRsZTogJ0Fwcm92YWRvIScsXHJcbiAgICAgICAgbWVzc2FnZTogJ1ZvY8OqIGZvaSBhcHJvdmFkby4nLFxyXG4gICAgICAgIHRhcmdldF9wYXJ0aWNpcGF0aW9uX2lkOiAncGFydC03ODknLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgbW9ja1JwYy5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGVycm9yOiBudWxsIH0pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5jcmVhdGVGb3JVc2VyKHJwY1BhcmFtcyk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja1JwYykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2NyZWF0ZV9ub3RpZmljYXRpb25fZm9yX3VzZXInLCBycGNQYXJhbXMpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnZGV2ZSBsaWRhciBjb20gcGFydGljaXBhdGlvbl9pZCBudWxvIG5vIFJQQycsIGFzeW5jICgpID0+IHtcclxuICAgICAgbW9ja1JwYy5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGVycm9yOiBudWxsIH0pO1xyXG5cclxuICAgICAgYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5jcmVhdGVGb3JVc2VyKHtcclxuICAgICAgICB0YXJnZXRfdXNlcl9pZDogJ3VzZXItNDU2JyxcclxuICAgICAgICB0YXJnZXRfZXZlbnRfaWQ6IDIsXHJcbiAgICAgICAgbm90aWZpY2F0aW9uX3R5cGU6ICdDYW5kaWRhdHVyYSBBcHJvdmFkYScsXHJcbiAgICAgICAgdGl0bGU6ICdBcHJvdmFkbyEnLFxyXG4gICAgICAgIG1lc3NhZ2U6ICdWb2PDqiBmb2kgYXByb3ZhZG8uJyxcclxuICAgICAgICAvLyBwYXJ0aWNpcGF0aW9uX2lkIMOpIG9taXRpZG9cclxuICAgICAgfSk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja1JwYykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2NyZWF0ZV9ub3RpZmljYXRpb25fZm9yX3VzZXInLCBcclxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICB0YXJnZXRfcGFydGljaXBhdGlvbl9pZDogbnVsbCwgLy8gVmVyaWZpY2Egc2UgZm9pIGRlZmluaWRvIGNvbW8gbnVsbFxyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0Z1bsOnw7VlcyBkZSBOb3RpZmljYcOnw6NvIChub3RpZnkqKScsICgpID0+IHtcclxuICAgIC8vIEVzcGlvbmEgbyBtw6l0b2RvICdjcmVhdGVGb3JVc2VyJyBxdWUgw6kgYSBiYXNlIGRlIHRvZG9zXHJcbiAgICBsZXQgc3B5Q3JlYXRlRm9yVXNlcjogamVzdC5TcGllZEZ1bmN0aW9uPHR5cGVvZiBOb3RpZmljYXRpb25TZXJ2aWNlLmNyZWF0ZUZvclVzZXI+O1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAvLyBFc3Bpb25hbW9zIG8gbcOpdG9kbyBlIHNpbXVsYW1vcyB1bSByZXRvcm5vIGRlIHN1Y2Vzc29cclxuICAgICAgc3B5Q3JlYXRlRm9yVXNlciA9IGplc3Quc3B5T24oTm90aWZpY2F0aW9uU2VydmljZSwgJ2NyZWF0ZUZvclVzZXInKVxyXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZSh7IHN1Y2Nlc3M6IHRydWUgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBhZnRlckVhY2goKCkgPT4ge1xyXG4gICAgICAvLyBSZXN0YXVyYW1vcyBvIG3DqXRvZG8gb3JpZ2luYWwgYXDDs3MgY2FkYSB0ZXN0ZVxyXG4gICAgICBzcHlDcmVhdGVGb3JVc2VyLm1vY2tSZXN0b3JlKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnbm90aWZ5TmV3UGFydGljaXBhdGlvbiBkZXZlIGNoYW1hciBjcmVhdGVGb3JVc2VyIGNvcnJldGFtZW50ZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5ub3RpZnlOZXdQYXJ0aWNpcGF0aW9uKCdob3N0LWlkJywgMSwgJ3BhcnQtaWQnLCAnTWljaGFlbCcsICdFdmVudG8gVGVzdGUnKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChzcHlDcmVhdGVGb3JVc2VyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgdGFyZ2V0X3VzZXJfaWQ6ICdob3N0LWlkJyxcclxuICAgICAgICB0YXJnZXRfZXZlbnRfaWQ6IDEsXHJcbiAgICAgICAgbm90aWZpY2F0aW9uX3R5cGU6ICdDYW5kaWRhdHVyYSBSZWNlYmlkYScsXHJcbiAgICAgICAgdGl0bGU6ICfwn46JIE5vdmEgQ2FuZGlkYXR1cmEhJyxcclxuICAgICAgICBtZXNzYWdlOiAnTWljaGFlbCBzZSBjYW5kaWRhdG91IGFvIHNldSBldmVudG8gXCJFdmVudG8gVGVzdGVcIicsXHJcbiAgICAgICAgdGFyZ2V0X3BhcnRpY2lwYXRpb25faWQ6ICdwYXJ0LWlkJyxcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnbm90aWZ5UGFydGljaXBhdGlvbkFwcHJvdmVkIGRldmUgY2hhbWFyIGNyZWF0ZUZvclVzZXIgY29ycmV0YW1lbnRlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBhd2FpdCBOb3RpZmljYXRpb25TZXJ2aWNlLm5vdGlmeVBhcnRpY2lwYXRpb25BcHByb3ZlZCgndXNlci1pZCcsIDIsICdFdmVudG8gQXByb3ZhZG8nKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChzcHlDcmVhdGVGb3JVc2VyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgdGFyZ2V0X3VzZXJfaWQ6ICd1c2VyLWlkJyxcclxuICAgICAgICB0YXJnZXRfZXZlbnRfaWQ6IDIsXHJcbiAgICAgICAgbm90aWZpY2F0aW9uX3R5cGU6ICdDYW5kaWRhdHVyYSBBcHJvdmFkYScsXHJcbiAgICAgICAgdGl0bGU6ICfinIUgVm9jw6ogZm9pIGFwcm92YWRvIScsXHJcbiAgICAgICAgbWVzc2FnZTogJ1N1YSBjYW5kaWRhdHVyYSBwYXJhIFwiRXZlbnRvIEFwcm92YWRvXCIgZm9pIGFwcm92YWRhIScsXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdub3RpZnlVc2Vyc1dpdGhNYXRjaGluZ0hhc2h0YWdzJywgKCkgPT4ge1xyXG4gICAgaXQoJ2RldmUgbm90aWZpY2FyIHVzdcOhcmlvcyBjb20gaGFzaHRhZ3MgY29ycmVzcG9uZGVudGVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBwcm9maWxlcyA9IFtcclxuICAgICAgICB7IGlkOiAndXNlci0xJywgdXNlcm5hbWU6ICd1c2VyMScsIGhhc2h0YWdzOiBbJ3JlYWN0JywgJ25vZGUnXSB9LFxyXG4gICAgICAgIHsgaWQ6ICd1c2VyLTInLCB1c2VybmFtZTogJ3VzZXIyJywgaGFzaHRhZ3M6IFsncmVhY3QnLCAnb3V0cm8nXSB9LFxyXG4gICAgICAgIHsgaWQ6ICd1c2VyLTMnLCB1c2VybmFtZTogJ3VzZXIzJywgaGFzaHRhZ3M6IFsncHl0aG9uJ10gfSwgLy8gbsOjbyBkZXZlIG5vdGlmaWNhclxyXG4gICAgICBdO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgZXZlbnREYXRhID0ge1xyXG4gICAgICAgIGNyZWF0b3JfaWQ6ICdob3N0LWlkJyxcclxuICAgICAgICB0aXRsZTogJ0V2ZW50byBkZSBSZWFjdCcsXHJcbiAgICAgICAgaGFzaHRhZ3M6IFsncmVhY3QnLCAndHlwZXNjcmlwdCddLFxyXG4gICAgICAgIGV2ZW50X3R5cGU6ICdwYWRyYW8nLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgLy8gTW9jayAxOiBTRUxFQ1QgZGUgcGVyZmlzXHJcbiAgICAgIGNvbnN0IG1vY2tTZWxlY3ROZXEgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBkYXRhOiBwcm9maWxlcywgZXJyb3I6IG51bGwgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tTZWxlY3ROb3QgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgbmVxOiBtb2NrU2VsZWN0TmVxIH0pO1xyXG4gICAgICBjb25zdCBtb2NrU2VsZWN0ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IG5vdDogbW9ja1NlbGVjdE5vdCB9KTtcclxuICAgICAgXHJcbiAgICAgIC8vIE1vY2sgMjogSU5TRVJUIGRlIG5vdGlmaWNhw6fDtWVzXHJcbiAgICAgIGNvbnN0IG1vY2tJbnNlcnQgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBlcnJvcjogbnVsbCB9KTtcclxuXHJcbiAgICAgIG1vY2tGcm9tXHJcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZU9uY2UoeyBzZWxlY3Q6IG1vY2tTZWxlY3QgfSkgIC8vIHByaW1laXJhIGNoYW1hZGE6IGJ1c2NhciBwZXJmaXNcclxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZSh7IGluc2VydDogbW9ja0luc2VydCB9KTsgLy8gc2VndW5kYSBjaGFtYWRhOiBpbnNlcmlyIG5vdGlmaWNhw6fDtWVzXHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBOb3RpZmljYXRpb25TZXJ2aWNlLm5vdGlmeVVzZXJzV2l0aE1hdGNoaW5nSGFzaHRhZ3MoMTAsIGV2ZW50RGF0YSk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja0Zyb20pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdwcm9maWxlcycpO1xyXG4gICAgICBleHBlY3QobW9ja0Zyb20pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdub3RpZmljYXRpb25zJyk7XHJcbiAgICAgIGV4cGVjdChtb2NrSW5zZXJ0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBWZXJpZmljYSBzZSBhcGVuYXMgMiB1c3XDoXJpb3MgKHVzZXItMSwgdXNlci0yKSBmb3JhbSBub3RpZmljYWRvc1xyXG4gICAgICBjb25zdCBpbnNlcnRlZE5vdGlmaWNhdGlvbnMgPSBtb2NrSW5zZXJ0Lm1vY2suY2FsbHNbMF1bMF07XHJcbiAgICAgIGV4cGVjdChpbnNlcnRlZE5vdGlmaWNhdGlvbnMpLnRvSGF2ZUxlbmd0aCgyKTtcclxuICAgICAgZXhwZWN0KGluc2VydGVkTm90aWZpY2F0aW9uc1swXS51c2VyX2lkKS50b0JlKCd1c2VyLTEnKTtcclxuICAgICAgZXhwZWN0KGluc2VydGVkTm90aWZpY2F0aW9uc1sxXS51c2VyX2lkKS50b0JlKCd1c2VyLTInKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhLm5vdGlmaWVkKS50b0JlKDIpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdnZXRVc2VyTm90aWZpY2F0aW9ucycsICgpID0+IHtcclxuICAgIGl0KCdkZXZlIGJ1c2NhciBub3RpZmljYcOnw7VlcyBlIG9yZGVuw6EtbGFzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrTm90aWZpY2F0aW9ucyA9IFt7IGlkOiAxLCBtZXNzYWdlOiAnTm90aWZpY2HDp8OjbyAxJyB9XTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IG1vY2tMaW1pdCA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IG1vY2tOb3RpZmljYXRpb25zLCBlcnJvcjogbnVsbCB9KTtcclxuICAgICAgY29uc3QgbW9ja09yZGVyID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IGxpbWl0OiBtb2NrTGltaXQgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tFcSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBvcmRlcjogbW9ja09yZGVyIH0pO1xyXG4gICAgICBjb25zdCBtb2NrU2VsZWN0ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IGVxOiBtb2NrRXEgfSk7XHJcbiAgICAgIFxyXG4gICAgICBtb2NrRnJvbS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHNlbGVjdDogbW9ja1NlbGVjdCxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBOb3RpZmljYXRpb25TZXJ2aWNlLmdldFVzZXJOb3RpZmljYXRpb25zKCd1c2VyLWlkJyk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja0Zyb20pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdub3RpZmljYXRpb25zJyk7XHJcbiAgICAgIGV4cGVjdChtb2NrU2VsZWN0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnKicpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuZGF0YSkudG9FcXVhbChtb2NrTm90aWZpY2F0aW9ucyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ21hcmtBc1JlYWQnLCAoKSA9PiB7XHJcbiAgICBpdCgnZGV2ZSBjaGFtYXIgdXBkYXRlIHBhcmEgbWFyY2FyIGNvbW8gc2VudDogdHJ1ZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja0VxID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZXJyb3I6IG51bGwgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tVcGRhdGUgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcSB9KTtcclxuICAgICAgXHJcbiAgICAgIG1vY2tGcm9tLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgdXBkYXRlOiBtb2NrVXBkYXRlLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGF3YWl0IE5vdGlmaWNhdGlvblNlcnZpY2UubWFya0FzUmVhZCgxMjMpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tGcm9tKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnbm90aWZpY2F0aW9ucycpO1xyXG4gICAgICBleHBlY3QobW9ja1VwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBzZW50OiB0cnVlIH0pO1xyXG4gICAgICBleHBlY3QobW9ja0VxKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnaWQnLCAxMjMpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdnZXRVbnJlYWRDb3VudCcsICgpID0+IHtcclxuICAgIGl0KCdkZXZlIHJldG9ybmFyIGEgY29udGFnZW0gZGUgbm90aWZpY2HDp8O1ZXMgbsOjbyBsaWRhcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja0VxMiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGNvdW50OiA1LCBlcnJvcjogbnVsbCB9KTtcclxuICAgICAgY29uc3QgbW9ja0VxMSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMiB9KTtcclxuICAgICAgY29uc3QgbW9ja1NlbGVjdCA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMSB9KTtcclxuICAgICAgXHJcbiAgICAgIG1vY2tGcm9tLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgc2VsZWN0OiBtb2NrU2VsZWN0LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IGNvdW50ID0gYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5nZXRVbnJlYWRDb3VudCgndXNlci1pZCcpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tTZWxlY3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCcqJywgeyBjb3VudDogJ2V4YWN0JywgaGVhZDogdHJ1ZSB9KTtcclxuICAgICAgZXhwZWN0KG1vY2tFcTIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdzZW50JywgZmFsc2UpO1xyXG4gICAgICBleHBlY3QoY291bnQpLnRvQmUoNSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2RlbGV0ZScsICgpID0+IHtcclxuICAgIGl0KCdkZXZlIGNoYW1hciBkZWxldGUgY29tIG8gSUQgY29ycmV0bycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja0VxID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZXJyb3I6IG51bGwgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tEZWxldGUgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcSB9KTtcclxuICAgICAgXHJcbiAgICAgIG1vY2tGcm9tLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgZGVsZXRlOiBtb2NrRGVsZXRlLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGF3YWl0IE5vdGlmaWNhdGlvblNlcnZpY2UuZGVsZXRlKDEyMyk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja0Zyb20pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdub3RpZmljYXRpb25zJyk7XHJcbiAgICAgIGV4cGVjdChtb2NrRXEpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdpZCcsIDEyMyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==