041a9230ada2a4386992dced5bd29cae
"use strict";
// src/services/PushNotificationService.test.ts
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
jest.mock('../lib/supabaseClient', () => ({
    supabase: {
        from: mockFrom,
    }
}));
// --- 1. MOCKING DEPENDÃŠNCIAS (ANTES DAS IMPORTAÃ‡Ã•ES) ---
// Mock do Supabase
const mockFrom = jest.fn();
const PushNotificationService_1 = tslib_1.__importDefault(require("./PushNotificationService"));
// --- 3. CONFIGURAÃ‡ÃƒO DOS TESTES ---
describe('PushNotificationService', () => {
    // EspiÃµes (Spies) para os mÃ©todos estÃ¡ticos que sÃ£o chamados internamente
    let spySendPush;
    let spyLogPush;
    let spySendToDevice;
    beforeEach(() => {
        jest.clearAllMocks();
        // Recria os espiÃµes antes de cada teste
        spySendPush = jest.spyOn(PushNotificationService_1.default, 'sendPush')
            .mockResolvedValue({ success: true });
        // Espionamos os mÃ©todos privados para verificar se sÃ£o chamados
        spyLogPush = jest.spyOn(PushNotificationService_1.default, 'logPushNotification')
            .mockResolvedValue(undefined);
        spySendToDevice = jest.spyOn(PushNotificationService_1.default, 'sendPushToDevice')
            .mockResolvedValue(undefined);
    });
    afterEach(() => {
        // Restaura os espiÃµes apÃ³s cada teste
        spySendPush.mockRestore();
        spyLogPush.mockRestore();
        spySendToDevice.mockRestore();
    });
    // --- 4. TESTES DOS MÃ‰TODOS ---
    describe('sendPush (MÃ©todo Principal)', () => {
        it('deve enviar push para mÃºltiplos devices e registrar log', async () => {
            // Libera o mock de 'sendPush' para testar sua lÃ³gica interna
            spySendPush.mockRestore();
            const mockDevices = [
                { token: 'token-web', platform: 'web' },
                { token: 'token-ios', platform: 'ios' },
            ];
            // Mock do SELECT de tokens
            const mockEq2 = jest.fn().mockResolvedValue({ data: mockDevices, error: null });
            const mockEq1 = jest.fn().mockReturnValue({ eq: mockEq2 });
            const mockSelect = jest.fn().mockReturnValue({ eq: mockEq1 });
            mockFrom.mockReturnValue({
                select: mockSelect,
            });
            const params = {
                userId: 'user-123',
                title: 'TÃ­tulo Teste',
                body: 'Corpo Teste',
                eventId: 1,
            };
            const result = await PushNotificationService_1.default.sendPush(params);
            expect(result.success).toBe(true);
            expect(result.message).toBe('Enviada para 2 dispositivos');
            // Verifica se buscou os tokens
            expect(mockFrom).toHaveBeenCalledWith('user_device_tokens');
            // Verifica se tentou enviar para os 2 devices
            expect(spySendToDevice).toHaveBeenCalledTimes(2);
            expect(spySendToDevice).toHaveBeenCalledWith(expect.objectContaining({ token: 'token-web' }));
            expect(spySendToDevice).toHaveBeenCalledWith(expect.objectContaining({ token: 'token-ios' }));
            // Verifica se registrou o log
            expect(spyLogPush).toHaveBeenCalledWith(expect.objectContaining({
                user_id: 'user-123',
                devices_sent: 2,
                total_devices: 2,
            }));
        });
        it('nÃ£o deve fazer nada se o usuÃ¡rio nÃ£o tiver tokens', async () => {
            // Libera o mock de 'sendPush' para testar sua lÃ³gica interna
            spySendPush.mockRestore();
            // Mock do SELECT de tokens (retornando vazio)
            const mockEq2 = jest.fn().mockResolvedValue({ data: [], error: null });
            const mockEq1 = jest.fn().mockReturnValue({ eq: mockEq2 });
            const mockSelect = jest.fn().mockReturnValue({ eq: mockEq1 });
            mockFrom.mockReturnValue({
                select: mockSelect,
            });
            const params = { userId: 'user-404', title: 'Teste', body: '...' };
            const result = await PushNotificationService_1.default.sendPush(params);
            expect(result.success).toBe(true);
            expect(result.message).toBe('Nenhum dispositivo registrado');
            // Garante que nÃ£o tentou enviar nem registrar log
            expect(spySendToDevice).not.toHaveBeenCalled();
            expect(spyLogPush).not.toHaveBeenCalled();
        });
    });
    describe('sendPasswordToHost', () => {
        it('deve inserir notificaÃ§Ã£o no DB e chamar sendPush', async () => {
            // Mock do INSERT da notificaÃ§Ã£o
            const mockInsert = jest.fn().mockResolvedValue({ error: null });
            mockFrom.mockReturnValue({
                insert: mockInsert,
            });
            const result = await PushNotificationService_1.default.sendPasswordToHost('host-id', 1, '1234', 'Evento Senha');
            expect(result.success).toBe(true);
            // Verifica se inseriu a notificaÃ§Ã£o no DB
            expect(mockFrom).toHaveBeenCalledWith('notifications');
            expect(mockInsert).toHaveBeenCalledWith(expect.objectContaining({
                user_id: 'host-id',
                event_id: 1,
                notification_type: 'event_password',
                data: { password: '1234' },
            }));
            // Verifica se chamou o 'sendPush' (que estÃ¡ espionado)
            expect(spySendPush).toHaveBeenCalledWith(expect.objectContaining({
                userId: 'host-id',
                title: 'ðŸ”‘ Sua Senha do Evento',
                body: expect.stringContaining('1234'),
                data: expect.objectContaining({ password: '1234' }),
            }));
        });
    });
    describe('sendEventStartNotificationToParticipants', () => {
        it('deve chamar sendPush para cada participante', async () => {
            const participants = ['part-1', 'part-2'];
            await PushNotificationService_1.default.sendEventStartNotificationToParticipants(participants, 2, 'Evento ComeÃ§ando');
            // Verifica se 'sendPush' (espionado) foi chamado 2 vezes
            expect(spySendPush).toHaveBeenCalledTimes(2);
            // Verifica a chamada para o primeiro participante
            expect(spySendPush).toHaveBeenCalledWith(expect.objectContaining({
                userId: 'part-1',
                eventId: 2,
                title: 'ðŸŽ‰ Seu Evento estÃ¡ ComeÃ§ando!',
            }));
            // Verifica a chamada para o segundo participante
            expect(spySendPush).toHaveBeenCalledWith(expect.objectContaining({
                userId: 'part-2',
                eventId: 2,
                title: 'ðŸŽ‰ Seu Evento estÃ¡ ComeÃ§ando!',
            }));
        });
    });
    describe('registerDeviceToken', () => {
        it('deve chamar insert em user_device_tokens', async () => {
            const mockInsert = jest.fn().mockResolvedValue({ error: null });
            mockFrom.mockReturnValue({
                insert: mockInsert,
            });
            await PushNotificationService_1.default.registerDeviceToken('user-id', 'token-teste', 'web');
            expect(mockFrom).toHaveBeenCalledWith('user_device_tokens');
            expect(mockInsert).toHaveBeenCalledWith(expect.objectContaining({
                user_id: 'user-id',
                token: 'token-teste',
                platform: 'web',
                is_active: true,
            }));
        });
    });
    describe('unregisterDeviceToken', () => {
        it('deve chamar update em user_device_tokens', async () => {
            const mockEq = jest.fn().mockResolvedValue({ error: null });
            const mockUpdate = jest.fn().mockReturnValue({ eq: mockEq });
            mockFrom.mockReturnValue({
                update: mockUpdate,
            });
            await PushNotificationService_1.default.unregisterDeviceToken('token-para-remover');
            expect(mockFrom).toHaveBeenCalledWith('user_device_tokens');
            expect(mockUpdate).toHaveBeenCalledWith({ is_active: false });
            expect(mockEq).toHaveBeenCalledWith('token', 'token-para-remover');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUEsK0NBQStDOzs7QUFPL0MsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLFFBQVEsRUFBRTtRQUNSLElBQUksRUFBRSxRQUFRO0tBQ2Y7Q0FDRixDQUFDLENBQUMsQ0FBQztBQVRKLDBEQUEwRDtBQUUxRCxtQkFBbUI7QUFDbkIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBVzNCLGdHQUFnRTtBQUVoRSxxQ0FBcUM7QUFFckMsUUFBUSxDQUFDLHlCQUF5QixFQUFFLEdBQUcsRUFBRTtJQUV2QywwRUFBMEU7SUFDMUUsSUFBSSxXQUF3RSxDQUFDO0lBQzdFLElBQUksVUFBbUMsQ0FBQztJQUN4QyxJQUFJLGVBQXdDLENBQUM7SUFFN0MsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUVyQix3Q0FBd0M7UUFDeEMsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsaUNBQXVCLEVBQUUsVUFBVSxDQUFDO2FBQzFELGlCQUFpQixDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFFeEMsZ0VBQWdFO1FBQ2hFLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGlDQUE4QixFQUFFLHFCQUFxQixDQUFDO2FBQzNFLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRWhDLGVBQWUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGlDQUE4QixFQUFFLGtCQUFrQixDQUFDO2FBQzdFLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2xDLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLHNDQUFzQztRQUN0QyxXQUFXLENBQUMs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aXhcXEFwcC5NZXNhcHJhMi5jb21cXHNyY1xcc2VydmljZXNcXFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL3NlcnZpY2VzL1B1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnRlc3QudHNcclxuXHJcbi8vIC0tLSAxLiBNT0NLSU5HIERFUEVORMOKTkNJQVMgKEFOVEVTIERBUyBJTVBPUlRBw4fDlUVTKSAtLS1cclxuXHJcbi8vIE1vY2sgZG8gU3VwYWJhc2VcclxuY29uc3QgbW9ja0Zyb20gPSBqZXN0LmZuKCk7XHJcblxyXG5qZXN0Lm1vY2soJy4uL2xpYi9zdXBhYmFzZUNsaWVudCcsICgpID0+ICh7XHJcbiAgc3VwYWJhc2U6IHtcclxuICAgIGZyb206IG1vY2tGcm9tLFxyXG4gIH1cclxufSkpO1xyXG5cclxuLy8gLS0tIDIuIElNUE9SVEHDh8OVRVMgKERFUE9JUyBET1MgTU9DS1MpIC0tLVxyXG5cclxuaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tICcuLi9saWIvc3VwYWJhc2VDbGllbnQnO1xyXG5pbXBvcnQgUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UgZnJvbSAnLi9QdXNoTm90aWZpY2F0aW9uU2VydmljZSc7XHJcblxyXG4vLyAtLS0gMy4gQ09ORklHVVJBw4fDg08gRE9TIFRFU1RFUyAtLS1cclxuXHJcbmRlc2NyaWJlKCdQdXNoTm90aWZpY2F0aW9uU2VydmljZScsICgpID0+IHtcclxuXHJcbiAgLy8gRXNwacO1ZXMgKFNwaWVzKSBwYXJhIG9zIG3DqXRvZG9zIGVzdMOhdGljb3MgcXVlIHPDo28gY2hhbWFkb3MgaW50ZXJuYW1lbnRlXHJcbiAgbGV0IHNweVNlbmRQdXNoOiBqZXN0LlNwaWVkRnVuY3Rpb248dHlwZW9mIFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnNlbmRQdXNoPjtcclxuICBsZXQgc3B5TG9nUHVzaDogamVzdC5TcGllZEZ1bmN0aW9uPGFueT47XHJcbiAgbGV0IHNweVNlbmRUb0RldmljZTogamVzdC5TcGllZEZ1bmN0aW9uPGFueT47XHJcblxyXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XHJcblxyXG4gICAgLy8gUmVjcmlhIG9zIGVzcGnDtWVzIGFudGVzIGRlIGNhZGEgdGVzdGVcclxuICAgIHNweVNlbmRQdXNoID0gamVzdC5zcHlPbihQdXNoTm90aWZpY2F0aW9uU2VydmljZSwgJ3NlbmRQdXNoJylcclxuICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKHsgc3VjY2VzczogdHJ1ZSB9KTtcclxuXHJcbiAgICAvLyBFc3Bpb25hbW9zIG9zIG3DqXRvZG9zIHByaXZhZG9zIHBhcmEgdmVyaWZpY2FyIHNlIHPDo28gY2hhbWFkb3NcclxuICAgIHNweUxvZ1B1c2ggPSBqZXN0LnNweU9uKFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlIGFzIGFueSwgJ2xvZ1B1c2hOb3RpZmljYXRpb24nKVxyXG4gICAgICAubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuICAgICAgXHJcbiAgICBzcHlTZW5kVG9EZXZpY2UgPSBqZXN0LnNweU9uKFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlIGFzIGFueSwgJ3NlbmRQdXNoVG9EZXZpY2UnKVxyXG4gICAgICAubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuICB9KTtcclxuXHJcbiAgYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAgIC8vIFJlc3RhdXJhIG9zIGVzcGnDtWVzIGFww7NzIGNhZGEgdGVzdGVcclxuICAgIHNweVNlbmRQdXNoLm1vY2tSZXN0b3JlKCk7XHJcbiAgICBzcHlMb2dQdXNoLm1vY2tSZXN0b3JlKCk7XHJcbiAgICBzcHlTZW5kVG9EZXZpY2UubW9ja1Jlc3RvcmUoKTtcclxuICB9KTtcclxuXHJcbiAgLy8gLS0tIDQuIFRFU1RFUyBET1MgTcOJVE9ET1MgLS0tXHJcblxyXG4gIGRlc2NyaWJlKCdzZW5kUHVzaCAoTcOpdG9kbyBQcmluY2lwYWwpJywgKCkgPT4ge1xyXG4gICAgaXQoJ2RldmUgZW52aWFyIHB1c2ggcGFyYSBtw7psdGlwbG9zIGRldmljZXMgZSByZWdpc3RyYXIgbG9nJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBMaWJlcmEgbyBtb2NrIGRlICdzZW5kUHVzaCcgcGFyYSB0ZXN0YXIgc3VhIGzDs2dpY2EgaW50ZXJuYVxyXG4gICAgICBzcHlTZW5kUHVzaC5tb2NrUmVzdG9yZSgpOyBcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IG1vY2tEZXZpY2VzID0gW1xyXG4gICAgICAgIHsgdG9rZW46ICd0b2tlbi13ZWInLCBwbGF0Zm9ybTogJ3dlYicgfSxcclxuICAgICAgICB7IHRva2VuOiAndG9rZW4taW9zJywgcGxhdGZvcm06ICdpb3MnIH0sXHJcbiAgICAgIF07XHJcblxyXG4gICAgICAvLyBNb2NrIGRvIFNFTEVDVCBkZSB0b2tlbnNcclxuICAgICAgY29uc3QgbW9ja0VxMiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IG1vY2tEZXZpY2VzLCBlcnJvcjogbnVsbCB9KTtcclxuICAgICAgY29uc3QgbW9ja0VxMSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMiB9KTtcclxuICAgICAgY29uc3QgbW9ja1NlbGVjdCA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMSB9KTtcclxuXHJcbiAgICAgIG1vY2tGcm9tLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgc2VsZWN0OiBtb2NrU2VsZWN0LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHBhcmFtcyA9IHtcclxuICAgICAgICB1c2VySWQ6ICd1c2VyLTEyMycsXHJcbiAgICAgICAgdGl0bGU6ICdUw610dWxvIFRlc3RlJyxcclxuICAgICAgICBib2R5OiAnQ29ycG8gVGVzdGUnLFxyXG4gICAgICAgIGV2ZW50SWQ6IDEsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQdXNoTm90aWZpY2F0aW9uU2VydmljZS5zZW5kUHVzaChwYXJhbXMpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG4gICAgICBleHBlY3QocmVzdWx0Lm1lc3NhZ2UpLnRvQmUoJ0VudmlhZGEgcGFyYSAyIGRpc3Bvc2l0aXZvcycpO1xyXG4gICAgICBcclxuICAgICAgLy8gVmVyaWZpY2Egc2UgYnVzY291IG9zIHRva2Vuc1xyXG4gICAgICBleHBlY3QobW9ja0Zyb20pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyX2RldmljZV90b2tlbnMnKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFZlcmlmaWNhIHNlIHRlbnRvdSBlbnZpYXIgcGFyYSBvcyAyIGRldmljZXNcclxuICAgICAgZXhwZWN0KHNweVNlbmRUb0RldmljZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xyXG4gICAgICBleHBlY3Qoc3B5U2VuZFRvRGV2aWNlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7IHRva2VuOiAndG9rZW4td2ViJyB9KSk7XHJcbiAgICAgIGV4cGVjdChzcHlTZW5kVG9EZXZpY2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5vYmplY3RDb250YWluaW5nKHsgdG9rZW46ICd0b2tlbi1pb3MnIH0pKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFZlcmlmaWNhIHNlIHJlZ2lzdHJvdSBvIGxvZ1xyXG4gICAgICBleHBlY3Qoc3B5TG9nUHVzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgdXNlcl9pZDogJ3VzZXItMTIzJyxcclxuICAgICAgICAgIGRldmljZXNfc2VudDogMixcclxuICAgICAgICAgIHRvdGFsX2RldmljZXM6IDIsXHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCduw6NvIGRldmUgZmF6ZXIgbmFkYSBzZSBvIHVzdcOhcmlvIG7Do28gdGl2ZXIgdG9rZW5zJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBMaWJlcmEgbyBtb2NrIGRlICdzZW5kUHVzaCcgcGFyYSB0ZXN0YXIgc3VhIGzDs2dpY2EgaW50ZXJuYVxyXG4gICAgICBzcHlTZW5kUHVzaC5tb2NrUmVzdG9yZSgpOyBcclxuICAgICAgXHJcbiAgICAgIC8vIE1vY2sgZG8gU0VMRUNUIGRlIHRva2VucyAocmV0b3JuYW5kbyB2YXppbylcclxuICAgICAgY29uc3QgbW9ja0VxMiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IFtdLCBlcnJvcjogbnVsbCB9KTtcclxuICAgICAgY29uc3QgbW9ja0VxMSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMiB9KTtcclxuICAgICAgY29uc3QgbW9ja1NlbGVjdCA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMSB9KTtcclxuXHJcbiAgICAgIG1vY2tGcm9tLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgc2VsZWN0OiBtb2NrU2VsZWN0LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHBhcmFtcyA9IHsgdXNlcklkOiAndXNlci00MDQnLCB0aXRsZTogJ1Rlc3RlJywgYm9keTogJy4uLicgfTtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgUHVzaE5vdGlmaWNhdGlvblNlcnZpY2Uuc2VuZFB1c2gocGFyYW1zKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5tZXNzYWdlKS50b0JlKCdOZW5odW0gZGlzcG9zaXRpdm8gcmVnaXN0cmFkbycpO1xyXG4gICAgICBcclxuICAgICAgLy8gR2FyYW50ZSBxdWUgbsOjbyB0ZW50b3UgZW52aWFyIG5lbSByZWdpc3RyYXIgbG9nXHJcbiAgICAgIGV4cGVjdChzcHlTZW5kVG9EZXZpY2UpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgIGV4cGVjdChzcHlMb2dQdXNoKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdzZW5kUGFzc3dvcmRUb0hvc3QnLCAoKSA9PiB7XHJcbiAgICBpdCgnZGV2ZSBpbnNlcmlyIG5vdGlmaWNhw6fDo28gbm8gREIgZSBjaGFtYXIgc2VuZFB1c2gnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIC8vIE1vY2sgZG8gSU5TRVJUIGRhIG5vdGlmaWNhw6fDo29cclxuICAgICAgY29uc3QgbW9ja0luc2VydCA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGVycm9yOiBudWxsIH0pO1xyXG4gICAgICBcclxuICAgICAgbW9ja0Zyb20ubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICBpbnNlcnQ6IG1vY2tJbnNlcnQsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgUHVzaE5vdGlmaWNhdGlvblNlcnZpY2Uuc2VuZFBhc3N3b3JkVG9Ib3N0KFxyXG4gICAgICAgICdob3N0LWlkJywgMSwgJzEyMzQnLCAnRXZlbnRvIFNlbmhhJ1xyXG4gICAgICApO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG5cclxuICAgICAgLy8gVmVyaWZpY2Egc2UgaW5zZXJpdSBhIG5vdGlmaWNhw6fDo28gbm8gREJcclxuICAgICAgZXhwZWN0KG1vY2tGcm9tKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnbm90aWZpY2F0aW9ucycpO1xyXG4gICAgICBleHBlY3QobW9ja0luc2VydCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgdXNlcl9pZDogJ2hvc3QtaWQnLFxyXG4gICAgICAgICAgZXZlbnRfaWQ6IDEsXHJcbiAgICAgICAgICBub3RpZmljYXRpb25fdHlwZTogJ2V2ZW50X3Bhc3N3b3JkJyxcclxuICAgICAgICAgIGRhdGE6IHsgcGFzc3dvcmQ6ICcxMjM0JyB9LFxyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcblxyXG4gICAgICAvLyBWZXJpZmljYSBzZSBjaGFtb3UgbyAnc2VuZFB1c2gnIChxdWUgZXN0w6EgZXNwaW9uYWRvKVxyXG4gICAgICBleHBlY3Qoc3B5U2VuZFB1c2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgIHVzZXJJZDogJ2hvc3QtaWQnLFxyXG4gICAgICAgICAgdGl0bGU6ICfwn5SRIFN1YSBTZW5oYSBkbyBFdmVudG8nLFxyXG4gICAgICAgICAgYm9keTogZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJzEyMzQnKSxcclxuICAgICAgICAgIGRhdGE6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHsgcGFzc3dvcmQ6ICcxMjM0JyB9KSxcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdzZW5kRXZlbnRTdGFydE5vdGlmaWNhdGlvblRvUGFydGljaXBhbnRzJywgKCkgPT4ge1xyXG4gICAgaXQoJ2RldmUgY2hhbWFyIHNlbmRQdXNoIHBhcmEgY2FkYSBwYXJ0aWNpcGFudGUnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHBhcnRpY2lwYW50cyA9IFsncGFydC0xJywgJ3BhcnQtMiddO1xyXG4gICAgICBhd2FpdCBQdXNoTm90aWZpY2F0aW9uU2VydmljZS5zZW5kRXZlbnRTdGFydE5vdGlmaWNhdGlvblRvUGFydGljaXBhbnRzKFxyXG4gICAgICAgIHBhcnRpY2lwYW50cywgMiwgJ0V2ZW50byBDb21lw6dhbmRvJ1xyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gVmVyaWZpY2Egc2UgJ3NlbmRQdXNoJyAoZXNwaW9uYWRvKSBmb2kgY2hhbWFkbyAyIHZlemVzXHJcbiAgICAgIGV4cGVjdChzcHlTZW5kUHVzaCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xyXG5cclxuICAgICAgLy8gVmVyaWZpY2EgYSBjaGFtYWRhIHBhcmEgbyBwcmltZWlybyBwYXJ0aWNpcGFudGVcclxuICAgICAgZXhwZWN0KHNweVNlbmRQdXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICB1c2VySWQ6ICdwYXJ0LTEnLFxyXG4gICAgICAgICAgZXZlbnRJZDogMixcclxuICAgICAgICAgIHRpdGxlOiAn8J+OiSBTZXUgRXZlbnRvIGVzdMOhIENvbWXDp2FuZG8hJyxcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgICAvLyBWZXJpZmljYSBhIGNoYW1hZGEgcGFyYSBvIHNlZ3VuZG8gcGFydGljaXBhbnRlXHJcbiAgICAgIGV4cGVjdChzcHlTZW5kUHVzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgdXNlcklkOiAncGFydC0yJyxcclxuICAgICAgICAgIGV2ZW50SWQ6IDIsXHJcbiAgICAgICAgICB0aXRsZTogJ/CfjokgU2V1IEV2ZW50byBlc3TDoSBDb21lw6dhbmRvIScsXHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgncmVnaXN0ZXJEZXZpY2VUb2tlbicsICgpID0+IHtcclxuICAgIGl0KCdkZXZlIGNoYW1hciBpbnNlcnQgZW0gdXNlcl9kZXZpY2VfdG9rZW5zJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrSW5zZXJ0ID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZXJyb3I6IG51bGwgfSk7XHJcbiAgICAgIFxyXG4gICAgICBtb2NrRnJvbS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIGluc2VydDogbW9ja0luc2VydCxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBhd2FpdCBQdXNoTm90aWZpY2F0aW9uU2VydmljZS5yZWdpc3RlckRldmljZVRva2VuKCd1c2VyLWlkJywgJ3Rva2VuLXRlc3RlJywgJ3dlYicpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tGcm9tKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndXNlcl9kZXZpY2VfdG9rZW5zJyk7XHJcbiAgICAgIGV4cGVjdChtb2NrSW5zZXJ0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICB1c2VyX2lkOiAndXNlci1pZCcsXHJcbiAgICAgICAgICB0b2tlbjogJ3Rva2VuLXRlc3RlJyxcclxuICAgICAgICAgIHBsYXRmb3JtOiAnd2ViJyxcclxuICAgICAgICAgIGlzX2FjdGl2ZTogdHJ1ZSxcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCd1bnJlZ2lzdGVyRGV2aWNlVG9rZW4nLCAoKSA9PiB7XHJcbiAgICBpdCgnZGV2ZSBjaGFtYXIgdXBkYXRlIGVtIHVzZXJfZGV2aWNlX3Rva2VucycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja0VxID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZXJyb3I6IG51bGwgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tVcGRhdGUgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcSB9KTtcclxuICAgICAgXHJcbiAgICAgIG1vY2tGcm9tLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgdXBkYXRlOiBtb2NrVXBkYXRlLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGF3YWl0IFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnVucmVnaXN0ZXJEZXZpY2VUb2tlbigndG9rZW4tcGFyYS1yZW1vdmVyJyk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja0Zyb20pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyX2RldmljZV90b2tlbnMnKTtcclxuICAgICAgZXhwZWN0KG1vY2tVcGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgaXNfYWN0aXZlOiBmYWxzZSB9KTtcclxuICAgICAgZXhwZWN0KG1vY2tFcSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3Rva2VuJywgJ3Rva2VuLXBhcmEtcmVtb3ZlcicpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG59KTsiXSwidmVyc2lvbiI6M30=