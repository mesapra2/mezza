{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\services\\WaitingListService.ts","mappings":"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","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\services\\WaitingListService.ts"],"sourcesContent":["// src/features/shared/services/WaitingListService.ts\r\nimport { supabase } from '../lib/supabaseClient';\r\nimport NotificationService from '../services/NotificationService';\r\nimport ParticipationService from '../services/ParticipationService';\r\n\r\ninterface WaitingListEntry {\r\n  id?: string;\r\n  user_id: string;\r\n  event_id: string;\r\n  position: number;\r\n  created_at?: string;\r\n  notified?: boolean;\r\n}\r\n\r\nclass WaitingListService {\r\n  /**\r\n   * Adiciona um usuário à lista de espera\r\n   */\r\n  async addToWaitingList(userId: string, eventId: string): Promise<WaitingListEntry | null> {\r\n    try {\r\n      // Verifica se o usuário já está na lista de espera\r\n      const { data: existing, error: checkError } = await supabase\r\n        .from('waiting_list')\r\n        .select('*')\r\n        .eq('user_id', userId)\r\n        .eq('event_id', eventId)\r\n        .single();\r\n\r\n      if (existing) {\r\n        console.log('Usuário já está na lista de espera');\r\n        return existing;\r\n      }\r\n\r\n      // Obtém a última posição na lista\r\n      const { data: lastEntry } = await supabase\r\n        .from('waiting_list')\r\n        .select('position')\r\n        .eq('event_id', eventId)\r\n        .order('position', { ascending: false })\r\n        .limit(1)\r\n        .single();\r\n\r\n      const newPosition = lastEntry ? lastEntry.position + 1 : 1;\r\n\r\n      // Adiciona o usuário à lista\r\n      const { data, error } = await supabase\r\n        .from('waiting_list')\r\n        .insert({\r\n          user_id: userId,\r\n          event_id: eventId,\r\n          position: newPosition,\r\n          notified: false\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Envia notificação de confirmação\r\n      await NotificationService.createForUser({\r\n        target_user_id: userId,\r\n        target_event_id: parseInt(eventId),\r\n        notification_type: 'event_reminder',\r\n        title: 'Você entrou na lista de espera',\r\n        message: `Você está na posição ${newPosition} da lista de espera.`\r\n      });\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error('Erro ao adicionar à lista de espera:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove um usuário da lista de espera\r\n   */\r\n  async removeFromWaitingList(userId: string, eventId: string): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('waiting_list')\r\n        .delete()\r\n        .eq('user_id', userId)\r\n        .eq('event_id', eventId);\r\n\r\n      if (error) throw error;\r\n\r\n      // Reorganiza as posições\r\n      await this.reorganizePositions(eventId);\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Erro ao remover da lista de espera:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtém a lista de espera de um evento\r\n   */\r\n  async getWaitingList(eventId: string): Promise<WaitingListEntry[]> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('waiting_list')\r\n        .select('*')\r\n        .eq('event_id', eventId)\r\n        .order('position', { ascending: true });\r\n\r\n      if (error) throw error;\r\n\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Erro ao obter lista de espera:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtém a posição de um usuário na lista de espera\r\n   */\r\n  async getUserPosition(userId: string, eventId: string): Promise<number | null> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('waiting_list')\r\n        .select('position')\r\n        .eq('user_id', userId)\r\n        .eq('event_id', eventId)\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      return data?.position || null;\r\n    } catch (error) {\r\n      console.error('Erro ao obter posição na lista:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Processa a lista de espera quando uma vaga é liberada\r\n   */\r\n  async processWaitingList(eventId: string): Promise<void> {\r\n    try {\r\n      // Obtém o primeiro da lista que ainda não foi notificado\r\n      const { data: nextInLine, error } = await supabase\r\n        .from('waiting_list')\r\n        .select('*')\r\n        .eq('event_id', eventId)\r\n        .eq('notified', false)\r\n        .order('position', { ascending: true })\r\n        .limit(1)\r\n        .single();\r\n\r\n      if (error || !nextInLine) {\r\n        console.log('Nenhum usuário na lista de espera ou todos já foram notificados');\r\n        return;\r\n      }\r\n\r\n      // Marca como notificado\r\n      await supabase\r\n        .from('waiting_list')\r\n        .update({ notified: true })\r\n        .eq('id', nextInLine.id);\r\n\r\n      // Envia notificação\r\n      // TODO: Implementar método de notificação apropriado\r\n      console.log('Notificando usuário sobre vaga disponível:', nextInLine.user_id);\r\n\r\n      // Tenta aplicar para o evento automaticamente\r\n      const applied = await ParticipationService.applyToEvent(\r\n        eventId,\r\n        nextInLine.user_id,\r\n        'Aplicação automática da lista de espera'\r\n      );\r\n\r\n      if (applied.success && applied.isAutoApproved) {\r\n        // Remove da lista de espera se a participação foi confirmada\r\n        await this.removeFromWaitingList(nextInLine.user_id, eventId);\r\n      }\r\n    } catch (error) {\r\n      console.error('Erro ao processar lista de espera:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Reorganiza as posições na lista de espera\r\n   */\r\n  private async reorganizePositions(eventId: string): Promise<void> {\r\n    try {\r\n      const waitingList = await this.getWaitingList(eventId);\r\n\r\n      // Atualiza as posições sequencialmente\r\n      for (let i = 0; i < waitingList.length; i++) {\r\n        const entry = waitingList[i];\r\n        if (entry.position !== i + 1) {\r\n          await supabase\r\n            .from('waiting_list')\r\n            .update({ position: i + 1 })\r\n            .eq('id', entry.id);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Erro ao reorganizar posições:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verifica se um usuário está na lista de espera\r\n   */\r\n  async isInWaitingList(userId: string, eventId: string): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('waiting_list')\r\n        .select('id')\r\n        .eq('user_id', userId)\r\n        .eq('event_id', eventId)\r\n        .single();\r\n\r\n      return !!data && !error;\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtém o total de pessoas na lista de espera\r\n   */\r\n  async getWaitingListCount(eventId: string): Promise<number> {\r\n    try {\r\n      const { count, error } = await supabase\r\n        .from('waiting_list')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('event_id', eventId);\r\n\r\n      if (error) throw error;\r\n\r\n      return count || 0;\r\n    } catch (error) {\r\n      console.error('Erro ao contar lista de espera:', error);\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Limpa a lista de espera de um evento\r\n   */\r\n  async clearWaitingList(eventId: string): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('waiting_list')\r\n        .delete()\r\n        .eq('event_id', eventId);\r\n\r\n      if (error) throw error;\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Erro ao limpar lista de espera:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Notifica todos os usuários da lista de espera sobre uma atualização\r\n   */\r\n  async notifyWaitingList(eventId: string, message: string): Promise<void> {\r\n    try {\r\n      const waitingList = await this.getWaitingList(eventId);\r\n\r\n      for (const entry of waitingList) {\r\n        // TODO: Implementar método de notificação apropriado\r\n        console.log('Notificando usuário da lista de espera:', entry.user_id, message);\r\n      }\r\n    } catch (error) {\r\n      console.error('Erro ao notificar lista de espera:', error);\r\n    }\r\n  }\r\n}\r\n\r\nexport default new WaitingListService();"],"version":3}