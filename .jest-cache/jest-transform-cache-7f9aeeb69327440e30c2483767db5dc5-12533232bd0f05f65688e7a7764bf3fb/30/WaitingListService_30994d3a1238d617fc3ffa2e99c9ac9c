e221e413002d1d298eac6c7e4c28e1c3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
// src/features/shared/services/WaitingListService.ts
const supabaseClient_1 = require("../lib/supabaseClient");
const NotificationService_1 = tslib_1.__importDefault(require("../services/NotificationService"));
const ParticipationService_1 = tslib_1.__importDefault(require("../services/ParticipationService"));
class WaitingListService {
    /**
     * Adiciona um usuário à lista de espera
     */
    async addToWaitingList(userId, eventId) {
        try {
            // Verifica se o usuário já está na lista de espera
            const { data: existing, error: checkError } = await supabaseClient_1.supabase
                .from('waiting_list')
                .select('*')
                .eq('user_id', userId)
                .eq('event_id', eventId)
                .single();
            if (existing) {
                console.log('Usuário já está na lista de espera');
                return existing;
            }
            // Obtém a última posição na lista
            const { data: lastEntry } = await supabaseClient_1.supabase
                .from('waiting_list')
                .select('position')
                .eq('event_id', eventId)
                .order('position', { ascending: false })
                .limit(1)
                .single();
            const newPosition = lastEntry ? lastEntry.position + 1 : 1;
            // Adiciona o usuário à lista
            const { data, error } = await supabaseClient_1.supabase
                .from('waiting_list')
                .insert({
                user_id: userId,
                event_id: eventId,
                position: newPosition,
                notified: false
            })
                .select()
                .single();
            if (error)
                throw error;
            // Envia notificação de confirmação
            await NotificationService_1.default.createForUser({
                target_user_id: userId,
                target_event_id: parseInt(eventId),
                notification_type: 'event_reminder',
                title: 'Você entrou na lista de espera',
                message: `Você está na posição ${newPosition} da lista de espera.`
            });
            return data;
        }
        catch (error) {
            console.error('Erro ao adicionar à lista de espera:', error);
            return null;
        }
    }
    /**
     * Remove um usuário da lista de espera
     */
    async removeFromWaitingList(userId, eventId) {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('waiting_list')
                .delete()
                .eq('user_id', userId)
                .eq('event_id', eventId);
            if (error)
                throw error;
            // Reorganiza as posições
            await this.reorganizePositions(eventId);
            return true;
        }
        catch (error) {
            console.error('Erro ao remover da lista de espera:', error);
            return false;
        }
    }
    /**
     * Obtém a lista de espera de um evento
     */
    async getWaitingList(eventId) {
        try {
            const { data, error } = await supabaseClient_1.supabase
                .from('waiting_list')
                .select('*')
                .eq('event_id', eventId)
                .order('position', { ascending: true });
            if (error)
                throw error;
            return data || [];
        }
        catch (error) {
            console.error('Erro ao obter lista de espera:', error);
            return [];
        }
    }
    /**
     * Obtém a posição de um usuário na lista de espera
     */
    async getUserPosition(userId, eventId) {
        try {
            const { data, error } = await supabaseClient_1.supabase
                .from('waiting_list')
                .select('position')
                .eq('user_id', userId)
                .eq('event_id', eventId)
                .single();
            if (error)
                throw error;
            return data?.position || null;
        }
        catch (error) {
            console.error('Erro ao obter posição na lista:', error);
            return null;
        }
    }
    /**
     * Processa a lista de espera quando uma vaga é liberada
     */
    async processWaitingList(eventId) {
        try {
            // Obtém o primeiro da lista que ainda não foi notificado
            const { data: nextInLine, error } = await supabaseClient_1.supabase
                .from('waiting_list')
                .select('*')
                .eq('event_id', eventId)
                .eq('notified', false)
                .order('position', { ascending: true })
                .limit(1)
                .single();
            if (error || !nextInLine) {
                console.log('Nenhum usuário na lista de espera ou todos já foram notificados');
                return;
            }
            // Marca como notificado
            await supabaseClient_1.supabase
                .from('waiting_list')
                .update({ notified: true })
                .eq('id', nextInLine.id);
            // Envia notificação
            // TODO: Implementar método de notificação apropriado
            console.log('Notificando usuário sobre vaga disponível:', nextInLine.user_id);
            // Tenta aplicar para o evento automaticamente
            const applied = await ParticipationService_1.default.applyToEvent(eventId, nextInLine.user_id, 'Aplicação automática da lista de espera');
            if (applied.success && applied.isAutoApproved) {
                // Remove da lista de espera se a participação foi confirmada
                await this.removeFromWaitingList(nextInLine.user_id, eventId);
            }
        }
        catch (error) {
            console.error('Erro ao processar lista de espera:', error);
        }
    }
    /**
     * Reorganiza as posições na lista de espera
     */
    async reorganizePositions(eventId) {
        try {
            const waitingList = await this.getWaitingList(eventId);
            // Atualiza as posições sequencialmente
            for (let i = 0; i < waitingList.length; i++) {
                const entry = waitingList[i];
                if (entry.position !== i + 1) {
                    await supabaseClient_1.supabase
                        .from('waiting_list')
                        .update({ position: i + 1 })
                        .eq('id', entry.id);
                }
            }
        }
        catch (error) {
            console.error('Erro ao reorganizar posições:', error);
        }
    }
    /**
     * Verifica se um usuário está na lista de espera
     */
    async isInWaitingList(userId, eventId) {
        try {
            const { data, error } = await supabaseClient_1.supabase
                .from('waiting_list')
                .select('id')
                .eq('user_id', userId)
                .eq('event_id', eventId)
                .single();
            return !!data && !error;
        }
        catch (error) {
            return false;
        }
    }
    /**
     * Obtém o total de pessoas na lista de espera
     */
    async getWaitingListCount(eventId) {
        try {
            const { count, error } = await supabaseClient_1.supabase
                .from('waiting_list')
                .select('*', { count: 'exact', head: true })
                .eq('event_id', eventId);
            if (error)
                throw error;
            return count || 0;
        }
        catch (error) {
            console.error('Erro ao contar lista de espera:', error);
            return 0;
        }
    }
    /**
     * Limpa a lista de espera de um evento
     */
    async clearWaitingList(eventId) {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('waiting_list')
                .delete()
                .eq('event_id', eventId);
            if (error)
                throw error;
            return true;
        }
        catch (error) {
            console.error('Erro ao limpar lista de espera:', error);
            return false;
        }
    }
    /**
     * Notifica todos os usuários da lista de espera sobre uma atualização
     */
    async notifyWaitingList(eventId, message) {
        try {
            const waitingList = await this.getWaitingList(eventId);
            for (const entry of waitingList) {
                // TODO: Implementar método de notificação apropriado
                console.log('Notificando usuário da lista de espera:', entry.user_id, message);
            }
        }
        catch (error) {
            console.error('Erro ao notificar lista de espera:', error);
        }
    }
}
exports.default = new WaitingListService();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcV2FpdGluZ0xpc3RTZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFEQUFxRDtBQUNyRCwwREFBaUQ7QUFDakQsa0dBQWtFO0FBQ2xFLG9HQUFvRTtBQVdwRSxNQUFNLGtCQUFrQjtJQUN0Qjs7T0FFRztJQUNILEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFjLEVBQUUsT0FBZTtRQUNwRCxJQUFJLENBQUM7WUFDSCxtREFBbUQ7WUFDbkQsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxHQUFHLE1BQU0seUJBQVE7aUJBQ3pELElBQUksQ0FBQyxjQUFjLENBQUM7aUJBQ3BCLE1BQU0sQ0FBQyxHQUFHLENBQUM7aUJBQ1gsRUFBRSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUM7aUJBQ3JCLEVBQUUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDO2lCQUN2QixNQUFNLEVBQUUsQ0FBQztZQUVaLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQ2IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO2dCQUNsRCxPQUFPLFFBQVEsQ0FBQztZQUNsQixDQUFDO1lBRUQsa0NBQWtDO1lBQ2xDLE1BQU0sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsTUFBTSx5QkFBUTtpQkFDdkMsSUFBSSxDQUFDLGNBQWMsQ0FBQztpQkFDcEIsTUFBTSxDQUFDLFVBQVUsQ0FBQztpQkFDbEIsRUFBRSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUM7aUJBQ3ZCLEtBQUssQ0FBQyxVQUFVLEVBQUUsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUM7aUJBQ3ZDLEtBQUssQ0FBQyxDQUFDLENBQUM7aUJBQ1IsTUFBTSxFQUFFLENBQUM7WUFFWixNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFM0QsNkJBQTZCO1lBQzdCLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSx5QkFBUTtpQkFDbkMsSUFBSSxDQUFDLGNBQWMsQ0FBQztpQkFDcEIsTUFBTSxDQUFDO2dCQUNOLE9BQU8sRUFBRSxNQUFNO2dCQUNmLFFBQVEsRUFBRSxPQUFPO2dCQUNqQixRQUFRLEVBQUUsV0FBVztnQkFDckIsUUFBUSxFQUFFLEtBQUs7YUFDaEIsQ0FBQztpQkFDRCxNQUFNLEVBQUU7aUJBQ1IsTUFBTSxFQUFFLENBQUM7WUFFWixJQUFJLEtBQUs7Z0JBQUUsTUFBTSxLQUFLLENBQUM7WUFFdkIsbUNBQW1DO1lBQ25DLE1BQU0sNkJBQW1CLENBQUMsYUFBYSxDQUFDO2dCQUN0QyxjQUFjLEVBQUUsTUFBTTtnQkFDdEIsZUFBZSxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUM7Z0JBQ2xDLGlCQUFpQixFQUFFLGdCQUFnQjtnQkFDbkMsS0FBSyxFQUFFLGdDQUFnQztnQkFDdkMsT0FBTyxFQUFFLHdCQUF3QixXQUFXLHNCQUFzQjthQUNuRSxDQUFDLENBQUM7WUFFSCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM3RCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMscUJBQXFCLENBQUMsTUFBYyxFQUFFLE9BQWU7UUFDekQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0seUJBQVE7aUJBQzdCLElBQUksQ0FBQyxjQUFjLENBQUM7aUJBQ3BCLE1BQU0sRUFBRTtpQkFDUixFQUFFLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQztpQkFDckIsRUFBRSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUUzQixJQUFJLEtBQUs7Z0JBQUUsTUFBTSxLQUFLLENBQUM7WUFFdkIseUJBQXlCO1lBQ3pCLE1BQU0sSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRXhDLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHFDQUFxQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzVELE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBZTtRQUNsQyxJQUFJLENBQUM7WUFDSCxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0seUJBQVE7aUJBQ25DLElBQUksQ0FBQyxjQUFjLENBQUM7aUJBQ3BCLE1BQU0sQ0FBQyxHQUFHLENBQUM7aUJBQ1gsRUFBRSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUM7aUJBQ3ZCLEtBQUssQ0FBQyxVQUFVLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUUxQyxJQUFJLEtBQUs7Z0JBQUUsTUFBTSxLQUFLLENBQUM7WUFFdkIsT0FBTyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3BCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN2RCxPQUFPLEVBQUUsQ0FBQztRQUNaLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQWMsRUFBRSxPQUFlO1FBQ25ELElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSx5QkFBUTtpQkFDbkMsSUFBSSxDQUFDLGNBQWMsQ0FBQztpQkFDcEIsTUFBTSxDQUFDLFVBQVUsQ0FBQztpQkFDbEIsRUFBRSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUM7aUJBQ3JCLEVBQUUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDO2lCQUN2QixNQUFNLEVBQUUsQ0FBQztZQUVaLElBQUksS0FBSztnQkFBRSxNQUFNLEtBQUssQ0FBQztZQUV2QixPQUFPLElBQUksRUFBRSxRQUFRLElBQUksSUFBSSxDQUFDO1FBQ2hDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN4RCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsa0JBQWtCLENBQUMsT0FBZTtRQUN0QyxJQUFJLENBQUM7WUFDSCx5REFBeUQ7WUFDekQsTUFBTSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSx5QkFBUTtpQkFDL0MsSUFBSSxDQUFDLGNBQWMsQ0FBQztpQkFDcEIsTUFBTSxDQUFDLEdBQUcsQ0FBQztpQkFDWCxFQUFFLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQztpQkFDdkIsRUFBRSxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUM7aUJBQ3JCLEtBQUssQ0FBQyxVQUFVLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUM7aUJBQ3RDLEtBQUssQ0FBQyxDQUFDLENBQUM7aUJBQ1IsTUFBTSxFQUFFLENBQUM7WUFFWixJQUFJLEtBQUssSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUN6QixPQUFPLENBQUMsR0FBRyxDQUFDLGlFQUFpRSxDQUFDLENBQUM7Z0JBQy9FLE9BQU87WUFDVCxDQUFDO1lBRUQsd0JBQXdCO1lBQ3hCLE1BQU0seUJBQVE7aUJBQ1gsSUFBSSxDQUFDLGNBQWMsQ0FBQztpQkFDcEIsTUFBTSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDO2lCQUMxQixFQUFFLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUUzQixvQkFBb0I7WUFDcEIscURBQXFEO1lBQ3JELE9BQU8sQ0FBQyxHQUFHLENBQUMsNENBQTRDLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRTlFLDhDQUE4QztZQUM5QyxNQUFNLE9BQU8sR0FBRyxNQUFNLDhCQUFvQixDQUFDLFlBQVksQ0FDckQsT0FBTyxFQUNQLFVBQVUsQ0FBQyxPQUFPLEVBQ2xCLHlDQUF5QyxDQUMxQyxDQUFDO1lBRUYsSUFBSSxPQUFPLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDOUMsNkRBQTZEO2dCQUM3RCxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2hFLENBQUM7UUFDSCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDN0QsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxPQUFlO1FBQy9DLElBQUksQ0FBQztZQUNILE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUV2RCx1Q0FBdUM7WUFDdkMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDNUMsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixJQUFJLEtBQUssQ0FBQyxRQUFRLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUM3QixNQUFNLHlCQUFRO3lCQUNYLElBQUksQ0FBQyxjQUFjLENBQUM7eUJBQ3BCLE1BQU0sQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7eUJBQzNCLEVBQUUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN4QixDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4RCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGVBQWUsQ0FBQyxNQUFjLEVBQUUsT0FBZTtRQUNuRCxJQUFJLENBQUM7WUFDSCxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0seUJBQVE7aUJBQ25DLElBQUksQ0FBQyxjQUFjLENBQUM7aUJBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQUM7aUJBQ1osRUFBRSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUM7aUJBQ3JCLEVBQUUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDO2lCQUN2QixNQUFNLEVBQUUsQ0FBQztZQUVaLE9BQU8sQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQztRQUMxQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxPQUFlO1FBQ3ZDLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSx5QkFBUTtpQkFDcEMsSUFBSSxDQUFDLGNBQWMsQ0FBQztpQkFDcEIsTUFBTSxDQUFDLEdBQUcsRUFBRSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO2lCQUMzQyxFQUFFLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBRTNCLElBQUksS0FBSztnQkFBRSxNQUFNLEtBQUssQ0FBQztZQUV2QixPQUFPLEtBQUssSUFBSSxDQUFDLENBQUM7UUFDcEIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3hELE9BQU8sQ0FBQyxDQUFDO1FBQ1gsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFlO1FBQ3BDLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLHlCQUFRO2lCQUM3QixJQUFJLENBQUMsY0FBYyxDQUFDO2lCQUNwQixNQUFNLEVBQUU7aUJBQ1IsRUFBRSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUUzQixJQUFJLEtBQUs7Z0JBQUUsTUFBTSxLQUFLLENBQUM7WUFFdkIsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDeEQsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGlCQUFpQixDQUFDLE9BQWUsRUFBRSxPQUFlO1FBQ3RELElBQUksQ0FBQztZQUNILE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUV2RCxLQUFLLE1BQU0sS0FBSyxJQUFJLFdBQVcsRUFBRSxDQUFDO2dCQUNoQyxxREFBcUQ7Z0JBQ3JELE9BQU8sQ0FBQyxHQUFHLENBQUMseUNBQXlDLEVBQUUsS0FBSyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNqRixDQUFDO1FBQ0gsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdELENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxrQkFBZSxJQUFJLGtCQUFrQixFQUFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcV2FpdGluZ0xpc3RTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9mZWF0dXJlcy9zaGFyZWQvc2VydmljZXMvV2FpdGluZ0xpc3RTZXJ2aWNlLnRzXHJcbmltcG9ydCB7IHN1cGFiYXNlIH0gZnJvbSAnLi4vbGliL3N1cGFiYXNlQ2xpZW50JztcclxuaW1wb3J0IE5vdGlmaWNhdGlvblNlcnZpY2UgZnJvbSAnLi4vc2VydmljZXMvTm90aWZpY2F0aW9uU2VydmljZSc7XHJcbmltcG9ydCBQYXJ0aWNpcGF0aW9uU2VydmljZSBmcm9tICcuLi9zZXJ2aWNlcy9QYXJ0aWNpcGF0aW9uU2VydmljZSc7XHJcblxyXG5pbnRlcmZhY2UgV2FpdGluZ0xpc3RFbnRyeSB7XHJcbiAgaWQ/OiBzdHJpbmc7XHJcbiAgdXNlcl9pZDogc3RyaW5nO1xyXG4gIGV2ZW50X2lkOiBzdHJpbmc7XHJcbiAgcG9zaXRpb246IG51bWJlcjtcclxuICBjcmVhdGVkX2F0Pzogc3RyaW5nO1xyXG4gIG5vdGlmaWVkPzogYm9vbGVhbjtcclxufVxyXG5cclxuY2xhc3MgV2FpdGluZ0xpc3RTZXJ2aWNlIHtcclxuICAvKipcclxuICAgKiBBZGljaW9uYSB1bSB1c3XDoXJpbyDDoCBsaXN0YSBkZSBlc3BlcmFcclxuICAgKi9cclxuICBhc3luYyBhZGRUb1dhaXRpbmdMaXN0KHVzZXJJZDogc3RyaW5nLCBldmVudElkOiBzdHJpbmcpOiBQcm9taXNlPFdhaXRpbmdMaXN0RW50cnkgfCBudWxsPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBWZXJpZmljYSBzZSBvIHVzdcOhcmlvIGrDoSBlc3TDoSBuYSBsaXN0YSBkZSBlc3BlcmFcclxuICAgICAgY29uc3QgeyBkYXRhOiBleGlzdGluZywgZXJyb3I6IGNoZWNrRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ3dhaXRpbmdfbGlzdCcpXHJcbiAgICAgICAgLnNlbGVjdCgnKicpXHJcbiAgICAgICAgLmVxKCd1c2VyX2lkJywgdXNlcklkKVxyXG4gICAgICAgIC5lcSgnZXZlbnRfaWQnLCBldmVudElkKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICAgIGlmIChleGlzdGluZykge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdVc3XDoXJpbyBqw6EgZXN0w6EgbmEgbGlzdGEgZGUgZXNwZXJhJyk7XHJcbiAgICAgICAgcmV0dXJuIGV4aXN0aW5nO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBPYnTDqW0gYSDDumx0aW1hIHBvc2nDp8OjbyBuYSBsaXN0YVxyXG4gICAgICBjb25zdCB7IGRhdGE6IGxhc3RFbnRyeSB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnd2FpdGluZ19saXN0JylcclxuICAgICAgICAuc2VsZWN0KCdwb3NpdGlvbicpXHJcbiAgICAgICAgLmVxKCdldmVudF9pZCcsIGV2ZW50SWQpXHJcbiAgICAgICAgLm9yZGVyKCdwb3NpdGlvbicsIHsgYXNjZW5kaW5nOiBmYWxzZSB9KVxyXG4gICAgICAgIC5saW1pdCgxKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICAgIGNvbnN0IG5ld1Bvc2l0aW9uID0gbGFzdEVudHJ5ID8gbGFzdEVudHJ5LnBvc2l0aW9uICsgMSA6IDE7XHJcblxyXG4gICAgICAvLyBBZGljaW9uYSBvIHVzdcOhcmlvIMOgIGxpc3RhXHJcbiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ3dhaXRpbmdfbGlzdCcpXHJcbiAgICAgICAgLmluc2VydCh7XHJcbiAgICAgICAgICB1c2VyX2lkOiB1c2VySWQsXHJcbiAgICAgICAgICBldmVudF9pZDogZXZlbnRJZCxcclxuICAgICAgICAgIHBvc2l0aW9uOiBuZXdQb3NpdGlvbixcclxuICAgICAgICAgIG5vdGlmaWVkOiBmYWxzZVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnNlbGVjdCgpXHJcbiAgICAgICAgLnNpbmdsZSgpO1xyXG5cclxuICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuXHJcbiAgICAgIC8vIEVudmlhIG5vdGlmaWNhw6fDo28gZGUgY29uZmlybWHDp8Ojb1xyXG4gICAgICBhd2FpdCBOb3RpZmljYXRpb25TZXJ2aWNlLmNyZWF0ZUZvclVzZXIoe1xyXG4gICAgICAgIHRhcmdldF91c2VyX2lkOiB1c2VySWQsXHJcbiAgICAgICAgdGFyZ2V0X2V2ZW50X2lkOiBwYXJzZUludChldmVudElkKSxcclxuICAgICAgICBub3RpZmljYXRpb25fdHlwZTogJ2V2ZW50X3JlbWluZGVyJyxcclxuICAgICAgICB0aXRsZTogJ1ZvY8OqIGVudHJvdSBuYSBsaXN0YSBkZSBlc3BlcmEnLFxyXG4gICAgICAgIG1lc3NhZ2U6IGBWb2PDqiBlc3TDoSBuYSBwb3Npw6fDo28gJHtuZXdQb3NpdGlvbn0gZGEgbGlzdGEgZGUgZXNwZXJhLmBcclxuICAgICAgfSk7XHJcblxyXG4gICAgICByZXR1cm4gZGF0YTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm8gYW8gYWRpY2lvbmFyIMOgIGxpc3RhIGRlIGVzcGVyYTonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVtb3ZlIHVtIHVzdcOhcmlvIGRhIGxpc3RhIGRlIGVzcGVyYVxyXG4gICAqL1xyXG4gIGFzeW5jIHJlbW92ZUZyb21XYWl0aW5nTGlzdCh1c2VySWQ6IHN0cmluZywgZXZlbnRJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCd3YWl0aW5nX2xpc3QnKVxyXG4gICAgICAgIC5kZWxldGUoKVxyXG4gICAgICAgIC5lcSgndXNlcl9pZCcsIHVzZXJJZClcclxuICAgICAgICAuZXEoJ2V2ZW50X2lkJywgZXZlbnRJZCk7XHJcblxyXG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xyXG5cclxuICAgICAgLy8gUmVvcmdhbml6YSBhcyBwb3Npw6fDtWVzXHJcbiAgICAgIGF3YWl0IHRoaXMucmVvcmdhbml6ZVBvc2l0aW9ucyhldmVudElkKTtcclxuXHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJybyBhbyByZW1vdmVyIGRhIGxpc3RhIGRlIGVzcGVyYTonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE9idMOpbSBhIGxpc3RhIGRlIGVzcGVyYSBkZSB1bSBldmVudG9cclxuICAgKi9cclxuICBhc3luYyBnZXRXYWl0aW5nTGlzdChldmVudElkOiBzdHJpbmcpOiBQcm9taXNlPFdhaXRpbmdMaXN0RW50cnlbXT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnd2FpdGluZ19saXN0JylcclxuICAgICAgICAuc2VsZWN0KCcqJylcclxuICAgICAgICAuZXEoJ2V2ZW50X2lkJywgZXZlbnRJZClcclxuICAgICAgICAub3JkZXIoJ3Bvc2l0aW9uJywgeyBhc2NlbmRpbmc6IHRydWUgfSk7XHJcblxyXG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xyXG5cclxuICAgICAgcmV0dXJuIGRhdGEgfHwgW107XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvIGFvIG9idGVyIGxpc3RhIGRlIGVzcGVyYTonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE9idMOpbSBhIHBvc2nDp8OjbyBkZSB1bSB1c3XDoXJpbyBuYSBsaXN0YSBkZSBlc3BlcmFcclxuICAgKi9cclxuICBhc3luYyBnZXRVc2VyUG9zaXRpb24odXNlcklkOiBzdHJpbmcsIGV2ZW50SWQ6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyIHwgbnVsbD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnd2FpdGluZ19saXN0JylcclxuICAgICAgICAuc2VsZWN0KCdwb3NpdGlvbicpXHJcbiAgICAgICAgLmVxKCd1c2VyX2lkJywgdXNlcklkKVxyXG4gICAgICAgIC5lcSgnZXZlbnRfaWQnLCBldmVudElkKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICByZXR1cm4gZGF0YT8ucG9zaXRpb24gfHwgbnVsbDtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm8gYW8gb2J0ZXIgcG9zacOnw6NvIG5hIGxpc3RhOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQcm9jZXNzYSBhIGxpc3RhIGRlIGVzcGVyYSBxdWFuZG8gdW1hIHZhZ2Egw6kgbGliZXJhZGFcclxuICAgKi9cclxuICBhc3luYyBwcm9jZXNzV2FpdGluZ0xpc3QoZXZlbnRJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBPYnTDqW0gbyBwcmltZWlybyBkYSBsaXN0YSBxdWUgYWluZGEgbsOjbyBmb2kgbm90aWZpY2Fkb1xyXG4gICAgICBjb25zdCB7IGRhdGE6IG5leHRJbkxpbmUsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCd3YWl0aW5nX2xpc3QnKVxyXG4gICAgICAgIC5zZWxlY3QoJyonKVxyXG4gICAgICAgIC5lcSgnZXZlbnRfaWQnLCBldmVudElkKVxyXG4gICAgICAgIC5lcSgnbm90aWZpZWQnLCBmYWxzZSlcclxuICAgICAgICAub3JkZXIoJ3Bvc2l0aW9uJywgeyBhc2NlbmRpbmc6IHRydWUgfSlcclxuICAgICAgICAubGltaXQoMSlcclxuICAgICAgICAuc2luZ2xlKCk7XHJcblxyXG4gICAgICBpZiAoZXJyb3IgfHwgIW5leHRJbkxpbmUpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnTmVuaHVtIHVzdcOhcmlvIG5hIGxpc3RhIGRlIGVzcGVyYSBvdSB0b2RvcyBqw6EgZm9yYW0gbm90aWZpY2Fkb3MnKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIE1hcmNhIGNvbW8gbm90aWZpY2Fkb1xyXG4gICAgICBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCd3YWl0aW5nX2xpc3QnKVxyXG4gICAgICAgIC51cGRhdGUoeyBub3RpZmllZDogdHJ1ZSB9KVxyXG4gICAgICAgIC5lcSgnaWQnLCBuZXh0SW5MaW5lLmlkKTtcclxuXHJcbiAgICAgIC8vIEVudmlhIG5vdGlmaWNhw6fDo29cclxuICAgICAgLy8gVE9ETzogSW1wbGVtZW50YXIgbcOpdG9kbyBkZSBub3RpZmljYcOnw6NvIGFwcm9wcmlhZG9cclxuICAgICAgY29uc29sZS5sb2coJ05vdGlmaWNhbmRvIHVzdcOhcmlvIHNvYnJlIHZhZ2EgZGlzcG9uw612ZWw6JywgbmV4dEluTGluZS51c2VyX2lkKTtcclxuXHJcbiAgICAgIC8vIFRlbnRhIGFwbGljYXIgcGFyYSBvIGV2ZW50byBhdXRvbWF0aWNhbWVudGVcclxuICAgICAgY29uc3QgYXBwbGllZCA9IGF3YWl0IFBhcnRpY2lwYXRpb25TZXJ2aWNlLmFwcGx5VG9FdmVudChcclxuICAgICAgICBldmVudElkLFxyXG4gICAgICAgIG5leHRJbkxpbmUudXNlcl9pZCxcclxuICAgICAgICAnQXBsaWNhw6fDo28gYXV0b23DoXRpY2EgZGEgbGlzdGEgZGUgZXNwZXJhJ1xyXG4gICAgICApO1xyXG5cclxuICAgICAgaWYgKGFwcGxpZWQuc3VjY2VzcyAmJiBhcHBsaWVkLmlzQXV0b0FwcHJvdmVkKSB7XHJcbiAgICAgICAgLy8gUmVtb3ZlIGRhIGxpc3RhIGRlIGVzcGVyYSBzZSBhIHBhcnRpY2lwYcOnw6NvIGZvaSBjb25maXJtYWRhXHJcbiAgICAgICAgYXdhaXQgdGhpcy5yZW1vdmVGcm9tV2FpdGluZ0xpc3QobmV4dEluTGluZS51c2VyX2lkLCBldmVudElkKTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJybyBhbyBwcm9jZXNzYXIgbGlzdGEgZGUgZXNwZXJhOicsIGVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlb3JnYW5pemEgYXMgcG9zacOnw7VlcyBuYSBsaXN0YSBkZSBlc3BlcmFcclxuICAgKi9cclxuICBwcml2YXRlIGFzeW5jIHJlb3JnYW5pemVQb3NpdGlvbnMoZXZlbnRJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB3YWl0aW5nTGlzdCA9IGF3YWl0IHRoaXMuZ2V0V2FpdGluZ0xpc3QoZXZlbnRJZCk7XHJcblxyXG4gICAgICAvLyBBdHVhbGl6YSBhcyBwb3Npw6fDtWVzIHNlcXVlbmNpYWxtZW50ZVxyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdhaXRpbmdMaXN0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgY29uc3QgZW50cnkgPSB3YWl0aW5nTGlzdFtpXTtcclxuICAgICAgICBpZiAoZW50cnkucG9zaXRpb24gIT09IGkgKyAxKSB7XHJcbiAgICAgICAgICBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgICAgICAuZnJvbSgnd2FpdGluZ19saXN0JylcclxuICAgICAgICAgICAgLnVwZGF0ZSh7IHBvc2l0aW9uOiBpICsgMSB9KVxyXG4gICAgICAgICAgICAuZXEoJ2lkJywgZW50cnkuaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJybyBhbyByZW9yZ2FuaXphciBwb3Npw6fDtWVzOicsIGVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFZlcmlmaWNhIHNlIHVtIHVzdcOhcmlvIGVzdMOhIG5hIGxpc3RhIGRlIGVzcGVyYVxyXG4gICAqL1xyXG4gIGFzeW5jIGlzSW5XYWl0aW5nTGlzdCh1c2VySWQ6IHN0cmluZywgZXZlbnRJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCd3YWl0aW5nX2xpc3QnKVxyXG4gICAgICAgIC5zZWxlY3QoJ2lkJylcclxuICAgICAgICAuZXEoJ3VzZXJfaWQnLCB1c2VySWQpXHJcbiAgICAgICAgLmVxKCdldmVudF9pZCcsIGV2ZW50SWQpXHJcbiAgICAgICAgLnNpbmdsZSgpO1xyXG5cclxuICAgICAgcmV0dXJuICEhZGF0YSAmJiAhZXJyb3I7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBPYnTDqW0gbyB0b3RhbCBkZSBwZXNzb2FzIG5hIGxpc3RhIGRlIGVzcGVyYVxyXG4gICAqL1xyXG4gIGFzeW5jIGdldFdhaXRpbmdMaXN0Q291bnQoZXZlbnRJZDogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgY291bnQsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCd3YWl0aW5nX2xpc3QnKVxyXG4gICAgICAgIC5zZWxlY3QoJyonLCB7IGNvdW50OiAnZXhhY3QnLCBoZWFkOiB0cnVlIH0pXHJcbiAgICAgICAgLmVxKCdldmVudF9pZCcsIGV2ZW50SWQpO1xyXG5cclxuICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuXHJcbiAgICAgIHJldHVybiBjb3VudCB8fCAwO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJybyBhbyBjb250YXIgbGlzdGEgZGUgZXNwZXJhOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBMaW1wYSBhIGxpc3RhIGRlIGVzcGVyYSBkZSB1bSBldmVudG9cclxuICAgKi9cclxuICBhc3luYyBjbGVhcldhaXRpbmdMaXN0KGV2ZW50SWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnd2FpdGluZ19saXN0JylcclxuICAgICAgICAuZGVsZXRlKClcclxuICAgICAgICAuZXEoJ2V2ZW50X2lkJywgZXZlbnRJZCk7XHJcblxyXG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xyXG5cclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvIGFvIGxpbXBhciBsaXN0YSBkZSBlc3BlcmE6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBOb3RpZmljYSB0b2RvcyBvcyB1c3XDoXJpb3MgZGEgbGlzdGEgZGUgZXNwZXJhIHNvYnJlIHVtYSBhdHVhbGl6YcOnw6NvXHJcbiAgICovXHJcbiAgYXN5bmMgbm90aWZ5V2FpdGluZ0xpc3QoZXZlbnRJZDogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHdhaXRpbmdMaXN0ID0gYXdhaXQgdGhpcy5nZXRXYWl0aW5nTGlzdChldmVudElkKTtcclxuXHJcbiAgICAgIGZvciAoY29uc3QgZW50cnkgb2Ygd2FpdGluZ0xpc3QpIHtcclxuICAgICAgICAvLyBUT0RPOiBJbXBsZW1lbnRhciBtw6l0b2RvIGRlIG5vdGlmaWNhw6fDo28gYXByb3ByaWFkb1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdOb3RpZmljYW5kbyB1c3XDoXJpbyBkYSBsaXN0YSBkZSBlc3BlcmE6JywgZW50cnkudXNlcl9pZCwgbWVzc2FnZSk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm8gYW8gbm90aWZpY2FyIGxpc3RhIGRlIGVzcGVyYTonLCBlcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBuZXcgV2FpdGluZ0xpc3RTZXJ2aWNlKCk7Il0sInZlcnNpb24iOjN9