f931e72bfb9231e0f3dad90a4be5fccb
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// src/services/EventSecurityService.ts
const supabaseClient_1 = require("../lib/supabaseClient");
/**
 * üîê Servi√ßo de Seguran√ßa de Eventos
 * Gerencia senhas de entrada 4 d√≠gitos
 */
class EventSecurityService {
    /**
     * üé≤ Gera uma senha aleat√≥ria de 4 d√≠gitos
     * @returns Senha no formato "1234"
     */
    static generatePassword() {
        const password = Math.floor(1000 + Math.random() * 9000).toString();
        console.log(`üé≤ Senha gerada: ${password}`);
        return password;
    }
    /**
     * üíæ Salva a senha no evento
     * @param eventId - ID do evento
     * @param password - Senha de 4 d√≠gitos
     */
    static async savePasswordToEvent(eventId, password) {
        try {
            if (!password || password.length !== 4 || !/^\d+$/.test(password)) {
                return {
                    success: false,
                    error: 'Senha deve ser exatamente 4 d√≠gitos'
                };
            }
            const { error } = await supabaseClient_1.supabase
                .from('events')
                .update({
                event_entry_password: password,
                entry_opened_at: new Date().toISOString()
            })
                .eq('id', eventId);
            if (error)
                throw error;
            console.log(`‚úÖ Senha ${password} salva no evento ${eventId}`);
            return { success: true, password };
        }
        catch (error) {
            console.error('‚ùå Erro ao salvar senha:', error);
            return { success: false, error };
        }
    }
    /**
     * üîë Gera e salva uma nova senha de entrada
     * @param eventId - ID do evento
     */
    static async generateAndSavePassword(eventId) {
        try {
            const password = this.generatePassword();
            return this.savePasswordToEvent(eventId, password);
        }
        catch (error) {
            console.error('‚ùå Erro ao gerar e salvar senha:', error);
            return { success: false, error };
        }
    }
    /**
     * üïê Verifica se est√° no hor√°rio permitido para entrada
     * Regra: 1 minuto antes at√© 2 minutos antes do fim
     * @param eventId - ID do evento
     * @returns { allowed: boolean, reason?: string }
     */
    static async isEntryTimeValid(eventId) {
        try {
            const { data: event, error: eventError } = await supabaseClient_1.supabase
                .from('events')
                .select('start_time, end_time, status')
                .eq('id', eventId)
                .single();
            if (eventError)
                throw eventError;
            if (!event) {
                return { allowed: false, reason: 'Evento n√£o encontrado' };
            }
            const now = new Date();
            const startTime = new Date(event.start_time);
            const endTime = new Date(event.end_time);
            // üïê Verificar: falta 1 minuto para come√ßar?
            const oneMinBeforeStart = new Date(startTime.getTime() - 60 * 1000);
            if (now < oneMinBeforeStart) {
                return {
                    allowed: false,
                    reason: `Entrada dispon√≠vel a partir de ${oneMinBeforeStart.toLocaleTimeString()}`
                };
            }
            // üïê Verificar: falta 2 minutos para terminar?
            const twoMinBeforeEnd = new Date(endTime.getTime() - 1 * 20 * 1000);
            if (now >= twoMinBeforeEnd) {
                return {
                    allowed: false,
                    reason: 'Entrada encerrada (faltam 2 minutos para o fim do evento)'
                };
            }
            // üïê Verificar: evento j√° come√ßou ou ainda est√° confirmado?
            if (event.status !== 'Confirmado' && event.status !== 'Em Andamento') {
                return {
                    allowed: false,
                    reason: `Evento n√£o est√° dispon√≠vel para entrada (status: ${event.status})`
                };
            }
            return { allowed: true };
        }
        catch (error) {
            console.error('‚ùå Erro ao validar timing de entrada:', error);
            return { allowed: false, reason: 'Erro ao validar timing' };
        }
    }
    /**
     * ‚úÖ Valida a senha digitada
     * @param params - { eventId, participantId, password }
     */
    static async validateEntryPassword(params) {
        try {
            const { eventId, participantId, password } = params;
            // 1Ô∏è‚É£ Verificar timing
            const timingCheck = await this.isEntryTimeValid(eventId);
            if (!timingCheck.allowed) {
                return {
                    success: false,
                    message: timingCheck.reason
                };
            }
            // 2Ô∏è‚É£ Buscar evento e senha correta
            const { data: event, error: eventError } = await supabaseClient_1.supabase
                .from('events')
                .select('event_entry_password, status')
                .eq('id', eventId)
                .single();
            if (eventError)
                throw eventError;
            if (!event) {
                return { success: false, message: 'Evento n√£o encontrado' };
            }
            // 3Ô∏è‚É£ Validar senha
            if (password !== event.event_entry_password) {
                console.warn(`‚ùå Participante ${participantId} digitou senha errada no evento ${eventId}`);
                return {
                    success: false,
                    message: 'Senha incorreta. Tente novamente.'
                };
            }
            // 4Ô∏è‚É£ Senha correta! Registrar entrada
            console.log(`‚úÖ Participante ${participantId} digitou a senha correta do evento ${eventId}`);
            const { error: updateError } = await supabaseClient_1.supabase
                .from('event_participants')
                .update({
                com_acesso: true,
                entry_time: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
                .eq('event_id', eventId)
                .eq('user_id', participantId);
            if (updateError)
                throw updateError;
            console.log(`‚úÖ Participa√ß√£o atualizada: com_acesso = true para ${participantId}`);
            // 5Ô∏è‚É£ Verificar se deve auto-iniciar evento
            // (Se √© o primeiro a entrar e evento est√° em CONFIRMADO)
            const shouldAutoStart = event.status === 'Confirmado';
            return {
                success: true,
                message: '‚úÖ Acesso liberado! Bem-vindo ao evento.',
                shouldAutoStart
            };
        }
        catch (error) {
            console.error('‚ùå Erro ao validar senha:', error);
            return { success: false, message: 'Erro ao validar entrada', error };
        }
    }
    /**
     * üîç Verifica se um participante j√° tem acesso
     * @param eventId - ID do evento
     * @param participantId - ID do participante
     */
    static async hasUserAccess(eventId, participantId) {
        try {
            const { data: participation, error } = await supabaseClient_1.supabase
                .from('event_participants')
                .select('com_acesso')
                .eq('event_id', eventId)
                .eq('user_id', participantId)
                .single();
            if (error && error.code === 'PGRST116')
                return false; // Not found
            if (error)
                throw error;
            return participation?.com_acesso === true;
        }
        catch (error) {
            console.error('‚ùå Erro ao verificar acesso:', error);
            return false;
        }
    }
    /**
     * üîí Bloqueia entrada de novos participantes (2 min antes do fim)
     * @param eventId - ID do evento
     */
    static async lockEventEntry(eventId) {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('events')
                .update({
                entry_locked: true,
                entry_locked_at: new Date().toISOString()
            })
                .eq('id', eventId);
            if (error)
                throw error;
            console.log(`üîí Entrada bloqueada para evento ${eventId}`);
            return { success: true };
        }
        catch (error) {
            console.error('‚ùå Erro ao bloquear entrada:', error);
            return { success: false, error };
        }
    }
    /**
     * üìä Obt√©m status de entrada do evento
     */
    static async getEntryStatus(eventId) {
        try {
            const { data: event, error: eventError } = await supabaseClient_1.supabase
                .from('events')
                .select('event_entry_password, entry_locked, entry_locked_at, entry_opened_at')
                .eq('id', eventId)
                .single();
            if (eventError)
                throw eventError;
            const { data: participations, error: partError } = await supabaseClient_1.supabase
                .from('event_participants')
                .select('com_acesso')
                .eq('event_id', eventId)
                .eq('status', 'aprovado');
            if (partError)
                throw partError;
            const totalWithAccess = (participations || []).filter(p => p.com_acesso).length;
            const totalParticipants = participations?.length || 0;
            return {
                success: true,
                data: {
                    password: event?.event_entry_password || '****',
                    isLocked: event?.entry_locked || false,
                    lockedAt: event?.entry_locked_at,
                    openedAt: event?.entry_opened_at,
                    totalWithAccess,
                    totalParticipants
                }
            };
        }
        catch (error) {
            console.error('‚ùå Erro ao obter status de entrada:', error);
            return { success: false, error };
        }
    }
}
exports.default = EventSecurityService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcRXZlbnRTZWN1cml0eVNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FBdUM7QUFDdkMsMERBQWlEO0FBcUJqRDs7O0dBR0c7QUFDSCxNQUFNLG9CQUFvQjtJQUN4Qjs7O09BR0c7SUFDSCxNQUFNLENBQUMsZ0JBQWdCO1FBQ3JCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNwRSxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxPQUFlLEVBQUUsUUFBZ0I7UUFDaEUsSUFBSSxDQUFDO1lBQ0gsSUFBSSxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztnQkFDbEUsT0FBTztvQkFDTCxPQUFPLEVBQUUsS0FBSztvQkFDZCxLQUFLLEVBQUUscUNBQXFDO2lCQUM3QyxDQUFDO1lBQ0osQ0FBQztZQUVELE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLHlCQUFRO2lCQUM3QixJQUFJLENBQUMsUUFBUSxDQUFDO2lCQUNkLE1BQU0sQ0FBQztnQkFDTixvQkFBb0IsRUFBRSxRQUFRO2dCQUM5QixlQUFlLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7YUFDMUMsQ0FBQztpQkFDRCxFQUFFLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBRXJCLElBQUksS0FBSztnQkFBRSxNQUFNLEtBQUssQ0FBQztZQUV2QixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsUUFBUSxvQkFBb0IsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUM5RCxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQztRQUNyQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDbkMsQ0FBQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLHVCQUF1QixDQUFDLE9BQWU7UUFDbEQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDekMsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN4RCxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQztRQUNuQyxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFlO1FBQzNDLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsR0FBRyxNQUFNLHlCQUFRO2lCQUN0RCxJQUFJLENBQUMsUUFBUSxDQUFDO2lCQUNkLE1BQU0sQ0FBQyw4QkFBOEIsQ0FBQztpQkFDdEMsRUFBRSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUM7aUJBQ2pCLE1BQU0sRUFBRSxDQUFDO1lBRVosSUFBSSxVQUFVO2dCQUFFLE1BQU0sVUFBVSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDWCxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQztZQUM3RCxDQUFDO1lBRUQsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUN2QixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDN0MsTUFBTSxPQUFPLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXpDLDZDQUE2QztZQUM3QyxNQUFNLGlCQUFpQixHQUFHLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFDcEUsSUFBSSxHQUFHLEdBQUcsaUJBQWlCLEVBQUUsQ0FBQztnQkFDNUIsT0FBTztvQkFDTCxPQUFPLEVBQUUsS0FBSztvQkFDZCxNQUFNLEVBQUUsa0NBQWtDLGlCQUFpQixDQUFDLGtCQUFrQixFQUFFLEVBQUU7aUJBQ25GLENBQUM7WUFDSixDQUFDO1lBRUQsK0NBQStDO1lBQy9DLE1BQU0sZUFBZSxHQUFHLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ3BFLElBQUksR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO2dCQUMzQixPQUFPO29CQUNMLE9BQU8sRUFBRSxLQUFLO29CQUNkLE1BQU0sRUFBRSwyREFBMkQ7aUJBQ3BFLENBQUM7WUFDSixDQUFDO1lBRUQsNERBQTREO1lBQzVELElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxZQUFZLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxjQUFjLEVBQUUsQ0FBQztnQkFDckUsT0FBTztvQkFDTCxPQUFPLEVBQUUsS0FBSztvQkFDZCxNQUFNLEVBQUUsb0RBQW9ELEtBQUssQ0FBQyxNQUFNLEdBQUc7aUJBQzVFLENBQUM7WUFDSixDQUFDO1lBRUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUMzQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0NBQXNDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDN0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLHdCQUF3QixFQUFFLENBQUM7UUFDOUQsQ0FBQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLE1BQWdDO1FBQ2pFLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxHQUFHLE1BQU0sQ0FBQztZQUVwRCx1QkFBdUI7WUFDdkIsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDekQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDekIsT0FBTztvQkFDTCxPQUFPLEVBQUUsS0FBSztvQkFDZCxPQUFPLEVBQUUsV0FBVyxDQUFDLE1BQU07aUJBQzVCLENBQUM7WUFDSixDQUFDO1lBRUQsb0NBQW9DO1lBQ3BDLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsR0FBRyxNQUFNLHlCQUFRO2lCQUN0RCxJQUFJLENBQUMsUUFBUSxDQUFDO2lCQUNkLE1BQU0sQ0FBQyw4QkFBOEIsQ0FBQztpQkFDdEMsRUFBRSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUM7aUJBQ2pCLE1BQU0sRUFBRSxDQUFDO1lBRVosSUFBSSxVQUFVO2dCQUFFLE1BQU0sVUFBVSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDWCxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQztZQUM5RCxDQUFDO1lBRUQsb0JBQW9CO1lBQ3BCLElBQUksUUFBUSxLQUFLLEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO2dCQUM1QyxPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixhQUFhLG1DQUFtQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO2dCQUMxRixPQUFPO29CQUNMLE9BQU8sRUFBRSxLQUFLO29CQUNkLE9BQU8sRUFBRSxtQ0FBbUM7aUJBQzdDLENBQUM7WUFDSixDQUFDO1lBRUQsdUNBQXVDO1lBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLGFBQWEsc0NBQXNDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFFNUYsTUFBTSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsR0FBRyxNQUFNLHlCQUFRO2lCQUMxQyxJQUFJLENBQUMsb0JBQW9CLENBQUM7aUJBQzFCLE1BQU0sQ0FBQztnQkFDTixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2dCQUNwQyxVQUFVLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7YUFDckMsQ0FBQztpQkFDRCxFQUFFLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQztpQkFDdkIsRUFBRSxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUVoQyxJQUFJLFdBQVc7Z0JBQUUsTUFBTSxXQUFXLENBQUM7WUFFbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxREFBcUQsYUFBYSxFQUFFLENBQUMsQ0FBQztZQUVsRiw0Q0FBNEM7WUFDNUMseURBQXlEO1lBQ3pELE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxNQUFNLEtBQUssWUFBWSxDQUFDO1lBRXRELE9BQU87Z0JBQ0wsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsT0FBTyxFQUFFLHlDQUF5QztnQkFDbEQsZUFBZTthQUNoQixDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLDBCQUEwQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2pELE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxLQUFLLEVBQUUsQ0FBQztRQUN2RSxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxPQUFlLEVBQUUsYUFBcUI7UUFDL0QsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSx5QkFBUTtpQkFDbEQsSUFBSSxDQUFDLG9CQUFvQixDQUFDO2lCQUMxQixNQUFNLENBQUMsWUFBWSxDQUFDO2lCQUNwQixFQUFFLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQztpQkFDdkIsRUFBRSxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUM7aUJBQzVCLE1BQU0sRUFBRSxDQUFDO1lBRVosSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxVQUFVO2dCQUFFLE9BQU8sS0FBSyxDQUFDLENBQUMsWUFBWTtZQUNsRSxJQUFJLEtBQUs7Z0JBQUUsTUFBTSxLQUFLLENBQUM7WUFFdkIsT0FBTyxhQUFhLEVBQUUsVUFBVSxLQUFLLElBQUksQ0FBQztRQUM1QyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDcEQsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLE9BQWU7UUFDekMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0seUJBQVE7aUJBQzdCLElBQUksQ0FBQyxRQUFRLENBQUM7aUJBQ2QsTUFBTSxDQUFDO2dCQUNOLFlBQVksRUFBRSxJQUFJO2dCQUNsQixlQUFlLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7YUFDMUMsQ0FBQztpQkFDRCxFQUFFLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBRXJCLElBQUksS0FBSztnQkFBRSxNQUFNLEtBQUssQ0FBQztZQUV2QixPQUFPLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQzNELE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDM0IsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLDZCQUE2QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3BELE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDO1FBQ25DLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxPQUFlO1FBWXpDLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsR0FBRyxNQUFNLHlCQUFRO2lCQUN0RCxJQUFJLENBQUMsUUFBUSxDQUFDO2lCQUNkLE1BQU0sQ0FBQyxzRUFBc0UsQ0FBQztpQkFDOUUsRUFBRSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUM7aUJBQ2pCLE1BQU0sRUFBRSxDQUFDO1lBRVosSUFBSSxVQUFVO2dCQUFFLE1BQU0sVUFBVSxDQUFDO1lBRWpDLE1BQU0sRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxNQUFNLHlCQUFRO2lCQUM5RCxJQUFJLENBQUMsb0JBQW9CLENBQUM7aUJBQzFCLE1BQU0sQ0FBQyxZQUFZLENBQUM7aUJBQ3BCLEVBQUUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDO2lCQUN2QixFQUFFLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBRTVCLElBQUksU0FBUztnQkFBRSxNQUFNLFNBQVMsQ0FBQztZQUUvQixNQUFNLGVBQWUsR0FBRyxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQ2hGLE1BQU0saUJBQWlCLEdBQUcsY0FBYyxFQUFFLE1BQU0sSUFBSSxDQUFDLENBQUM7WUFFdEQsT0FBTztnQkFDTCxPQUFPLEVBQUUsSUFBSTtnQkFDYixJQUFJLEVBQUU7b0JBQ0osUUFBUSxFQUFFLEtBQUssRUFBRSxvQkFBb0IsSUFBSSxNQUFNO29CQUMvQyxRQUFRLEVBQUUsS0FBSyxFQUFFLFlBQVksSUFBSSxLQUFLO29CQUN0QyxRQUFRLEVBQUUsS0FBSyxFQUFFLGVBQWU7b0JBQ2hDLFFBQVEsRUFBRSxLQUFLLEVBQUUsZUFBZTtvQkFDaEMsZUFBZTtvQkFDZixpQkFBaUI7aUJBQ2xCO2FBQ0YsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMzRCxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQztRQUNuQyxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBRUQsa0JBQWUsb0JBQW9CLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcRXZlbnRTZWN1cml0eVNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL3NlcnZpY2VzL0V2ZW50U2VjdXJpdHlTZXJ2aWNlLnRzXHJcbmltcG9ydCB7IHN1cGFiYXNlIH0gZnJvbSAnLi4vbGliL3N1cGFiYXNlQ2xpZW50JztcclxuXHJcbmludGVyZmFjZSBHZW5lcmF0ZVBhc3N3b3JkUmVzdWx0IHtcclxuICBzdWNjZXNzOiBib29sZWFuO1xyXG4gIHBhc3N3b3JkPzogc3RyaW5nO1xyXG4gIGVycm9yPzogYW55O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgVmFsaWRhdGVQYXNzd29yZFJlc3VsdCB7XHJcbiAgc3VjY2VzczogYm9vbGVhbjtcclxuICBtZXNzYWdlPzogc3RyaW5nO1xyXG4gIHNob3VsZEF1dG9TdGFydD86IGJvb2xlYW47XHJcbiAgZXJyb3I/OiBhbnk7XHJcbn1cclxuXHJcbmludGVyZmFjZSBQYXNzd29yZFZhbGlkYXRpb25QYXJhbXMge1xyXG4gIGV2ZW50SWQ6IG51bWJlcjtcclxuICBwYXJ0aWNpcGFudElkOiBzdHJpbmc7XHJcbiAgcGFzc3dvcmQ6IHN0cmluZztcclxufVxyXG5cclxuLyoqXHJcbiAqIPCflJAgU2VydmnDp28gZGUgU2VndXJhbsOnYSBkZSBFdmVudG9zXHJcbiAqIEdlcmVuY2lhIHNlbmhhcyBkZSBlbnRyYWRhIDQgZMOtZ2l0b3NcclxuICovXHJcbmNsYXNzIEV2ZW50U2VjdXJpdHlTZXJ2aWNlIHtcclxuICAvKipcclxuICAgKiDwn46yIEdlcmEgdW1hIHNlbmhhIGFsZWF0w7NyaWEgZGUgNCBkw61naXRvc1xyXG4gICAqIEByZXR1cm5zIFNlbmhhIG5vIGZvcm1hdG8gXCIxMjM0XCJcclxuICAgKi9cclxuICBzdGF0aWMgZ2VuZXJhdGVQYXNzd29yZCgpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgcGFzc3dvcmQgPSBNYXRoLmZsb29yKDEwMDAgKyBNYXRoLnJhbmRvbSgpICogOTAwMCkudG9TdHJpbmcoKTtcclxuICAgIGNvbnNvbGUubG9nKGDwn46yIFNlbmhhIGdlcmFkYTogJHtwYXNzd29yZH1gKTtcclxuICAgIHJldHVybiBwYXNzd29yZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCfkr4gU2FsdmEgYSBzZW5oYSBubyBldmVudG9cclxuICAgKiBAcGFyYW0gZXZlbnRJZCAtIElEIGRvIGV2ZW50b1xyXG4gICAqIEBwYXJhbSBwYXNzd29yZCAtIFNlbmhhIGRlIDQgZMOtZ2l0b3NcclxuICAgKi9cclxuICBzdGF0aWMgYXN5bmMgc2F2ZVBhc3N3b3JkVG9FdmVudChldmVudElkOiBudW1iZXIsIHBhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPEdlbmVyYXRlUGFzc3dvcmRSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGlmICghcGFzc3dvcmQgfHwgcGFzc3dvcmQubGVuZ3RoICE9PSA0IHx8ICEvXlxcZCskLy50ZXN0KHBhc3N3b3JkKSkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgIGVycm9yOiAnU2VuaGEgZGV2ZSBzZXIgZXhhdGFtZW50ZSA0IGTDrWdpdG9zJ1xyXG4gICAgICAgIH07XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgLnVwZGF0ZSh7XHJcbiAgICAgICAgICBldmVudF9lbnRyeV9wYXNzd29yZDogcGFzc3dvcmQsXHJcbiAgICAgICAgICBlbnRyeV9vcGVuZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmVxKCdpZCcsIGV2ZW50SWQpO1xyXG5cclxuICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKGDinIUgU2VuaGEgJHtwYXNzd29yZH0gc2FsdmEgbm8gZXZlbnRvICR7ZXZlbnRJZH1gKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgcGFzc3dvcmQgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIHNhbHZhciBzZW5oYTonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvciB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog8J+UkSBHZXJhIGUgc2FsdmEgdW1hIG5vdmEgc2VuaGEgZGUgZW50cmFkYVxyXG4gICAqIEBwYXJhbSBldmVudElkIC0gSUQgZG8gZXZlbnRvXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIGdlbmVyYXRlQW5kU2F2ZVBhc3N3b3JkKGV2ZW50SWQ6IG51bWJlcik6IFByb21pc2U8R2VuZXJhdGVQYXNzd29yZFJlc3VsdD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcGFzc3dvcmQgPSB0aGlzLmdlbmVyYXRlUGFzc3dvcmQoKTtcclxuICAgICAgcmV0dXJuIHRoaXMuc2F2ZVBhc3N3b3JkVG9FdmVudChldmVudElkLCBwYXNzd29yZCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBnZXJhciBlIHNhbHZhciBzZW5oYTonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvciB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog8J+VkCBWZXJpZmljYSBzZSBlc3TDoSBubyBob3LDoXJpbyBwZXJtaXRpZG8gcGFyYSBlbnRyYWRhXHJcbiAgICogUmVncmE6IDEgbWludXRvIGFudGVzIGF0w6kgMiBtaW51dG9zIGFudGVzIGRvIGZpbVxyXG4gICAqIEBwYXJhbSBldmVudElkIC0gSUQgZG8gZXZlbnRvXHJcbiAgICogQHJldHVybnMgeyBhbGxvd2VkOiBib29sZWFuLCByZWFzb24/OiBzdHJpbmcgfVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBpc0VudHJ5VGltZVZhbGlkKGV2ZW50SWQ6IG51bWJlcik6IFByb21pc2U8eyBhbGxvd2VkOiBib29sZWFuOyByZWFzb24/OiBzdHJpbmcgfT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBkYXRhOiBldmVudCwgZXJyb3I6IGV2ZW50RXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ2V2ZW50cycpXHJcbiAgICAgICAgLnNlbGVjdCgnc3RhcnRfdGltZSwgZW5kX3RpbWUsIHN0YXR1cycpXHJcbiAgICAgICAgLmVxKCdpZCcsIGV2ZW50SWQpXHJcbiAgICAgICAgLnNpbmdsZSgpO1xyXG5cclxuICAgICAgaWYgKGV2ZW50RXJyb3IpIHRocm93IGV2ZW50RXJyb3I7XHJcbiAgICAgIGlmICghZXZlbnQpIHtcclxuICAgICAgICByZXR1cm4geyBhbGxvd2VkOiBmYWxzZSwgcmVhc29uOiAnRXZlbnRvIG7Do28gZW5jb250cmFkbycgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcclxuICAgICAgY29uc3Qgc3RhcnRUaW1lID0gbmV3IERhdGUoZXZlbnQuc3RhcnRfdGltZSk7XHJcbiAgICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZShldmVudC5lbmRfdGltZSk7XHJcblxyXG4gICAgICAvLyDwn5WQIFZlcmlmaWNhcjogZmFsdGEgMSBtaW51dG8gcGFyYSBjb21lw6dhcj9cclxuICAgICAgY29uc3Qgb25lTWluQmVmb3JlU3RhcnQgPSBuZXcgRGF0ZShzdGFydFRpbWUuZ2V0VGltZSgpIC0gNjAgKiAxMDAwKTtcclxuICAgICAgaWYgKG5vdyA8IG9uZU1pbkJlZm9yZVN0YXJ0KSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIGFsbG93ZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgcmVhc29uOiBgRW50cmFkYSBkaXNwb27DrXZlbCBhIHBhcnRpciBkZSAke29uZU1pbkJlZm9yZVN0YXJ0LnRvTG9jYWxlVGltZVN0cmluZygpfWBcclxuICAgICAgICB9O1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDwn5WQIFZlcmlmaWNhcjogZmFsdGEgMiBtaW51dG9zIHBhcmEgdGVybWluYXI/XHJcbiAgICAgIGNvbnN0IHR3b01pbkJlZm9yZUVuZCA9IG5ldyBEYXRlKGVuZFRpbWUuZ2V0VGltZSgpIC0gMSAqIDIwICogMTAwMCk7XHJcbiAgICAgIGlmIChub3cgPj0gdHdvTWluQmVmb3JlRW5kKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIGFsbG93ZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgcmVhc29uOiAnRW50cmFkYSBlbmNlcnJhZGEgKGZhbHRhbSAyIG1pbnV0b3MgcGFyYSBvIGZpbSBkbyBldmVudG8pJ1xyXG4gICAgICAgIH07XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIPCflZAgVmVyaWZpY2FyOiBldmVudG8gasOhIGNvbWXDp291IG91IGFpbmRhIGVzdMOhIGNvbmZpcm1hZG8/XHJcbiAgICAgIGlmIChldmVudC5zdGF0dXMgIT09ICdDb25maXJtYWRvJyAmJiBldmVudC5zdGF0dXMgIT09ICdFbSBBbmRhbWVudG8nKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIGFsbG93ZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgcmVhc29uOiBgRXZlbnRvIG7Do28gZXN0w6EgZGlzcG9uw612ZWwgcGFyYSBlbnRyYWRhIChzdGF0dXM6ICR7ZXZlbnQuc3RhdHVzfSlgXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHsgYWxsb3dlZDogdHJ1ZSB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gdmFsaWRhciB0aW1pbmcgZGUgZW50cmFkYTonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IGFsbG93ZWQ6IGZhbHNlLCByZWFzb246ICdFcnJvIGFvIHZhbGlkYXIgdGltaW5nJyB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog4pyFIFZhbGlkYSBhIHNlbmhhIGRpZ2l0YWRhXHJcbiAgICogQHBhcmFtIHBhcmFtcyAtIHsgZXZlbnRJZCwgcGFydGljaXBhbnRJZCwgcGFzc3dvcmQgfVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyB2YWxpZGF0ZUVudHJ5UGFzc3dvcmQocGFyYW1zOiBQYXNzd29yZFZhbGlkYXRpb25QYXJhbXMpOiBQcm9taXNlPFZhbGlkYXRlUGFzc3dvcmRSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZXZlbnRJZCwgcGFydGljaXBhbnRJZCwgcGFzc3dvcmQgfSA9IHBhcmFtcztcclxuXHJcbiAgICAgIC8vIDHvuI/ig6MgVmVyaWZpY2FyIHRpbWluZ1xyXG4gICAgICBjb25zdCB0aW1pbmdDaGVjayA9IGF3YWl0IHRoaXMuaXNFbnRyeVRpbWVWYWxpZChldmVudElkKTtcclxuICAgICAgaWYgKCF0aW1pbmdDaGVjay5hbGxvd2VkKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgbWVzc2FnZTogdGltaW5nQ2hlY2sucmVhc29uXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gMu+4j+KDoyBCdXNjYXIgZXZlbnRvIGUgc2VuaGEgY29ycmV0YVxyXG4gICAgICBjb25zdCB7IGRhdGE6IGV2ZW50LCBlcnJvcjogZXZlbnRFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRzJylcclxuICAgICAgICAuc2VsZWN0KCdldmVudF9lbnRyeV9wYXNzd29yZCwgc3RhdHVzJylcclxuICAgICAgICAuZXEoJ2lkJywgZXZlbnRJZClcclxuICAgICAgICAuc2luZ2xlKCk7XHJcblxyXG4gICAgICBpZiAoZXZlbnRFcnJvcikgdGhyb3cgZXZlbnRFcnJvcjtcclxuICAgICAgaWYgKCFldmVudCkge1xyXG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnRXZlbnRvIG7Do28gZW5jb250cmFkbycgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gM++4j+KDoyBWYWxpZGFyIHNlbmhhXHJcbiAgICAgIGlmIChwYXNzd29yZCAhPT0gZXZlbnQuZXZlbnRfZW50cnlfcGFzc3dvcmQpIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oYOKdjCBQYXJ0aWNpcGFudGUgJHtwYXJ0aWNpcGFudElkfSBkaWdpdG91IHNlbmhhIGVycmFkYSBubyBldmVudG8gJHtldmVudElkfWApO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgIG1lc3NhZ2U6ICdTZW5oYSBpbmNvcnJldGEuIFRlbnRlIG5vdmFtZW50ZS4nXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gNO+4j+KDoyBTZW5oYSBjb3JyZXRhISBSZWdpc3RyYXIgZW50cmFkYVxyXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIFBhcnRpY2lwYW50ZSAke3BhcnRpY2lwYW50SWR9IGRpZ2l0b3UgYSBzZW5oYSBjb3JyZXRhIGRvIGV2ZW50byAke2V2ZW50SWR9YCk7XHJcblxyXG4gICAgICBjb25zdCB7IGVycm9yOiB1cGRhdGVFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRfcGFydGljaXBhbnRzJylcclxuICAgICAgICAudXBkYXRlKHtcclxuICAgICAgICAgIGNvbV9hY2Vzc286IHRydWUsXHJcbiAgICAgICAgICBlbnRyeV90aW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5lcSgnZXZlbnRfaWQnLCBldmVudElkKVxyXG4gICAgICAgIC5lcSgndXNlcl9pZCcsIHBhcnRpY2lwYW50SWQpO1xyXG5cclxuICAgICAgaWYgKHVwZGF0ZUVycm9yKSB0aHJvdyB1cGRhdGVFcnJvcjtcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKGDinIUgUGFydGljaXBhw6fDo28gYXR1YWxpemFkYTogY29tX2FjZXNzbyA9IHRydWUgcGFyYSAke3BhcnRpY2lwYW50SWR9YCk7XHJcblxyXG4gICAgICAvLyA177iP4oOjIFZlcmlmaWNhciBzZSBkZXZlIGF1dG8taW5pY2lhciBldmVudG9cclxuICAgICAgLy8gKFNlIMOpIG8gcHJpbWVpcm8gYSBlbnRyYXIgZSBldmVudG8gZXN0w6EgZW0gQ09ORklSTUFETylcclxuICAgICAgY29uc3Qgc2hvdWxkQXV0b1N0YXJ0ID0gZXZlbnQuc3RhdHVzID09PSAnQ29uZmlybWFkbyc7XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgbWVzc2FnZTogJ+KchSBBY2Vzc28gbGliZXJhZG8hIEJlbS12aW5kbyBhbyBldmVudG8uJyxcclxuICAgICAgICBzaG91bGRBdXRvU3RhcnRcclxuICAgICAgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIHZhbGlkYXIgc2VuaGE6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgbWVzc2FnZTogJ0Vycm8gYW8gdmFsaWRhciBlbnRyYWRhJywgZXJyb3IgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCflI0gVmVyaWZpY2Egc2UgdW0gcGFydGljaXBhbnRlIGrDoSB0ZW0gYWNlc3NvXHJcbiAgICogQHBhcmFtIGV2ZW50SWQgLSBJRCBkbyBldmVudG9cclxuICAgKiBAcGFyYW0gcGFydGljaXBhbnRJZCAtIElEIGRvIHBhcnRpY2lwYW50ZVxyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBoYXNVc2VyQWNjZXNzKGV2ZW50SWQ6IG51bWJlciwgcGFydGljaXBhbnRJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IGRhdGE6IHBhcnRpY2lwYXRpb24sIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCdldmVudF9wYXJ0aWNpcGFudHMnKVxyXG4gICAgICAgIC5zZWxlY3QoJ2NvbV9hY2Vzc28nKVxyXG4gICAgICAgIC5lcSgnZXZlbnRfaWQnLCBldmVudElkKVxyXG4gICAgICAgIC5lcSgndXNlcl9pZCcsIHBhcnRpY2lwYW50SWQpXHJcbiAgICAgICAgLnNpbmdsZSgpO1xyXG5cclxuICAgICAgaWYgKGVycm9yICYmIGVycm9yLmNvZGUgPT09ICdQR1JTVDExNicpIHJldHVybiBmYWxzZTsgLy8gTm90IGZvdW5kXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICByZXR1cm4gcGFydGljaXBhdGlvbj8uY29tX2FjZXNzbyA9PT0gdHJ1ZTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIHZlcmlmaWNhciBhY2Vzc286JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDwn5SSIEJsb3F1ZWlhIGVudHJhZGEgZGUgbm92b3MgcGFydGljaXBhbnRlcyAoMiBtaW4gYW50ZXMgZG8gZmltKVxyXG4gICAqIEBwYXJhbSBldmVudElkIC0gSUQgZG8gZXZlbnRvXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIGxvY2tFdmVudEVudHJ5KGV2ZW50SWQ6IG51bWJlcik6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyBlcnJvcj86IGFueSB9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCdldmVudHMnKVxyXG4gICAgICAgIC51cGRhdGUoe1xyXG4gICAgICAgICAgZW50cnlfbG9ja2VkOiB0cnVlLFxyXG4gICAgICAgICAgZW50cnlfbG9ja2VkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5lcSgnaWQnLCBldmVudElkKTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhg8J+UkiBFbnRyYWRhIGJsb3F1ZWFkYSBwYXJhIGV2ZW50byAke2V2ZW50SWR9YCk7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGJsb3F1ZWFyIGVudHJhZGE6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3IgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIPCfk4ogT2J0w6ltIHN0YXR1cyBkZSBlbnRyYWRhIGRvIGV2ZW50b1xyXG4gICAqL1xyXG4gIHN0YXRpYyBhc3luYyBnZXRFbnRyeVN0YXR1cyhldmVudElkOiBudW1iZXIpOiBQcm9taXNlPHtcclxuICAgIHN1Y2Nlc3M6IGJvb2xlYW47XHJcbiAgICBkYXRhPzoge1xyXG4gICAgICBwYXNzd29yZDogc3RyaW5nO1xyXG4gICAgICBpc0xvY2tlZDogYm9vbGVhbjtcclxuICAgICAgbG9ja2VkQXQ/OiBzdHJpbmc7XHJcbiAgICAgIG9wZW5lZEF0Pzogc3RyaW5nO1xyXG4gICAgICB0b3RhbFdpdGhBY2Nlc3M6IG51bWJlcjtcclxuICAgICAgdG90YWxQYXJ0aWNpcGFudHM6IG51bWJlcjtcclxuICAgIH07XHJcbiAgICBlcnJvcj86IGFueTtcclxuICB9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IGRhdGE6IGV2ZW50LCBlcnJvcjogZXZlbnRFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnZXZlbnRzJylcclxuICAgICAgICAuc2VsZWN0KCdldmVudF9lbnRyeV9wYXNzd29yZCwgZW50cnlfbG9ja2VkLCBlbnRyeV9sb2NrZWRfYXQsIGVudHJ5X29wZW5lZF9hdCcpXHJcbiAgICAgICAgLmVxKCdpZCcsIGV2ZW50SWQpXHJcbiAgICAgICAgLnNpbmdsZSgpO1xyXG5cclxuICAgICAgaWYgKGV2ZW50RXJyb3IpIHRocm93IGV2ZW50RXJyb3I7XHJcblxyXG4gICAgICBjb25zdCB7IGRhdGE6IHBhcnRpY2lwYXRpb25zLCBlcnJvcjogcGFydEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKCdldmVudF9wYXJ0aWNpcGFudHMnKVxyXG4gICAgICAgIC5zZWxlY3QoJ2NvbV9hY2Vzc28nKVxyXG4gICAgICAgIC5lcSgnZXZlbnRfaWQnLCBldmVudElkKVxyXG4gICAgICAgIC5lcSgnc3RhdHVzJywgJ2Fwcm92YWRvJyk7XHJcblxyXG4gICAgICBpZiAocGFydEVycm9yKSB0aHJvdyBwYXJ0RXJyb3I7XHJcblxyXG4gICAgICBjb25zdCB0b3RhbFdpdGhBY2Nlc3MgPSAocGFydGljaXBhdGlvbnMgfHwgW10pLmZpbHRlcihwID0+IHAuY29tX2FjZXNzbykubGVuZ3RoO1xyXG4gICAgICBjb25zdCB0b3RhbFBhcnRpY2lwYW50cyA9IHBhcnRpY2lwYXRpb25zPy5sZW5ndGggfHwgMDtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICBwYXNzd29yZDogZXZlbnQ/LmV2ZW50X2VudHJ5X3Bhc3N3b3JkIHx8ICcqKioqJyxcclxuICAgICAgICAgIGlzTG9ja2VkOiBldmVudD8uZW50cnlfbG9ja2VkIHx8IGZhbHNlLFxyXG4gICAgICAgICAgbG9ja2VkQXQ6IGV2ZW50Py5lbnRyeV9sb2NrZWRfYXQsXHJcbiAgICAgICAgICBvcGVuZWRBdDogZXZlbnQ/LmVudHJ5X29wZW5lZF9hdCxcclxuICAgICAgICAgIHRvdGFsV2l0aEFjY2VzcyxcclxuICAgICAgICAgIHRvdGFsUGFydGljaXBhbnRzXHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gb2J0ZXIgc3RhdHVzIGRlIGVudHJhZGE6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3IgfTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IEV2ZW50U2VjdXJpdHlTZXJ2aWNlOyJdLCJ2ZXJzaW9uIjozfQ==