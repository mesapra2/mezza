ad66fdcfd2495ebaddd09b5a13af42b2
"use strict";
// src/services/RatingService.test.ts
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
jest.mock('../lib/supabaseClient', () => ({
    supabase: {
        from: mockFrom,
    }
}));
// --- 1. MOCKING DEPENDÊNCIAS (ANTES DAS IMPORTAÇÕES) ---
// Mock do Supabase
const mockFrom = jest.fn();
const RatingService_1 = tslib_1.__importDefault(require("./RatingService"));
// --- 3. CONFIGURAÇÃO DOS TESTES ---
describe('RatingService', () => {
    // Espiões para métodos estáticos chamados internamente
    let spyUpdateRating;
    let spyUpdateFlag;
    beforeEach(() => {
        jest.clearAllMocks();
        // Mockamos as implementações dos métodos internos para isolar os testes
        spyUpdateRating = jest.spyOn(RatingService_1.default, 'updateRating')
            .mockResolvedValue({ success: true });
        spyUpdateFlag = jest.spyOn(RatingService_1.default, 'updateParticipationEvaluationFlag')
            .mockResolvedValue(undefined);
    });
    afterEach(() => {
        // Restauramos os espiões
        spyUpdateRating.mockRestore();
        spyUpdateFlag.mockRestore();
    });
    // --- 4. TESTES DOS MÉTODOS ---
    describe('createRating', () => {
        const params = {
            eventId: 1,
            raterId: 'user-rater',
            ratedId: 'user-rated',
            ratingType: 'host',
            score: 5,
        };
        it('deve criar uma nova avaliação se ela não existir', async () => {
            const mockRating = { id: 'rating-123', ...params };
            // Mock 1: SELECT (checkError) - não encontra (PGRST116)
            const mockSingle1 = jest.fn().mockResolvedValue({
                data: null,
                error: { code: 'PGRST116' }
            });
            const mockEq4 = jest.fn().mockReturnValue({ single: mockSingle1 });
            const mockEq3 = jest.fn().mockReturnValue({ eq: mockEq4 });
            const mockEq2 = jest.fn().mockReturnValue({ eq: mockEq3 });
            const mockEq1 = jest.fn().mockReturnValue({ eq: mockEq2 });
            const mockSelect = jest.fn().mockReturnValue({ eq: mockEq1 });
            // Mock 2: INSERT
            const mockSingle2 = jest.fn().mockResolvedValue({ data: mockRating, error: null });
            const mockSelectInsert = jest.fn().mockReturnValue({ single: mockSingle2 });
            const mockInsert = jest.fn().mockReturnValue({ select: mockSelectInsert });
            mockFrom
                .mockReturnValueOnce({ select: mockSelect }) // primeira chamada: check
                .mockReturnValueOnce({ insert: mockInsert }); // segunda chamada: insert
            const result = await RatingService_1.default.createRating(params);
            expect(result.success).toBe(true);
            expect(result.data).toEqual(mockRating);
            expect(mockInsert).toHaveBeenCalled();
            // Verifica se chamou o método interno para atualizar o status do participante
            expect(spyUpdateFlag).toHaveBeenCalledWith(params.eventId, params.raterId);
            // Garante que NÃO chamou o updateRating
            expect(spyUpdateRating).not.toHaveBeenCalled();
        });
        it('deve chamar updateRating se a avaliação já existir', async () => {
            const existingRating = { id: 'rating-existing' };
            // Mock SELECT (checkError) - ENCONTRA
            const mockSingle = jest.fn().mockResolvedValue({
                data: existingRating,
                error: null
            });
            const mockEq4 = jest.fn().mockReturnValue({ single: mockSingle });
            const mockEq3 = jest.fn().mockReturnValue({ eq: mockEq4 });
            const mockEq2 = jest.fn().mockReturnValue({ eq: mockEq3 });
            const mockEq1 = jest.fn().mockReturnValue({ eq: mockEq2 });
            const mockSelect = jest.fn().mockReturnValue({ eq: mockEq1 });
            mockFrom.mockReturnValue({ select: mockSelect });
            await RatingService_1.default.createRating(params);
            // Garante que chamou o spy de updateRating
            expect(spyUpdateRating).toHaveBeenCalledWith(existingRating.id, params.score);
            // Garante que NÃO chamou insert nem o updateFlag
            expect(spyUpdateFlag).not.toHaveBeenCalled();
        });
        it('deve falhar se o score for inválido', async () => {
            const result = await RatingService_1.default.createRating({ ...params, score: 0 });
            expect(result.success).toBe(false);
            expect(result.error).toBe('Score deve estar entre 1 e 5');
        });
    });
    describe('updateRating', () => {
        it('deve chamar supabase.update com o novo score', async () => {
            // Libera o spy para testar a implementação real
            spyUpdateRating.mockRestore();
            const mockRating = { id: 'rating-123', score: 5 };
            // Mock do UPDATE
            const mockSingle = jest.fn().mockResolvedValue({ data: mockRating, error: null });
            const mockSelect = jest.fn().mockReturnValue({ single: mockSingle });
            const mockEq = jest.fn().mockReturnValue({ select: mockSelect });
            const mockUpdate = jest.fn().mockReturnValue({ eq: mockEq });
            mockFrom.mockReturnValue({
                update: mockUpdate,
            });
            const result = await RatingService_1.default.updateRating('rating-123', 5);
            expect(result.success).toBe(true);
            expect(result.data).toEqual(mockRating);
            expect(mockUpdate).toHaveBeenCalledWith(expect.objectContaining({ score: 5 }));
        });
    });
    describe('getUserRatings', () => {
        it('deve calcular a média e o total de avaliações', async () => {
            const mockRatings = [
                { rated_id: 'user-1', rating_type: 'host', score: 5 },
                { rated_id: 'user-1', rating_type: 'participant', score: 4 },
                { rated_id: 'user-1', rating_type: 'participant', score: 3 },
            ];
            // Mock do SELECT
            const mockEq = jest.fn().mockResolvedValue({ data: mockRatings, error: null });
            const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });
            mockFrom.mockReturnValue({
                select: mockSelect,
            });
            const result = await RatingService_1.default.getUserRatings('user-1');
            expect(result.success).toBe(true);
            expect(result.totalRatings).toBe(3);
            expect(result.averageScore).toBe(4); // (5+4+3) / 3 = 4
            expect(result.hostRatings).toBe(1);
            expect(result.participantRatings).toBe(2);
        });
    });
    describe('getEventRatingsStatus', () => {
        it('deve identificar avaliações pendentes', async () => {
            const mockParticipants = [
                { user_id: 'user-A', presenca_confirmada: true, profile: { username: 'UserA' } },
                { user_id: 'user-B', presenca_confirmada: true, profile: { username: 'UserB' } },
            ];
            const mockEvent = { creator_id: 'host-id', partner_id: 'resto-id' };
            const mockRatings = [
                // User A avaliou tudo
                { rater_id: 'user-A', rating_type: 'host', rated_id: 'host-id' },
                { rater_id: 'user-A', rating_type: 'participant', rated_id: 'user-B' },
                { rater_id: 'user-A', rating_type: 'restaurant', rated_id: 'resto-id' },
                // User B esqueceu o restaurante
                { rater_id: 'user-B', rating_type: 'host', rated_id: 'host-id' },
                { rater_id: 'user-B', rating_type: 'participant', rated_id: 'user-A' },
            ];
            // Mock 1: SELECT participantes
            const mockEq1_2 = jest.fn().mockResolvedValue({ data: mockParticipants, error: null });
            const mockEq1_1 = jest.fn().mockReturnValue({ eq: mockEq1_2 });
            const mockSelect1 = jest.fn().mockReturnValue({ eq: mockEq1_1 });
            // Mock 2: SELECT evento
            const mockSingle = jest.fn().mockResolvedValue({ data: mockEvent, error: null });
            const mockEq2 = jest.fn().mockReturnValue({ single: mockSingle });
            const mockSelect2 = jest.fn().mockReturnValue({ eq: mockEq2 });
            // Mock 3: SELECT ratings
            const mockEq3 = jest.fn().mockResolvedValue({ data: mockRatings, error: null });
            const mockSelect3 = jest.fn().mockReturnValue({ eq: mockEq3 });
            mockFrom
                .mockReturnValueOnce({ select: mockSelect1 }) // participantes
                .mockReturnValueOnce({ select: mockSelect2 }) // evento
                .mockReturnValueOnce({ select: mockSelect3 }); // ratings
            const result = await RatingService_1.default.getEventRatingsStatus(1);
            expect(result.success).toBe(true);
            expect(result.data?.allRatingsComplete).toBe(false);
            expect(result.data?.totalParticipants).toBe(2);
            expect(result.data?.pendingRaters).toHaveLength(1);
            expect(result.data?.pendingRaters[0].user_id).toBe('user-B');
            expect(result.data?.pendingRaters[0].evaluated_restaurant).toBe(false);
            expect(result.data?.pendingRaters[0].evaluated_host).toBe(true);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcUmF0aW5nU2VydmljZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQSxxQ0FBcUM7OztBQU9yQyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDeEMsUUFBUSxFQUFFO1FBQ1IsSUFBSSxFQUFFLFFBQVE7S0FDZjtDQUNGLENBQUMsQ0FBQyxDQUFDO0FBVEosMERBQTBEO0FBRTFELG1CQUFtQjtBQUNuQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7QUFXM0IsNEVBQTREO0FBRTVELHFDQUFxQztBQUVyQyxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUU3Qix1REFBdUQ7SUFDdkQsSUFBSSxlQUFzRSxDQUFDO0lBQzNFLElBQUksYUFBeUYsQ0FBQztJQUU5RixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXJCLHdFQUF3RTtRQUN4RSxlQUFlLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyx1QkFBYSxFQUFFLGNBQWMsQ0FBQzthQUN4RCxpQkFBaUIsQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXhDLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLHVCQUFhLEVBQUUsbUNBQW1DLENBQUM7YUFDM0UsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IseUJBQXlCO1FBQ3pCLGVBQWUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM5QixhQUFhLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxnQ0FBZ0M7SUFFaEMsUUFBUSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUU7UUFDNUIsTUFBTSxNQUFNLEdBQUc7WUFDYixP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YUFBYSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25ELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDN0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZFLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUVMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxERVZNaXhcXEFwcC5NZXNhcHJhMi5jb21cXHNyY1xcc2VydmljZXNcXFJhdGluZ1NlcnZpY2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvc2VydmljZXMvUmF0aW5nU2VydmljZS50ZXN0LnRzXHJcblxyXG4vLyAtLS0gMS4gTU9DS0lORyBERVBFTkTDik5DSUFTIChBTlRFUyBEQVMgSU1QT1JUQcOHw5VFUykgLS0tXHJcblxyXG4vLyBNb2NrIGRvIFN1cGFiYXNlXHJcbmNvbnN0IG1vY2tGcm9tID0gamVzdC5mbigpO1xyXG5cclxuamVzdC5tb2NrKCcuLi9saWIvc3VwYWJhc2VDbGllbnQnLCAoKSA9PiAoe1xyXG4gIHN1cGFiYXNlOiB7XHJcbiAgICBmcm9tOiBtb2NrRnJvbSxcclxuICB9XHJcbn0pKTtcclxuXHJcbi8vIC0tLSAyLiBJTVBPUlRBw4fDlUVTIChERVBPSVMgRE9TIE1PQ0tTKSAtLS1cclxuXHJcbmltcG9ydCB7IHN1cGFiYXNlIH0gZnJvbSAnLi4vbGliL3N1cGFiYXNlQ2xpZW50JztcclxuaW1wb3J0IFJhdGluZ1NlcnZpY2UsIHsgUmF0aW5nVHlwZSB9IGZyb20gJy4vUmF0aW5nU2VydmljZSc7XHJcblxyXG4vLyAtLS0gMy4gQ09ORklHVVJBw4fDg08gRE9TIFRFU1RFUyAtLS1cclxuXHJcbmRlc2NyaWJlKCdSYXRpbmdTZXJ2aWNlJywgKCkgPT4ge1xyXG5cclxuICAvLyBFc3Bpw7VlcyBwYXJhIG3DqXRvZG9zIGVzdMOhdGljb3MgY2hhbWFkb3MgaW50ZXJuYW1lbnRlXHJcbiAgbGV0IHNweVVwZGF0ZVJhdGluZzogamVzdC5TcGllZEZ1bmN0aW9uPHR5cGVvZiBSYXRpbmdTZXJ2aWNlLnVwZGF0ZVJhdGluZz47XHJcbiAgbGV0IHNweVVwZGF0ZUZsYWc6IGplc3QuU3BpZWRGdW5jdGlvbjx0eXBlb2YgUmF0aW5nU2VydmljZS51cGRhdGVQYXJ0aWNpcGF0aW9uRXZhbHVhdGlvbkZsYWc+O1xyXG5cclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG5cclxuICAgIC8vIE1vY2thbW9zIGFzIGltcGxlbWVudGHDp8O1ZXMgZG9zIG3DqXRvZG9zIGludGVybm9zIHBhcmEgaXNvbGFyIG9zIHRlc3Rlc1xyXG4gICAgc3B5VXBkYXRlUmF0aW5nID0gamVzdC5zcHlPbihSYXRpbmdTZXJ2aWNlLCAndXBkYXRlUmF0aW5nJylcclxuICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKHsgc3VjY2VzczogdHJ1ZSB9KTtcclxuICAgICAgXHJcbiAgICBzcHlVcGRhdGVGbGFnID0gamVzdC5zcHlPbihSYXRpbmdTZXJ2aWNlLCAndXBkYXRlUGFydGljaXBhdGlvbkV2YWx1YXRpb25GbGFnJylcclxuICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XHJcbiAgfSk7XHJcblxyXG4gIGFmdGVyRWFjaCgoKSA9PiB7XHJcbiAgICAvLyBSZXN0YXVyYW1vcyBvcyBlc3Bpw7Vlc1xyXG4gICAgc3B5VXBkYXRlUmF0aW5nLm1vY2tSZXN0b3JlKCk7XHJcbiAgICBzcHlVcGRhdGVGbGFnLm1vY2tSZXN0b3JlKCk7XHJcbiAgfSk7XHJcblxyXG4gIC8vIC0tLSA0LiBURVNURVMgRE9TIE3DiVRPRE9TIC0tLVxyXG5cclxuICBkZXNjcmliZSgnY3JlYXRlUmF0aW5nJywgKCkgPT4ge1xyXG4gICAgY29uc3QgcGFyYW1zID0ge1xyXG4gICAgICBldmVudElkOiAxLFxyXG4gICAgICByYXRlcklkOiAndXNlci1yYXRlcicsXHJcbiAgICAgIHJhdGVkSWQ6ICd1c2VyLXJhdGVkJyxcclxuICAgICAgcmF0aW5nVHlwZTogJ2hvc3QnIGFzIFJhdGluZ1R5cGUsXHJcbiAgICAgIHNjb3JlOiA1LFxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgaXQoJ2RldmUgY3JpYXIgdW1hIG5vdmEgYXZhbGlhw6fDo28gc2UgZWxhIG7Do28gZXhpc3RpcicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja1JhdGluZyA9IHsgaWQ6ICdyYXRpbmctMTIzJywgLi4ucGFyYW1zIH07XHJcblxyXG4gICAgICAvLyBNb2NrIDE6IFNFTEVDVCAoY2hlY2tFcnJvcikgLSBuw6NvIGVuY29udHJhIChQR1JTVDExNilcclxuICAgICAgY29uc3QgbW9ja1NpbmdsZTEgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBcclxuICAgICAgICBkYXRhOiBudWxsLCBcclxuICAgICAgICBlcnJvcjogeyBjb2RlOiAnUEdSU1QxMTYnIH0gXHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zdCBtb2NrRXE0ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IHNpbmdsZTogbW9ja1NpbmdsZTEgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tFcTMgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcTQgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tFcTIgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcTMgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tFcTEgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcTIgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tTZWxlY3QgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcTEgfSk7XHJcblxyXG4gICAgICAvLyBNb2NrIDI6IElOU0VSVFxyXG4gICAgICBjb25zdCBtb2NrU2luZ2xlMiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IG1vY2tSYXRpbmcsIGVycm9yOiBudWxsIH0pO1xyXG4gICAgICBjb25zdCBtb2NrU2VsZWN0SW5zZXJ0ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IHNpbmdsZTogbW9ja1NpbmdsZTIgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tJbnNlcnQgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgc2VsZWN0OiBtb2NrU2VsZWN0SW5zZXJ0IH0pO1xyXG5cclxuICAgICAgbW9ja0Zyb21cclxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZSh7IHNlbGVjdDogbW9ja1NlbGVjdCB9KSAvLyBwcmltZWlyYSBjaGFtYWRhOiBjaGVja1xyXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKHsgaW5zZXJ0OiBtb2NrSW5zZXJ0IH0pOyAvLyBzZWd1bmRhIGNoYW1hZGE6IGluc2VydFxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgUmF0aW5nU2VydmljZS5jcmVhdGVSYXRpbmcocGFyYW1zKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhKS50b0VxdWFsKG1vY2tSYXRpbmcpO1xyXG4gICAgICBleHBlY3QobW9ja0luc2VydCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBcclxuICAgICAgLy8gVmVyaWZpY2Egc2UgY2hhbW91IG8gbcOpdG9kbyBpbnRlcm5vIHBhcmEgYXR1YWxpemFyIG8gc3RhdHVzIGRvIHBhcnRpY2lwYW50ZVxyXG4gICAgICBleHBlY3Qoc3B5VXBkYXRlRmxhZykudG9IYXZlQmVlbkNhbGxlZFdpdGgocGFyYW1zLmV2ZW50SWQsIHBhcmFtcy5yYXRlcklkKTtcclxuICAgICAgXHJcbiAgICAgIC8vIEdhcmFudGUgcXVlIE7Dg08gY2hhbW91IG8gdXBkYXRlUmF0aW5nXHJcbiAgICAgIGV4cGVjdChzcHlVcGRhdGVSYXRpbmcpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnZGV2ZSBjaGFtYXIgdXBkYXRlUmF0aW5nIHNlIGEgYXZhbGlhw6fDo28gasOhIGV4aXN0aXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGV4aXN0aW5nUmF0aW5nID0geyBpZDogJ3JhdGluZy1leGlzdGluZycgfTtcclxuXHJcbiAgICAgIC8vIE1vY2sgU0VMRUNUIChjaGVja0Vycm9yKSAtIEVOQ09OVFJBXHJcbiAgICAgIGNvbnN0IG1vY2tTaW5nbGUgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBcclxuICAgICAgICBkYXRhOiBleGlzdGluZ1JhdGluZywgXHJcbiAgICAgICAgZXJyb3I6IG51bGwgXHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zdCBtb2NrRXE0ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IHNpbmdsZTogbW9ja1NpbmdsZSB9KTtcclxuICAgICAgY29uc3QgbW9ja0VxMyA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxNCB9KTtcclxuICAgICAgY29uc3QgbW9ja0VxMiA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMyB9KTtcclxuICAgICAgY29uc3QgbW9ja0VxMSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMiB9KTtcclxuICAgICAgY29uc3QgbW9ja1NlbGVjdCA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMSB9KTtcclxuXHJcbiAgICAgIG1vY2tGcm9tLm1vY2tSZXR1cm5WYWx1ZSh7IHNlbGVjdDogbW9ja1NlbGVjdCB9KTtcclxuXHJcbiAgICAgIGF3YWl0IFJhdGluZ1NlcnZpY2UuY3JlYXRlUmF0aW5nKHBhcmFtcyk7XHJcblxyXG4gICAgICAvLyBHYXJhbnRlIHF1ZSBjaGFtb3UgbyBzcHkgZGUgdXBkYXRlUmF0aW5nXHJcbiAgICAgIGV4cGVjdChzcHlVcGRhdGVSYXRpbmcpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4aXN0aW5nUmF0aW5nLmlkLCBwYXJhbXMuc2NvcmUpO1xyXG4gICAgICBcclxuICAgICAgLy8gR2FyYW50ZSBxdWUgTsODTyBjaGFtb3UgaW5zZXJ0IG5lbSBvIHVwZGF0ZUZsYWdcclxuICAgICAgZXhwZWN0KHNweVVwZGF0ZUZsYWcpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnZGV2ZSBmYWxoYXIgc2UgbyBzY29yZSBmb3IgaW52w6FsaWRvJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBSYXRpbmdTZXJ2aWNlLmNyZWF0ZVJhdGluZyh7IC4uLnBhcmFtcywgc2NvcmU6IDAgfSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZShmYWxzZSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQmUoJ1Njb3JlIGRldmUgZXN0YXIgZW50cmUgMSBlIDUnKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgndXBkYXRlUmF0aW5nJywgKCkgPT4ge1xyXG4gICAgaXQoJ2RldmUgY2hhbWFyIHN1cGFiYXNlLnVwZGF0ZSBjb20gbyBub3ZvIHNjb3JlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBMaWJlcmEgbyBzcHkgcGFyYSB0ZXN0YXIgYSBpbXBsZW1lbnRhw6fDo28gcmVhbFxyXG4gICAgICBzcHlVcGRhdGVSYXRpbmcubW9ja1Jlc3RvcmUoKTtcclxuICAgICAgY29uc3QgbW9ja1JhdGluZyA9IHsgaWQ6ICdyYXRpbmctMTIzJywgc2NvcmU6IDUgfTtcclxuXHJcbiAgICAgIC8vIE1vY2sgZG8gVVBEQVRFXHJcbiAgICAgIGNvbnN0IG1vY2tTaW5nbGUgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBkYXRhOiBtb2NrUmF0aW5nLCBlcnJvcjogbnVsbCB9KTtcclxuICAgICAgY29uc3QgbW9ja1NlbGVjdCA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBzaW5nbGU6IG1vY2tTaW5nbGUgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tFcSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBzZWxlY3Q6IG1vY2tTZWxlY3QgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tVcGRhdGUgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcSB9KTtcclxuXHJcbiAgICAgIG1vY2tGcm9tLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgdXBkYXRlOiBtb2NrVXBkYXRlLFxyXG4gICAgICB9KTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFJhdGluZ1NlcnZpY2UudXBkYXRlUmF0aW5nKCdyYXRpbmctMTIzJywgNSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuZGF0YSkudG9FcXVhbChtb2NrUmF0aW5nKTtcclxuICAgICAgZXhwZWN0KG1vY2tVcGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHsgc2NvcmU6IDUgfSlcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZ2V0VXNlclJhdGluZ3MnLCAoKSA9PiB7XHJcbiAgICBpdCgnZGV2ZSBjYWxjdWxhciBhIG3DqWRpYSBlIG8gdG90YWwgZGUgYXZhbGlhw6fDtWVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrUmF0aW5ncyA9IFtcclxuICAgICAgICB7IHJhdGVkX2lkOiAndXNlci0xJywgcmF0aW5nX3R5cGU6ICdob3N0Jywgc2NvcmU6IDUgfSxcclxuICAgICAgICB7IHJhdGVkX2lkOiAndXNlci0xJywgcmF0aW5nX3R5cGU6ICdwYXJ0aWNpcGFudCcsIHNjb3JlOiA0IH0sXHJcbiAgICAgICAgeyByYXRlZF9pZDogJ3VzZXItMScsIHJhdGluZ190eXBlOiAncGFydGljaXBhbnQnLCBzY29yZTogMyB9LFxyXG4gICAgICBdO1xyXG4gICAgICBcclxuICAgICAgLy8gTW9jayBkbyBTRUxFQ1RcclxuICAgICAgY29uc3QgbW9ja0VxID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogbW9ja1JhdGluZ3MsIGVycm9yOiBudWxsIH0pO1xyXG4gICAgICBjb25zdCBtb2NrU2VsZWN0ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IGVxOiBtb2NrRXEgfSk7XHJcblxyXG4gICAgICBtb2NrRnJvbS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHNlbGVjdDogbW9ja1NlbGVjdCxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBSYXRpbmdTZXJ2aWNlLmdldFVzZXJSYXRpbmdzKCd1c2VyLTEnKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC50b3RhbFJhdGluZ3MpLnRvQmUoMyk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuYXZlcmFnZVNjb3JlKS50b0JlKDQpOyAvLyAoNSs0KzMpIC8gMyA9IDRcclxuICAgICAgZXhwZWN0KHJlc3VsdC5ob3N0UmF0aW5ncykudG9CZSgxKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5wYXJ0aWNpcGFudFJhdGluZ3MpLnRvQmUoMik7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2dldEV2ZW50UmF0aW5nc1N0YXR1cycsICgpID0+IHtcclxuICAgIGl0KCdkZXZlIGlkZW50aWZpY2FyIGF2YWxpYcOnw7VlcyBwZW5kZW50ZXMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tQYXJ0aWNpcGFudHMgPSBbXHJcbiAgICAgICAgeyB1c2VyX2lkOiAndXNlci1BJywgcHJlc2VuY2FfY29uZmlybWFkYTogdHJ1ZSwgcHJvZmlsZTogeyB1c2VybmFtZTogJ1VzZXJBJyB9IH0sXHJcbiAgICAgICAgeyB1c2VyX2lkOiAndXNlci1CJywgcHJlc2VuY2FfY29uZmlybWFkYTogdHJ1ZSwgcHJvZmlsZTogeyB1c2VybmFtZTogJ1VzZXJCJyB9IH0sXHJcbiAgICAgIF07XHJcbiAgICAgIGNvbnN0IG1vY2tFdmVudCA9IHsgY3JlYXRvcl9pZDogJ2hvc3QtaWQnLCBwYXJ0bmVyX2lkOiAncmVzdG8taWQnIH07XHJcbiAgICAgIGNvbnN0IG1vY2tSYXRpbmdzID0gW1xyXG4gICAgICAgIC8vIFVzZXIgQSBhdmFsaW91IHR1ZG9cclxuICAgICAgICB7IHJhdGVyX2lkOiAndXNlci1BJywgcmF0aW5nX3R5cGU6ICdob3N0JywgcmF0ZWRfaWQ6ICdob3N0LWlkJyB9LFxyXG4gICAgICAgIHsgcmF0ZXJfaWQ6ICd1c2VyLUEnLCByYXRpbmdfdHlwZTogJ3BhcnRpY2lwYW50JywgcmF0ZWRfaWQ6ICd1c2VyLUInIH0sXHJcbiAgICAgICAgeyByYXRlcl9pZDogJ3VzZXItQScsIHJhdGluZ190eXBlOiAncmVzdGF1cmFudCcsIHJhdGVkX2lkOiAncmVzdG8taWQnIH0sXHJcbiAgICAgICAgLy8gVXNlciBCIGVzcXVlY2V1IG8gcmVzdGF1cmFudGVcclxuICAgICAgICB7IHJhdGVyX2lkOiAndXNlci1CJywgcmF0aW5nX3R5cGU6ICdob3N0JywgcmF0ZWRfaWQ6ICdob3N0LWlkJyB9LFxyXG4gICAgICAgIHsgcmF0ZXJfaWQ6ICd1c2VyLUInLCByYXRpbmdfdHlwZTogJ3BhcnRpY2lwYW50JywgcmF0ZWRfaWQ6ICd1c2VyLUEnIH0sXHJcbiAgICAgIF07XHJcblxyXG4gICAgICAvLyBNb2NrIDE6IFNFTEVDVCBwYXJ0aWNpcGFudGVzXHJcbiAgICAgIGNvbnN0IG1vY2tFcTFfMiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IG1vY2tQYXJ0aWNpcGFudHMsIGVycm9yOiBudWxsIH0pO1xyXG4gICAgICBjb25zdCBtb2NrRXExXzEgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcTFfMiB9KTtcclxuICAgICAgY29uc3QgbW9ja1NlbGVjdDEgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IG1vY2tFcTFfMSB9KTtcclxuICAgICAgXHJcbiAgICAgIC8vIE1vY2sgMjogU0VMRUNUIGV2ZW50b1xyXG4gICAgICBjb25zdCBtb2NrU2luZ2xlID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogbW9ja0V2ZW50LCBlcnJvcjogbnVsbCB9KTtcclxuICAgICAgY29uc3QgbW9ja0VxMiA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBzaW5nbGU6IG1vY2tTaW5nbGUgfSk7XHJcbiAgICAgIGNvbnN0IG1vY2tTZWxlY3QyID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IGVxOiBtb2NrRXEyIH0pO1xyXG4gICAgICBcclxuICAgICAgLy8gTW9jayAzOiBTRUxFQ1QgcmF0aW5nc1xyXG4gICAgICBjb25zdCBtb2NrRXEzID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogbW9ja1JhdGluZ3MsIGVycm9yOiBudWxsIH0pO1xyXG4gICAgICBjb25zdCBtb2NrU2VsZWN0MyA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBlcTogbW9ja0VxMyB9KTtcclxuXHJcbiAgICAgIG1vY2tGcm9tXHJcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZU9uY2UoeyBzZWxlY3Q6IG1vY2tTZWxlY3QxIH0pIC8vIHBhcnRpY2lwYW50ZXNcclxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZSh7IHNlbGVjdDogbW9ja1NlbGVjdDIgfSkgLy8gZXZlbnRvXHJcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZU9uY2UoeyBzZWxlY3Q6IG1vY2tTZWxlY3QzIH0pOyAvLyByYXRpbmdzXHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBSYXRpbmdTZXJ2aWNlLmdldEV2ZW50UmF0aW5nc1N0YXR1cygxKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhPy5hbGxSYXRpbmdzQ29tcGxldGUpLnRvQmUoZmFsc2UpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LmRhdGE/LnRvdGFsUGFydGljaXBhbnRzKS50b0JlKDIpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LmRhdGE/LnBlbmRpbmdSYXRlcnMpLnRvSGF2ZUxlbmd0aCgxKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhPy5wZW5kaW5nUmF0ZXJzWzBdLnVzZXJfaWQpLnRvQmUoJ3VzZXItQicpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LmRhdGE/LnBlbmRpbmdSYXRlcnNbMF0uZXZhbHVhdGVkX3Jlc3RhdXJhbnQpLnRvQmUoZmFsc2UpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LmRhdGE/LnBlbmRpbmdSYXRlcnNbMF0uZXZhbHVhdGVkX2hvc3QpLnRvQmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==