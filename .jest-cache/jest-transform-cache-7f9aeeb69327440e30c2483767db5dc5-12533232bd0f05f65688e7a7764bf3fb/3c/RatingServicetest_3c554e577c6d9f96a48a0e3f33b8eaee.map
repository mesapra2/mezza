{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\services\\RatingService.test.ts","mappings":";AAAA,qCAAqC;;;AAOrC,IAAI,CAAC,IAAI,CAAC,uBAAuB,EAAE,GAAG,EAAE,CAAC,CAAC;IACxC,QAAQ,EAAE;QACR,IAAI,EAAE,QAAQ;KACf;CACF,CAAC,CAAC,CAAC;AATJ,0DAA0D;AAE1D,mBAAmB;AACnB,MAAM,QAAQ,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;AAW3B,4EAA4D;AAE5D,qCAAqC;AAErC,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;IAE7B,uDAAuD;IACvD,IAAI,eAAsE,CAAC;IAC3E,IAAI,aAAyF,CAAC;IAE9F,UAAU,CAAC,GAAG,EAAE;QACd,IAAI,CAAC,aAAa,EAAE,CAAC;QAErB,wEAAwE;QACxE,eAAe,GAAG,IAAI,CAAC,KAAK,CAAC,uBAAa,EAAE,cAAc,CAAC;aACxD,iBAAiB,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;QAExC,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC,uBAAa,EAAE,mCAAmC,CAAC;aAC3E,iBAAiB,CAAC,SAAS,CAAC,CAAC;IAClC,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,GAAG,EAAE;QACb,yBAAyB;QACzB,eAAe,CAAC,WAAW,EAAE,CAAC;QAC9B,aAAa,CAAC,WAAW,EAAE,CAAC;IAC9B,CAAC,CAAC,CAAC;IAEH,gCAAgC;IAEhC,QAAQ,CAAC,cAAc,EAAE,GAAG,EAAE;QAC5B,MAAM,MAAM,GAAG;YACb,OAAO,EAAE,CAAC;YACV,OAAO,EAAE,YAAY;YACrB,OAAO,EAAE,YAAY;YACrB,UAAU,EAAE,MAAoB;YAChC,KAAK,EAAE,CAAC;SACT,CAAC;QAEF,EAAE,CAAC,kDAAkD,EAAE,KAAK,IAAI,EAAE;YAChE,MAAM,UAAU,GAAG,EAAE,EAAE,EAAE,YAAY,EAAE,GAAG,MAAM,EAAE,CAAC;YAEnD,wDAAwD;YACxD,MAAM,WAAW,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC;gBAC9C,IAAI,EAAE,IAAI;gBACV,KAAK,EAAE,EAAE,IAAI,EAAE,UAAU,EAAE;aAC5B,CAAC,CAAC;YACH,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC;YACnE,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAC3D,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAC3D,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAC3D,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAE9D,iBAAiB;YACjB,MAAM,WAAW,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;YACnF,MAAM,gBAAgB,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC;YAC5E,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,MAAM,EAAE,gBAAgB,EAAE,CAAC,CAAC;YAE3E,QAAQ;iBACL,mBAAmB,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC,0BAA0B;iBACtE,mBAAmB,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC,CAAC,0BAA0B;YAE1E,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;YAExD,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;YACxC,MAAM,CAAC,UAAU,CAAC,CAAC,gBAAgB,EAAE,CAAC;YAEtC,8EAA8E;YAC9E,MAAM,CAAC,aAAa,CAAC,CAAC,oBAAoB,CAAC,MAAM,CAAC,OAAO,EAAE,MAAM,CAAC,OAAO,CAAC,CAAC;YAE3E,wCAAwC;YACxC,MAAM,CAAC,eAAe,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC;QACjD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,oDAAoD,EAAE,KAAK,IAAI,EAAE;YAClE,MAAM,cAAc,GAAG,EAAE,EAAE,EAAE,iBAAiB,EAAE,CAAC;YAEjD,sCAAsC;YACtC,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC;gBAC7C,IAAI,EAAE,cAAc;gBACpB,KAAK,EAAE,IAAI;aACZ,CAAC,CAAC;YACH,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC;YAClE,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAC3D,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAC3D,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAC3D,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAE9D,QAAQ,CAAC,eAAe,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC;YAEjD,MAAM,uBAAa,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;YAEzC,2CAA2C;YAC3C,MAAM,CAAC,eAAe,CAAC,CAAC,oBAAoB,CAAC,cAAc,CAAC,EAAE,EAAE,MAAM,CAAC,KAAK,CAAC,CAAC;YAE9E,iDAAiD;YACjD,MAAM,CAAC,aAAa,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC;QAC/C,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,qCAAqC,EAAE,KAAK,IAAI,EAAE;YACnD,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,YAAY,CAAC,EAAE,GAAG,MAAM,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC,CAAC;YACzE,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACnC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,8BAA8B,CAAC,CAAC;QAC5D,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,cAAc,EAAE,GAAG,EAAE;QAC5B,EAAE,CAAC,8CAA8C,EAAE,KAAK,IAAI,EAAE;YAC5D,gDAAgD;YAChD,eAAe,CAAC,WAAW,EAAE,CAAC;YAC9B,MAAM,UAAU,GAAG,EAAE,EAAE,EAAE,YAAY,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;YAElD,iBAAiB;YACjB,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;YAClF,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC;YACrE,MAAM,MAAM,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC;YACjE,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,MAAM,EAAE,CAAC,CAAC;YAE7D,QAAQ,CAAC,eAAe,CAAC;gBACvB,MAAM,EAAE,UAAU;aACnB,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,YAAY,CAAC,YAAY,EAAE,CAAC,CAAC,CAAC;YAEjE,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;YACxC,MAAM,CAAC,UAAU,CAAC,CAAC,oBAAoB,CACrC,MAAM,CAAC,gBAAgB,CAAC,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC,CACtC,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,gBAAgB,EAAE,GAAG,EAAE;QAC9B,EAAE,CAAC,+CAA+C,EAAE,KAAK,IAAI,EAAE;YAC7D,MAAM,WAAW,GAAG;gBAClB,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,EAAE;gBACrD,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,aAAa,EAAE,KAAK,EAAE,CAAC,EAAE;gBAC5D,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,aAAa,EAAE,KAAK,EAAE,CAAC,EAAE;aAC7D,CAAC;YAEF,iBAAiB;YACjB,MAAM,MAAM,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,EAAE,IAAI,EAAE,WAAW,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;YAC/E,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,MAAM,EAAE,CAAC,CAAC;YAE7D,QAAQ,CAAC,eAAe,CAAC;gBACvB,MAAM,EAAE,UAAU;aACnB,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;YAE5D,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,MAAM,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YACpC,MAAM,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,kBAAkB;YACvD,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YACnC,MAAM,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAC5C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,uBAAuB,EAAE,GAAG,EAAE;QACrC,EAAE,CAAC,uCAAuC,EAAE,KAAK,IAAI,EAAE;YACrD,MAAM,gBAAgB,GAAG;gBACvB,EAAE,OAAO,EAAE,QAAQ,EAAE,mBAAmB,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,QAAQ,EAAE,OAAO,EAAE,EAAE;gBAChF,EAAE,OAAO,EAAE,QAAQ,EAAE,mBAAmB,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,QAAQ,EAAE,OAAO,EAAE,EAAE;aACjF,CAAC;YACF,MAAM,SAAS,GAAG,EAAE,UAAU,EAAE,SAAS,EAAE,UAAU,EAAE,UAAU,EAAE,CAAC;YACpE,MAAM,WAAW,GAAG;gBAClB,sBAAsB;gBACtB,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,MAAM,EAAE,QAAQ,EAAE,SAAS,EAAE;gBAChE,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,aAAa,EAAE,QAAQ,EAAE,QAAQ,EAAE;gBACtE,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,YAAY,EAAE,QAAQ,EAAE,UAAU,EAAE;gBACvE,gCAAgC;gBAChC,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,MAAM,EAAE,QAAQ,EAAE,SAAS,EAAE;gBAChE,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,EAAE,aAAa,EAAE,QAAQ,EAAE,QAAQ,EAAE;aACvE,CAAC;YAEF,+BAA+B;YAC/B,MAAM,SAAS,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,EAAE,IAAI,EAAE,gBAAgB,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;YACvF,MAAM,SAAS,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,SAAS,EAAE,CAAC,CAAC;YAC/D,MAAM,WAAW,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,SAAS,EAAE,CAAC,CAAC;YAEjE,wBAAwB;YACxB,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;YACjF,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC;YAClE,MAAM,WAAW,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAE/D,yBAAyB;YACzB,MAAM,OAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,EAAE,IAAI,EAAE,WAAW,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;YAChF,MAAM,WAAW,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAE/D,QAAQ;iBACL,mBAAmB,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC,gBAAgB;iBAC7D,mBAAmB,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC,SAAS;iBACtD,mBAAmB,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC,CAAC,UAAU;YAE3D,MAAM,MAAM,GAAG,MAAM,uBAAa,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAE5D,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,kBAAkB,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACpD,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,iBAAiB,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YAC/C,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;YACnD,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YAC7D,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC,CAAC,CAAC,oBAAoB,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACvE,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClE,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AAEL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\services\\RatingService.test.ts"],"sourcesContent":["// src/services/RatingService.test.ts\r\n\r\n// --- 1. MOCKING DEPENDÊNCIAS (ANTES DAS IMPORTAÇÕES) ---\r\n\r\n// Mock do Supabase\r\nconst mockFrom = jest.fn();\r\n\r\njest.mock('../lib/supabaseClient', () => ({\r\n  supabase: {\r\n    from: mockFrom,\r\n  }\r\n}));\r\n\r\n// --- 2. IMPORTAÇÕES (DEPOIS DOS MOCKS) ---\r\n\r\nimport { supabase } from '../lib/supabaseClient';\r\nimport RatingService, { RatingType } from './RatingService';\r\n\r\n// --- 3. CONFIGURAÇÃO DOS TESTES ---\r\n\r\ndescribe('RatingService', () => {\r\n\r\n  // Espiões para métodos estáticos chamados internamente\r\n  let spyUpdateRating: jest.SpiedFunction<typeof RatingService.updateRating>;\r\n  let spyUpdateFlag: jest.SpiedFunction<typeof RatingService.updateParticipationEvaluationFlag>;\r\n\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n\r\n    // Mockamos as implementações dos métodos internos para isolar os testes\r\n    spyUpdateRating = jest.spyOn(RatingService, 'updateRating')\r\n      .mockResolvedValue({ success: true });\r\n      \r\n    spyUpdateFlag = jest.spyOn(RatingService, 'updateParticipationEvaluationFlag')\r\n      .mockResolvedValue(undefined);\r\n  });\r\n\r\n  afterEach(() => {\r\n    // Restauramos os espiões\r\n    spyUpdateRating.mockRestore();\r\n    spyUpdateFlag.mockRestore();\r\n  });\r\n\r\n  // --- 4. TESTES DOS MÉTODOS ---\r\n\r\n  describe('createRating', () => {\r\n    const params = {\r\n      eventId: 1,\r\n      raterId: 'user-rater',\r\n      ratedId: 'user-rated',\r\n      ratingType: 'host' as RatingType,\r\n      score: 5,\r\n    };\r\n    \r\n    it('deve criar uma nova avaliação se ela não existir', async () => {\r\n      const mockRating = { id: 'rating-123', ...params };\r\n\r\n      // Mock 1: SELECT (checkError) - não encontra (PGRST116)\r\n      const mockSingle1 = jest.fn().mockResolvedValue({ \r\n        data: null, \r\n        error: { code: 'PGRST116' } \r\n      });\r\n      const mockEq4 = jest.fn().mockReturnValue({ single: mockSingle1 });\r\n      const mockEq3 = jest.fn().mockReturnValue({ eq: mockEq4 });\r\n      const mockEq2 = jest.fn().mockReturnValue({ eq: mockEq3 });\r\n      const mockEq1 = jest.fn().mockReturnValue({ eq: mockEq2 });\r\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq1 });\r\n\r\n      // Mock 2: INSERT\r\n      const mockSingle2 = jest.fn().mockResolvedValue({ data: mockRating, error: null });\r\n      const mockSelectInsert = jest.fn().mockReturnValue({ single: mockSingle2 });\r\n      const mockInsert = jest.fn().mockReturnValue({ select: mockSelectInsert });\r\n\r\n      mockFrom\r\n        .mockReturnValueOnce({ select: mockSelect }) // primeira chamada: check\r\n        .mockReturnValueOnce({ insert: mockInsert }); // segunda chamada: insert\r\n\r\n      const result = await RatingService.createRating(params);\r\n\r\n      expect(result.success).toBe(true);\r\n      expect(result.data).toEqual(mockRating);\r\n      expect(mockInsert).toHaveBeenCalled();\r\n      \r\n      // Verifica se chamou o método interno para atualizar o status do participante\r\n      expect(spyUpdateFlag).toHaveBeenCalledWith(params.eventId, params.raterId);\r\n      \r\n      // Garante que NÃO chamou o updateRating\r\n      expect(spyUpdateRating).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it('deve chamar updateRating se a avaliação já existir', async () => {\r\n      const existingRating = { id: 'rating-existing' };\r\n\r\n      // Mock SELECT (checkError) - ENCONTRA\r\n      const mockSingle = jest.fn().mockResolvedValue({ \r\n        data: existingRating, \r\n        error: null \r\n      });\r\n      const mockEq4 = jest.fn().mockReturnValue({ single: mockSingle });\r\n      const mockEq3 = jest.fn().mockReturnValue({ eq: mockEq4 });\r\n      const mockEq2 = jest.fn().mockReturnValue({ eq: mockEq3 });\r\n      const mockEq1 = jest.fn().mockReturnValue({ eq: mockEq2 });\r\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq1 });\r\n\r\n      mockFrom.mockReturnValue({ select: mockSelect });\r\n\r\n      await RatingService.createRating(params);\r\n\r\n      // Garante que chamou o spy de updateRating\r\n      expect(spyUpdateRating).toHaveBeenCalledWith(existingRating.id, params.score);\r\n      \r\n      // Garante que NÃO chamou insert nem o updateFlag\r\n      expect(spyUpdateFlag).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it('deve falhar se o score for inválido', async () => {\r\n      const result = await RatingService.createRating({ ...params, score: 0 });\r\n      expect(result.success).toBe(false);\r\n      expect(result.error).toBe('Score deve estar entre 1 e 5');\r\n    });\r\n  });\r\n\r\n  describe('updateRating', () => {\r\n    it('deve chamar supabase.update com o novo score', async () => {\r\n      // Libera o spy para testar a implementação real\r\n      spyUpdateRating.mockRestore();\r\n      const mockRating = { id: 'rating-123', score: 5 };\r\n\r\n      // Mock do UPDATE\r\n      const mockSingle = jest.fn().mockResolvedValue({ data: mockRating, error: null });\r\n      const mockSelect = jest.fn().mockReturnValue({ single: mockSingle });\r\n      const mockEq = jest.fn().mockReturnValue({ select: mockSelect });\r\n      const mockUpdate = jest.fn().mockReturnValue({ eq: mockEq });\r\n\r\n      mockFrom.mockReturnValue({\r\n        update: mockUpdate,\r\n      });\r\n      \r\n      const result = await RatingService.updateRating('rating-123', 5);\r\n\r\n      expect(result.success).toBe(true);\r\n      expect(result.data).toEqual(mockRating);\r\n      expect(mockUpdate).toHaveBeenCalledWith(\r\n        expect.objectContaining({ score: 5 })\r\n      );\r\n    });\r\n  });\r\n\r\n  describe('getUserRatings', () => {\r\n    it('deve calcular a média e o total de avaliações', async () => {\r\n      const mockRatings = [\r\n        { rated_id: 'user-1', rating_type: 'host', score: 5 },\r\n        { rated_id: 'user-1', rating_type: 'participant', score: 4 },\r\n        { rated_id: 'user-1', rating_type: 'participant', score: 3 },\r\n      ];\r\n      \r\n      // Mock do SELECT\r\n      const mockEq = jest.fn().mockResolvedValue({ data: mockRatings, error: null });\r\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });\r\n\r\n      mockFrom.mockReturnValue({\r\n        select: mockSelect,\r\n      });\r\n\r\n      const result = await RatingService.getUserRatings('user-1');\r\n\r\n      expect(result.success).toBe(true);\r\n      expect(result.totalRatings).toBe(3);\r\n      expect(result.averageScore).toBe(4); // (5+4+3) / 3 = 4\r\n      expect(result.hostRatings).toBe(1);\r\n      expect(result.participantRatings).toBe(2);\r\n    });\r\n  });\r\n\r\n  describe('getEventRatingsStatus', () => {\r\n    it('deve identificar avaliações pendentes', async () => {\r\n      const mockParticipants = [\r\n        { user_id: 'user-A', presenca_confirmada: true, profile: { username: 'UserA' } },\r\n        { user_id: 'user-B', presenca_confirmada: true, profile: { username: 'UserB' } },\r\n      ];\r\n      const mockEvent = { creator_id: 'host-id', partner_id: 'resto-id' };\r\n      const mockRatings = [\r\n        // User A avaliou tudo\r\n        { rater_id: 'user-A', rating_type: 'host', rated_id: 'host-id' },\r\n        { rater_id: 'user-A', rating_type: 'participant', rated_id: 'user-B' },\r\n        { rater_id: 'user-A', rating_type: 'restaurant', rated_id: 'resto-id' },\r\n        // User B esqueceu o restaurante\r\n        { rater_id: 'user-B', rating_type: 'host', rated_id: 'host-id' },\r\n        { rater_id: 'user-B', rating_type: 'participant', rated_id: 'user-A' },\r\n      ];\r\n\r\n      // Mock 1: SELECT participantes\r\n      const mockEq1_2 = jest.fn().mockResolvedValue({ data: mockParticipants, error: null });\r\n      const mockEq1_1 = jest.fn().mockReturnValue({ eq: mockEq1_2 });\r\n      const mockSelect1 = jest.fn().mockReturnValue({ eq: mockEq1_1 });\r\n      \r\n      // Mock 2: SELECT evento\r\n      const mockSingle = jest.fn().mockResolvedValue({ data: mockEvent, error: null });\r\n      const mockEq2 = jest.fn().mockReturnValue({ single: mockSingle });\r\n      const mockSelect2 = jest.fn().mockReturnValue({ eq: mockEq2 });\r\n      \r\n      // Mock 3: SELECT ratings\r\n      const mockEq3 = jest.fn().mockResolvedValue({ data: mockRatings, error: null });\r\n      const mockSelect3 = jest.fn().mockReturnValue({ eq: mockEq3 });\r\n\r\n      mockFrom\r\n        .mockReturnValueOnce({ select: mockSelect1 }) // participantes\r\n        .mockReturnValueOnce({ select: mockSelect2 }) // evento\r\n        .mockReturnValueOnce({ select: mockSelect3 }); // ratings\r\n\r\n      const result = await RatingService.getEventRatingsStatus(1);\r\n\r\n      expect(result.success).toBe(true);\r\n      expect(result.data?.allRatingsComplete).toBe(false);\r\n      expect(result.data?.totalParticipants).toBe(2);\r\n      expect(result.data?.pendingRaters).toHaveLength(1);\r\n      expect(result.data?.pendingRaters[0].user_id).toBe('user-B');\r\n      expect(result.data?.pendingRaters[0].evaluated_restaurant).toBe(false);\r\n      expect(result.data?.pendingRaters[0].evaluated_host).toBe(true);\r\n    });\r\n  });\r\n\r\n});"],"version":3}