{"file":"C:\\DEVMix\\App.Mesapra2.com\\src\\services\\NotificationService.ts","mappings":"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","names":[],"sources":["C:\\DEVMix\\App.Mesapra2.com\\src\\services\\NotificationService.ts"],"sourcesContent":["import { supabase } from '@/lib/supabaseClient';\r\n\r\ntype NotificationType =\r\n  | 'participation_request'\r\n  | 'participation_approved'\r\n  | 'participation_rejected'\r\n  | 'event_cancelled'\r\n  | 'event_confirmed'\r\n  | 'event_reminder'\r\n  | 'crusher_invite'\r\n  | 'new_event_matching_hashtag'\r\n  // Adicionando os tipos em Portugu√™s que o banco de dados espera\r\n  | 'Candidatura Recebida'\r\n  | 'Candidatura Aprovada'\r\n  | 'Candidatura Rejeitada'\r\n  | 'Novo Evento'\r\n  | 'Convite Crusher';\r\n\r\ninterface Notification {\r\n  id?: number;\r\n  user_id: string;\r\n  event_id?: number;\r\n  notification_type: NotificationType |string;\r\n  sent?: boolean;\r\n  created_at?: string;\r\n  title?: string;\r\n  message?: string;\r\n  participation_id?: string;\r\n}\r\n\r\ninterface ServiceResult {\r\n  success: boolean;\r\n  error?: string;\r\n  data?: any;\r\n}\r\n\r\nclass NotificationService {\r\n  \r\n  /**\r\n   * Cria uma notifica√ß√£o para O PR√ìPRIO USU√ÅRIO LOGADO.\r\n   * (Ex: O participante notifica o criador)\r\n   * Esta fun√ß√£o USA RLS.\r\n   */\r\n  static async create(notification: Omit<Notification, 'id' | 'created_at' | 'sent'>): Promise<ServiceResult> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('notifications')\r\n        .insert({\r\n          ...notification,\r\n          sent: false,\r\n          created_at: new Date().toISOString(),\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      console.log('‚úÖ Notifica√ß√£o criada (via create):', data);\r\n      return { success: true, data };\r\n    } catch (error: any) {\r\n      console.error('‚ùå Erro ao criar notifica√ß√£o (via create):', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cria uma notifica√ß√£o para QUALQUER USU√ÅRIO.\r\n   * (Ex: O criador notifica o participante)\r\n   * Esta fun√ß√£o usa RPC e IGNORA RLS.\r\n   */\r\n  static async createForUser(params: {\r\n    target_user_id: string;\r\n    target_event_id: number;\r\n    notification_type: NotificationType |string;\r\n    title: string;\r\n    message: string;\r\n    target_participation_id?: string;\r\n  }): Promise<ServiceResult> {\r\n    try {\r\n      // Ajuste para lidar com participation_id nulo\r\n      const rpcParams = {\r\n        ...params,\r\n        target_participation_id: params.target_participation_id || null, \r\n      };\r\n      \r\n      const { error } = await supabase.rpc('create_notification_for_user', rpcParams);\r\n\r\n      if (error) throw error;\r\n\r\n      console.log(`‚úÖ Notifica√ß√£o RPC criada para ${params.target_user_id}`);\r\n      return { success: true };\r\n    } catch (error: any) {\r\n      console.error('‚ùå Erro ao criar notifica√ß√£o (via RPC):', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n\r\n  static async notifyNewParticipation(\r\n    creatorId: string,\r\n    eventId: number,\r\n    participationId: string,\r\n    participantName: string,\r\n    eventTitle: string\r\n  ): Promise<ServiceResult> {\r\n    // ‚ú® CORRE√á√ÉO: Usar RPC para notificar o criador\r\n    return this.createForUser({\r\n      target_user_id: creatorId,\r\n      target_event_id: eventId,\r\n      notification_type: 'Candidatura Recebida',\r\n      title: 'üéâ Nova Candidatura!',\r\n      message: `${participantName} se candidatou ao seu evento \"${eventTitle}\"`,\r\n      target_participation_id: participationId,\r\n    });\r\n  }\r\n\r\n  static async notifyParticipationApproved(\r\n    userId: string,\r\n    eventId: number,\r\n    eventTitle: string\r\n  ): Promise<ServiceResult> {\r\n    // ‚ú® CORRE√á√ÉO: Usar RPC para notificar o participante\r\n    return this.createForUser({\r\n      target_user_id: userId,\r\n      target_event_id: eventId,\r\n      notification_type: 'Candidatura Aprovada',\r\n      title: '‚úÖ Voc√™ foi aprovado!',\r\n      message: `Sua candidatura para \"${eventTitle}\" foi aprovada!`,\r\n    });\r\n  }\r\n\r\n  static async notifyParticipationRejected(\r\n    userId: string,\r\n    eventId: number,\r\n    eventTitle: string,\r\n    reason?: string\r\n  ): Promise<ServiceResult> {\r\n    // ‚ú® CORRE√á√ÉO: Usar RPC para notificar o participante\r\n    return this.createForUser({\r\n      target_user_id: userId,\r\n      target_event_id: eventId,\r\n      notification_type: 'Candidatura Rejeitada',\r\n      title: '‚ùå Candidatura n√£o aprovada',\r\n      message: `Sua candidatura para \"${eventTitle}\" n√£o foi aprovada${reason ? `: ${reason}` : '.'}`,\r\n    });\r\n  }\r\n\r\n  static async notifyCrusherInvite(\r\n    userId: string,\r\n    eventId: number,\r\n    inviterName: string,\r\n    eventTitle: string\r\n  ): Promise<ServiceResult> {\r\n    // ‚ú® CORRE√á√ÉO: Usar RPC para notificar o convidado\r\n    return this.createForUser({\r\n      target_user_id: userId,\r\n      target_event_id: eventId,\r\n      notification_type: 'convite_crusher',\r\n      title: 'üíò Convite Crusher Especial',\r\n      message: `${inviterName} te convidou para um evento exclusivo: \"${eventTitle}\"`,\r\n    });\r\n  }\r\n\r\n  // (O resto do arquivo permanece o mesmo)\r\n  \r\n  static async notifyUsersWithMatchingHashtags(\r\n    eventId: number,\r\n    eventData: {\r\n      creator_id: string;\r\n      title: string;\r\n      hashtags: string[];\r\n      event_type: string;\r\n    }\r\n  ): Promise<ServiceResult> {\r\n    try {\r\n      console.log('üîî Iniciando notifica√ß√£o por hashtags para evento:', eventId);\r\n      \r\n      const { data: profiles, error: profileError } = await supabase\r\n        .from('profiles')\r\n        .select('id, username, hashtags')\r\n        .not('hashtags', 'is', null)\r\n        .neq('id', eventData.creator_id); \r\n\r\n      if (profileError) {\r\n        console.error('‚ùå Erro ao buscar perfis:', profileError);\r\n        throw profileError;\r\n      }\r\n\r\n      if (!profiles || profiles.length === 0) {\r\n        console.log('‚ö†Ô∏è Nenhum usu√°rio com hashtags encontrado');\r\n        return { success: true, data: { notified: 0, users: [] } };\r\n      }\r\n\r\n      const eventHashtags = Array.isArray(eventData.hashtags) \r\n        ? eventData.hashtags.map(h => h.toLowerCase().trim())\r\n        : [];\r\n\r\n      console.log('üè∑Ô∏è Hashtags do evento:', eventHashtags);\r\n\r\n      const usersToNotify = profiles.filter(profile => {\r\n        if (!profile.hashtags || !Array.isArray(profile.hashtags)) return false;\r\n        \r\n        const userHashtags = profile.hashtags.map((h: string) => h.toLowerCase().trim());\r\n        const matchingTags = eventHashtags.filter(eventTag => \r\n          userHashtags.includes(eventTag)\r\n        );\r\n        \r\n        return matchingTags.length > 0;\r\n      });\r\n\r\n      console.log(`‚úÖ ${usersToNotify.length} usu√°rios para notificar`);\r\n\r\n      if (usersToNotify.length === 0) {\r\n        return { success: true, data: { notified: 0, users: [] } };\r\n      }\r\n\r\n      const notifications = usersToNotify.map(user => {\r\n        const userHashtags = user.hashtags.map((h: string) => h.toLowerCase().trim());\r\n        const matchingTags = eventHashtags.filter(tag => userHashtags.includes(tag));\r\n        \r\n        return {\r\n          user_id: user.id, \r\n          event_id: eventId,\r\n          notification_type: 'Novo Evento' as NotificationType,\r\n          title: 'üéØ Novo Evento com suas Hashtags!',\r\n          message: `\"${eventData.title}\" foi criado com hashtags que voc√™ segue: ${matchingTags.map(t => `#${t}`).join(', ')}`,\r\n          sent: false,\r\n          created_at: new Date().toISOString()\r\n        };\r\n      });\r\n\r\n      // ‚ú® CORRE√á√ÉO: Usar RPC para inserir em lote (mais complexo)\r\n      // Por simplicidade, vamos usar o .insert() que j√° estava aqui,\r\n      // pois esta fun√ß√£o √© chamada de um local seguro (backend/trigger)\r\n      // ONDE AS REGRAS DE RLS S√ÉO IGNORADAS.\r\n      // Se for chamada do CLIENTE, isso VAI FALHAR.\r\n      // Assumindo que √© chamada de um local seguro:\r\n      const { error: insertError } = await supabase\r\n        .from('notifications')\r\n        .insert(notifications);\r\n\r\n      if (insertError) {\r\n        console.error('‚ùå Erro ao inserir notifica√ß√µes:', insertError);\r\n        throw insertError;\r\n      }\r\n\r\n      console.log(`‚úÖ ${notifications.length} notifica√ß√µes criadas com sucesso`);\r\n\r\n      return { \r\n        success: true, \r\n        data: {\r\n          notified: notifications.length,\r\n          users: usersToNotify.map(u => u.username || u.id)\r\n        }\r\n      };\r\n\r\n    } catch (error: any) {\r\n      console.error('‚ùå Erro ao notificar usu√°rios por hashtag:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n\r\n  static getMatchingHashtags(\r\n    userHashtags: string[],\r\n    eventHashtags: string[]\r\n  ): string[] {\r\n    if (!Array.isArray(userHashtags) || !Array.isArray(eventHashtags)) {\r\n      return [];\r\n    }\r\n\r\n    const userTags = userHashtags.map(h => h.toLowerCase().trim());\r\n    const eventTags = eventHashtags.map(h => h.toLowerCase().trim());\r\n\r\n    return eventTags.filter(tag => userTags.includes(tag));\r\n  }\r\n\r\n  static async hasUnreadEventNotifications(userId: string): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('notifications')\r\n        .select('id')\r\n        .eq('user_id', userId)\r\n        .eq('sent', false)\r\n        .eq('notification_type', 'Novo Evento')\r\n        .limit(1);\r\n\r\n      if (error) throw error;\r\n      return data && data.length > 0;\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao verificar notifica√ß√µes:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  static async getUserNotifications(userId: string, unreadOnly: boolean = false): Promise<ServiceResult> {\r\n    try {\r\n      let query = supabase\r\n        .from('notifications')\r\n        .select('*')\r\n        .eq('user_id', userId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(50);\r\n\r\n      const { data, error } = await query;\r\n\r\n      if (error) throw error;\r\n\r\n      return { success: true, data };\r\n    } catch (error: any) {\r\n      console.error('‚ùå Erro ao buscar notifica√ß√µes:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n\r\n  static async markAsRead(notificationId: number): Promise<ServiceResult> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('notifications')\r\n        .update({ sent: true })\r\n        .eq('id', notificationId);\r\n\r\n      if (error) throw error;\r\n\r\n      return { success: true };\r\n    } catch (error: any) {\r\n      console.error('‚ùå Erro ao marcar como lida:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n\r\n  static async markAllAsRead(userId: string): Promise<ServiceResult> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('notifications')\r\n        .update({ sent: true })\r\n        .eq('user_id', userId)\r\n        .eq('sent', false);\r\n\r\n      if (error) throw error;\r\n\r\n      return { success: true };\r\n    } catch (error: any) {\r\n      console.error('‚ùå Erro ao marcar todas como lidas:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n\r\n  static async getUnreadCount(userId: string): Promise<number> {\r\n    try {\r\n      const { count, error } = await supabase\r\n        .from('notifications')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('user_id', userId)\r\n        .eq('sent', false);\r\n\r\n      if (error) throw error;\r\n\r\n      return count || 0;\r\n    } catch (error) {\r\n      console.error('‚ùå Erro ao contar n√£o lidas:', error);\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  static async delete(notificationId: number): Promise<ServiceResult> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('notifications')\r\n        .delete()\r\n        .eq('id', notificationId);\r\n\r\n      if (error) throw error;\r\n\r\n      return { success: true };\r\n    } catch (error: any) {\r\n      console.error('‚ùå Erro ao deletar notifica√ß√£o:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n}\r\n\r\nexport default NotificationService;"],"version":3}