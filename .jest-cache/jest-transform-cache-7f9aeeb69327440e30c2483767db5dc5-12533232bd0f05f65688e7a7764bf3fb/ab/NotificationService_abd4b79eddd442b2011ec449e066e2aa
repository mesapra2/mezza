649e092771ec8c98b39828df82a74360
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const supabaseClient_1 = require("@/lib/supabaseClient");
class NotificationService {
    /**
     * Cria uma notifica√ß√£o para O PR√ìPRIO USU√ÅRIO LOGADO.
     * (Ex: O participante notifica o criador)
     * Esta fun√ß√£o USA RLS.
     */
    static async create(notification) {
        try {
            const { data, error } = await supabaseClient_1.supabase
                .from('notifications')
                .insert({
                ...notification,
                sent: false,
                created_at: new Date().toISOString(),
            })
                .select()
                .single();
            if (error)
                throw error;
            console.log('‚úÖ Notifica√ß√£o criada (via create):', data);
            return { success: true, data };
        }
        catch (error) {
            console.error('‚ùå Erro ao criar notifica√ß√£o (via create):', error);
            return { success: false, error: error.message };
        }
    }
    /**
     * Cria uma notifica√ß√£o para QUALQUER USU√ÅRIO.
     * (Ex: O criador notifica o participante)
     * Esta fun√ß√£o usa RPC e IGNORA RLS.
     */
    static async createForUser(params) {
        try {
            // Ajuste para lidar com participation_id nulo
            const rpcParams = {
                ...params,
                target_participation_id: params.target_participation_id || null,
            };
            const { error } = await supabaseClient_1.supabase.rpc('create_notification_for_user', rpcParams);
            if (error)
                throw error;
            console.log(`‚úÖ Notifica√ß√£o RPC criada para ${params.target_user_id}`);
            return { success: true };
        }
        catch (error) {
            console.error('‚ùå Erro ao criar notifica√ß√£o (via RPC):', error);
            return { success: false, error: error.message };
        }
    }
    static async notifyNewParticipation(creatorId, eventId, participationId, participantName, eventTitle) {
        // ‚ú® CORRE√á√ÉO: Usar RPC para notificar o criador
        return this.createForUser({
            target_user_id: creatorId,
            target_event_id: eventId,
            notification_type: 'Candidatura Recebida',
            title: 'üéâ Nova Candidatura!',
            message: `${participantName} se candidatou ao seu evento "${eventTitle}"`,
            target_participation_id: participationId,
        });
    }
    static async notifyParticipationApproved(userId, eventId, eventTitle) {
        // ‚ú® CORRE√á√ÉO: Usar RPC para notificar o participante
        return this.createForUser({
            target_user_id: userId,
            target_event_id: eventId,
            notification_type: 'Candidatura Aprovada',
            title: '‚úÖ Voc√™ foi aprovado!',
            message: `Sua candidatura para "${eventTitle}" foi aprovada!`,
        });
    }
    static async notifyParticipationRejected(userId, eventId, eventTitle, reason) {
        // ‚ú® CORRE√á√ÉO: Usar RPC para notificar o participante
        return this.createForUser({
            target_user_id: userId,
            target_event_id: eventId,
            notification_type: 'Candidatura Rejeitada',
            title: '‚ùå Candidatura n√£o aprovada',
            message: `Sua candidatura para "${eventTitle}" n√£o foi aprovada${reason ? `: ${reason}` : '.'}`,
        });
    }
    static async notifyCrusherInvite(userId, eventId, inviterName, eventTitle) {
        // ‚ú® CORRE√á√ÉO: Usar RPC para notificar o convidado
        return this.createForUser({
            target_user_id: userId,
            target_event_id: eventId,
            notification_type: 'convite_crusher',
            title: 'üíò Convite Crusher Especial',
            message: `${inviterName} te convidou para um evento exclusivo: "${eventTitle}"`,
        });
    }
    // (O resto do arquivo permanece o mesmo)
    static async notifyUsersWithMatchingHashtags(eventId, eventData) {
        try {
            console.log('üîî Iniciando notifica√ß√£o por hashtags para evento:', eventId);
            const { data: profiles, error: profileError } = await supabaseClient_1.supabase
                .from('profiles')
                .select('id, username, hashtags')
                .not('hashtags', 'is', null)
                .neq('id', eventData.creator_id);
            if (profileError) {
                console.error('‚ùå Erro ao buscar perfis:', profileError);
                throw profileError;
            }
            if (!profiles || profiles.length === 0) {
                console.log('‚ö†Ô∏è Nenhum usu√°rio com hashtags encontrado');
                return { success: true, data: { notified: 0, users: [] } };
            }
            const eventHashtags = Array.isArray(eventData.hashtags)
                ? eventData.hashtags.map(h => h.toLowerCase().trim())
                : [];
            console.log('üè∑Ô∏è Hashtags do evento:', eventHashtags);
            const usersToNotify = profiles.filter(profile => {
                if (!profile.hashtags || !Array.isArray(profile.hashtags))
                    return false;
                const userHashtags = profile.hashtags.map((h) => h.toLowerCase().trim());
                const matchingTags = eventHashtags.filter(eventTag => userHashtags.includes(eventTag));
                return matchingTags.length > 0;
            });
            console.log(`‚úÖ ${usersToNotify.length} usu√°rios para notificar`);
            if (usersToNotify.length === 0) {
                return { success: true, data: { notified: 0, users: [] } };
            }
            const notifications = usersToNotify.map(user => {
                const userHashtags = user.hashtags.map((h) => h.toLowerCase().trim());
                const matchingTags = eventHashtags.filter(tag => userHashtags.includes(tag));
                return {
                    user_id: user.id,
                    event_id: eventId,
                    notification_type: 'Novo Evento',
                    title: 'üéØ Novo Evento com suas Hashtags!',
                    message: `"${eventData.title}" foi criado com hashtags que voc√™ segue: ${matchingTags.map(t => `#${t}`).join(', ')}`,
                    sent: false,
                    created_at: new Date().toISOString()
                };
            });
            // ‚ú® CORRE√á√ÉO: Usar RPC para inserir em lote (mais complexo)
            // Por simplicidade, vamos usar o .insert() que j√° estava aqui,
            // pois esta fun√ß√£o √© chamada de um local seguro (backend/trigger)
            // ONDE AS REGRAS DE RLS S√ÉO IGNORADAS.
            // Se for chamada do CLIENTE, isso VAI FALHAR.
            // Assumindo que √© chamada de um local seguro:
            const { error: insertError } = await supabaseClient_1.supabase
                .from('notifications')
                .insert(notifications);
            if (insertError) {
                console.error('‚ùå Erro ao inserir notifica√ß√µes:', insertError);
                throw insertError;
            }
            console.log(`‚úÖ ${notifications.length} notifica√ß√µes criadas com sucesso`);
            return {
                success: true,
                data: {
                    notified: notifications.length,
                    users: usersToNotify.map(u => u.username || u.id)
                }
            };
        }
        catch (error) {
            console.error('‚ùå Erro ao notificar usu√°rios por hashtag:', error);
            return { success: false, error: error.message };
        }
    }
    static getMatchingHashtags(userHashtags, eventHashtags) {
        if (!Array.isArray(userHashtags) || !Array.isArray(eventHashtags)) {
            return [];
        }
        const userTags = userHashtags.map(h => h.toLowerCase().trim());
        const eventTags = eventHashtags.map(h => h.toLowerCase().trim());
        return eventTags.filter(tag => userTags.includes(tag));
    }
    static async hasUnreadEventNotifications(userId) {
        try {
            const { data, error } = await supabaseClient_1.supabase
                .from('notifications')
                .select('id')
                .eq('user_id', userId)
                .eq('sent', false)
                .eq('notification_type', 'Novo Evento')
                .limit(1);
            if (error)
                throw error;
            return data && data.length > 0;
        }
        catch (error) {
            console.error('‚ùå Erro ao verificar notifica√ß√µes:', error);
            return false;
        }
    }
    static async getUserNotifications(userId, unreadOnly = false) {
        try {
            let query = supabaseClient_1.supabase
                .from('notifications')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(50);
            const { data, error } = await query;
            if (error)
                throw error;
            return { success: true, data };
        }
        catch (error) {
            console.error('‚ùå Erro ao buscar notifica√ß√µes:', error);
            return { success: false, error: error.message };
        }
    }
    static async markAsRead(notificationId) {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('notifications')
                .update({ sent: true })
                .eq('id', notificationId);
            if (error)
                throw error;
            return { success: true };
        }
        catch (error) {
            console.error('‚ùå Erro ao marcar como lida:', error);
            return { success: false, error: error.message };
        }
    }
    static async markAllAsRead(userId) {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('notifications')
                .update({ sent: true })
                .eq('user_id', userId)
                .eq('sent', false);
            if (error)
                throw error;
            return { success: true };
        }
        catch (error) {
            console.error('‚ùå Erro ao marcar todas como lidas:', error);
            return { success: false, error: error.message };
        }
    }
    static async getUnreadCount(userId) {
        try {
            const { count, error } = await supabaseClient_1.supabase
                .from('notifications')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', userId)
                .eq('sent', false);
            if (error)
                throw error;
            return count || 0;
        }
        catch (error) {
            console.error('‚ùå Erro ao contar n√£o lidas:', error);
            return 0;
        }
    }
    static async delete(notificationId) {
        try {
            const { error } = await supabaseClient_1.supabase
                .from('notifications')
                .delete()
                .eq('id', notificationId);
            if (error)
                throw error;
            return { success: true };
        }
        catch (error) {
            console.error('‚ùå Erro ao deletar notifica√ß√£o:', error);
            return { success: false, error: error.message };
        }
    }
}
exports.default = NotificationService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXERFVk1peFxcQXBwLk1lc2FwcmEyLmNvbVxcc3JjXFxzZXJ2aWNlc1xcTm90aWZpY2F0aW9uU2VydmljZS50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHlEQUFnRDtBQW9DaEQsTUFBTSxtQkFBbUI7SUFFdkI7Ozs7T0FJRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFlBQThEO1FBQ2hGLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSx5QkFBUTtpQkFDbkMsSUFBSSxDQUFDLGVBQWUsQ0FBQztpQkFDckIsTUFBTSxDQUFDO2dCQUNOLEdBQUcsWUFBWTtnQkFDZixJQUFJLEVBQUUsS0FBSztnQkFDWCxVQUFVLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7YUFDckMsQ0FBQztpQkFDRCxNQUFNLEVBQUU7aUJBQ1IsTUFBTSxFQUFFLENBQUM7WUFFWixJQUFJLEtBQUs7Z0JBQUUsTUFBTSxLQUFLLENBQUM7WUFFdkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN4RCxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUNqQyxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLDJDQUEyQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2xFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbEQsQ0FBQztJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsTUFPMUI7UUFDQyxJQUFJLENBQUM7WUFDSCw4Q0FBOEM7WUFDOUMsTUFBTSxTQUFTLEdBQUc7Z0JBQ2hCLEdBQUcsTUFBTTtnQkFDVCx1QkFBdUIsRUFBRSxNQUFNLENBQUMsdUJBQXVCLElBQUks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QUVELGtCQUFlLG1CQUFtQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxERVZNaXhcXEFwcC5NZXNhcHJhMi5jb21cXHNyY1xcc2VydmljZXNcXE5vdGlmaWNhdGlvblNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tICdAL2xpYi9zdXBhYmFzZUNsaWVudCc7XHJcblxyXG50eXBlIE5vdGlmaWNhdGlvblR5cGUgPVxyXG4gIHwgJ3BhcnRpY2lwYXRpb25fcmVxdWVzdCdcclxuICB8ICdwYXJ0aWNpcGF0aW9uX2FwcHJvdmVkJ1xyXG4gIHwgJ3BhcnRpY2lwYXRpb25fcmVqZWN0ZWQnXHJcbiAgfCAnZXZlbnRfY2FuY2VsbGVkJ1xyXG4gIHwgJ2V2ZW50X2NvbmZpcm1lZCdcclxuICB8ICdldmVudF9yZW1pbmRlcidcclxuICB8ICdjcnVzaGVyX2ludml0ZSdcclxuICB8ICduZXdfZXZlbnRfbWF0Y2hpbmdfaGFzaHRhZydcclxuICAvLyBBZGljaW9uYW5kbyBvcyB0aXBvcyBlbSBQb3J0dWd1w6pzIHF1ZSBvIGJhbmNvIGRlIGRhZG9zIGVzcGVyYVxyXG4gIHwgJ0NhbmRpZGF0dXJhIFJlY2ViaWRhJ1xyXG4gIHwgJ0NhbmRpZGF0dXJhIEFwcm92YWRhJ1xyXG4gIHwgJ0NhbmRpZGF0dXJhIFJlamVpdGFkYSdcclxuICB8ICdOb3ZvIEV2ZW50bydcclxuICB8ICdDb252aXRlIENydXNoZXInO1xyXG5cclxuaW50ZXJmYWNlIE5vdGlmaWNhdGlvbiB7XHJcbiAgaWQ/OiBudW1iZXI7XHJcbiAgdXNlcl9pZDogc3RyaW5nO1xyXG4gIGV2ZW50X2lkPzogbnVtYmVyO1xyXG4gIG5vdGlmaWNhdGlvbl90eXBlOiBOb3RpZmljYXRpb25UeXBlIHxzdHJpbmc7XHJcbiAgc2VudD86IGJvb2xlYW47XHJcbiAgY3JlYXRlZF9hdD86IHN0cmluZztcclxuICB0aXRsZT86IHN0cmluZztcclxuICBtZXNzYWdlPzogc3RyaW5nO1xyXG4gIHBhcnRpY2lwYXRpb25faWQ/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBTZXJ2aWNlUmVzdWx0IHtcclxuICBzdWNjZXNzOiBib29sZWFuO1xyXG4gIGVycm9yPzogc3RyaW5nO1xyXG4gIGRhdGE/OiBhbnk7XHJcbn1cclxuXHJcbmNsYXNzIE5vdGlmaWNhdGlvblNlcnZpY2Uge1xyXG4gIFxyXG4gIC8qKlxyXG4gICAqIENyaWEgdW1hIG5vdGlmaWNhw6fDo28gcGFyYSBPIFBSw5NQUklPIFVTVcOBUklPIExPR0FETy5cclxuICAgKiAoRXg6IE8gcGFydGljaXBhbnRlIG5vdGlmaWNhIG8gY3JpYWRvcilcclxuICAgKiBFc3RhIGZ1bsOnw6NvIFVTQSBSTFMuXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIGNyZWF0ZShub3RpZmljYXRpb246IE9taXQ8Tm90aWZpY2F0aW9uLCAnaWQnIHwgJ2NyZWF0ZWRfYXQnIHwgJ3NlbnQnPik6IFByb21pc2U8U2VydmljZVJlc3VsdD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnbm90aWZpY2F0aW9ucycpXHJcbiAgICAgICAgLmluc2VydCh7XHJcbiAgICAgICAgICAuLi5ub3RpZmljYXRpb24sXHJcbiAgICAgICAgICBzZW50OiBmYWxzZSxcclxuICAgICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5zZWxlY3QoKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZygn4pyFIE5vdGlmaWNhw6fDo28gY3JpYWRhICh2aWEgY3JlYXRlKTonLCBkYXRhKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgZGF0YSB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBjcmlhciBub3RpZmljYcOnw6NvICh2aWEgY3JlYXRlKTonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JpYSB1bWEgbm90aWZpY2HDp8OjbyBwYXJhIFFVQUxRVUVSIFVTVcOBUklPLlxyXG4gICAqIChFeDogTyBjcmlhZG9yIG5vdGlmaWNhIG8gcGFydGljaXBhbnRlKVxyXG4gICAqIEVzdGEgZnVuw6fDo28gdXNhIFJQQyBlIElHTk9SQSBSTFMuXHJcbiAgICovXHJcbiAgc3RhdGljIGFzeW5jIGNyZWF0ZUZvclVzZXIocGFyYW1zOiB7XHJcbiAgICB0YXJnZXRfdXNlcl9pZDogc3RyaW5nO1xyXG4gICAgdGFyZ2V0X2V2ZW50X2lkOiBudW1iZXI7XHJcbiAgICBub3RpZmljYXRpb25fdHlwZTogTm90aWZpY2F0aW9uVHlwZSB8c3RyaW5nO1xyXG4gICAgdGl0bGU6IHN0cmluZztcclxuICAgIG1lc3NhZ2U6IHN0cmluZztcclxuICAgIHRhcmdldF9wYXJ0aWNpcGF0aW9uX2lkPzogc3RyaW5nO1xyXG4gIH0pOiBQcm9taXNlPFNlcnZpY2VSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIEFqdXN0ZSBwYXJhIGxpZGFyIGNvbSBwYXJ0aWNpcGF0aW9uX2lkIG51bG9cclxuICAgICAgY29uc3QgcnBjUGFyYW1zID0ge1xyXG4gICAgICAgIC4uLnBhcmFtcyxcclxuICAgICAgICB0YXJnZXRfcGFydGljaXBhdGlvbl9pZDogcGFyYW1zLnRhcmdldF9wYXJ0aWNpcGF0aW9uX2lkIHx8IG51bGwsIFxyXG4gICAgICB9O1xyXG4gICAgICBcclxuICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UucnBjKCdjcmVhdGVfbm90aWZpY2F0aW9uX2Zvcl91c2VyJywgcnBjUGFyYW1zKTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIE5vdGlmaWNhw6fDo28gUlBDIGNyaWFkYSBwYXJhICR7cGFyYW1zLnRhcmdldF91c2VyX2lkfWApO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGNyaWFyIG5vdGlmaWNhw6fDo28gKHZpYSBSUEMpOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgYXN5bmMgbm90aWZ5TmV3UGFydGljaXBhdGlvbihcclxuICAgIGNyZWF0b3JJZDogc3RyaW5nLFxyXG4gICAgZXZlbnRJZDogbnVtYmVyLFxyXG4gICAgcGFydGljaXBhdGlvbklkOiBzdHJpbmcsXHJcbiAgICBwYXJ0aWNpcGFudE5hbWU6IHN0cmluZyxcclxuICAgIGV2ZW50VGl0bGU6IHN0cmluZ1xyXG4gICk6IFByb21pc2U8U2VydmljZVJlc3VsdD4ge1xyXG4gICAgLy8g4pyoIENPUlJFw4fDg086IFVzYXIgUlBDIHBhcmEgbm90aWZpY2FyIG8gY3JpYWRvclxyXG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlRm9yVXNlcih7XHJcbiAgICAgIHRhcmdldF91c2VyX2lkOiBjcmVhdG9ySWQsXHJcbiAgICAgIHRhcmdldF9ldmVudF9pZDogZXZlbnRJZCxcclxuICAgICAgbm90aWZpY2F0aW9uX3R5cGU6ICdDYW5kaWRhdHVyYSBSZWNlYmlkYScsXHJcbiAgICAgIHRpdGxlOiAn8J+OiSBOb3ZhIENhbmRpZGF0dXJhIScsXHJcbiAgICAgIG1lc3NhZ2U6IGAke3BhcnRpY2lwYW50TmFtZX0gc2UgY2FuZGlkYXRvdSBhbyBzZXUgZXZlbnRvIFwiJHtldmVudFRpdGxlfVwiYCxcclxuICAgICAgdGFyZ2V0X3BhcnRpY2lwYXRpb25faWQ6IHBhcnRpY2lwYXRpb25JZCxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGFzeW5jIG5vdGlmeVBhcnRpY2lwYXRpb25BcHByb3ZlZChcclxuICAgIHVzZXJJZDogc3RyaW5nLFxyXG4gICAgZXZlbnRJZDogbnVtYmVyLFxyXG4gICAgZXZlbnRUaXRsZTogc3RyaW5nXHJcbiAgKTogUHJvbWlzZTxTZXJ2aWNlUmVzdWx0PiB7XHJcbiAgICAvLyDinKggQ09SUkXDh8ODTzogVXNhciBSUEMgcGFyYSBub3RpZmljYXIgbyBwYXJ0aWNpcGFudGVcclxuICAgIHJldHVybiB0aGlzLmNyZWF0ZUZvclVzZXIoe1xyXG4gICAgICB0YXJnZXRfdXNlcl9pZDogdXNlcklkLFxyXG4gICAgICB0YXJnZXRfZXZlbnRfaWQ6IGV2ZW50SWQsXHJcbiAgICAgIG5vdGlmaWNhdGlvbl90eXBlOiAnQ2FuZGlkYXR1cmEgQXByb3ZhZGEnLFxyXG4gICAgICB0aXRsZTogJ+KchSBWb2PDqiBmb2kgYXByb3ZhZG8hJyxcclxuICAgICAgbWVzc2FnZTogYFN1YSBjYW5kaWRhdHVyYSBwYXJhIFwiJHtldmVudFRpdGxlfVwiIGZvaSBhcHJvdmFkYSFgLFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgYXN5bmMgbm90aWZ5UGFydGljaXBhdGlvblJlamVjdGVkKFxyXG4gICAgdXNlcklkOiBzdHJpbmcsXHJcbiAgICBldmVudElkOiBudW1iZXIsXHJcbiAgICBldmVudFRpdGxlOiBzdHJpbmcsXHJcbiAgICByZWFzb24/OiBzdHJpbmdcclxuICApOiBQcm9taXNlPFNlcnZpY2VSZXN1bHQ+IHtcclxuICAgIC8vIOKcqCBDT1JSRcOHw4NPOiBVc2FyIFJQQyBwYXJhIG5vdGlmaWNhciBvIHBhcnRpY2lwYW50ZVxyXG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlRm9yVXNlcih7XHJcbiAgICAgIHRhcmdldF91c2VyX2lkOiB1c2VySWQsXHJcbiAgICAgIHRhcmdldF9ldmVudF9pZDogZXZlbnRJZCxcclxuICAgICAgbm90aWZpY2F0aW9uX3R5cGU6ICdDYW5kaWRhdHVyYSBSZWplaXRhZGEnLFxyXG4gICAgICB0aXRsZTogJ+KdjCBDYW5kaWRhdHVyYSBuw6NvIGFwcm92YWRhJyxcclxuICAgICAgbWVzc2FnZTogYFN1YSBjYW5kaWRhdHVyYSBwYXJhIFwiJHtldmVudFRpdGxlfVwiIG7Do28gZm9pIGFwcm92YWRhJHtyZWFzb24gPyBgOiAke3JlYXNvbn1gIDogJy4nfWAsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBhc3luYyBub3RpZnlDcnVzaGVySW52aXRlKFxyXG4gICAgdXNlcklkOiBzdHJpbmcsXHJcbiAgICBldmVudElkOiBudW1iZXIsXHJcbiAgICBpbnZpdGVyTmFtZTogc3RyaW5nLFxyXG4gICAgZXZlbnRUaXRsZTogc3RyaW5nXHJcbiAgKTogUHJvbWlzZTxTZXJ2aWNlUmVzdWx0PiB7XHJcbiAgICAvLyDinKggQ09SUkXDh8ODTzogVXNhciBSUEMgcGFyYSBub3RpZmljYXIgbyBjb252aWRhZG9cclxuICAgIHJldHVybiB0aGlzLmNyZWF0ZUZvclVzZXIoe1xyXG4gICAgICB0YXJnZXRfdXNlcl9pZDogdXNlcklkLFxyXG4gICAgICB0YXJnZXRfZXZlbnRfaWQ6IGV2ZW50SWQsXHJcbiAgICAgIG5vdGlmaWNhdGlvbl90eXBlOiAnY29udml0ZV9jcnVzaGVyJyxcclxuICAgICAgdGl0bGU6ICfwn5KYIENvbnZpdGUgQ3J1c2hlciBFc3BlY2lhbCcsXHJcbiAgICAgIG1lc3NhZ2U6IGAke2ludml0ZXJOYW1lfSB0ZSBjb252aWRvdSBwYXJhIHVtIGV2ZW50byBleGNsdXNpdm86IFwiJHtldmVudFRpdGxlfVwiYCxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gKE8gcmVzdG8gZG8gYXJxdWl2byBwZXJtYW5lY2UgbyBtZXNtbylcclxuICBcclxuICBzdGF0aWMgYXN5bmMgbm90aWZ5VXNlcnNXaXRoTWF0Y2hpbmdIYXNodGFncyhcclxuICAgIGV2ZW50SWQ6IG51bWJlcixcclxuICAgIGV2ZW50RGF0YToge1xyXG4gICAgICBjcmVhdG9yX2lkOiBzdHJpbmc7XHJcbiAgICAgIHRpdGxlOiBzdHJpbmc7XHJcbiAgICAgIGhhc2h0YWdzOiBzdHJpbmdbXTtcclxuICAgICAgZXZlbnRfdHlwZTogc3RyaW5nO1xyXG4gICAgfVxyXG4gICk6IFByb21pc2U8U2VydmljZVJlc3VsdD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc29sZS5sb2coJ/CflJQgSW5pY2lhbmRvIG5vdGlmaWNhw6fDo28gcG9yIGhhc2h0YWdzIHBhcmEgZXZlbnRvOicsIGV2ZW50SWQpO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgeyBkYXRhOiBwcm9maWxlcywgZXJyb3I6IHByb2ZpbGVFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgncHJvZmlsZXMnKVxyXG4gICAgICAgIC5zZWxlY3QoJ2lkLCB1c2VybmFtZSwgaGFzaHRhZ3MnKVxyXG4gICAgICAgIC5ub3QoJ2hhc2h0YWdzJywgJ2lzJywgbnVsbClcclxuICAgICAgICAubmVxKCdpZCcsIGV2ZW50RGF0YS5jcmVhdG9yX2lkKTsgXHJcblxyXG4gICAgICBpZiAocHJvZmlsZUVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gYnVzY2FyIHBlcmZpczonLCBwcm9maWxlRXJyb3IpO1xyXG4gICAgICAgIHRocm93IHByb2ZpbGVFcnJvcjtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCFwcm9maWxlcyB8fCBwcm9maWxlcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBjb25zb2xlLmxvZygn4pqg77iPIE5lbmh1bSB1c3XDoXJpbyBjb20gaGFzaHRhZ3MgZW5jb250cmFkbycpO1xyXG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHsgbm90aWZpZWQ6IDAsIHVzZXJzOiBbXSB9IH07XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGV2ZW50SGFzaHRhZ3MgPSBBcnJheS5pc0FycmF5KGV2ZW50RGF0YS5oYXNodGFncykgXHJcbiAgICAgICAgPyBldmVudERhdGEuaGFzaHRhZ3MubWFwKGggPT4gaC50b0xvd2VyQ2FzZSgpLnRyaW0oKSlcclxuICAgICAgICA6IFtdO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coJ/Cfj7fvuI8gSGFzaHRhZ3MgZG8gZXZlbnRvOicsIGV2ZW50SGFzaHRhZ3MpO1xyXG5cclxuICAgICAgY29uc3QgdXNlcnNUb05vdGlmeSA9IHByb2ZpbGVzLmZpbHRlcihwcm9maWxlID0+IHtcclxuICAgICAgICBpZiAoIXByb2ZpbGUuaGFzaHRhZ3MgfHwgIUFycmF5LmlzQXJyYXkocHJvZmlsZS5oYXNodGFncykpIHJldHVybiBmYWxzZTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCB1c2VySGFzaHRhZ3MgPSBwcm9maWxlLmhhc2h0YWdzLm1hcCgoaDogc3RyaW5nKSA9PiBoLnRvTG93ZXJDYXNlKCkudHJpbSgpKTtcclxuICAgICAgICBjb25zdCBtYXRjaGluZ1RhZ3MgPSBldmVudEhhc2h0YWdzLmZpbHRlcihldmVudFRhZyA9PiBcclxuICAgICAgICAgIHVzZXJIYXNodGFncy5pbmNsdWRlcyhldmVudFRhZylcclxuICAgICAgICApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBtYXRjaGluZ1RhZ3MubGVuZ3RoID4gMDtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhg4pyFICR7dXNlcnNUb05vdGlmeS5sZW5ndGh9IHVzdcOhcmlvcyBwYXJhIG5vdGlmaWNhcmApO1xyXG5cclxuICAgICAgaWYgKHVzZXJzVG9Ob3RpZnkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgZGF0YTogeyBub3RpZmllZDogMCwgdXNlcnM6IFtdIH0gfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3Qgbm90aWZpY2F0aW9ucyA9IHVzZXJzVG9Ob3RpZnkubWFwKHVzZXIgPT4ge1xyXG4gICAgICAgIGNvbnN0IHVzZXJIYXNodGFncyA9IHVzZXIuaGFzaHRhZ3MubWFwKChoOiBzdHJpbmcpID0+IGgudG9Mb3dlckNhc2UoKS50cmltKCkpO1xyXG4gICAgICAgIGNvbnN0IG1hdGNoaW5nVGFncyA9IGV2ZW50SGFzaHRhZ3MuZmlsdGVyKHRhZyA9PiB1c2VySGFzaHRhZ3MuaW5jbHVkZXModGFnKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIHVzZXJfaWQ6IHVzZXIuaWQsIFxyXG4gICAgICAgICAgZXZlbnRfaWQ6IGV2ZW50SWQsXHJcbiAgICAgICAgICBub3RpZmljYXRpb25fdHlwZTogJ05vdm8gRXZlbnRvJyBhcyBOb3RpZmljYXRpb25UeXBlLFxyXG4gICAgICAgICAgdGl0bGU6ICfwn46vIE5vdm8gRXZlbnRvIGNvbSBzdWFzIEhhc2h0YWdzIScsXHJcbiAgICAgICAgICBtZXNzYWdlOiBgXCIke2V2ZW50RGF0YS50aXRsZX1cIiBmb2kgY3JpYWRvIGNvbSBoYXNodGFncyBxdWUgdm9jw6ogc2VndWU6ICR7bWF0Y2hpbmdUYWdzLm1hcCh0ID0+IGAjJHt0fWApLmpvaW4oJywgJyl9YCxcclxuICAgICAgICAgIHNlbnQ6IGZhbHNlLFxyXG4gICAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgfTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyDinKggQ09SUkXDh8ODTzogVXNhciBSUEMgcGFyYSBpbnNlcmlyIGVtIGxvdGUgKG1haXMgY29tcGxleG8pXHJcbiAgICAgIC8vIFBvciBzaW1wbGljaWRhZGUsIHZhbW9zIHVzYXIgbyAuaW5zZXJ0KCkgcXVlIGrDoSBlc3RhdmEgYXF1aSxcclxuICAgICAgLy8gcG9pcyBlc3RhIGZ1bsOnw6NvIMOpIGNoYW1hZGEgZGUgdW0gbG9jYWwgc2VndXJvIChiYWNrZW5kL3RyaWdnZXIpXHJcbiAgICAgIC8vIE9OREUgQVMgUkVHUkFTIERFIFJMUyBTw4NPIElHTk9SQURBUy5cclxuICAgICAgLy8gU2UgZm9yIGNoYW1hZGEgZG8gQ0xJRU5URSwgaXNzbyBWQUkgRkFMSEFSLlxyXG4gICAgICAvLyBBc3N1bWluZG8gcXVlIMOpIGNoYW1hZGEgZGUgdW0gbG9jYWwgc2VndXJvOlxyXG4gICAgICBjb25zdCB7IGVycm9yOiBpbnNlcnRFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnbm90aWZpY2F0aW9ucycpXHJcbiAgICAgICAgLmluc2VydChub3RpZmljYXRpb25zKTtcclxuXHJcbiAgICAgIGlmIChpbnNlcnRFcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGluc2VyaXIgbm90aWZpY2HDp8O1ZXM6JywgaW5zZXJ0RXJyb3IpO1xyXG4gICAgICAgIHRocm93IGluc2VydEVycm9yO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhg4pyFICR7bm90aWZpY2F0aW9ucy5sZW5ndGh9IG5vdGlmaWNhw6fDtWVzIGNyaWFkYXMgY29tIHN1Y2Vzc29gKTtcclxuXHJcbiAgICAgIHJldHVybiB7IFxyXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsIFxyXG4gICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgIG5vdGlmaWVkOiBub3RpZmljYXRpb25zLmxlbmd0aCxcclxuICAgICAgICAgIHVzZXJzOiB1c2Vyc1RvTm90aWZ5Lm1hcCh1ID0+IHUudXNlcm5hbWUgfHwgdS5pZClcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcblxyXG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBub3RpZmljYXIgdXN1w6FyaW9zIHBvciBoYXNodGFnOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0TWF0Y2hpbmdIYXNodGFncyhcclxuICAgIHVzZXJIYXNodGFnczogc3RyaW5nW10sXHJcbiAgICBldmVudEhhc2h0YWdzOiBzdHJpbmdbXVxyXG4gICk6IHN0cmluZ1tdIHtcclxuICAgIGlmICghQXJyYXkuaXNBcnJheSh1c2VySGFzaHRhZ3MpIHx8ICFBcnJheS5pc0FycmF5KGV2ZW50SGFzaHRhZ3MpKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB1c2VyVGFncyA9IHVzZXJIYXNodGFncy5tYXAoaCA9PiBoLnRvTG93ZXJDYXNlKCkudHJpbSgpKTtcclxuICAgIGNvbnN0IGV2ZW50VGFncyA9IGV2ZW50SGFzaHRhZ3MubWFwKGggPT4gaC50b0xvd2VyQ2FzZSgpLnRyaW0oKSk7XHJcblxyXG4gICAgcmV0dXJuIGV2ZW50VGFncy5maWx0ZXIodGFnID0+IHVzZXJUYWdzLmluY2x1ZGVzKHRhZykpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGFzeW5jIGhhc1VucmVhZEV2ZW50Tm90aWZpY2F0aW9ucyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnbm90aWZpY2F0aW9ucycpXHJcbiAgICAgICAgLnNlbGVjdCgnaWQnKVxyXG4gICAgICAgIC5lcSgndXNlcl9pZCcsIHVzZXJJZClcclxuICAgICAgICAuZXEoJ3NlbnQnLCBmYWxzZSlcclxuICAgICAgICAuZXEoJ25vdGlmaWNhdGlvbl90eXBlJywgJ05vdm8gRXZlbnRvJylcclxuICAgICAgICAubGltaXQoMSk7XHJcblxyXG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xyXG4gICAgICByZXR1cm4gZGF0YSAmJiBkYXRhLmxlbmd0aCA+IDA7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyB2ZXJpZmljYXIgbm90aWZpY2HDp8O1ZXM6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgYXN5bmMgZ2V0VXNlck5vdGlmaWNhdGlvbnModXNlcklkOiBzdHJpbmcsIHVucmVhZE9ubHk6IGJvb2xlYW4gPSBmYWxzZSk6IFByb21pc2U8U2VydmljZVJlc3VsdD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHF1ZXJ5ID0gc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnbm90aWZpY2F0aW9ucycpXHJcbiAgICAgICAgLnNlbGVjdCgnKicpXHJcbiAgICAgICAgLmVxKCd1c2VyX2lkJywgdXNlcklkKVxyXG4gICAgICAgIC5vcmRlcignY3JlYXRlZF9hdCcsIHsgYXNjZW5kaW5nOiBmYWxzZSB9KVxyXG4gICAgICAgIC5saW1pdCg1MCk7XHJcblxyXG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBxdWVyeTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGJ1c2NhciBub3RpZmljYcOnw7VlczonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc3RhdGljIGFzeW5jIG1hcmtBc1JlYWQobm90aWZpY2F0aW9uSWQ6IG51bWJlcik6IFByb21pc2U8U2VydmljZVJlc3VsdD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbSgnbm90aWZpY2F0aW9ucycpXHJcbiAgICAgICAgLnVwZGF0ZSh7IHNlbnQ6IHRydWUgfSlcclxuICAgICAgICAuZXEoJ2lkJywgbm90aWZpY2F0aW9uSWQpO1xyXG5cclxuICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuXHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gbWFyY2FyIGNvbW8gbGlkYTonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc3RhdGljIGFzeW5jIG1hcmtBbGxBc1JlYWQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPFNlcnZpY2VSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ25vdGlmaWNhdGlvbnMnKVxyXG4gICAgICAgIC51cGRhdGUoeyBzZW50OiB0cnVlIH0pXHJcbiAgICAgICAgLmVxKCd1c2VyX2lkJywgdXNlcklkKVxyXG4gICAgICAgIC5lcSgnc2VudCcsIGZhbHNlKTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIG1hcmNhciB0b2RhcyBjb21vIGxpZGFzOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgYXN5bmMgZ2V0VW5yZWFkQ291bnQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBjb3VudCwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ25vdGlmaWNhdGlvbnMnKVxyXG4gICAgICAgIC5zZWxlY3QoJyonLCB7IGNvdW50OiAnZXhhY3QnLCBoZWFkOiB0cnVlIH0pXHJcbiAgICAgICAgLmVxKCd1c2VyX2lkJywgdXNlcklkKVxyXG4gICAgICAgIC5lcSgnc2VudCcsIGZhbHNlKTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcblxyXG4gICAgICByZXR1cm4gY291bnQgfHwgMDtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvIGFvIGNvbnRhciBuw6NvIGxpZGFzOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgYXN5bmMgZGVsZXRlKG5vdGlmaWNhdGlvbklkOiBudW1iZXIpOiBQcm9taXNlPFNlcnZpY2VSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oJ25vdGlmaWNhdGlvbnMnKVxyXG4gICAgICAgIC5kZWxldGUoKVxyXG4gICAgICAgIC5lcSgnaWQnLCBub3RpZmljYXRpb25JZCk7XHJcblxyXG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xyXG5cclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBhbyBkZWxldGFyIG5vdGlmaWNhw6fDo286JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IE5vdGlmaWNhdGlvblNlcnZpY2U7Il0sInZlcnNpb24iOjN9